<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-signin-client_id" content="232267534625-oju4j8ob02rn6tim24tcdas26c5rh3j4.apps.googleusercontent.com">
    <title>Dashboard de OKRs - CS (Automático)</title>
    <link rel="icon" type="image/png" href="icone.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ESTILOS (CSS) EMBUTIDOS PARA GARANTIR FUNCIONAMENTO */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        :root { --primary-color: #007BFF; --primary-hover-color: #0056b3; --secondary-color: #28a745; --danger-color: #dc3545; --warning-color: #ffc107; --bg-color: #121828; --bg-gradient: linear-gradient(180deg, #1a2238 0%, #121828 30%); --card-bg-color: #1a2238; --text-color: #F0F2F5; --text-light-color: #a9b3c1; --border-color: #3a476a; --shadow-color: rgba(0, 0, 0, 0.2); --font-family: 'Inter', sans-serif; --border-radius-lg: 16px; --border-radius-md: 12px; --border-radius-sm: 8px; }
        body.light-theme { --primary-color: #007BFF; --primary-hover-color: #0069d9; --bg-color: #f4f7fc; --bg-gradient: linear-gradient(180deg, #ffffff 0%, #f4f7fc 40%); --card-bg-color: #ffffff; --text-color: #2c3e50; --text-light-color: #57606A; --border-color: #e3e8f0; --shadow-color: rgba(99, 112, 134, 0.15); }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: var(--font-family); background: var(--bg-gradient) no-repeat; background-color: var(--bg-color); margin: 0; padding: 24px; color: var(--text-color); line-height: 1.6; transition: background-color 0.3s, color 0.3s; }
        #login-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 90vh; text-align: center; }
        #login-container h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 15px; color: var(--text-color); }
        .container { max-width: 1800px; margin: auto; padding: 0 20px; }
        header { text-align: center; margin-bottom: 40px; position: relative; }
        header h1 { font-size: 2.8rem; font-weight: 800; color: var(--text-color); margin: 0 0 8px 0; }
        #last-load-info { font-size: 0.9rem; color: var(--text-light-color); margin-top: 12px; background-color: color-mix(in srgb, var(--border-color) 40%, transparent); padding: 8px 15px; border-radius: var(--border-radius-md); display: inline-block; border: 1px solid var(--border-color); }
        .header-actions { position: absolute; top: 0; right: 0; display: flex; align-items: center; gap: 15px; background-color: var(--card-bg-color); padding: 8px 12px; border-radius: var(--border-radius-lg); border: 1px solid var(--border-color); }
        .header-actions button { background: none; border: none; color: var(--text-light-color); font-size: 1.5rem; cursor: pointer; transition: all 0.3s; }
        .header-actions button:hover { color: var(--primary-color); transform: scale(1.1); }
        .theme-switcher { display: flex; align-items: center; gap: 12px; color: var(--text-light-color); }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked+.slider { background-color: var(--primary-color); }
        input:checked+.slider:before { transform: translateX(20px); }
        .controls, .onboarding-controls { display: flex; gap: 20px; padding: 20px; background-color: var(--card-bg-color); border-radius: var(--border-radius-lg); margin-bottom: 30px; flex-wrap: wrap; justify-content: center; align-items: flex-end; border: 1px solid var(--border-color); box-shadow: 0 4px 15px var(--shadow-color); }
        .onboarding-controls { background-color: color-mix(in srgb, var(--primary-color) 8%, transparent); border: 1px solid var(--primary-color); }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-weight: 600; margin-bottom: 10px; color: var(--text-color); font-size: 0.9rem; }
        .control-group select { padding: 12px 15px; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); min-width: 180px; background-color: var(--bg-color); color: var(--text-color); font-size: 1rem; }
        .tabs { display: flex; gap: 5px; border-bottom: 2px solid var(--border-color); margin-bottom: 30px; }
        .tab-button { padding: 12px 25px; cursor: pointer; background: transparent; border: none; border-bottom: 4px solid transparent; font-size: 1.1rem; font-weight: 600; color: var(--text-light-color); }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .metric-group { margin-bottom: 50px; }
        .group-title { font-size: 1.8rem; font-weight: 700; color: var(--text-color); margin: 0 0 25px 0; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .group-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 25px; }
        .card { background-color: var(--card-bg-color); border-radius: var(--border-radius-lg); padding: 25px; border: 1px solid var(--border-color); display: flex; flex-direction: column; box-shadow: 0 4px 15px var(--shadow-color); transition: transform 0.3s; position: relative; }
        .card:hover { transform: translateY(-5px); }
        .card h3 { margin-top: 0; color: var(--text-color); border-bottom: 1px solid var(--border-color); padding-bottom: 15px; font-size: 1.25rem; display: flex; align-items: center; gap: 10px; }
        .metric { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 1rem; padding: 12px 8px; border-radius: var(--border-radius-sm); }
        .metric:hover { background-color: color-mix(in srgb, var(--primary-color) 10%, transparent); }
        .metric-label { color: var(--text-light-color); font-weight: 500; }
        .metric-value { font-weight: 700; color: var(--text-color); font-size: 1.6rem; }
        .metric-value.success { color: var(--secondary-color); }
        .metric-value.danger { color: var(--danger-color); }
        .progress-bar-container { display: flex; align-items: center; gap: 15px; margin-top: 20px; }
        .progress-bar { flex-grow: 1; background-color: var(--border-color); border-radius: 25px; height: 12px; overflow: hidden; }
        .progress-bar-fill { background: var(--primary-color); height: 100%; width: 0%; border-radius: 25px; transition: width 1s; }
        .loader { text-align: center; padding: 60px; font-weight: 600; grid-column: 1 / -1; font-size: 1.2rem; color: var(--text-light-color); }
        
        /* Modais */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); overflow-y: auto; }
        .modal-content { background-color: var(--card-bg-color); margin: 5% auto; padding: 30px; border: 1px solid var(--border-color); width: 90%; max-width: 1400px; border-radius: var(--border-radius-lg); box-shadow: 0 15px 40px rgba(0,0,0,0.5); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .close-button { font-size: 2rem; cursor: pointer; color: var(--text-light-color); }
        .modal-search-container input { width: 100%; padding: 12px; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); margin-bottom: 20px; }
        
        /* Tabelas */
        .data-table-wrapper { background-color: var(--card-bg-color); border-radius: var(--border-radius-lg); padding: 25px; border: 1px solid var(--border-color); margin-bottom: 30px; }
        .data-table-container { max-height: 500px; overflow-y: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px 15px; border-bottom: 1px solid var(--border-color); text-align: left; font-size: 0.9rem; color: var(--text-color); }
        .data-table th { background-color: var(--bg-color); position: sticky; top: 0; font-weight: 700; }
        .client-activity-trigger { color: var(--primary-color); cursor: pointer; font-weight: 600; }
        
        /* Outros */
        #user-info-card { position: absolute; top: 15px; left: 20px; background: var(--card-bg-color); padding: 8px 15px; border-radius: var(--border-radius-md); border: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; }
        #app-version-marker { position: fixed; bottom: 10px; left: 15px; background: var(--card-bg-color); padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; opacity: 0.7; border: 1px solid var(--border-color); }
        .trend-chart-button { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-light-color); cursor: pointer; }
        .trend-chart-button:hover { color: var(--primary-color); }
        
        /* Top 5 Onboarding */
        .onboarding-top5-list { list-style: none; padding: 0; margin: 15px 0; }
        .onboarding-top5-list li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .onboarding-top5-list .duration { font-weight: 700; color: var(--warning-color); }
    </style>
</head>

<body>
    <div id="app-version-marker">Versão: 3.1.0-final</div>
    
    <div id="login-container">
        <h1>Dashboard de OKRs</h1>
        <p>Por favor, faça login com sua conta Google para acessar.</p>
        <div id="g_id_onload" 
             data-client_id="232267534625-oju4j8ob02rn6tim24tcdas26c5rh3j4.apps.googleusercontent.com" 
             data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with"></div>
        <button id="force-clear-button" style="background: none; border: 1px solid #555; color: #888; padding: 10px 20px; margin-top: 30px; border-radius: 8px; cursor: pointer;">
            <i class="fas fa-sync-alt"></i> Limpar cache e recarregar
        </button>
    </div>

    <div id="dashboard-wrapper" style="display: none;">
        <div class="container">
            <header>
                <div id="user-info-card">
                    <span id="user-info-text"></span>
                    <button id="logout-button" title="Sair" style="background:none;border:none;color:#dc3545;cursor:pointer;"><i class="fas fa-sign-out-alt"></i></button>
                </div>
                <h1>Dashboard de OKRs</h1>
                <p>Avaliação de Resultados e Performance</p>
                <div id="last-load-info" style="display: none;"></div>
                <div class="header-actions">
                    <div class="theme-switcher">
                        <i class="fas fa-sun"></i>
                        <label class="switch"><input type="checkbox" id="theme-toggle"><span class="slider"></span></label>
                        <i class="fas fa-moon"></i>
                    </div>
                    <button id="bulk-export-button" title="Exportar Lote"><i class="fas fa-file-export"></i></button>
                    <button id="export-html-button" title="Exportar HTML"><i class="fas fa-file-invoice"></i></button>
                    <button id="export-csv-button" title="Exportar CSV"><i class="fas fa-file-csv"></i></button>
                    <button id="settings-button" title="Metas"><i class="fas fa-cog"></i></button>
                </div>
            </header>

            <section class="controls">
                <div class="control-group">
                    <label style="color: var(--secondary-color); font-weight: bold;"><i class="fas fa-database"></i> Conexão SenseData</label>
                    <button id="btn-refresh-data" onclick="window.loadDataFromAPI()" style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                        <i class="fas fa-sync-alt"></i> Atualizar Agora
                    </button>
                </div>
                <div class="control-group">
                    <label>Análise de Período</label>
                    <select id="select-period">
                        <option value="monthly" selected>Mensal</option>
                        <option value="q1">1º Trimestre</option>
                        <option value="q2">2º Trimestre</option>
                        <option value="q3">3º Trimestre</option>
                        <option value="q4">4º Trimestre</option>
                        <option value="year">Ano Inteiro</option>
                    </select>
                </div>
                <div class="control-group"><label>Ano</label><select id="select-year"></select></div>
                <div class="control-group"><label>Mês</label><select id="select-month"></select></div>
                <div class="control-group"><label>CS</label><select id="select-cs" disabled><option>Aguardando...</option></select></div>
                <div id="squad-filter-group" class="control-group"><label>Squad</label><select id="select-squad" disabled><option>Aguardando...</option></select></div>
                <div class="control-group"><label>Segmento</label><select id="select-segmento" disabled><option>Aguardando...</option></select></div>
                <div class="control-group">
                    <label>Comparar com</label>
                    <select id="select-comparison">
                        <option value="none" selected>Nenhum</option>
                        <option value="prev_month">Mês Anterior</option>
                        <option value="prev_year">Ano Anterior</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Incluir Onboarding</label>
                    <label class="switch"><input type="checkbox" id="include-onboarding-toggle"><span class="slider"></span></label>
                </div>
            </section>

            <div id="squad-cs-list" style="text-align: center; margin: -15px 0 20px 0; color: #aaa; font-style: italic;"></div>
            <div id="divergence-marker" class="divergence-info" style="display: none;"><span id="divergence-text"></span></div>
            <div id="status-message" class="loader">Aguardando login...</div>

            <div class="tabs" style="display: none;">
                <button class="tab-button active" data-tab="dashboard-view"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                <button class="tab-button" data-tab="onboarding-view"><i class="fas fa-rocket"></i> Onboarding</button>
                <button class="tab-button" data-tab="overdue-view" style="color: #dc3545;"><i class="fas fa-clock-rotate-left"></i> Atrasadas</button>
                <button class="tab-button" data-tab="data-view"><i class="fas fa-table"></i> Dados</button>
            </div>

            <main id="main-content">
                <div id="dashboard-view" class="tab-content active">
                    <div id="dashboard" style="display: none;">
                        <div class="metric-group"><h2 class="group-title">Indicadores Gerais</h2><div class="group-content" id="general-indicators-grid"></div></div>
                        <div class="metric-group"><h2 class="group-title">Visão por Negócio</h2><div class="group-content" id="business-commercial-grid"></div></div>
                        <div class="metric-group"><h2 class="group-title">Playbooks</h2><div class="group-content" id="playbooks-grid"></div></div>
                        <div class="metric-group"><h2 class="group-title" id="okr-title-header">OKRs</h2><div class="group-content" id="okr-grid-container"></div></div>
                    </div>
                    <div id="period-view" style="display: none;"></div>
                </div>

                <div id="onboarding-view" class="tab-content">
                    <div id="onboarding-dashboard" style="display: none;">
                        <section class="onboarding-controls">
                            <div class="control-group">
                                <label>Visão do Time</label>
                                <select id="select-onboarding-team" disabled>
                                    <option value="geral">Visão Geral</option>
                                    <option value="syneco">Syneco</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                            <div class="control-group"><label>ISM Responsável</label><select id="select-ism" disabled><option>Aguardando...</option></select></div>
                        </section>
                        <div class="metric-group"><h2 class="group-title">Resultados Onboarding</h2><div class="group-content" id="onboarding-outcomes-grid"><div class="loader">Calculando...</div></div></div>
                        <div class="metric-group"><h2 class="group-title">Eficiência do Processo</h2><div class="group-content" id="onboarding-process-grid"><div class="loader">Calculando...</div></div></div>
                    </div>
                </div>

                <div id="overdue-view" class="tab-content">
                    <div class="metric-group"><h2 class="group-title">Atividades Atrasadas</h2><div class="group-content" id="overdue-grid-container"><div class="loader">Selecione um CS.</div></div></div>
                </div>

                <div id="data-view" class="tab-content">
                    <div class="data-table-wrapper"><h3>Atividades</h3><div id="atividades-table" class="data-table-container"></div><div id="atividades-pagination" class="pagination-controls"></div></div>
                    <div class="data-table-wrapper"><h3>Clientes</h3><div id="clientes-table" class="data-table-container"></div><div id="clientes-pagination" class="pagination-controls"></div></div>
                </div>
            </main>

            <div id="details-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header"><h2 id="modal-title">Detalhes</h2><span class="close-button">&times;</span></div>
                    <div class="modal-search-container"><input type="search" id="modal-search-input" placeholder="Pesquisar..."></div>
                    <div id="modal-body" class="data-table-container"></div>
                </div>
            </div>
            <div id="settings-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header"><h2>Configurar Metas</h2><span class="close-button">&times;</span></div>
                    <div class="settings-grid">
                         <div class="control-group"><label for="goal-sensescore">Sense Score</label><input type="number" id="goal-sensescore" step="1"></div>
                         <div class="control-group"><label for="goal-labs">SKA LABS (%)</label><input type="number" id="goal-labs" step="1"></div>
                         <div class="control-group"><label for="goal-coverage">Cobertura (%)</label><input type="number" id="goal-coverage" step="1"></div>
                         <div class="control-group"><label for="goal-qbr">QBR (nº)</label><input type="number" id="goal-qbr" step="1"></div>
                         <div class="control-group"><label for="goal-successplan">Planos Sucesso (nº)</label><input type="number" id="goal-successplan" step="1"></div>
                         <div class="control-group"><label for="goal-engagement">Engajamento (%)</label><input type="number" id="goal-engagement" step="1"></div>
                         <button id="save-settings-button"><i class="fas fa-save"></i> Salvar</button>
                    </div>
                </div>
            </div>
            <div id="anotacao-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Anotação</h2><span class="close-button">&times;</span></div><div id="anotacao-modal-body" style="padding: 20px;"></div></div></div>
            <div id="trend-chart-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Gráfico de Tendência</h2><span class="close-button">&times;</span></div><div id="trend-chart-container" style="padding: 20px;"><canvas id="trend-chart-canvas"></canvas></div></div></div>
            <div id="bulk-export-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Exportar em Lote</h2><span class="close-button">&times;</span></div><div id="cs-selection-list" style="margin: 20px 0; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #ccc;"></div><button id="generate-bulk-reports-button" style="width: 100%; padding: 14px; background: #28a745; color: white; border: none; cursor: pointer;">Gerar</button></div></div>
        </div>
    </div>

    <script src="ism_config.js"></script>

    <script>
    // ============================================================
    //  JAVASCRIPT PRINCIPAL UNIFICADO
    // ============================================================
    
    const WORKER_URL = "https://sensedata-api.sensedata-dash.workers.dev"; 

    let dataWorker, rawActivities = [], rawClients = [], dataStore = {}, onboardingDataStore = {}, appGoals = {}, filterDataCache = {}, chartInstances = {}, trendChartInstance = null;
    const defaultGoals = { sensescore: 85, labs: 10, coverage: 40, qbr: 5, successplan: 5, engagement: 50 };
    let currentUser = { email: null, name: null, isManager: false, userGroup: null };
    const manualEmailToCsMap = {
        "email.dificil@provedor.com": "Nome Completo do CS", "gabriellermsviana@gmail.com": "Gabrielle Viana", "francielesilvadomingues@gmail.com": "Franciele Domingues", "okrmarina1@gmail.com": "Marina Santos", "deborahsimonearruda@gmail.com": "Deborah Arruda"
    };

    // --- HELPER FUNCTIONS (DEFINIDAS PRIMEIRO) ---
    function normalizeText(str = '') { return String(str).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }
    function formatDate(date) { if (!(date instanceof Date) || isNaN(date)) return ''; return `${String(date.getUTCDate()).padStart(2,'0')}/${String(date.getUTCMonth()+1).padStart(2,'0')}/${date.getUTCFullYear()}`; }
    function showModal(el) { if(el) el.style.display = 'block'; }
    function closeModal(el) { if(el) { el.style.display = 'none'; if(el.querySelector('input')) el.querySelector('input').value = ''; } }

    function createHtmlTable(data) {
        if (!data || data.length === 0) return '<p style="padding: 20px; text-align: center;">Sem dados.</p>';
        const headers = Object.keys(data[0]).filter(h => normalizeText(h) !== 'anotacoes');
        const head = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
        const body = `<tbody>${data.map(row => `<tr>${headers.map(h => {
            let val = row[h];
            if(val instanceof Date) val = formatDate(val);
            if(normalizeText(h) === 'cliente') return `<td><span class="client-activity-trigger" data-anotacao="${(row['Anotações']||'').replace(/"/g,'&quot;')}">${val}</span></td>`;
            return `<td>${val !== null && val !== undefined ? val : ''}</td>`;
        }).join('')}</tr>`).join('')}</tbody>`;
        return `<table class="data-table">${head}${body}</table>`;
    }

    // --- JANELAS MODAIS (Garantir que existam) ---
    window.showDataInModal = function(data, title) {
        if (!data || data.length === 0) { alert(`Não há dados.`); return; }
        const modal = document.getElementById('details-modal');
        modal.querySelector('#modal-title').textContent = title;
        const body = modal.querySelector('#modal-body');
        const input = modal.querySelector('#modal-search-input');
        input.value = '';
        input.oninput = () => {
            const term = normalizeText(input.value);
            body.innerHTML = createHtmlTable(data.filter(r => Object.values(r).some(v => normalizeText(String(v)).includes(term))));
        };
        body.innerHTML = createHtmlTable(data);
        showModal(modal);
    };

    function showDetailsModal(id, title) { const data = dataStore[id] || onboardingDataStore[id]; window.showDataInModal(data, title); }
    function showAnotacaoModal(txt) { document.getElementById('anotacao-modal-body').textContent = txt || 'Sem anotações.'; showModal(document.getElementById('anotacao-modal')); }

    function showTrendChart(metricId, title, type) {
        const modal = document.getElementById('trend-chart-modal');
        document.getElementById('trend-chart-title').textContent = `Tendência: ${title}`;
        document.getElementById('trend-chart-container').innerHTML = '<canvas id="trend-chart-canvas"></canvas>';
        showModal(modal);
        if(dataWorker) {
            dataWorker.postMessage({
                type: 'CALCULATE_TREND',
                payload: {
                    metricId, title, type,
                    baseMonth: parseInt(document.getElementById('select-month').value),
                    baseYear: parseInt(document.getElementById('select-year').value),
                    selectedCS: document.getElementById('select-cs').value,
                    selectedSquad: document.getElementById('select-squad').value,
                    includeOnboarding: document.getElementById('include-onboarding-toggle').checked,
                    segmento: document.getElementById('select-segmento').value
                }
            });
        }
    }

    // --- CARGA DE DADOS ---
    window.mapDatabaseToDashboard = (dbData, type) => {
        const trType = (r) => { if(!r) return ""; const t=r.toLowerCase(); if(t.includes('phone')||t.includes('call'))return 'Ligação'; if(t.includes('meeting'))return 'Reunião'; if(t.includes('email'))return 'E-mail'; return r; };
        const trStatus = (r) => { if(!r) return ""; const s=r.toLowerCase(); if(s==='completed'||s==='concluded') return 'Concluída'; if(s==='open'||s==='scheduled') return 'Agendada'; return r; };

        return dbData.map(row => {
            if (type === 'atividades') return {
                "Criado em": row.criado_em ? new Date(row.criado_em) : null,
                "Cliente": row.cliente, "CS": row.cs, "Playbook": row.playbook, "Atividade": row.atividade,
                "Tipo de Atividade": trType(row.tipo_atividade), "Categoria": row.categoria || trType(row.tipo_atividade),
                "Status": trStatus(row.status), "Previsão de conclusão": row.previsao_conclusao ? new Date(row.previsao_conclusao) : null,
                "Concluída em": row.concluida_em ? new Date(row.concluida_em) : null, "Responsável": row.responsavel, "Status Cliente": row.status_cliente
            };
            else return {
                "Cliente": row.cliente, "CS": row.cs, "Segmento": row.segmento, "Fase": row.fase, "ISM": row.ism,
                "Negócio": row.negocio, "Comercial": row.comercial, "NPS onboarding": row.nps_onboarding,
                "Valor total não faturado": row.valor_total_em_aberto, "Status": row.status, "Squad CS": row.squad_cs,
                "Dias sem touch": row.dias_sem_touch, "Situação": row.situacao, "Modelo de negócio": row.modelo_de_negocio, "Potencial": row.potencial
            };
        });
    };

    window.loadDataFromAPI = async function() {
        const msg = document.getElementById('status-message');
        const btn = document.getElementById('btn-refresh-data');
        if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...'; }
        if(msg) { msg.style.display = 'block'; msg.className = 'loader'; msg.textContent = 'Conectando...'; }

        try {
            if(msg) msg.innerHTML = 'Baixando Atividades (300k)...';
            const r1 = await fetch(`${WORKER_URL}/api/atividades?limit=300000`);
            const j1 = await r1.json();
            if(msg) msg.innerHTML = 'Baixando Clientes...';
            const r2 = await fetch(`${WORKER_URL}/api/clientes`);
            const j2 = await r2.json();

            if(msg) msg.innerHTML = 'Processando...';
            rawActivities = window.mapDatabaseToDashboard(j1, 'atividades');
            rawClients = window.mapDatabaseToDashboard(j2, 'clientes');
            console.log(`Loaded: ${rawActivities.length} acts / ${rawClients.length} clients`);

            if (dataWorker) dataWorker.terminate();
            dataWorker = new Worker('worker.js');
            dataWorker.onmessage = handleWorkerMessage;
            dataWorker.postMessage({ type: 'INIT', payload: { rawActivities, rawClients, currentUser, manualEmailToCsMap } });
            
            if(msg) { msg.textContent = 'Pronto!'; setTimeout(()=>msg.style.display='none', 1000); }
        } catch (e) {
            console.error(e); alert("Erro ao conectar: " + e.message);
        } finally {
            if(btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar Agora'; }
        }
    };

    // --- RENDERIZAÇÃO GRÁFICA (Donut + Trend) ---
    function customLegendClickHandler(e, item, legend) {
        const chart = legend.chart, index = item.index, meta = chart.getDatasetMeta(0);
        if (!chart.legendClickState) chart.legendClickState = { idx: null, count: 0 };
        if (index !== chart.legendClickState.idx) {
            let vis = 0; meta.data.forEach(d => { if (!d.hidden) vis++; });
            if (vis === 1 && chart.data.labels.length > 1) meta.data.forEach(d => d.hidden = false);
            chart.legendClickState.count = 0;
        }
        chart.legendClickState.idx = index; chart.legendClickState.count++;
        if (chart.legendClickState.count === 1) meta.data[index].hidden = !meta.data[index].hidden;
        else if (chart.legendClickState.count === 2) meta.data.forEach((d, i) => d.hidden = (i !== index));
        else { meta.data.forEach(d => d.hidden = false); chart.legendClickState.count = 0; }
        chart.update();
    }

    function renderDoughnutChart(cid, canvid, title, data) {
        const con = document.getElementById(cid);
        if (!con) return;
        const labs = Object.keys(data), vals = Object.values(data);
        if (labs.length === 0) { con.innerHTML = `<div class="card"><h3>${title}</h3><div class="loader" style="padding:40px;font-size:1rem">Sem dados.</div></div>`; return; }
        
        con.innerHTML = `<div class="card"><h3>${title}</h3><div class="card-content" style="position:relative;height:320px;padding-top:10px"><canvas id="${canvid}"></canvas></div></div>`;
        if (chartInstances[canvid]) chartInstances[canvid].destroy();
        const ctx = document.getElementById(canvid).getContext('2d');
        const colors = ['#007BFF', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2', '#fd7e14', '#20c997'];
        const bgColors = labs.map((_, i) => colors[i % colors.length]);
        const isLight = document.body.classList.contains('light-theme');

        chartInstances[canvid] = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labs, datasets: [{ data: vals, backgroundColor: bgColors, borderColor: isLight ? '#fff' : '#1a2238', borderWidth: 2 }] },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: '60%',
                plugins: {
                    legend: { position: 'bottom', labels: { color: isLight ? '#2c3e50' : '#F0F2F5', padding: 15, boxWidth: 12 }, onClick: customLegendClickHandler },
                    tooltip: { callbacks: { label: (c) => `${c.label}: ${c.raw} (${((c.raw/c.dataset.data.reduce((a,b)=>a+b,0))*100).toFixed(1)}%)` } }
                },
                onClick: (evt, els) => {
                    if (els.length > 0) {
                        const lbl = labs[els[0].index];
                        let fil = [];
                        if(cid.includes('negocio')) fil = (dataStore['cob-carteira']||[]).filter(c => normalizeText(c.Negocio||'').includes(normalizeText(lbl)));
                        else if(cid.includes('comercial')) fil = (dataStore['cob-carteira']||[]).filter(c => normalizeText(c.Comercial||'').includes(normalizeText(lbl)));
                        else if(cid.includes('clientes')) fil = (dataStore['total-clientes']||[]).filter(c => normalizeText(c['Negócio']||'').includes(normalizeText(lbl)));
                        if(fil.length) window.showDataInModal(fil, `${title}: ${lbl}`);
                    }
                },
                onHover: (e, el) => { e.native.target.style.cursor = el[0] ? 'pointer' : 'default'; }
            }
        });
    }

    function renderTrendChart(labels, dataPoints, title) {
        const ctx = document.getElementById('trend-chart-canvas').getContext('2d');
        if (trendChartInstance) trendChartInstance.destroy();
        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: title, data: dataPoints, fill: true, borderColor: '#007BFF', backgroundColor: 'rgba(0, 123, 255, 0.2)', pointBackgroundColor: '#007BFF', tension: 0.3 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }
    
    function renderOnboardingProductChart(data) {
        if(!data || !data.labels) return;
        const ctx = document.getElementById('onboardingProductChart').getContext('2d');
        if(chartInstances['onboardingProductChart']) chartInstances['onboardingProductChart'].destroy();
        chartInstances['onboardingProductChart'] = new Chart(ctx, {
            type: 'bar',
            data: { labels: data.labels, datasets: [{ label: 'Clientes', data: data.clientCount, backgroundColor: '#007BFF', yAxisID: 'y1' }, { label: 'Dias (Média)', data: data.avgTime, type: 'line', borderColor: '#ffc107', yAxisID: 'y2' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y1: { position: 'left' }, y2: { position: 'right', grid: { display: false } } } }
        });
    }

    // --- RENDERIZAÇÃO UI (Cards) ---
    function renderOKRs() {
        const seg = document.getElementById('select-segmento').value;
        document.getElementById('okr-title-header').textContent = `OKRs: ${seg}`;
        
        document.getElementById('business-commercial-grid').innerHTML = `<div id="negocio-chart-container"></div><div id="comercial-chart-container"></div><div id="clientes-negocio-chart-container"></div>`;
        if(dataStore['contatos-por-negocio']) renderDoughnutChart('negocio-chart-container', 'negocioChart', 'Contatos por Negócio', dataStore['contatos-por-negocio']);
        if(dataStore['contatos-por-comercial']) renderDoughnutChart('comercial-chart-container', 'comercialChart', 'Contatos por Comercial', dataStore['contatos-por-comercial']);
        if(dataStore['clientes-por-negocio']) renderDoughnutChart('clientes-negocio-chart-container', 'clientesNegocioChart', 'Clientes por Negócio', dataStore['clientes-por-negocio']);

        // Visão Geral
        const calls = (dataStore['contato-ligacao']||[]).length, emails = (dataStore['contato-email']||[]).length, tot = calls+emails;
        const pC = tot>0?((calls/tot)*100).toFixed(0):0, pE = tot>0?((emails/tot)*100).toFixed(0):0;
        const cardType = `<div class="card"><h3>Tipos de Contato</h3><div class="card-content"><div class="metric"><span class="metric-label">Ligação:</span><span class="metric-value">${calls} (${pC}%)</span></div><div class="metric"><span class="metric-label">Email:</span><span class="metric-value">${emails} (${pE}%)</span></div></div></div>`;
        
        const cov = dataStore['cob-carteira']?.length||0, uni = dataStore['total-clientes-unicos-cs']||0, pCov = uni>0?(cov/uni)*100:0;
        const cardCov = createOkrCard('Cobertura', pCov, appGoals.coverage, '%', 'cob-carteira', null, null, dataStore['cob-carteira_comp_perc']);
        const cardSense = createOkrCard('Sense Score', dataStore['sensescore-avg']||0, appGoals.sensescore, ' pts', 'sensescore-avg', (dataStore['sensescore-avg']||0).toFixed(1), null, dataStore['sensescore-avg_comp']);
        
        document.getElementById('general-indicators-grid').innerHTML = `${createSimpleCard('Visão Geral', 'total-clientes', 'Total Clientes', (dataStore['total-clientes']||[]).length, 'cob-carteira', 'Contatados', cov)} ${cardCov} ${cardSense} ${cardType}`;

        // Playbooks
        const pbGrid = document.getElementById('playbooks-grid');
        pbGrid.innerHTML = '';
        ['plano', 'adocao', 'followup', 'discovery'].forEach(p => {
            if(p === 'discovery' && seg === 'MID/Enterprise') return;
            pbGrid.innerHTML += createPrevistoRealizadoCard(p.toUpperCase(), (dataStore[`${p}-previsto`]||[]).length, (dataStore[`${p}-realizado`]||[]).length, p, null, (dataStore[`${p}-atrasado-concluido`]||[]).length, (dataStore[`${p}-concluido-antecipado`]||[]).length);
        });

        // OKRs
        const okrGrid = document.getElementById('okr-grid-container');
        okrGrid.innerHTML = '';
        const labs = createOkrCard('SKA LABS', ((dataStore['ska-labs-realizado-list']?.length||0)*100)/(dataStore['total-labs-eligible']||1), appGoals.labs, '%', 'ska-labs-realizado-list');
        if(seg === 'MID/Enterprise') {
            ['reunioes-qbr', 'planos-sucesso', 'baixo-engajamento-mid'].forEach(p => {
                okrGrid.innerHTML += createPrevistoRealizadoCard(p, (dataStore[`${p}-previsto`]||[]).length, (dataStore[`${p}-realizado`]||[]).length, p, (p==='reunioes-qbr'?appGoals.qbr:(p==='planos-sucesso'?appGoals.successplan:null)), (dataStore[`${p}-atrasado-concluido`]||[]).length, (dataStore[`${p}-concluido-antecipado`]||[]).length);
            });
            okrGrid.innerHTML += labs;
        } else {
            const tr = (dataStore['engajamento-smb-realizado']||[]).length + (dataStore['engajamento-smb-atrasado-concluido']||[]).length;
            const eng = (dataStore['engajamento-smb-engajado']||[]).length;
            const perf = tr>0?(eng/tr)*100:0;
            okrGrid.innerHTML += `<div class="card"><h3>Engajamento</h3><div class="card-content"><div class="metric"><span class="metric-label">Realizado:</span><span class="metric-value">${tr}</span></div><div class="metric"><span class="metric-label">Engajado:</span><span class="metric-value success">${eng}</span></div><div class="metric"><span class="metric-label">Performance:</span><span class="metric-value">${perf.toFixed(1)}%</span></div></div></div>`;
            okrGrid.innerHTML += labs;
        }
    }

    function renderNewOnboardingView() {
        const grid = document.getElementById('onboarding-outcomes-grid');
        const goLive = (onboardingDataStore.goLiveActivitiesConcluded?.length||0);
        grid.innerHTML = `
            ${createOnboardingStageCard(onboardingDataStore.totalFilteredClients||0, onboardingDataStore.stageCounts, onboardingDataStore.stageLists||{})}
            ${createOnboardingMetricCard('Go-Lives', 'Realizados', goLive, '', 'fa-rocket', 'onb-go-live-combined', onboardingDataStore.goLiveActivitiesConcluded||[])}
            ${createTop5OnboardingCard(onboardingDataStore.top5LongestOnboardings||[], onboardingDataStore.clientsOver120Days||[])}
            <div class="card" id="onboarding-product-chart-card"><h3>Análise Produto</h3><div class="card-content" style="height:350px;padding-top:20px"><canvas id="onboardingProductChart"></canvas></div></div>
        `;
        renderOnboardingProductChart(onboardingDataStore.productChartData);
        
        const proc = document.getElementById('onboarding-process-grid');
        proc.innerHTML = '';
        ['welcome', 'kickoff', 'planejamento', 'mapearContatos', 'goLiveMeeting', 'acompanhamento'].forEach(k => {
            proc.innerHTML += createOnboardingProcessCard(k.toUpperCase(), '', (onboardingDataStore[`${k}Previsto`]||[]).length, (onboardingDataStore[`${k}Realizado`]||[]).length, 'fa-check', k);
        });
    }

    function renderOverdueView(metrics) {
        const grid = document.getElementById('overdue-grid-container');
        let html = '';
        for (const k in metrics.overdueActivities) {
            const c = metrics.overdueActivities[k].length;
            if(c > 0) {
                onboardingDataStore[`overdue-${k}`] = metrics.overdueActivities[k];
                html += `<div class="card" onclick="showDetailsModal('overdue-${k}', 'Atrasadas: ${k}')" style="cursor:pointer"><h3>${k}</h3><div class="card-content"><div class="metric"><span class="metric-label">Qtd:</span><span class="metric-value danger">${c}</span></div></div></div>`;
            }
        }
        grid.innerHTML = html || '<div class="loader">Sem atrasos.</div>';
    }
    
    function renderPeriodView(d, n) {
        document.getElementById('dashboard').style.display = 'none';
        const view = document.getElementById('period-view');
        view.style.display = 'block';
        view.innerHTML = `<div class="card"><h3>Cobertura Média (${n})</h3><div class="card-content"><div class="metric"><span class="metric-value">${d.averageCoverage.toFixed(1)}%</span></div></div></div>`;
    }

    // --- CARD HELPERS ---
    const createSimpleCard = (t, i1, l1, v1, i2, l2, v2) => `<div class="card"><h3>${t}</h3><div class="card-content"><div class="metric" data-metric-id="${i1}" data-metric-title="${l1}"><span class="metric-label">${l1}:</span><span class="metric-value">${v1}</span></div>${i2 ? `<div class="metric" data-metric-id="${i2}" data-metric-title="${l2}"><span class="metric-label">${l2}:</span><span class="metric-value">${v2}</span></div>` : ''}</div></div>`;
    const createOkrCard = (t, v, g, u, id, cv, gv, cmp, miss, dist) => {
        const p = g>0?(v/g)*100:0;
        const valTxt = cv!==null ? `${cv}${u}` : `${u==='%'?v.toFixed(1):v.toFixed(0)}${u}`;
        const trd = cmp!==null ? `<span class="trend-indicator ${v-cmp>0?'trend-positive':'trend-negative'}">${(v-cmp).toFixed(1)}</span>` : '';
        return `<div class="card"><h3>${t}</h3><div class="card-content"><div class="metric" data-metric-id="${id}" data-metric-title="${t}"><span class="metric-label">Meta: ${g}${u}</span><span class="metric-value">${valTxt} ${trd}</span></div>${dist||''}</div><div class="progress-bar-container"><div class="progress-bar"><div class="progress-bar-fill" style="width:${Math.min(p,100)}%"></div></div><span class="progress-percentage">${p.toFixed(0)}%</span></div></div>`;
    };
    const createOnboardingMetricCard = (t, s, v, d, i, id, dt=[]) => { if(id) onboardingDataStore[id]=dt; return `<div class="card" ${id?`onclick="showDetailsModal('${id}','${t}')" style="cursor:pointer"`:''}><h3>${t}</h3><div class="card-content"><div class="metric"><span class="metric-value" style="font-size:2rem">${v}</span></div></div></div>`; };
    const createOnboardingStageCard = (tot, cnt, lst) => { if(!cnt) return ''; const stages=['preGoLive','execucao','inicio','backlog']; stages.forEach(s=>onboardingDataStore[`onb-stage-${s}`]=lst[s]||[]); const h=stages.map(s=>`<div class="metric" onclick="showDetailsModal('onb-stage-${s}','${s}')" style="cursor:pointer"><span class="metric-label">${s}:</span><span class="metric-value">${cnt[s]||0}</span></div>`).join(''); return `<div class="card"><h3>Estágios</h3><div class="card-content">${h}</div></div>`; };
    const createTop5OnboardingCard = (l, o) => { onboardingDataStore['onb-over-120-days']=o; const h = l.map(i=>`<li>${i.Cliente} (${i.onboardingDuration}d)</li>`).join(''); return `<div class="card"><h3>Top 5 Tempo</h3><ul class="onboarding-top5-list">${h}</ul>${o.length?`<button onclick="showDetailsModal('onb-over-120-days','>120 dias')">Ver > 120d</button>`:''}</div>`; };
    const createOnboardingProcessCard = (t, s, p, r, i, id) => `<div class="card"><h3>${t}</h3><div class="card-content"><div class="metric" onclick="showDetailsModal('${id}Previsto','${t} Pen')"><span class="metric-label">Pend:</span><span class="metric-value">${p}</span></div><div class="metric" onclick="showDetailsModal('${id}Realizado','${t} Real')"><span class="metric-label">Real:</span><span class="metric-value success">${r}</span></div></div></div>`;
    const createPrevistoRealizadoCard = (t, p, r, id, g, o, a) => { const tot=r+o+a, prg=tot+p, pc=prg>0?(tot/prg)*100:0; return `<div class="card"><h3>${t}</h3><div class="card-content"><div class="metric" onclick="showDetailsModal('${id}-realizado','${t}')"><span class="metric-label">Real:</span><span class="metric-value success">${r}</span></div><div class="metric" onclick="showDetailsModal('${id}-previsto','${t}')"><span class="metric-label">Pend:</span><span class="metric-value">${p}</span></div></div><div class="progress-bar-container"><div class="progress-bar"><div class="progress-bar-fill" style="width:${Math.min(pc,100)}%"></div></div><span>${pc.toFixed(0)}%</span></div></div>`; };

    // --- LOGIN & HANDLER ---
    function handleWorkerMessage(e) {
        const { type, payload } = e.data;
        if (type === 'INIT_COMPLETE') {
            filterDataCache = payload.filterData; populateFilters();
            if(!currentUser.isManager && currentUser.userGroup==='ongoing') {
                 const selCS = document.getElementById('select-cs');
                 let f = [...filterDataCache.csSet].includes(currentUser.name) ? currentUser.name : manualEmailToCsMap[currentUser.email];
                 if(f) selCS.value = f;
                 if(selCS.value) autoSelectSegment(rawClients.filter(c=>c.CS?.trim()===selCS.value));
            }
            renderDataTables(); applyFilterLocks();
            document.querySelector('.tabs').style.display = 'flex';
            document.getElementById('status-message').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('onboarding-dashboard').style.display = 'block';
            triggerCalculations();
        } else if (type === 'CALCULATION_COMPLETE') {
            dataStore = payload.dataStore; onboardingDataStore = payload.onboardingDataStore;
            renderOKRs(); renderNewOnboardingView(); renderOverdueView(payload.overdueMetrics);
            document.getElementById('status-message').style.display = 'none';
        } else if (type === 'PERIOD_CALCULATION_COMPLETE') renderPeriodView(payload.periodData, payload.periodName);
        else if (type === 'TREND_DATA_COMPLETE') renderTrendChart(payload.labels, payload.dataPoints, payload.title);
        else if (type === 'ERROR') console.error(payload.error);
    }

    window.handleCredentialResponse = function(r) {
        const d = (function(t){try{return JSON.parse(atob(t.split('.')[1]));}catch(e){return null;}})(r.credential);
        if(d) {
            localStorage.setItem('googleUserToken', r.credential);
            const e = d.email.toLowerCase();
            const mgr = ['lorhanska@gmail.com', 'elianeokr@gmail.com', 'juliarail@gmail.com', 'jadecristianettirp@gmail.com'];
            const grp = mgr.includes(e) ? 'admin' : 'ongoing'; // Simplificado
            currentUser = { email: e, name: d.name, userGroup: grp, isManager: grp==='admin', selectedCS: 'Todos', selectedISM: 'Todos' };
            
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('dashboard-wrapper').style.display = 'block';
            window.loadDataFromAPI();
            
            // Init Logic
            const ver = '3.1';
            if(localStorage.getItem('appVersion')!==ver) { localStorage.clear(); localStorage.setItem('appVersion', ver); location.reload(); }
            document.getElementById('app-version-marker').textContent = `v${ver}`;
            if(currentUser.name) { document.getElementById('user-info-text').innerHTML=`<i class="fas fa-user"></i> ${currentUser.name}`; document.getElementById('user-info-card').style.display='flex'; }
            document.getElementById('logout-button').onclick = () => { localStorage.removeItem('googleUserToken'); location.reload(); };
            
            // Events
            ['select-cs','select-month','select-year','select-segmento','include-onboarding-toggle'].forEach(id=>document.getElementById(id).addEventListener('change', triggerCalculations));
            
            // Load Goals
            const g = localStorage.getItem('dashboardOKRsGoals');
            appGoals = g ? JSON.parse(g) : defaultGoals;
        }
    };

    // Auto Login Check
    (function(){
        const t = localStorage.getItem('googleUserToken');
        if(t) window.handleCredentialResponse({credential: t});
    })();

    // Filters Logic (Simplified for space)
    function populateFilters() {
        const { csSet, years } = filterDataCache;
        const sCS = document.getElementById('select-cs'), sY = document.getElementById('select-year'), sM = document.getElementById('select-month');
        sCS.innerHTML = currentUser.isManager ? '<option value="Todos">Todos os CS</option>' : '';
        [...csSet].sort().forEach(c => sCS.add(new Option(c, c)));
        sM.innerHTML = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"].map((m,i)=>`<option value="${i}">${m}</option>`).join('');
        sY.innerHTML = [...years].sort((a,b)=>b-a).map(y=>`<option value="${y}">${y}</option>`).join('');
        sM.value = new Date().getMonth(); sY.value = new Date().getFullYear();
        
        const segs = ["SMB CAD", "SMB Multiprodutos", "MID/Enterprise"];
        const sSeg = document.getElementById('select-segmento'); sSeg.innerHTML='';
        segs.forEach(s => sSeg.add(new Option(s,s)));
    }
    
    function autoSelectSegment(c) {
        let mid=0, smb=0; c.forEach(i => normalizeText(i.Segmento||'').includes('smb') ? smb++ : mid++);
        document.getElementById('select-segmento').value = mid > smb ? 'MID/Enterprise' : 'SMB CAD';
    }
    
    function applyFilterLocks() {
        const sCS = document.getElementById('select-cs');
        if(currentUser.isManager) sCS.disabled = false;
        else sCS.disabled = true;
    }
    
    function triggerCalculations() {
        if(!dataWorker) return;
        const per = document.getElementById('select-period').value;
        const pay = {
            month: parseInt(document.getElementById('select-month').value),
            year: parseInt(document.getElementById('select-year').value),
            selectedCS: document.getElementById('select-cs').value,
            selectedSquad: 'Todos',
            includeOnboarding: document.getElementById('include-onboarding-toggle').checked,
            comparison: document.getElementById('select-comparison').value,
            segmento: document.getElementById('select-segmento').value,
            teamView: 'geral', selectedISM: 'Todos', goals: appGoals
        };
        if(per === 'monthly') dataWorker.postMessage({ type: 'CALCULATE_MONTHLY', payload: pay });
        else dataWorker.postMessage({ type: 'CALCULATE_PERIOD', payload: { ...pay, period: per } });
    }

    </script>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>
