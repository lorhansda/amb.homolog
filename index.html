    <script>
        // Configuração Global
        const ITEMS_PER_PAGE = 10; 
        let currentPage = 1;
        let ordensServico = []; 
        const defaultProducts = [ 
            "WORKNC", "EDGECAM", "ESPRIT", "ALPHACAM", "LANTEK",
            "SOLIDWORKS CAD", "SOLIDWORKS PDM", "SYNECO", "HEXAGON Scanner",
            "Impressora 3D Markforged", "Serviço de Consultoria", "Treinamento Software X", "Outro"
        ];
        let googleUser = null; 
        let savedFilters = {}; // Objeto para armazenar filtros salvos

        // Elementos da DOM 
        const osTableBody = document.getElementById('osTableBody');
        const weeklyAnalysisTableBody = document.getElementById('weeklyAnalysisTableBody');
        const reportsTableBody = document.getElementById('reportsTableBody');
        const osModal = document.getElementById('osModal');
        const osForm = document.getElementById('osForm');
        const modalTitle = document.getElementById('modalTitle');
        const recentActivityList = document.getElementById('recentActivityList');
        const paginationControls = document.getElementById('paginationControls');
        const productDatalist = document.getElementById('productList');
        const filterProductSelect = document.getElementById('filterProduct');
        const reportProductSelect = document.getElementById('reportProduct');
        const selectedMonthInfo = document.getElementById('selectedMonthInfo'); 
        const analysisMonthYearInput = document.getElementById('analysisMonthYearInput'); 
        const googleLoginContainer = document.getElementById('google-login-container');
        const userInfoDiv = document.getElementById('user-info');
        const userPic = document.getElementById('user-pic');
        const userName = document.getElementById('user-name');
        const googleSignInButton = document.querySelector('.g_id_signin');
        const darkModeIcon = document.getElementById('darkModeIcon');
        const savedFiltersSelect = document.getElementById('savedFilters');
        const newFilterNameInput = document.getElementById('newFilterName');
        const filterDescriptionInput = document.getElementById('filterDescription');
        const selectAllOsCheckbox = document.getElementById('selectAllOsCheckbox');
        const bulkActionsContainer = document.getElementById('bulkActionsContainer');
        const selectedOsCountSpan = document.getElementById('selectedOsCount');
        const bulkActionStatusSelect = document.getElementById('bulkActionStatus');


        // Funções Auxiliares de Data
        function formatDateToBR(dateString) {
            if (!dateString) return 'N/A';
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) {
                return dateString;
            }
            const datePart = dateString.toString().split('T')[0];
            const partsYMD = datePart.split('-');
            if (partsYMD.length === 3 && partsYMD[0].length === 4) { 
                return `${partsYMD[2]}/${partsYMD[1]}/${partsYMD[0]}`;
            }
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Data Inválida'; 
            return date.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' }); 
        }
        
        function getWeeksInMonth(year, month) {
            const weeks = [];
            const firstDayOfMonth = new Date(year, month - 1, 1);
            const lastDayOfMonth = new Date(year, month, 0); 

            let currentMonday = new Date(firstDayOfMonth);
            currentMonday.setDate(firstDayOfMonth.getDate() - (firstDayOfMonth.getDay() === 0 ? 6 : firstDayOfMonth.getDay() - 1)); 

            while (currentMonday <= lastDayOfMonth) {
                const weekStart = new Date(currentMonday);
                weekStart.setHours(0, 0, 0, 0);

                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                weekEnd.setHours(23, 59, 59, 999);

                const weekWednesday = new Date(weekStart);
                weekWednesday.setDate(weekStart.getDate() + 2); 
                weekWednesday.setHours(23, 59, 59, 999); 

                const target = new Date(weekStart.valueOf());
                target.setDate(target.getDate() - ((weekStart.getDay() + 6) % 7) + 3);
                const firstThursday = target.valueOf();
                target.setMonth(0, 1);
                if (target.getDay() !== 4) {
                    target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
                }
                const weekNumber = 1 + Math.ceil((firstThursday - target) / 604800000);

                weeks.push({ start: weekStart, end: weekEnd, wednesday: weekWednesday, weekNumber: weekNumber });
                currentMonday.setDate(currentMonday.getDate() + 7); 
            }
            return weeks;
        }

        function getPriorityClass(priority) {
            switch (priority) {
                case 'Alta': return 'priority-Alta';
                case 'Urgente': return 'priority-Urgente';
                case 'Média': return 'priority-Média';
                case 'Baixa': return 'priority-Baixa';
                default: return 'bg-gray-100 text-gray-700 dark:bg-slate-700 dark:text-slate-300'; 
            }
        }

        function generateId() {
            return 'OS' + String(Date.now()).slice(-6) + Math.random().toString(36).substr(2, 3).toUpperCase();
        }

        // Funções de LocalStorage 
        function saveDataToLocalStorage() {
            localStorage.setItem('ordensServicoData_v5_1', JSON.stringify(ordensServico)); 
            localStorage.setItem('googleUser_v5_1', JSON.stringify(googleUser));
            localStorage.setItem('darkMode_v5_1', document.documentElement.classList.contains('dark'));
            localStorage.setItem('savedFilters_v5_1', JSON.stringify(savedFilters));
            addRecentActivity("Dados salvos no LocalStorage.");
        }

        function loadDataFromLocalStorage() {
            const data = localStorage.getItem('ordensServicoData_v5_1'); 
            if (data) {
                ordensServico = JSON.parse(data);
                // addRecentActivity("Dados de OS carregados."); // Removido para não poluir ao carregar
            } else {
                ordensServico = [
                    { id: generateId(), numero: 'OS2505W3-1', cliente: 'Cliente Teste A', produto: 'SOLIDWORKS CAD', descricao: 'Resolver problema de instalação e configuração do SOLIDWORKS Premium na máquina do cliente.', dataAbertura: '2025-05-01', prazoFinal: '2025-05-15', responsavel: 'Carlos Z.', solicitante: 'Ana P.', status: 'Em Andamento', prioridade: 'Alta' }, 
                    { id: generateId(), numero: 'OS2505W3-2', cliente: 'Cliente Teste B', produto: 'EDGECAM', descricao: 'Treinamento de Fresamento 3 Eixos e otimização de percursos para novas peças.', dataAbertura: '2025-05-02', prazoFinal: '2025-05-16', responsavel: 'Beatriz L.', solicitante: 'Mario S.', status: 'Completa', prioridade: 'Média' }, 
                    { id: generateId(), numero: 'OS2505W4-1', cliente: 'Cliente Teste C', produto: 'WORKNC', descricao: 'Verificar licença do WORKNC e auxiliar na criação de um novo projeto complexo.', dataAbertura: '2025-05-10', prazoFinal: '2025-05-22', responsavel: 'Daniel F.', solicitante: 'Julia M.', status: 'Aberta', prioridade: 'Urgente'}, 
                    { id: generateId(), numero: 'OS2504W5-1', cliente: 'Cliente Teste D', produto: 'LANTEK', descricao: 'Suporte para configuração de nesting e importação de arquivos DXF no Lantek Expert.', dataAbertura: '2025-04-20', prazoFinal: '2025-04-30', responsavel: 'Eduardo G.', solicitante: 'Laura C.', status: 'Pendente Informação', prioridade: 'Média'}, 
                ];
                // addRecentActivity("Dados de OS iniciais carregados.");
            }
            const storedUser = localStorage.getItem('googleUser_v5_1');
            if (storedUser) {
                googleUser = JSON.parse(storedUser);
                updateLoginUI();
            }
            const storedDarkMode = localStorage.getItem('darkMode_v5_1');
            if (storedDarkMode === 'true') {
                document.documentElement.classList.add('dark');
                if(darkModeIcon) darkModeIcon.classList.replace('fa-moon', 'fa-sun');
            } else {
                 document.documentElement.classList.remove('dark');
                 if(darkModeIcon) darkModeIcon.classList.replace('fa-sun', 'fa-moon');
            }
            const storedFilters = localStorage.getItem('savedFilters_v5_1');
            if (storedFilters) {
                savedFilters = JSON.parse(storedFilters);
                populateSavedFiltersSelect();
            }
            populateProductFilters(); 
        }

        function populateProductFilters() {
            if(!productDatalist || !filterProductSelect || !reportProductSelect) return;
            const products = [...new Set(ordensServico.map(os => os.produto).concat(defaultProducts)
                                            .filter(p => p && p.trim() !== ""))]
                                            .sort();
            
            productDatalist.innerHTML = '';
            filterProductSelect.innerHTML = '<option value="">Todos os Produtos</option>'; 
            reportProductSelect.innerHTML = '<option value="">Todos os Produtos</option>'; 

            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                productDatalist.appendChild(option.cloneNode(true)); 
                filterProductSelect.appendChild(option.cloneNode(true)); 
                reportProductSelect.appendChild(option.cloneNode(true)); 
            });
        }

        function addRecentActivity(action) {
            if (!recentActivityList) return;
            const listItem = document.createElement('li');
            const now = new Date();
            listItem.className = 'flex justify-between items-center text-sm pb-2 border-b border-gray-200 dark:border-slate-700'; 
            listItem.innerHTML = `
                <span>${action}</span>
                <span class="text-gray-400 dark:text-slate-500 text-xs">${now.toLocaleTimeString('pt-BR')}</span>
            `;
            const firstChild = recentActivityList.firstChild;
            if (firstChild && firstChild.nodeType === Node.ELEMENT_NODE && firstChild.textContent.trim() === 'Nenhuma atividade recente.') {
                 recentActivityList.innerHTML = '';
            }

            recentActivityList.insertBefore(listItem, recentActivityList.firstChild); 
            if (recentActivityList.children.length > 7) { 
                recentActivityList.removeChild(recentActivityList.lastChild);
            }
        }

        // Funções de Login com Google
        function parseJwt (token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return null;
            }
        }

        function handleCredentialResponse(response) {
            const responsePayload = parseJwt(response.credential);
            googleUser = {
                id: responsePayload.sub,
                name: responsePayload.name,
                given_name: responsePayload.given_name,
                picture: responsePayload.picture,
                email: responsePayload.email
            };
            saveDataToLocalStorage();
            updateLoginUI();
            addRecentActivity(`Usuário ${googleUser.name} logado.`);
        }

        function handleSignOut() {
            googleUser = null;
            saveDataToLocalStorage(); 
            updateLoginUI();
            addRecentActivity("Usuário deslogado.");
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                google.accounts.id.disableAutoSelect();
            }
        }

        function updateLoginUI() {
            if (!userInfoDiv || !googleSignInButton || !userName || !userPic) return;
            if (googleUser) {
                userName.textContent = googleUser.given_name || googleUser.name;
                userPic.src = googleUser.picture;
                userInfoDiv.classList.remove('hidden');
                googleSignInButton.classList.add('hidden');
            } else {
                userInfoDiv.classList.add('hidden');
                googleSignInButton.classList.remove('hidden');
                userName.textContent = '';
                userPic.src = '';
            }
        }

        // Modo Escuro
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            if (darkModeIcon) {
                if (document.documentElement.classList.contains('dark')) {
                    darkModeIcon.classList.replace('fa-moon', 'fa-sun');
                } else {
                    darkModeIcon.classList.replace('fa-sun', 'fa-moon');
                }
            }
            saveDataToLocalStorage(); 
            renderOSStatusChart(); 
        }

        // Filtros Salvos
        function saveCurrentFilters() {
            if (!newFilterNameInput || !savedFiltersSelect) return;
            const name = newFilterNameInput.value.trim();
            if (!name) {
                alert("Por favor, dê um nome para o filtro.");
                return;
            }
            if (savedFilters[name]) {
                if (!confirm(`Já existe um filtro com o nome "${name}". Deseja sobrescrevê-lo?`)) {
                    return;
                }
            }
            savedFilters[name] = {
                numero: document.getElementById('filterOsNumber').value,
                cliente: document.getElementById('filterClient').value,
                descricao: filterDescriptionInput ? filterDescriptionInput.value : "",
                produto: filterProductSelect.value,
                status: document.getElementById('filterStatus').value
            };
            newFilterNameInput.value = '';
            populateSavedFiltersSelect();
            saveDataToLocalStorage();
            addRecentActivity(`Filtro "${name}" salvo.`);
        }

        function populateSavedFiltersSelect() {
            if (!savedFiltersSelect) return;
            savedFiltersSelect.innerHTML = '<option value="">Carregar filtro...</option>';
            for (const name in savedFilters) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                savedFiltersSelect.appendChild(option);
            }
        }

        function loadSelectedFilter() {
            if (!savedFiltersSelect) return;
            const name = savedFiltersSelect.value;
            if (name && savedFilters[name]) {
                document.getElementById('filterOsNumber').value = savedFilters[name].numero;
                document.getElementById('filterClient').value = savedFilters[name].cliente;
                if(filterDescriptionInput) filterDescriptionInput.value = savedFilters[name].descricao || "";
                filterProductSelect.value = savedFilters[name].produto;
                document.getElementById('filterStatus').value = savedFilters[name].status;
                applyFiltersAndRender();
                addRecentActivity(`Filtro "${name}" carregado.`);
            } else if (name) {
                alert("Filtro selecionado não encontrado.");
            }
        }

        function deleteSavedFilter() {
            if (!savedFiltersSelect) return;
            const name = savedFiltersSelect.value;
            if (name && savedFilters[name]) {
                if (confirm(`Tem certeza que deseja excluir o filtro salvo "${name}"?`)) {
                    delete savedFilters[name];
                    populateSavedFiltersSelect();
                    saveDataToLocalStorage();
                    addRecentActivity(`Filtro "${name}" excluído.`);
                }
            } else if (name) { // Mudança aqui: só alerta se um nome foi selecionado mas não encontrado.
                alert("Nenhum filtro salvo selecionado para excluir ou filtro inválido.");
            } else { // Se nenhum filtro estiver selecionado (value === "")
                 alert("Por favor, selecione um filtro salvo para excluir.");
            }
        }

        // Ações em Massa
        function updateSelectedCount() {
            if(!selectedOsCountSpan || !bulkActionsContainer || !osTableBody) return;
            const selectedCheckboxes = Array.from(osTableBody.querySelectorAll('input[type="checkbox"][data-id]:checked'));
            selectedOsCountSpan.textContent = `${selectedCheckboxes.length} selecionadas`;
            if (selectedCheckboxes.length > 0) {
                bulkActionsContainer.classList.remove('hidden');
            } else {
                bulkActionsContainer.classList.add('hidden');
                if(selectAllOsCheckbox) selectAllOsCheckbox.checked = false;
            }
        }

        function toggleSelectAllOS(masterCheckbox) {
            if(!osTableBody) return;
            const checkboxes = osTableBody.querySelectorAll('input[type="checkbox"][data-id]'); // Apenas checkboxes de OS
            checkboxes.forEach(checkbox => checkbox.checked = masterCheckbox.checked);
            updateSelectedCount();
        }

        function applyBulkAction() {
            if(!bulkActionStatusSelect || !osTableBody) return;
            const newStatus = bulkActionStatusSelect.value;
            if (!newStatus) {
                alert("Por favor, selecione um status para aplicar.");
                return;
            }
            const selectedCheckboxes = Array.from(osTableBody.querySelectorAll('input[type="checkbox"][data-id]:checked'));
            if (selectedCheckboxes.length === 0) {
                alert("Nenhuma OS selecionada.");
                return;
            }

            selectedCheckboxes.forEach(checkbox => {
                const osId = checkbox.dataset.id;
                const osIndex = ordensServico.findIndex(os => os.id === osId);
                if (osIndex !== -1) {
                    ordensServico[osIndex].status = newStatus;
                }
            });
            addRecentActivity(`${selectedCheckboxes.length} OSs tiveram status alterado para ${newStatus}.`);
            saveDataToLocalStorage();
            refreshAllViews();
            if(selectAllOsCheckbox) selectAllOsCheckbox.checked = false; 
            updateSelectedCount(); 
        }

        function bulkDeleteSelectedOS() {
            if(!osTableBody) return;
            const selectedCheckboxes = Array.from(osTableBody.querySelectorAll('input[type="checkbox"][data-id]:checked'));
            if (selectedCheckboxes.length === 0) {
                alert("Nenhuma OS selecionada para excluir.");
                return;
            }
            if (confirm(`Tem certeza que deseja excluir ${selectedCheckboxes.length} OS(s) selecionada(s)? Esta ação não pode ser desfeita.`)) {
                const idsToDelete = selectedCheckboxes.map(cb => cb.dataset.id);
                ordensServico = ordensServico.filter(os => !idsToDelete.includes(os.id));
                addRecentActivity(`${idsToDelete.length} OS(s) excluída(s) em massa.`);
                saveDataToLocalStorage();
                if (currentPage > 1 && paginateData(getFilteredOS(), currentPage, ITEMS_PER_PAGE).length === 0) {
                    currentPage--;
                }
                refreshAllViews();
                if(selectAllOsCheckbox) selectAllOsCheckbox.checked = false;
                updateSelectedCount();
            }
        }


        // --- Restante do JavaScript (CRUD, Tabelas, Dashboard, etc.) ---

        function renderOSTable(filteredData = getFilteredOS()) {
            if (!osTableBody) return;
            osTableBody.innerHTML = ''; 
            if(selectAllOsCheckbox) selectAllOsCheckbox.checked = false; 
            updateSelectedCount(); 

            if (filteredData.length === 0) {
                osTableBody.innerHTML = '<tr><td colspan="12" class="text-center py-10 text-gray-500 dark:text-gray-400">Nenhuma ordem de serviço encontrada.</td></tr>';
                renderPagination(0, 0); 
                return;
            }

            const paginatedData = paginateData(filteredData, currentPage, ITEMS_PER_PAGE); 

            paginatedData.forEach(os => { 
                const row = osTableBody.insertRow();
                row.className = 'table-row hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors duration-150'; 
                row.innerHTML = `
                    <td class="py-3 px-2 text-center checkbox-cell"><input type="checkbox" data-id="${os.id}" onchange="updateSelectedCount()" class="form-checkbox h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500 dark:focus:ring-teal-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"></td>
                    <td class="py-3 px-4 text-sm font-medium">${os.numero}</td>
                    <td class="py-3 px-4 text-sm">${os.cliente}</td>
                    <td class="py-3 px-4 text-sm">${os.produto || 'N/A'}</td>
                    <td class="py-3 px-4 text-sm truncate max-w-xs" title="${os.descricao}">${os.descricao}</td>
                    <td class="py-3 px-4 text-sm whitespace-nowrap">${formatDateToBR(os.dataAbertura)}</td>
                    <td class="py-3 px-4 text-sm whitespace-nowrap">${formatDateToBR(os.prazoFinal)}</td>
                    <td class="py-3 px-4 text-sm">${os.responsavel}</td>
                    <td class="py-3 px-4 text-sm">${os.solicitante || 'N/A'}</td>
                    <td class="py-3 px-4 text-sm">
                        <select class="select-field status-select p-1 rounded-md text-xs" data-id="${os.id}" onchange="updateStatus(this)">
                            <option value="Aberta" ${os.status === 'Aberta' ? 'selected' : ''}>Aberta</option>
                            <option value="Em Andamento" ${os.status === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option>
                            <option value="Pendente Informação" ${os.status === 'Pendente Informação' ? 'selected' : ''}>Pendente Info</option>
                            <option value="Aguardando Aprovação" ${os.status === 'Aguardando Aprovação' ? 'selected' : ''}>Aguard. Aprov.</option>
                            <option value="Completa" ${os.status === 'Completa' ? 'selected' : ''}>Completa</option>
                            <option value="Cancelada" ${os.status === 'Cancelada' ? 'selected' : ''}>Cancelada</option>
                        </select>
                    </td>
                    <td class="py-3 px-4 text-sm">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${getPriorityClass(os.prioridade)}">${os.prioridade}</span>
                    </td>
                    <td class="py-3 px-4 text-sm whitespace-nowrap">
                        <button class="text-blue-600 hover:text-blue-800 dark:text-sky-400 dark:hover:text-sky-300 mr-2 p-1" title="Editar" onclick="editOS('${os.id}')"><i class="fas fa-edit"></i></button>
                        <button class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 mr-2 p-1" title="Excluir" onclick="deleteOS('${os.id}')"><i class="fas fa-trash"></i></button>
                        <button class="text-green-600 hover:text-green-800 dark:text-emerald-400 dark:hover:text-emerald-300 p-1" title="Baixar .ics do Calendário" onclick="downloadICS('${os.id}')"><i class="fas fa-calendar-plus"></i></button>
                    </td>
                `;
            });
            renderPagination(filteredData.length, currentPage); 
        }

        function paginateData(data, page, itemsPerPage) {
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            return data.slice(start, end);
        }

        function renderPagination(totalItems, page) {
            if (!paginationControls) return;
            paginationControls.innerHTML = ''; 
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

            if (totalPages <= 1) return; 

            const prevButton = document.createElement('button');
            prevButton.innerHTML = '<i class="fas fa-chevron-left"></i> Anterior';
            prevButton.className = 'btn btn-sm btn-secondary disabled:opacity-50';
            prevButton.disabled = page === 1;
            prevButton.onclick = () => { if (page > 1) changePage(page - 1); };
            paginationControls.appendChild(prevButton);

            const pageInfo = document.createElement('span');
            pageInfo.className = 'text-sm px-3';
            pageInfo.textContent = `Página ${page} de ${totalPages}`;
            paginationControls.appendChild(pageInfo);

            const nextButton = document.createElement('button');
            nextButton.innerHTML = 'Próximo <i class="fas fa-chevron-right"></i>';
            nextButton.className = 'btn btn-sm btn-secondary disabled:opacity-50';
            nextButton.disabled = page === totalPages;
            nextButton.onclick = () => { if (page < totalPages) changePage(page + 1); };
            paginationControls.appendChild(nextButton);
        }

        function changePage(newPage) {
            currentPage = newPage;
            renderOSTable(); 
        }

        function updateStatus(selectElement) {
            const osId = selectElement.dataset.id; 
            const newStatus = selectElement.value; 
            const osIndex = ordensServico.findIndex(os => os.id === osId);
            if (osIndex !== -1) {
                ordensServico[osIndex].status = newStatus;
                addRecentActivity(`Status da OS ${ordensServico[osIndex].numero} alterado para ${newStatus}.`);
                saveDataToLocalStorage(); 
                refreshAllViews(); 
            }
        }

        function openAddOSModal() {
            if (!osForm || !modalTitle || !osModal) return;
            osForm.reset(); 
            document.getElementById('osId').value = ''; 
            modalTitle.textContent = 'Adicionar Nova Ordem de Serviço';
            document.getElementById('osDataAberturaModal').value = new Date().toISOString().split('T')[0]; 
            osModal.style.display = 'block'; 
        }

        function closeOSModal() {
            if (!osModal) return;
            osModal.style.display = 'none'; 
        }

        function editOS(id) {
            if (!osModal || !modalTitle) return;
            const os = ordensServico.find(o => o.id === id); 
            if (os) {
                modalTitle.textContent = `Editar Ordem de Serviço - ${os.numero}`;
                document.getElementById('osId').value = os.id;
                document.getElementById('osNumeroModal').value = os.numero;
                document.getElementById('osClienteModal').value = os.cliente;
                document.getElementById('osProdutoModal').value = os.produto || '';
                document.getElementById('osSolicitanteModal').value = os.solicitante || '';
                document.getElementById('osDescricaoModal').value = os.descricao;
                document.getElementById('osDataAberturaModal').value = os.dataAbertura; 
                document.getElementById('osPrazoFinalModal').value = os.prazoFinal;   
                document.getElementById('osResponsavelModal').value = os.responsavel;
                document.getElementById('osStatusModal').value = os.status;
                document.getElementById('osPrioridadeModal').value = os.prioridade;
                osModal.style.display = 'block'; 
            }
        }

        function deleteOS(id) {
            const osToDelete = ordensServico.find(os => os.id === id);
            if (confirm(`Tem certeza que deseja excluir a OS ${osToDelete?.numero || id}? Esta ação não pode ser desfeita.`)) {
                ordensServico = ordensServico.filter(os => os.id !== id); 
                addRecentActivity(`OS ${osToDelete?.numero || id} excluída.`);
                saveDataToLocalStorage(); 
                if (currentPage > 1 && paginateData(getFilteredOS(), currentPage, ITEMS_PER_PAGE).length === 0) {
                    currentPage--;
                }
                refreshAllViews(); 
            }
        }

        if (osForm) {
            osForm.addEventListener('submit', function(event) {
                event.preventDefault(); 
                const id = document.getElementById('osId').value; 
                const osData = {
                    numero: document.getElementById('osNumeroModal').value,
                    cliente: document.getElementById('osClienteModal').value,
                    produto: document.getElementById('osProdutoModal').value,
                    solicitante: document.getElementById('osSolicitanteModal').value,
                    descricao: document.getElementById('osDescricaoModal').value,
                    dataAbertura: document.getElementById('osDataAberturaModal').value,
                    prazoFinal: document.getElementById('osPrazoFinalModal').value,
                    responsavel: document.getElementById('osResponsavelModal').value,
                    status: document.getElementById('osStatusModal').value, 
                    prioridade: document.getElementById('osPrioridadeModal').value, 
                };

                if (id) { 
                    const osIndex = ordensServico.findIndex(o => o.id === id);
                    if (osIndex !== -1) {
                        ordensServico[osIndex] = { ...ordensServico[osIndex], ...osData }; 
                        addRecentActivity(`OS ${osData.numero} editada.`);
                    }
                } else { 
                    osData.id = generateId(); 
                    ordensServico.unshift(osData); 
                    addRecentActivity(`Nova OS ${osData.numero} adicionada.`);
                }
                saveDataToLocalStorage(); 
                populateProductFilters(); 
                refreshAllViews(); 
                closeOSModal(); 
                currentPage = 1; 
                renderOSTable(); 
            });
        }

        function showView(viewId, clickedElement) {
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.add('hidden');
            });
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
            } else {
                console.error(`View com ID '${viewId}' não encontrada.`);
                return; 
            }

            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            if (clickedElement && typeof clickedElement.classList !== 'undefined' && clickedElement.classList.contains('sidebar-item')) {
                clickedElement.classList.add('active');
            }
            
            if (viewId === 'weeklyAnalysisView') {
                setDefaultAnalysisMonth(); 
                renderMonthlyAnalysisByWeek();
            }
        }

        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        const sidebarTitleDiv = document.getElementById('sidebar-title');

        if (toggleSidebarBtn && sidebar && mainContent && sidebarTitleDiv) { 
            toggleSidebarBtn.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('collapsed');
                const isCollapsed = sidebar.classList.contains('collapsed');
                toggleSidebarBtn.innerHTML = isCollapsed ? '<i class="fas fa-chevron-right text-lg"></i>' : '<i class="fas fa-bars text-lg"></i>'; 
                if (sidebarTitleDiv.querySelector('span')) { 
                    sidebarTitleDiv.querySelector('span').style.display = isCollapsed ? 'none' : 'inline'; 
                }
                if (sidebarTitleDiv.querySelector('i')) { 
                     sidebarTitleDiv.querySelector('i').style.marginRight = isCollapsed ? '0' : '0.5rem'; 
                }
            });
        }

        if (analysisMonthYearInput) { 
            analysisMonthYearInput.addEventListener('change', renderMonthlyAnalysisByWeek); 
        }
        
        function renderMonthlyAnalysisByWeek() {
            if (!weeklyAnalysisTableBody || !analysisMonthYearInput || !selectedMonthInfo) { 
                console.error("Elementos da Análise Semanal/Mensal não encontrados no DOM.");
                return;
            }
            weeklyAnalysisTableBody.innerHTML = ''; 
            const monthYearValue = analysisMonthYearInput.value; 
            
            if (!monthYearValue) {
                selectedMonthInfo.textContent = 'Por favor, selecione um mês/ano para análise.';
                weeklyAnalysisTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-10 text-gray-500 dark:text-gray-400">Selecione um mês/ano.</td></tr>`;
                return;
            }

            const [year, month] = monthYearValue.split('-').map(Number);
            const monthName = new Date(year, month - 1, 1).toLocaleString('pt-BR', { month: 'long' });
            selectedMonthInfo.textContent = `Analisando pendências para ${monthName} de ${year}. Pendências são OSs não 'Completas' após a Quarta-Feira da respectiva semana do prazo.`;
            
            const weeksInSelectedMonth = getWeeksInMonth(year, month);
            let allPendingOS = [];

            weeksInSelectedMonth.forEach(week => {
                const { start: weekStart, end: weekEnd, wednesday: weekWednesday, weekNumber } = week;
                const today = new Date();
                const hasWednesdayOfOSWeekPassed = today > weekWednesday || today > weekEnd;


                const osInThisWeek = ordensServico.filter(os => {
                    const prazoFinalDate = new Date(os.prazoFinal + 'T23:59:59');
                    const isPrazoInThisSpecificWeek = prazoFinalDate >= weekStart && prazoFinalDate <= weekEnd;
                    if (!isPrazoInThisSpecificWeek) return false;

                    const isNotCompleteOrCancelled = os.status !== 'Completa' && os.status !== 'Cancelada';
                    if (!isNotCompleteOrCancelled) return false;
                    
                    return hasWednesdayOfOSWeekPassed;
                });
                
                osInThisWeek.forEach(os => allPendingOS.push({...os, weekNumberForAnalysis: weekNumber}));
            });


            if (allPendingOS.length === 0) {
                weeklyAnalysisTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-10 text-gray-500 dark:text-gray-400">Nenhuma OS pendente encontrada para o mês selecionado conforme os critérios.</td></tr>`;
                return;
            }

            allPendingOS.sort((a, b) => { 
                if (a.weekNumberForAnalysis !== b.weekNumberForAnalysis) {
                    return a.weekNumberForAnalysis - b.weekNumberForAnalysis;
                }
                return new Date(a.prazoFinal) - new Date(b.prazoFinal);
            }); 

            allPendingOS.forEach(os => {
                const row = weeklyAnalysisTableBody.insertRow();
                row.className = 'table-row hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors duration-150';
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm text-gray-500 dark:text-gray-400">Semana ${os.weekNumberForAnalysis}</td>
                    <td class="py-3 px-4 text-sm font-medium">${os.numero}</td>
                    <td class="py-3 px-4 text-sm">${os.cliente}</td>
                    <td class="py-3 px-4 text-sm">${os.produto || 'N/A'}</td>
                    <td class="py-3 px-4 text-sm whitespace-nowrap">${formatDateToBR(os.prazoFinal)}</td>
                    <td class="py-3 px-4 text-sm">${os.status}</td>
                    <td class="py-3 px-4 text-sm">${os.responsavel}</td>
                    <td class="py-3 px-4 text-sm text-red-600">Não 'Completa' após Quarta-feira da semana do prazo.</td>
                    <td class="py-3 px-4 text-sm whitespace-nowrap">
                        <button class="btn btn-sm bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 mr-1 rounded" onclick="editOS('${os.id}')" title="Ver/Editar OS"><i class="fas fa-edit"></i> Detalhes</button>
                        <button class="btn btn-sm bg-yellow-400 hover:bg-yellow-500 text-black py-1 px-2 rounded" onclick="notifyCollaborator('${os.responsavel}', '${os.numero}')" title="Notificar Colaborador (Simulação)"><i class="fas fa-bell"></i> Notificar</button>
                    </td>
                `;
            });
        }
        
        function sendWeeklyReportAndGeneratePDF() {
            if (!analysisMonthYearInput) {
                alert("Elemento de seleção de mês não encontrado.");
                return;
            }
            const monthYearValue = analysisMonthYearInput.value;
            if (!monthYearValue) {
                alert("Por favor, selecione um mês/ano para gerar o relatório de pendências.");
                return;
            }
            const [year, month] = monthYearValue.split('-').map(Number);
            const monthName = new Date(year, month - 1, 1).toLocaleString('pt-BR', { month: 'long' });
            const title = `Relatório de Pendências Mensal - ${monthName} de ${year}`;
            
            exportTableToPDF('weeklyAnalysisTable', title, 'weeklyAnalysisTableBody', true); 
            addRecentActivity("PDF do relatório mensal de pendências gerado.");
            alert(`PDF "${title}" gerado.\n\nEste arquivo está pronto para ser salvo e anexado ao seu e-mail no Outlook para envio aos responsáveis.`);
        }

        function notifyCollaborator(responsavel, osNumero) {
            alert(`Simulação: Notificação para ${responsavel} sobre pendências na OS ${osNumero} seria preparada aqui para envio.`);
            addRecentActivity(`Notificação (simulada) para ${responsavel} (OS ${osNumero}).`);
        }

        const filterOsNumEl = document.getElementById('filterOsNumber');
        if (filterOsNumEl) filterOsNumEl.addEventListener('input', applyFiltersAndRender);
        const filterClientEl = document.getElementById('filterClient');
        if (filterClientEl) filterClientEl.addEventListener('input', applyFiltersAndRender);
        const filterStatusEl = document.getElementById('filterStatus');
        if (filterStatusEl) filterStatusEl.addEventListener('change', applyFiltersAndRender);
        const filterProductEl = document.getElementById('filterProduct');
        if (filterProductEl) filterProductEl.addEventListener('change', applyFiltersAndRender);
        if (filterDescriptionInput) filterDescriptionInput.addEventListener('input', applyFiltersAndRender);


        function getFilteredOS() {
            const filterOsNumberValue = filterOsNumEl ? filterOsNumEl.value.toLowerCase() : "";
            const filterClientValue = filterClientEl ? filterClientEl.value.toLowerCase() : "";
            const filterStatusValue = filterStatusEl ? filterStatusEl.value : "";
            const filterProductValue = filterProductEl ? filterProductEl.value : "";
            const filterDescriptionValue = filterDescriptionInput ? filterDescriptionInput.value.toLowerCase() : "";

            return ordensServico.filter(os => {
                const matchesOsNumber = os.numero.toLowerCase().includes(filterOsNumberValue);
                const matchesClient = os.cliente.toLowerCase().includes(filterClientValue);
                const matchesStatus = filterStatusValue ? os.status === filterStatusValue : true;
                const matchesProduct = filterProductValue ? os.produto === filterProductValue : true;
                const matchesDescription = os.descricao.toLowerCase().includes(filterDescriptionValue);
                return matchesOsNumber && matchesClient && matchesStatus && matchesProduct && matchesDescription;
            });
        }
        function applyFiltersAndRender() {
            currentPage = 1; 
            renderOSTable();
        }

        let osStatusChartInstance = null; 
        function updateDashboardCounts() {
            const osAbertasEl = document.getElementById('osAbertasCount');
            const osCompletasMesEl = document.getElementById('osCompletasMesCount');
            const osPendentesEl = document.getElementById('osPendentesCount');
            const osCanceladasEl = document.getElementById('osCanceladasCount');

            if (osAbertasEl) osAbertasEl.textContent = ordensServico.filter(os => os.status === 'Aberta').length;
            
            const hoje = new Date();
            if (osCompletasMesEl) osCompletasMesEl.textContent = ordensServico.filter(os => {
                if (os.status !== 'Completa') return false;
                const prazo = new Date(os.prazoFinal + 'T23:59:59');
                return prazo.getMonth() === hoje.getMonth() && prazo.getFullYear() === hoje.getFullYear();
            }).length;

            if (osPendentesEl) osPendentesEl.textContent = ordensServico.filter(os => os.status === 'Pendente Informação' || os.status === 'Aguardando Aprovação').length;
            if (osCanceladasEl) osCanceladasEl.textContent = ordensServico.filter(os => os.status === 'Cancelada').length;
            
            renderOSStatusChart(); 
        }

        function renderOSStatusChart() {
            const chartContainer = document.getElementById('osStatusChartContainer');
            const chartCanvas = document.getElementById('osStatusChart');
            if (!chartContainer || !chartCanvas) {
                return;
            }
            const ctx = chartCanvas.getContext('2d');
            const isDarkMode = document.documentElement.classList.contains('dark');

            const statusCounts = ordensServico.reduce((acc, os) => { 
                acc[os.status] = (acc[os.status] || 0) + 1;
                return acc;
            }, {});

            const data = {
                labels: Object.keys(statusCounts),
                datasets: [{
                    label: 'OS por Status', data: Object.values(statusCounts),
                    backgroundColor: ['rgba(54, 162, 235, 0.8)','rgba(255, 159, 64, 0.8)','rgba(255, 205, 86, 0.8)','rgba(153, 102, 255, 0.8)','rgba(75, 192, 192, 0.8)','rgba(255, 99, 132, 0.8)'],
                    borderColor: isDarkMode ? '#0f172a' : '#fff', 
                    borderWidth: 2, hoverOffset: 4
                }]
            };
            if (osStatusChartInstance) osStatusChartInstance.destroy(); 
            osStatusChartInstance = new Chart(ctx, { type: 'doughnut', data: data, options: { responsive: true, maintainAspectRatio: false, animation: { animateScale: true, animateRotate: true }, plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { size: 11 }, color: isDarkMode ? '#e2e8f0' : '#334155'}}, tooltip: { बॉडीFontColor: isDarkMode ? '#e2e8f0' : '#334155', titleFontColor: isDarkMode ? '#e2e8f0' : '#334155', callbacks: { label: function(c) { return `${c.label || ''}: ${c.parsed || 0}`; }}}}}});
        }

        const reportMonthYearEl = document.getElementById('reportMonthYear');
        const reportStatusEl = document.getElementById('reportStatus');
        const reportProductEl = document.getElementById('reportProduct');

        if(reportMonthYearEl) reportMonthYearEl.addEventListener('change', () => { if(reportsTableBody) reportsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-10 text-gray-500 dark:text-gray-400">Clique em "Gerar Relatório" para atualizar.</td></tr>';});
        if(reportStatusEl) reportStatusEl.addEventListener('change', () => { if(reportsTableBody) reportsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-10 text-gray-500 dark:text-gray-400">Clique em "Gerar Relatório" para atualizar.</td></tr>';});
        if(reportProductEl) reportProductEl.addEventListener('change', () => { if(reportsTableBody) reportsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-10 text-gray-500 dark:text-gray-400">Clique em "Gerar Relatório" para atualizar.</td></tr>';});

        function generateCustomReport() {
            if(!reportsTableBody || !reportMonthYearEl || !reportStatusEl || !reportProductEl) {
                return;
            }
            reportsTableBody.innerHTML = ''; 
            const monthYearValue = reportMonthYearEl.value;
            const statusValue = reportStatusEl.value;
            const productValue = reportProductEl.value;
            let [year, month] = [null, null]; if (monthYearValue) [year, month] = monthYearValue.split('-').map(Number);

            const filteredReportData = ordensServico.filter(os => {
                let matchesDate = true;
                if (year && month) {
                    const prazoFinalDate = new Date(os.prazoFinal + 'T23:59:59');
                    matchesDate = prazoFinalDate.getFullYear() === year && (prazoFinalDate.getMonth() + 1) === month;
                }
                const matchesStatus = statusValue ? os.status === statusValue : true;
                const matchesProduct = productValue ? os.produto === productValue : true;
                return matchesDate && matchesStatus && matchesProduct;
            });

            if (filteredReportData.length === 0) { reportsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-10 text-gray-500 dark:text-gray-400">Nenhuma OS encontrada para os filtros selecionados.</td></tr>'; return; }
            filteredReportData.forEach(os => {
                const row = reportsTableBody.insertRow(); row.className = 'table-row hover:bg-gray-100 dark:hover:bg-slate-700';
                row.innerHTML = `<td class="py-3 px-4 text-sm font-medium">${os.numero}</td><td class="py-3 px-4 text-sm">${os.cliente}</td><td class="py-3 px-4 text-sm">${os.produto||'N/A'}</td><td class="py-3 px-4 text-sm whitespace-nowrap">${formatDateToBR(os.prazoFinal)}</td><td class="py-3 px-4 text-sm">${os.status}</td><td class="py-3 px-4 text-sm">${os.responsavel}</td>`;
            });
            addRecentActivity("Relatório personalizado gerado.");
        }

        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId); if (!table) { alert("Tabela não encontrada para exportação CSV."); return; }
            let csv = [];
            table.querySelectorAll("tr").forEach(row => {
                const rowData = [];
                const headerCells = table.querySelectorAll("thead th");
                row.querySelectorAll("th, td").forEach((cell, cellIndex) => {
                    if (headerCells[cellIndex] && (headerCells[cellIndex].innerText.toUpperCase().includes("AÇÕES") || headerCells[cellIndex].innerText.toUpperCase().includes("AÇÃO SUGERIDA") || cell.querySelector('input[type="checkbox"]'))) { 
                        return; 
                    }
                    if (cell.querySelector('select')) rowData.push(cell.querySelector('select').value);
                    else rowData.push(`"${cell.innerText.replace(/(\r\n|\n|\r)/gm, " ").replace(/"/g, '""')}"`);
                });
                if(rowData.length > 0) csv.push(rowData.join(","));
            });
            const csvFile = new Blob([csv.join("\n")], { type: "text/csv;charset=utf-8;" });
            const downloadLink = document.createElement("a");
            downloadLink.href = URL.createObjectURL(csvFile);
            downloadLink.download = filename;
            downloadLink.style.display = "none"; document.body.appendChild(downloadLink);
            downloadLink.click(); document.body.removeChild(downloadLink);
            addRecentActivity(`Tabela ${tableId} exportada para CSV.`);
        }

        function exportTableToPDF(tableId, title, tableBodyId, isWeeklyReport = false) {
            const { jsPDF } = window.jspdf; 
            if (typeof jsPDF === 'undefined' || typeof jsPDF.API === 'undefined' || typeof jsPDF.API.autoTable === 'undefined') {
                alert("A biblioteca jsPDF ou o plugin autoTable não foram carregados corretamente.");
                console.error("jsPDF ou jsPDF.autoTable não está definido."); return;
            }
            const table = document.getElementById(tableId); if (!table) { alert("Tabela não encontrada para exportação PDF."); return; }

            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
            const head = []; const body = [];
            const isDarkMode = document.documentElement.classList.contains('dark');

            const headerCells = table.querySelectorAll("thead th");
            const headerRow = [];
            headerCells.forEach(cell => { 
                if (!cell.innerText.toUpperCase().includes("AÇÕES") && !(isWeeklyReport && cell.innerText.toUpperCase().includes("AÇÃO SUGERIDA")) && !cell.querySelector('input[type="checkbox"]')) {
                    headerRow.push(cell.innerText);
                }
            });
            head.push(headerRow);

            const targetTableBody = document.getElementById(tableBodyId);
            if (!targetTableBody) {
                alert(`Corpo da tabela com ID '${tableBodyId}' não encontrado.`);
                return;
            }
            const bodyRows = targetTableBody.querySelectorAll("tr");
            bodyRows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll("td");
                let cellOffset = 0; 
                if (tableId === 'osTable' && cells[0] && cells[0].querySelector('input[type="checkbox"]')) {
                    cellOffset = 1;
                }

                for(let i = cellOffset; i < cells.length; i++) {
                    const cell = cells[i];
                    if (rowData.length < headerRow.length) { 
                         if (cell.querySelector('select')) rowData.push(cell.querySelector('select').value);
                         else rowData.push(cell.innerText);
                    }
                }
                if (rowData.length > 0) body.push(rowData);
            });

            if (body.length === 0 && (!bodyRows.length || (bodyRows[0] && bodyRows[0].textContent.toLowerCase().includes("nenhuma")))) {
                 alert("Não há dados na tabela para exportar para PDF."); return;
            }

            doc.autoTable({ 
                head: head, body: body, startY: 60, 
                headStyles: { fillColor: isDarkMode ? [30, 41, 59] : [44, 62, 80], fontSize: 8, textColor: 255 }, 
                bodyStyles: { fontSize: 7, textColor: isDarkMode ? [203, 213, 225] : [44, 62, 80] }, 
                alternateRowStyles: { fillColor: isDarkMode ? [15, 23, 42, 0.5] : [243, 244, 246] }, 
                margin: { top: 50, right: 20, bottom: 30, left: 20 }, 
                didDrawPage: function (data) { 
                    doc.setFontSize(16); doc.setTextColor(isDarkMode ? 226 : 40); doc.text(title, data.settings.margin.left, 35); 
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.setFontSize(8); doc.text("Página " + doc.internal.getCurrentPageInfo().pageNumber + " de " + pageCount, data.settings.margin.left, doc.internal.pageSize.height - 15); 
                }
            });
            doc.save(`${title.replace(/[\s/:]+/g, '_').toLowerCase()}.pdf`); 
        }

        function refreshAllViews() {
            renderOSTable(getFilteredOS()); 
            updateDashboardCounts(); 
            if (document.getElementById('weeklyAnalysisView') && !document.getElementById('weeklyAnalysisView').classList.contains('hidden')) {
                 renderMonthlyAnalysisByWeek(); 
            }
            if (document.getElementById('reportsView') && !document.getElementById('reportsView').classList.contains('hidden')) {
                generateCustomReport(); 
            }
        }
        
        function setDefaultAnalysisMonth() {
            if (!analysisMonthYearInput) return; 
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); 
            analysisMonthYearInput.value = `${year}-${month}`;
        }

        function downloadICS(osId) {
            const os = ordensServico.find(o => o.id === osId);
            if (!os) {
                alert("OS não encontrada.");
                return;
            }
            const formatDateToICS = (dateString, isEndOfDay = false) => {
                const date = new Date(dateString);
                if (isEndOfDay) { date.setUTCHours(23, 59, 59, 999); } 
                else { date.setUTCHours(9,0,0,0); } // Evento começa às 9:00 UTC
                return date.toISOString().replace(/-|:|\.\d{3}/g, "") + "Z"; // Adiciona Z para UTC
            };

            const startDateICS = formatDateToICS(os.prazoFinal); 
            const endDateICS = formatDateToICS(os.prazoFinal, true); 
            const nowICS = formatDateToICS(new Date().toISOString());


            const icsContent = [
                "BEGIN:VCALENDAR",
                "VERSION:2.0",
                "PRODID:-//SeuNomeOuEmpresa//SeuAppOS//PT",
                "CALSCALE:GREGORIAN",
                "BEGIN:VEVENT",
                `UID:${os.id}@gestao-os.com`, 
                `DTSTAMP:${nowICS}`, 
                `DTSTART:${startDateICS}`,
                `DTEND:${endDateICS}`,
                `SUMMARY:Prazo OS: ${os.numero} - ${os.cliente}`,
                `DESCRIPTION:Detalhes da OS:\\nCliente: ${os.cliente}\\nProduto: ${os.produto || 'N/A'}\\nDescrição: ${os.descricao.replace(/\n/g, "\\n")}\\nResponsável: ${os.responsavel}\\nStatus: ${os.status}`,
                `LOCATION:${os.cliente || 'N/A'}`, 
                "END:VEVENT",
                "END:VCALENDAR"
            ].join("\r\n");

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `OS_${os.numero}_prazo.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            addRecentActivity(`Arquivo .ics gerado para OS ${os.numero}.`);
        }


        window.onload = () => {
            loadDataFromLocalStorage(); 
            populateProductFilters();   
            
            setDefaultAnalysisMonth(); 
            
            const dashboardSidebarItem = document.querySelector('.sidebar-item[onclick*="dashboardView"]');
            showView('dashboardView', dashboardSidebarItem); 
            
            refreshAllViews(); 

            const dataAberturaModalEl = document.getElementById('osDataAberturaModal');
            if (dataAberturaModalEl) dataAberturaModalEl.value = new Date().toISOString().split('T')[0];
            
            const reportMonthYearEl = document.getElementById('reportMonthYear');
            if (reportMonthYearEl) {
                const todayForReport = new Date();
                const currentMonthForReport = String(todayForReport.getMonth() + 1).padStart(2, '0');
                const currentYearForReport = todayForReport.getFullYear();
                reportMonthYearEl.value = `${currentYearForReport}-${currentMonthForReport}`;
            }

            if (window.innerWidth < 1024 && sidebar && mainContent && toggleSidebarBtn && sidebarTitleDiv) {
                sidebar.classList.add('collapsed'); mainContent.classList.add('collapsed');
                const isCollapsed = sidebar.classList.contains('collapsed');
                toggleSidebarBtn.innerHTML = isCollapsed ? '<i class="fas fa-chevron-right text-lg"></i>' : '<i class="fas fa-bars text-lg"></i>';
                if (sidebarTitleDiv.querySelector('span')) sidebarTitleDiv.querySelector('span').style.display = isCollapsed ? 'none' : 'inline';
                if (sidebarTitleDiv.querySelector('i')) sidebarTitleDiv.querySelector('i').style.marginRight = isCollapsed ? '0' : '0.5rem';
            }
            addRecentActivity("Sistema V1.5.1 inicializado e pronto.");
            updateLoginUI(); 
        };

        window.onclick = function(event) { 
            if (osModal && event.target == osModal) { 
                closeOSModal();
            }
        }
        window.onkeydown = function(event) { 
            if (osModal && osModal.style.display === 'block' && event.key === "Escape") { 
                closeOSModal();
            }
        };
    </script>
</body>
</html>
