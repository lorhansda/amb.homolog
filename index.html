<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-signin-client_id" content="232267534625-oju4j8ob02rn6tim24tcdas26c5rh3j4.apps.googleusercontent.com">
    <title>Dashboard de OKRs - CS (Automático)</title>
    <link rel="icon" type="image/png" href="icone.png">
    <script>
        window.__gsiCallbackQueue = [];
        window.handleCredentialResponse = function(response) {
            window.__gsiCallbackQueue.push(response);
        };
    </script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app-version-marker"></div>
    <div id="login-container">
        <h1>Dashboard de OKRs</h1>
        <p>Por favor, faça login com sua conta Google para acessar os dados de performance.</p>
        <div id="g_id_onload" data-client_id="232267534625-oju4j8ob02rn6tim24tcdas26c5rh3j4.apps.googleusercontent.com" data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left">
        </div>

        <button id="force-clear-button" style="background: none; border: 1px solid var(--border-color); color: var(--text-light-color); padding: 10px 20px; margin-top: 30px; border-radius: var(--border-radius-sm); cursor: pointer; font-family: var(--font-family); font-size: 0.9rem; transition: all 0.3s ease;">
            <i class="fas fa-sync-alt" style="margin-right: 8px;"></i>
            Problemas para acessar? Limpar dados e recarregar
        </button>
    </div>

    <div id="dashboard-wrapper" style="display: none;">
        <div class="container">
            <header>
                <div id="user-info-card" style="display: none;">
                    <span id="user-info-text"></span>
                    <button id="logout-button" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
                </div>
                <h1>Dashboard de OKRs</h1>
                <p>Avaliação de Resultados e Performance</p>
                <div id="last-load-info" style="display: none;"></div>
                <div class="header-actions">
                    <div class="theme-switcher">
                        <i class="fas fa-sun"></i>
                        <label class="switch">
                            <input type="checkbox" id="theme-toggle">
                            <span class="slider"></span>
                        </label>
                        <i class="fas fa-moon"></i>
                    </div>
                    <button id="bulk-export-button" title="Exportar Relatórios em Lote"><i class="fas fa-file-export"></i></button>
                    <button id="export-html-button" title="Exportar Relatório HTML"><i class="fas fa-file-invoice"></i></button>
                    <button id="export-csv-button" title="Exportar Resumo para CSV"><i class="fas fa-file-csv"></i></button>
                    <button id="settings-button" title="Configurar Metas"><i class="fas fa-cog"></i></button>
                </div>
            </header>

            <section class="controls">
                <div class="control-group">
                    <label style="color: var(--secondary-color);"><i class="fas fa-database"></i> Conexão SenseData</label>
                    <button id="btn-refresh-data" onclick="refreshDashboard()" style="padding: 12px 20px; background: var(--secondary-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                        <i class="fas fa-sync-alt"></i> Atualizar Agora
                    </button>
                </div>

                <div class="control-group">
                    <label for="select-period"><i class="fas fa-calendar-check"></i> Análise de Período</label>
                    <select id="select-period">
                        <option value="monthly" selected>Mensal</option>
                        <option value="q1">1º Trimestre</option>
                        <option value="q2">2º Trimestre</option>
                        <option value="q3">3º Trimestre</option>
                        <option value="q4">4º Trimestre</option>
                        <option value="s1">1º Semestre</option>
                        <option value="s2">2º Semestre</option>
                        <option value="year">Ano Inteiro</option>
                    </select>
                </div>
                <div class="control-group"><label for="select-year"><i class="fas fa-calendar-week"></i> Ano</label><select id="select-year"></select></div>
                <div class="control-group"><label for="select-month"><i class="fas fa-calendar-alt"></i> Mês</label><select id="select-month"></select></div>
                <div class="control-group"><label for="select-cs"><i class="fas fa-user-tie"></i> CS</label><select id="select-cs" disabled><option>Aguardando...</option></select></div>
                <div id="squad-filter-group" class="control-group">
                    <label for="select-squad"><i class="fas fa-users"></i> Squad</label>
                    <select id="select-squad" disabled><option>Aguardando...</option></select>
                </div>
                <div class="control-group"><label for="select-segmento"><i class="fas fa-chart-pie"></i> Segmento</label><select id="select-segmento" disabled><option>Aguardando...</option></select></div>
                <div class="control-group">
                    <label for="select-comparison"><i class="fas fa-exchange-alt"></i> Comparar com</label>
                    <select id="select-comparison">
                        <option value="none" selected>Nenhum</option>
                        <option value="prev_month">Mês Anterior</option>
                        <option value="prev_year">Mesmo Mês, Ano Anterior</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="include-onboarding-toggle">Incluir Onboarding</label>
                    <label class="switch">
                        <input type="checkbox" id="include-onboarding-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </section>

            <div id="squad-cs-list" style="text-align: center; margin: -15px 0 20px 0; color: var(--text-light-color); font-style: italic;"></div>

            <div id="divergence-marker" class="divergence-info" style="display: none;">
                <span id="divergence-text"></span>
            </div>

            <div id="status-message" class="loader">Aguardando login ou atualização de dados...</div>

            <div class="tabs" style="display: none;">
                <button class="tab-button active" data-tab="dashboard-view"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                <button class="tab-button" data-tab="onboarding-view"><i class="fas fa-rocket"></i> Onboarding</button>
                <button class="tab-button" data-tab="overdue-view" style="color: var(--danger-color);"><i class="fas fa-clock-rotate-left"></i> Atrasadas</button>
                <button class="tab-button" data-tab="data-view"><i class="fas fa-table"></i> Dados Carregados</button>
            </div>

            <main id="main-content">
                <div id="dashboard-view" class="tab-content active">
                    <div id="dashboard" style="display: none;">
                        <div class="metric-group">
                            <h2 class="group-title">Indicadores Gerais da Carteira</h2>
                            <div class="group-content" id="general-indicators-grid"></div>
                        </div>
                        <div class="metric-group">
                            <h2 class="group-title">Visão por Negócio e Comercial</h2>
                            <div class="group-content" id="business-commercial-grid"></div>
                        </div>
                        <div class="metric-group">
                            <h2 class="group-title">Acompanhamento de Playbooks</h2>
                            <div class="group-content" id="playbooks-grid"></div>
                        </div>
                        <div class="metric-group">
                            <h2 class="group-title" id="okr-title-header">OKRs de Engajamento e Eventos</h2>
                            <div class="group-content" id="okr-grid-container"></div>
                        </div>
                    </div>
                    <div id="period-view" style="display: none;"></div>
                </div>
                <div id="onboarding-view" class="tab-content">
                    <div id="onboarding-dashboard" style="display: none;">
                        <section class="onboarding-controls">
                            <div class="control-group">
                                <label for="select-onboarding-team"><i class="fas fa-users-cog"></i> Visão do Time</label>
                                <select id="select-onboarding-team" disabled>
                                    <option value="geral">Visão Geral</option>
                                    <option value="syneco">Syneco (Time CP)</option>
                                    <option value="outros">Outros Produtos (Time CS)</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="select-ism"><i class="fas fa-user-astronaut"></i> ISM Responsável</label>
                                <select id="select-ism" disabled><option>Aguardando...</option></select>
                            </div>
                        </section>

                        <div class="metric-group">
                            <h2 class="group-title">Resultados e Performance do Onboarding</h2>
                            <div class="group-content" id="onboarding-outcomes-grid">
                                <div class="loader">Calculando Resultados de Onboarding...</div>
                            </div>
                        </div>

                        <div class="metric-group">
                            <h2 class="group-title">Eficiência do Processo (Mês Atual)</h2>
                            <div class="group-content" id="onboarding-process-grid">
                                <div class="loader">Calculando Eficiência do Processo...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="overdue-view" class="tab-content">
                    <div class="metric-group">
                        <h2 class="group-title">Visão de Atividades Atrasadas</h2>
                        <div class="group-content" id="overdue-grid-container">
                            <div class="loader">Selecione um CS para ver as atividades atrasadas.</div>
                        </div>
                    </div>
                </div>

                <div id="data-view" class="tab-content">
                    <div class="data-table-wrapper">
                        <h3><i class="fas fa-clipboard-list" style="margin-right:10px; color: var(--primary-color);"></i>Dados da Planilha de Atividades</h3>
                    <div class="data-table-controls">
                        <input type="search" id="atividades-search" placeholder="Buscar por cliente, atividade, notas..." />
                        <select id="atividades-cs-filter">
                            <option value="">Todos os CS</option>
                        </select>
                        <div class="date-range">
                            <label>De <input type="date" id="atividades-date-start" /></label>
                            <label>Até <input type="date" id="atividades-date-end" /></label>
                        </div>
                    </div>
                        <div id="atividades-table" class="data-table-container"></div>
                        <div id="atividades-pagination" class="pagination-controls"></div>
                    </div>
                    <div class="data-table-wrapper">
                        <h3><i class="fas fa-address-book" style="margin-right:10px; color: var(--primary-color);"></i>Dados da Planilha de Clientes</h3>
                    <div class="data-table-controls">
                        <input type="search" id="clientes-search" placeholder="Buscar por cliente, segmento, status..." />
                        <select id="clientes-status-filter">
                            <option value="">Todos os status</option>
                        </select>
                        <select id="clientes-cs-filter">
                            <option value="">Todos os CS</option>
                        </select>
                    </div>
                        <div id="clientes-table" class="data-table-container"></div>
                        <div id="clientes-pagination" class="pagination-controls"></div>
                    </div>
                </div>
            </main>

            <div id="details-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modal-title">Detalhes</h2>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-search-container">
                        <input type="search" id="modal-search-input" placeholder="Pesquisar por cliente, atividade, etc...">
                    </div>
                    <div id="modal-body" class="data-table-container"></div>
                </div>
            </div>

            <div id="settings-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-bullseye" style="margin-right:15px;"></i>Configurar Metas</h2>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="settings-grid">
                        <div class="control-group"><label for="goal-sensescore">Média Sense Score</label><input type="number" id="goal-sensescore" step="1"></div>
                        <div class="control-group"><label for="goal-labs">Participação SKA LABS (%)</label><input type="number" id="goal-labs" step="1"></div>
                        <div class="control-group"><label for="goal-coverage">Cobertura de Carteira (%)</label><input type="number" id="goal-coverage" step="1"></div>
                        <div class="control-group"><label for="goal-qbr">Ligações de QBR (nº)</label><input type="number" id="goal-qbr" step="1"></div>
                        <div class="control-group"><label for="goal-successplan">Planos de Sucesso (nº)</label><input type="number" id="goal-successplan" step="1"></div>
                        <div class="control-group"><label for="goal-engagement">Performance Engajamento SMB (%)</label><input type="number" id="goal-engagement" step="1"></div>
                        <button id="save-settings-button"><i class="fas fa-save" style="margin-right:10px;"></i>Salvar Metas</button>
                    </div>
                </div>
            </div>

            <div id="client-360-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="client-360-name">Visão 360° do Cliente</h2>
                        <span class="close-button">&times;</span>
                    </div>
                    <div id="client-360-info" class="client-info"></div>
                    <div id="client-360-activities" class="data-table-wrapper" style="margin-bottom:0; box-shadow: none;">
                        <h3>Histórico de Atividades</h3>
                        <div class="data-table-container"></div>
                    </div>
                </div>
            </div>

            <div id="trend-chart-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="trend-chart-title">Gráfico de Tendência</h2>
                        <span class="close-button">&times;</span>
                    </div>
                    <div id="trend-chart-container" style="padding: 20px 0;">
                        <canvas id="trend-chart-canvas"></canvas>
                    </div>
                </div>
            </div>

            <div id="bulk-export-modal" class="modal">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2><i class="fas fa-users" style="margin-right:15px;"></i>Exportar Relatórios em Lote</h2>
                        <span class="close-button">&times;</span>
                    </div>
                    <div id="cs-selection-list" style="margin: 20px 0; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm);">
                    </div>
                    <button id="generate-bulk-reports-button" style="width: 100%; padding: 14px; font-size: 1.1rem; font-weight: 600; background-color: var(--secondary-color); color: #fff; border: none; border-radius: var(--border-radius-sm); cursor: pointer;">
                        <i class="fas fa-download" style="margin-right:10px;"></i>Gerar Relatórios Selecionados
                    </button>
                </div>
            </div>

            <div id="anotacao-modal" class="modal">
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2 id="anotacao-modal-title"><i class="fas fa-sticky-note" style="margin-right: 15px;"></i>Anotações da Atividade</h2>
                        <span class="close-button">&times;</span>
                    </div>
                    <div id="anotacao-modal-body" style="padding: 20px 5px; white-space: pre-wrap; word-wrap: break-word; font-size: 1.1rem; line-height: 1.7;">
                    </div>
                </div>
            </div>

        </div>
    </div>
    <script src="ism_config.js"></script>
    <script src="frontend-integration.js"></script>
    <script>
    (function() {
        const MANAGER_EMAILS = [
            'lorhanska@gmail.com',
            'elianeokr@gmail.com',
            'juliarail@gmail.com',
            'jadecristianettirp@gmail.com'
        ].map((email) => email.trim().toLowerCase());
        const ADMIN_EMAILS = [
            'lorhanska@gmail.com'
        ].map((email) => email.trim().toLowerCase());
        const ONBOARDING_EMAILS = [
            'lorhangames2@gmail.com',
            'naty.naveal@gmail.com',
            'outro.email@provedor.com'
        ].map((email) => email.trim().toLowerCase());

        const normalizeEmail = (email) => (email || '').trim().toLowerCase();
        const parseJwt = (token) => {
            try {
                if (!token) return null;
                const payload = token.split('.')[1];
                if (!payload) return null;
                const normalizedPayload = payload.replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(atob(normalizedPayload));
            } catch (error) {
                console.error('Erro ao decodificar token JWT', error);
                return null;
            }
        };

        const currentUser = window.currentUser = window.currentUser || {
            email: null,
            name: '',
            picture: '',
            isManager: false,
            userGroup: 'guest',
            selectedISM: 'Todos'
        };

        function applyUserRole(email) {
            const normalized = normalizeEmail(email);
            currentUser.userGroup = 'ongoing';
            currentUser.selectedISM = 'Todos';
            const mapping = window.ISM_MAPPING || {};
            const isAdmin = ADMIN_EMAILS.includes(normalized);
            const isManager = isAdmin || MANAGER_EMAILS.includes(normalized);
            currentUser.isManager = isManager;

            if (isAdmin) {
                currentUser.userGroup = 'admin';
                return;
            }

            if (mapping[normalized]) {
                currentUser.userGroup = 'onboarding';
                currentUser.selectedISM = mapping[normalized];
                return;
            }

            if (ONBOARDING_EMAILS.includes(normalized)) {
                currentUser.userGroup = 'onboarding';
                currentUser.selectedISM = mapping[normalized] || 'Todos';
                return;
            }
        }

        function showDashboardUI() {
            const login = document.getElementById('login-container');
            const dashboard = document.getElementById('dashboard-wrapper');
            if (login) login.style.display = 'none';
            if (dashboard) dashboard.style.display = 'block';
        }

        function bootstrapDashboard() {
            if (!currentUser.email) return;
            if (typeof window.initializeDashboard === 'function') {
                window.__pendingDashboardBootstrap = false;
                window.initializeDashboard();
            } else {
                window.__pendingDashboardBootstrap = true;
            }
        }

        async function forceClearAllData(showFeedback = true) {
            try {
                localStorage.clear();
                sessionStorage.clear();
                if (window.caches) {
                    const cacheKeys = await caches.keys();
                    await Promise.all(cacheKeys.map((key) => caches.delete(key)));
                }
                if (window.indexedDB && typeof indexedDB.databases === 'function') {
                    const databases = await indexedDB.databases();
                    await Promise.all(databases.map((db) => {
                        if (!db || !db.name) return Promise.resolve();
                        return new Promise((resolve) => {
                            const req = indexedDB.deleteDatabase(db.name);
                            req.onsuccess = req.onerror = req.onblocked = () => resolve();
                        });
                    }));
                }
            } catch (error) {
                console.warn('Erro ao limpar dados locais', error);
            } finally {
                if (showFeedback) {
                    alert('Dados locais apagados. A página será recarregada.');
                    window.location.reload();
                }
            }
        }

        function logout() {
            localStorage.removeItem('googleUserToken');
            try {
                if (window.google?.accounts?.id) {
                    window.google.accounts.id.disableAutoSelect();
                }
            } catch (error) {
                console.warn('Não foi possível desabilitar o auto select do Google', error);
            }
            window.location.reload();
        }

        window.forceClearAllData = forceClearAllData;
        window.logout = logout;

        function handleCredentialResponseInternal(response) {
            const decodedToken = parseJwt(response?.credential);
            if (!decodedToken) {
                alert('Falha no login. Não foi possível validar o token do Google.');
                localStorage.removeItem('googleUserToken');
                return;
            }
            localStorage.setItem('googleUserToken', response.credential);
            currentUser.email = decodedToken.email || '';
            currentUser.name = decodedToken.name || decodedToken.email || 'Usuário';
            currentUser.picture = decodedToken.picture || '';
            applyUserRole(currentUser.email);
            showDashboardUI();
            bootstrapDashboard();
        }

        window.handleCredentialResponse = handleCredentialResponseInternal;

        if (Array.isArray(window.__gsiCallbackQueue) && window.__gsiCallbackQueue.length) {
            const queued = window.__gsiCallbackQueue.splice(0, window.__gsiCallbackQueue.length);
            queued.forEach((payload) => {
                try {
                    handleCredentialResponseInternal(payload);
                } catch (error) {
                    console.error('Erro ao processar callback pendente do Google', error);
                }
            });
        }

        function attemptAutoLogin() {
            const storedToken = localStorage.getItem('googleUserToken');
            if (!storedToken) return;
            const decoded = parseJwt(storedToken);
            if (decoded && decoded.exp * 1000 > Date.now()) {
                handleCredentialResponseInternal({ credential: storedToken });
            } else {
                localStorage.removeItem('googleUserToken');
            }
        }

        function bindSupportButtons() {
            const clearBtn = document.getElementById('force-clear-button');
            if (!clearBtn) return;
            clearBtn.addEventListener('click', async () => {
                clearBtn.disabled = true;
                const originalText = clearBtn.innerHTML;
                clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Limpando dados...';
                await forceClearAllData(true);
                clearBtn.innerHTML = originalText;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const wrapper = document.getElementById('dashboard-wrapper');
            if (wrapper) wrapper.style.display = 'none';
            bindSupportButtons();
            attemptAutoLogin();
        });
    })();
    </script>
    <script>
    // ============================================================
    //  1. VARIÁVEIS GLOBAIS E CONFIGURAÇÕES
    // ============================================================
    const WORKER_URL = "https://sensedata-api.sensedata-dash.workers.dev"; 

    let dataWorker; 
    let rawActivities = [], rawClients = []; 
    let dataStore = {}; 
    let onboardingDataStore = {}; 
    let appGoals = {}; 
    let filterDataCache = {}; 
    let chartInstances = {};
    let dataTableFiltersInitialized = false;
    const createDefaultDataTableFilters = () => ({
        atividades: { search: '', cs: '', start: '', end: '' },
        clientes: { search: '', status: '', cs: '' }
    });
    let dataTableFilters = createDefaultDataTableFilters();
    
    const defaultGoals = {
        sensescore: 85, labs: 10, coverage: 40, qbr: 5, successplan: 5, engagement: 50
    };

    const manualEmailToCsMap = {
        "email.dificil@provedor.com": "Nome Completo do CS",
        "contato@empresa.com.br": "Outro CS",
        "gabriellermsviana@gmail.com": "Gabrielle Viana",
        "francielesilvadomingues@gmail.com": "Franciele Domingues",
        "okrmarina1@gmail.com": "Marina Santos",
        "deborahsimonearruda@gmail.com": "Deborah Arruda",
    };

    const decodeHtmlEntities = (text = '') =>
        text
            .replace(/&nbsp;/gi, ' ')
            .replace(/&amp;/gi, '&')
            .replace(/&lt;/gi, '<')
            .replace(/&gt;/gi, '>')
            .replace(/&quot;/gi, '"')
            .replace(/&#39;/gi, "'");

    const stripHtmlToPlainText = (html = '') => {
        if (!html) return '';
        return decodeHtmlEntities(
            html
                .replace(/<\s*br\s*\/?>/gi, '\n')
                .replace(/<\s*\/\s*p\s*>/gi, '\n')
                .replace(/<\s*li\s*>/gi, '\n• ')
                .replace(/<\s*\/\s*li\s*>/gi, '')
                .replace(/<\s*\/\s*(ul|ol)\s*>/gi, '\n')
                .replace(/<[^>]+>/g, '')
        )
            .replace(/\r/g, '')
            .replace(/\n{3,}/g, '\n\n')
            .trim();
    };

    const formatNotesValue = (value) => {
        if (value === null || value === undefined) return '';
        let text = '';
        if (typeof value === 'string') text = value;
        else if (typeof value === 'object') {
            try { text = JSON.stringify(value); }
            catch (error) { text = String(value); }
        } else {
            text = String(value);
        }
        return stripHtmlToPlainText(text);
    };

    const debounce = (fn, wait = 200) => {
        let timeoutId;
        return (...args) => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => fn(...args), wait);
        };
    };

    const ACTIVITY_COLUMN_ORDER = [
        "Criado em",
        "Cliente",
        "CS",
        "Playbook",
        "Atividade",
        "Status",
        "Previsão de conclusão",
        "Concluída em",
        "Responsável",
        "Categoria",
        "Tipo de Atividade",
        "Status Cliente",
        "ClienteCompleto",
        "Segmento",
        "Squad",
        "Fase",
        "ISM",
        "Negocio",
        "Comercial",
        "CriadoEm",
        "PrevisaoConclusao",
        "ConcluidaEm",
        "NPSOnboarding",
        "ValorNaoFaturado"
    ];

    const CLIENT_COLUMN_ORDER = [
        "Cliente",
        "CS",
        "Segmento",
        "Fase",
        "ISM",
        "Negócio",
        "Comercial",
        "Status",
        "Squad CS",
        "Dias sem touch",
        "Situação",
        "Modelo de negócio",
        "Potencial",
        "NPS onboarding",
        "Valor total não faturado"
    ];

    const APP_VERSION = '2.2.1-cache';
    const SNAPSHOT_DB_NAME = 'dashboard-cache';
    const SNAPSHOT_STORE_NAME = 'snapshots';
    const SNAPSHOT_STORAGE_KEY = 'latest';
    const SNAPSHOT_AUTO_REFRESH_MINUTES = 60;
    let lastSnapshotMeta = null;

    // ============================================================
    //  1.1 CACHE LOCAL E HIDRATAÇÃO DO DASHBOARD
    // ============================================================

    function openSnapshotDB() {
        return new Promise((resolve, reject) => {
            if (!('indexedDB' in window)) {
                resolve(null);
                return;
            }
            const request = indexedDB.open(SNAPSHOT_DB_NAME, 1);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(SNAPSHOT_STORE_NAME)) {
                    db.createObjectStore(SNAPSHOT_STORE_NAME);
                }
            };
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error || new Error('indexedDB error'));
        });
    }

    async function persistDashboardSnapshot(activities, clients, storedAt) {
        try {
            const db = await openSnapshotDB();
            if (!db) return;
            await new Promise((resolve, reject) => {
                const tx = db.transaction(SNAPSHOT_STORE_NAME, 'readwrite');
                tx.oncomplete = () => {
                    db.close();
                    resolve();
                };
                tx.onabort = tx.onerror = () => {
                    const err = tx.error || new Error('indexedDB transaction error');
                    db.close();
                    reject(err);
                };
                tx.objectStore(SNAPSHOT_STORE_NAME).put({
                    version: APP_VERSION,
                    storedAt,
                    activities,
                    clients
                }, SNAPSHOT_STORAGE_KEY);
            });
        } catch (error) {
            console.warn('Não foi possível salvar snapshot local', error);
        }
    }

    async function readDashboardSnapshot() {
        try {
            const db = await openSnapshotDB();
            if (!db) return null;
            const snapshot = await new Promise((resolve, reject) => {
                const tx = db.transaction(SNAPSHOT_STORE_NAME, 'readonly');
                const store = tx.objectStore(SNAPSHOT_STORE_NAME);
                const request = store.get(SNAPSHOT_STORAGE_KEY);
                request.onsuccess = () => resolve(request.result || null);
                request.onerror = () => reject(request.error);
                tx.oncomplete = () => db.close();
                tx.onabort = () => {
                    const err = tx.error || new Error('indexedDB transaction aborted');
                    db.close();
                    reject(err);
                };
            });
            return snapshot;
        } catch (error) {
            console.warn('Não foi possível ler snapshot local', error);
            return null;
        }
    }

    function getSnapshotAgeMinutes(storedAt) {
        if (!storedAt) return null;
        const ts = new Date(storedAt);
        if (Number.isNaN(ts.getTime())) return null;
        return Math.max(0, Math.round((Date.now() - ts.getTime()) / 60000));
    }

    async function hydrateDashboardData({ activities = [], clients = [], storedAt = new Date().toISOString(), sourceLabel = 'tempo real' } = {}) {
        rawActivities = Array.isArray(activities) ? activities.slice(0, ACTIVITY_MAX_RECORDS) : [];
        rawClients = Array.isArray(clients) ? clients : [];
        initializeDataTableFilterOptions();

        if (dataWorker) dataWorker.terminate();
        dataWorker = new Worker('worker.js');
        dataWorker.onmessage = handleWorkerMessage;
        dataWorker.postMessage({
            type: 'INIT',
            payload: {
                rawActivities,
                rawClients,
                currentUser,
                manualEmailToCsMap
            }
        });

        const lastLoadDiv = document.getElementById('last-load-info');
        if (lastLoadDiv) {
            const parsedDate = new Date(storedAt);
            const displayDate = Number.isNaN(parsedDate.getTime()) ? new Date() : parsedDate;
            lastLoadDiv.style.display = 'inline-block';
            const label = sourceLabel === 'cache local'
                ? 'Dados locais carregados em'
                : 'Dados atualizados em';
            lastLoadDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${label}: ${displayDate.toLocaleTimeString()} (${rawActivities.length.toLocaleString()} reg.)`;
        }

        lastSnapshotMeta = { sourceLabel, storedAt };
        return { activities: rawActivities, clients: rawClients };
    }

    async function restoreCachedDataIfAvailable() {
        try {
            const snapshot = await readDashboardSnapshot();
            if (!snapshot || !Array.isArray(snapshot.activities) || !Array.isArray(snapshot.clients)) {
                return null;
            }
            if (snapshot.version && snapshot.version !== APP_VERSION) {
                console.info('Snapshot local ignorado por versão diferente.');
                return null;
            }

            const restored = await hydrateDashboardData({
                activities: snapshot.activities,
                clients: snapshot.clients,
                storedAt: snapshot.storedAt,
                sourceLabel: 'cache local'
            });

            const statusMsg = document.getElementById('status-message');
            if (statusMsg) {
                statusMsg.style.display = 'block';
                statusMsg.className = 'loader';
                const age = getSnapshotAgeMinutes(snapshot.storedAt);
                statusMsg.textContent = age !== null
                    ? `Carregado do cache local (${age} min). Atualize para dados recentes.`
                    : 'Carregado do cache local. Atualize para dados recentes.';
            }

            return { ...snapshot, activities: restored.activities, clients: restored.clients };
        } catch (error) {
            console.warn('Falha ao restaurar snapshot local', error);
            return null;
        }
    }

    async function clearDashboardSnapshot() {
        try {
            const db = await openSnapshotDB();
            if (!db) return;
            await new Promise((resolve, reject) => {
                const tx = db.transaction(SNAPSHOT_STORE_NAME, 'readwrite');
                tx.oncomplete = () => {
                    db.close();
                    resolve();
                };
                tx.onabort = tx.onerror = () => {
                    const err = tx.error || new Error('indexedDB transaction error');
                    db.close();
                    reject(err);
                };
                tx.objectStore(SNAPSHOT_STORE_NAME).delete(SNAPSHOT_STORAGE_KEY);
            });
        } catch (error) {
            console.warn('Falha ao limpar snapshot local', error);
        }
        lastSnapshotMeta = null;
    }

    function resetDataTableFiltersState() {
        dataTableFilters = createDefaultDataTableFilters();
        const setValue = (id, value = '') => {
            const el = document.getElementById(id);
            if (el) el.value = value;
        };
        setValue('atividades-search');
        setValue('atividades-date-start');
        setValue('atividades-date-end');
        setValue('clientes-search');
        const selects = ['atividades-cs-filter', 'clientes-cs-filter', 'clientes-status-filter'];
        selects.forEach(id => setValue(id, ''));
    }

    async function refreshDashboard() {
        await clearDashboardSnapshot();
        resetDataTableFiltersState();
        await loadDataFromAPI();
    }

    window.refreshDashboard = refreshDashboard;

    // ============================================================
    //  2. FUNÇÕES AUXILIARES E MODAIS (PRECISAM VIR PRIMEIRO)
    // ============================================================
    
    function normalizeText(str = '') {
        return String(str).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    const normalizeClientKey = (value = '') => (value || '').trim().toLowerCase();

    function formatClientStatusValue(value = '') {
        if (!value) return '';
        return value
            .split('-')
            .map(part => part.split(' ').map(word => word ? word.charAt(0).toUpperCase() + word.slice(1).toLowerCase() : '').join(' '))
            .join('-')
            .trim();
    }

    function formatDate(date) {
        if (!(date instanceof Date) || isNaN(date)) return '';
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();
        return `${day}/${month}/${year}`;
    }

    function showModal(el) { 
        if(el) el.style.display = 'block'; 
    }
    
    function closeModal(el) { 
        if(el) {
            el.style.display = 'none'; 
            if(el.querySelector('input')) el.querySelector('input').value = ''; 
        }
    }

    function createHtmlTable(data, options = {}) {
        if (!data || data.length === 0) return '<p style="padding: 20px; text-align: center;">Sem dados para exibir.</p>';
        const columnOrder = Array.isArray(options.columnOrder) ? options.columnOrder : null;
        const hiddenKeys = ['__activityId'];
        let headers = Object.keys(data[0]).filter(h => !hiddenKeys.includes(h) && normalizeText(h) !== 'anotacoes');
        if (columnOrder) {
            const normalizedLookup = new Map();
            headers.forEach(header => normalizedLookup.set(normalizeText(header), header));
            const usedHeaders = new Set();
            const orderedHeaders = [];
            columnOrder.forEach(orderKey => {
                const normalizedKey = normalizeText(orderKey);
                const actualHeader = normalizedLookup.get(normalizedKey);
                if (actualHeader && !usedHeaders.has(actualHeader)) {
                    orderedHeaders.push(actualHeader);
                    usedHeaders.add(actualHeader);
                }
            });
            const remainingHeaders = headers.filter(header => !usedHeaders.has(header));
            headers = [...orderedHeaders, ...remainingHeaders];
        }
        const hasActions = data.some(row => row.__activityId);
        const head = `<thead><tr>${hasActions ? '<th style="width: 60px;"></th>' : ''}${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
        const body = `<tbody>${data.map(row => {
            const rowsCells = headers.map(h => {
                let val = row[h];
                if(val instanceof Date) val = formatDate(val);
                if(normalizeText(h) === 'cliente') return `<td><span class="client-activity-trigger" data-anotacao="${(row['Anotações']||'').replace(/"/g,'&quot;')}">${val}</span></td>`;
                return `<td>${val !== null && val !== undefined ? val : ''}</td>`;
            }).join('');
            const actionCell = hasActions ? `<td class="activity-action-cell">${row.__activityId ? `<button class="activity-delete-btn" data-activity-id="${row.__activityId}"><i class="fas fa-trash"></i></button>` : ''}</td>` : '';
            return `<tr>${actionCell}${rowsCells}</tr>`;
        }).join('')}</tbody>`;
        return `<table class="data-table">${head}${body}</table>`;
    }

    // FUNÇÃO CRÍTICA: Exibe dados no modal (Correção do erro ReferenceError)
    function showDataInModal(data, title) {
        if (!data || data.length === 0) { 
            alert(`Não há dados para exibir para "${title}".`); 
            return; 
        }
        const modal = document.getElementById('details-modal');
        modal.querySelector('#modal-title').textContent = title;
        const body = modal.querySelector('#modal-body');
        const input = modal.querySelector('#modal-search-input');
        
        input.value = '';
        input.oninput = () => {
            const term = normalizeText(input.value);
            const fil = data.filter(r => Object.values(r).some(v => normalizeText(String(v)).includes(term)));
            body.innerHTML = createHtmlTable(fil);
        };
        body.innerHTML = createHtmlTable(data);
        showModal(modal);
    }

    function showDetailsModal(id, title) {
        const data = dataStore[id] || onboardingDataStore[id];
        showDataInModal(data, title);
    }

    function showAnotacaoModal(txt) {
        document.getElementById('anotacao-modal-body').textContent = txt || 'Sem anotações.';
        showModal(document.getElementById('anotacao-modal'));
    }

    // --- LÓGICA DE GRÁFICO DE TENDÊNCIA (Correção do erro showTrendChart) ---
    let trendChartInstance = null;

    function showTrendChart(metricId, title, type) {
        const trendModal = document.getElementById('trend-chart-modal');
        document.getElementById('trend-chart-title').textContent = `Tendência: ${title}`;
        const canvas = document.getElementById('trend-chart-canvas');
        if (trendChartInstance) {
            trendChartInstance.destroy();
        }
        showModal(trendModal);
        document.getElementById('trend-chart-container').innerHTML = '<div class="loader">Calculando histórico...</div>';
        
        // Pede os dados de tendência ao worker
        if(dataWorker) {
            dataWorker.postMessage({
                type: 'CALCULATE_TREND',
                payload: {
                    metricId, title, type,
                    baseMonth: parseInt(document.getElementById('select-month').value, 10),
                    baseYear: parseInt(document.getElementById('select-year').value, 10),
                    selectedCS: document.getElementById('select-cs').value,
                    selectedSquad: document.getElementById('select-squad').value,
                    includeOnboarding: document.getElementById('include-onboarding-toggle').checked,
                    segmento: document.getElementById('select-segmento').value
                }
            });
        }
    }

    function renderTrendChart(labels, dataPoints, title) {
        const canvas = document.getElementById('trend-chart-canvas');
        // Garante que o canvas existe (caso tenha sido removido pelo loader)
        if(!canvas) {
             document.getElementById('trend-chart-container').innerHTML = '<canvas id="trend-chart-canvas"></canvas>';
        } else {
             document.getElementById('trend-chart-container').innerHTML = '';
             document.getElementById('trend-chart-container').appendChild(canvas);
        }
        
        const ctx = document.getElementById('trend-chart-canvas').getContext('2d');
        if (trendChartInstance) trendChartInstance.destroy();
        
        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: title, data: dataPoints, fill: true, 
                    borderColor: '#007BFF', backgroundColor: 'rgba(0, 123, 255, 0.2)',
                    pointBackgroundColor: '#007BFF', tension: 0.3, pointRadius: 5
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });
    }

    // ============================================================
    //  3. FUNÇÕES DE DADOS E TRADUÇÃO
    // ============================================================

    function enrichActivitiesWithClientData(activities = [], clients = []) {
        if (!Array.isArray(activities) || !Array.isArray(clients)) return activities;
        const clientMap = new Map(clients.map(client => [normalizeClientKey(client.Cliente), client]));
        return activities.map(activity => {
            const normalized = normalizeClientKey(activity.Cliente);
            const clientInfo = clientMap.get(normalized);
            if (!clientInfo) {
                return {
                    ...activity,
                    ClienteCompleto: normalizeClientKey(activity.Cliente || '')
                };
            }
            const canonicalName = clientInfo.Cliente || activity.Cliente;
            return {
                ...activity,
                Cliente: canonicalName || activity.Cliente,
                ClienteCompleto: normalizeClientKey(canonicalName),
                Segmento: clientInfo.Segmento || activity.Segmento || '',
                Squad: clientInfo['Squad CS'] || activity.Squad || '',
                Fase: clientInfo.Fase || activity.Fase || '',
                ISM: clientInfo.ISM || activity.ISM || '',
                Negocio: clientInfo['Negócio'] || activity.Negocio || '',
                Comercial: clientInfo.Comercial || activity.Comercial || '',
                NPSOnboarding: clientInfo['NPS onboarding'] ?? activity.NPSOnboarding ?? '',
                ValorNaoFaturado: clientInfo['Valor total não faturado'] ?? activity.ValorNaoFaturado ?? '',
                "Status Cliente": formatClientStatusValue(activity["Status Cliente"] || clientInfo.Status || clientInfo['Situação'])
            };
        });
    }
const parseDate = (dateInput) => {
    if (!dateInput) return null;
    if (dateInput instanceof Date) return dateInput;
    
    const dateStr = String(dateInput).trim();
    
    // Caso 1: Formato ISO ou SQL (ex: 2025-08-08 ou 2025-08-08T10:00:00)
    if (dateStr.includes('-')) {
        // Se tiver 'T' ou espaço, tenta criar direto. Se for só YYYY-MM-DD, força o meio-dia para evitar fuso horário
        const cleanDate = dateStr.includes('T') || dateStr.includes(':') ? dateStr : `${dateStr}T12:00:00`;
        const dateObj = new Date(cleanDate);
        if (!isNaN(dateObj)) return dateObj;
    }
    
    // Caso 2: Formato Brasileiro (ex: 08/08/2025)
    if (dateStr.includes('/')) {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            // Dia, Mês - 1, Ano
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }
    }
    return null;
};

        // --- HELPERS: Tradução de Termos (Inglês -> Português) ---

const translateActivityType = (type) => {
    if (!type) return 'Não Identificado';
    
    // Converte para minúsculo para facilitar a comparação
    const lower = String(type).toLowerCase();
    
    // Mapeamento de Tipos
    if (lower.includes('meeting') || lower.includes('reunião')) return 'Reunião';
    if (lower.includes('call') || lower.includes('phone') || lower.includes('ligação')) return 'Ligação';
    if (lower.includes('email') || lower.includes('e-mail')) return 'E-mail';
    if (lower.includes('whatsapp')) return 'Whatsapp';
    if (lower.includes('task') || lower.includes('tarefa')) return 'Tarefa';
    
    return type; // Se não achar, retorna o original
};

const translateStatus = (status) => {
    if (!status) return 'Desconhecido';
    const lower = String(status).toLowerCase();
    
    // Mapeamento de Status
    if (lower === 'completed' || lower === 'concluded' || lower === 'done' || lower === 'concluída') return 'Concluída';
    if (lower === 'open' || lower === 'pending' || lower === 'scheduled' || lower === 'agendada') return 'Agendada';
    if (lower === 'canceled' || lower === 'cancelled' || lower === 'cancelada') return 'Cancelada';
    if (lower === 'late' || lower === 'overdue' || lower === 'atrasada') return 'Atrasada';
    
    return status;
};
    // --- MAPPER: Banco D1 -> Formato do Dashboard ---
function mapDatabaseToDashboard(dbData, type) {
    if (!Array.isArray(dbData)) return [];

    return dbData.map(row => {
        if (type === 'atividades') {
            // Mapeia as colunas do D1 (snake_case) para o Dashboard (Title Case)
            
            // 1. Trata as datas usando o helper do Passo 1
            const created = parseDate(row.criado_em || row.created_at || row["Criado em"]);
            const due = parseDate(row.previsao_conclusao || row.due_date || row["Previsão de conclusão"]);
            const done = parseDate(row.end_date || row.system_end_date || row.concluida_em || row["Concluída em"]);
            
            // 2. Retorna o objeto no formato que o Worker e a Tabela esperam
            return {
                "__activityId": row.id_sensedata || row.id,
                
                // Campos de Data (Formatados)
                "Criado em": created,
                "Previsão de conclusão": due,
                "Concluída em": done,
                
                // Campos de Texto Principais
                "Cliente": row.cliente || row.customer_name || "Cliente Desconhecido",
                "ClienteCompleto": (row.cliente || '').trim().toLowerCase(),
                "CS": row.cs || row.owner_name, // Se vier vazio, será preenchido depois pelo 'enrich'
                "Playbook": row.playbook,
                "Atividade": row.atividade || row.description,
                "Tipo de Atividade": translateActivityType(row.tipo_atividade || row.tipo || row["Tipo de Atividade"]),
                "Categoria": row.categoria,
                
                // Status e Responsáveis
                "Status": translateStatus(row.status || row["Status"]),
                "Responsável": row.responsavel || row.responsavel_name,
                "Status Cliente": row.status_cliente, // Ex: "Ativo-Produto"
                
                // Anotações (JSON ou Texto)
                "Anotações": row.notes || row.anotacoes || ""
            };
        } 
        else if (type === 'clientes') {
            return {
                // Mapeamento da tabela de Clientes
                "Cliente": row.cliente || row.name,
                "ClienteCompleto": (row.cliente || '').trim().toLowerCase(),
                "CS": row.cs || row.owner,
                "Segmento": row.segmento || row.industry,
                "Fase": row.fase || row.stage,
                "ISM": row.ism,
                "Negócio": row.negocio,
                "Comercial": row.comercial,
                "NPS onboarding": row.nps_onboarding,
                "Valor total não faturado": row.valor_total_em_aberto,
                "Status": row.status,        // Ex: "Ativo"
                "Squad CS": row.squad_cs,
                "Dias sem touch": row.dias_sem_touch,
                "Situação": row.situacao,
                "Modelo de negócio": row.modelo_de_negocio,
                "Potencial": row.potencial
            };
        }
    });
}

function buildFilterDataSnapshot(clients = [], activities = []) {
    const csSet = new Set();
    const squadSet = new Set();
    const csToSquadMap = {};
    clients.forEach(client => {
        const csName = (client.CS || "").trim();
        if (csName) {
            csSet.add(csName);
            if (client["Squad CS"]) {
                squadSet.add(client["Squad CS"]);
                csToSquadMap[csName] = client["Squad CS"];
            }
        }
    });

    const years = new Set();
    const collectYear = (value) => {
        if (value instanceof Date && !isNaN(value)) {
            years.add(value.getUTCFullYear());
        }
    };
    activities.forEach(activity => {
        collectYear(activity["Previsão de conclusão"]);
        collectYear(activity["Concluída em"]);
    });
    if (years.size === 0) years.add(new Date().getFullYear());

    return {
        csSet,
        squadSet,
        years: [...years].sort((a, b) => b - a),
        csToSquadMap
    };
}

    const DASH_FETCH_CONFIG = window.DASH_FETCH_CONFIG || {};
    const ACTIVITY_FETCH_LIMIT = Number(DASH_FETCH_CONFIG.activityLimit ?? 30000);
    const ACTIVITY_FETCH_MAX_PAGES = Number(DASH_FETCH_CONFIG.activityMaxPages ?? 4);
    const ACTIVITY_PAGE_COOLDOWN_MS = Number(DASH_FETCH_CONFIG.pageDelayMs ?? 30);
    const ACTIVITY_DEFAULT_SINCE = '2025-05-01';
    const ACTIVITY_MAX_RECORDS = Number(DASH_FETCH_CONFIG.activityMaxRecords ?? (ACTIVITY_FETCH_LIMIT * ACTIVITY_FETCH_MAX_PAGES)) || 1000000;

    async function fetchActivitiesInChunks({ limit = ACTIVITY_FETCH_LIMIT, maxPages = ACTIVITY_FETCH_MAX_PAGES, since, onPageFetch }) {
        const aggregated = [];
        let page = 1;
        const now = () => (typeof performance !== 'undefined' && performance.now ? performance.now() : Date.now());

        const requestPage = (pageNumber) => {
            if (typeof onPageFetch === 'function') onPageFetch(pageNumber, aggregated.length);
            const url = new URL(`${WORKER_URL}/api/atividades`);
            url.searchParams.set('limit', String(limit));
            url.searchParams.set('page', String(pageNumber));
            if (since) url.searchParams.set('since', since);
            const requestStart = now();
            return fetch(url.toString()).then(async (response) => {
                if (!response.ok) {
                    const body = await response.text();
                    throw new Error(`Falha ao baixar atividades (página ${pageNumber}): ${body || response.statusText}`);
                }
                const chunk = await response.json();
                return { chunk, duration: now() - requestStart };
            });
        };

        let nextPagePromise = requestPage(page);

        while (page <= maxPages) {
            const { chunk, duration } = await nextPagePromise;
            if (!Array.isArray(chunk) || chunk.length === 0) break;

            aggregated.push(...chunk);
            if (aggregated.length >= ACTIVITY_MAX_RECORDS) {
                aggregated.length = ACTIVITY_MAX_RECORDS;
                break;
            }
            if (chunk.length < limit) break;
            if (page >= maxPages) break;

            const nextPageNumber = page + 1;
            const scheduleNext = () => {
                if (ACTIVITY_PAGE_COOLDOWN_MS > 0) {
                    const waitTime = Math.max(0, ACTIVITY_PAGE_COOLDOWN_MS - duration);
                    if (waitTime > 4) {
                        return new Promise((resolve, reject) => {
                            setTimeout(() => {
                                requestPage(nextPageNumber).then(resolve).catch(reject);
                            }, waitTime);
                        });
                    }
                }
                return requestPage(nextPageNumber);
            };

            page = nextPageNumber;
            nextPagePromise = scheduleNext();
        }

        return aggregated;
    }

    async function fetchAllClients() {
        const response = await fetch(`${WORKER_URL}/api/clientes`);
        if (!response.ok) {
            const body = await response.text();
            throw new Error(`Falha ao baixar tabela de Clientes: ${body || response.statusText}`);
        }
        const data = await response.json();
        return Array.isArray(data) ? data : [];
    }

    // --- LOADER: Busca dados, Mapeia e Atualiza a Tela ---
async function loadDataFromAPI() {
    const statusMsg = document.getElementById('status-message');
    if(statusMsg) {
        statusMsg.style.display = 'block';
        statusMsg.className = 'loader';
        statusMsg.innerHTML = 'Conectando ao banco D1 e processando dados...';
    }

    try {
        // 1. Instancia a integração e baixa os dados brutos do Cloudflare
        // (Certifique-se que o arquivo frontend-integration.js está carregado)
        const api = new SensedataAPIClient(WORKER_URL); 
        const dados = await api.carregarDadosClientes();

        if (!dados.atividades || dados.atividades.length === 0) {
            console.warn("Aviso: API retornou 0 atividades.");
        }

        // 2. APLICA O MAPEAMENTO (A CORREÇÃO PRINCIPAL)
        // Converte os dados "crus" do D1 para o formato Title Case do painel
        const mappedClients = mapDatabaseToDashboard(dados.clientes, 'clientes');
        let mappedActivities = mapDatabaseToDashboard(dados.atividades, 'atividades');

        // 3. ENRIQUECIMENTO
        // Garante que atividades sem CS peguem o CS da lista de clientes
        if (typeof window.enrichActivitiesWithClientData === 'function') {
            mappedActivities = window.enrichActivitiesWithClientData(mappedActivities, mappedClients);
        }

        // 4. Define as variáveis globais para as tabelas
        rawClients = mappedClients;
        rawActivities = mappedActivities;
        filterDataCache = buildFilterDataSnapshot(mappedClients, mappedActivities);

        // 5. Envia para o Worker de Cálculo (worker.js)
        // Passamos os dados JÁ MAPEADOS para que o worker encontre as colunas certas
        if (dataWorker) dataWorker.terminate();
        dataWorker = new Worker('worker.js');
        dataWorker.onmessage = handleWorkerMessage;
        
        dataWorker.postMessage({
            type: 'INIT',
            payload: {
                rawActivities: mappedActivities, 
                rawClients: mappedClients,
                currentUser: currentUser,
                manualEmailToCsMap: manualEmailToCsMap || {}
            }
        });

        // 6. Salva no Cache Local para o próximo acesso ser rápido
        if (typeof persistDashboardSnapshot === 'function') {
            persistDashboardSnapshot(mappedActivities, mappedClients, new Date().toISOString());
        }

        if(statusMsg) statusMsg.style.display = 'none';
        
        // 7. Atualiza a Interface
        populateFilters(); // Preenche os selects (CS, Mês, etc)
        renderDataTables(); // Preenche as tabelas
        
        // Trava seletor de CS se não for gestor
        if (!currentUser.isManager) {
            const selectedCS = document.getElementById('select-cs').value;
            if (selectedCS) {
                const clientsOfLoggedInUser = rawClients.filter(client => client.CS?.trim() === selectedCS);
                if(typeof autoSelectSegment === 'function') autoSelectSegment(clientsOfLoggedInUser);
            }
        }
        
        // Força o cálculo inicial dos gráficos
        triggerCalculations();

    } catch (error) {
        console.error(error);
        if(statusMsg) {
            statusMsg.className = 'error';
            statusMsg.innerHTML = 'Erro ao carregar dados: ' + error.message + '<br><button onclick="location.reload()">Recarregar</button>';
        }
    }
}


    // ============================================================
    //  4. FUNÇÕES GRÁFICAS (CHART.JS)
    // ============================================================

    function customLegendClickHandler(e, legendItem, legend) {
        const chart = legend.chart;
        const index = legendItem.index;
        const meta = chart.getDatasetMeta(0);
        if (!chart.legendClickState) chart.legendClickState = { lastClickedIndex: null, clickCount: 0 };
        
        if (index !== chart.legendClickState.lastClickedIndex) {
            let visibleCount = 0;
            meta.data.forEach(dataPoint => { if (!dataPoint.hidden) visibleCount++; });
            const isIsolated = visibleCount === 1 && chart.data.labels.length > 1;
            if (isIsolated) meta.data.forEach(dataPoint => { dataPoint.hidden = false; });
            chart.legendClickState.clickCount = 0;
        }
        chart.legendClickState.lastClickedIndex = index;
        chart.legendClickState.clickCount++;

        if (chart.legendClickState.clickCount === 1) {
            meta.data[index].hidden = !meta.data[index].hidden;
        } else if (chart.legendClickState.clickCount === 2) {
            meta.data.forEach((dataPoint, i) => { dataPoint.hidden = (i !== index); });
        } else {
            meta.data.forEach(dataPoint => { dataPoint.hidden = false; });
            chart.legendClickState.clickCount = 0;
            chart.legendClickState.lastClickedIndex = null;
        }
        chart.update();
    }

    function renderDoughnutChart(containerId, canvasId, title, data) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const labels = Object.keys(data);
        const values = Object.values(data);

        if (labels.length === 0) {
            container.innerHTML = `<div class="card"><h3>${title}</h3><div class="loader" style="padding: 40px; font-size: 1rem;">Sem dados.</div></div>`;
            return;
        }

        container.innerHTML = `<div class="card"><h3>${title}</h3><div class="card-content" style="position: relative; height: 320px; padding-top: 10px;"><canvas id="${canvasId}"></canvas></div></div>`;

        if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
        const ctx = document.getElementById(canvasId).getContext('2d');
        const colors = ['#007BFF', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2', '#fd7e14', '#20c997'];
        const backgroundColors = labels.map((_, i) => colors[i % colors.length]);
        const isLightTheme = document.body.classList.contains('light-theme');

        chartInstances[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{ data: values, backgroundColor: backgroundColors, borderColor: isLightTheme ? '#fff' : '#1a2238', borderWidth: 2 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: '60%',
                plugins: {
                    legend: { position: 'bottom', labels: { color: isLightTheme ? '#2c3e50' : '#F0F2F5', padding: 15, boxWidth: 12 }, onClick: customLegendClickHandler },
                    tooltip: { callbacks: { label: (c) => `${c.label}: ${c.raw} (${((c.raw/c.dataset.data.reduce((a,b)=>a+b,0))*100).toFixed(1)}%)` } }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const label = labels[index];
                        let filterData = [];
                        // Lógica de Drilldown SEGURA
                        if(containerId.includes('negocio')) {
                            filterData = (dataStore['cob-carteira']||[]).filter(c => normalizeText(c.Negocio||'Não Definido') === normalizeText(label));
                        } else if(containerId.includes('comercial')) {
                            filterData = (dataStore['cob-carteira']||[]).filter(c => normalizeText(c.Comercial||'Não Definido') === normalizeText(label));
                        } else if(containerId.includes('clientes')) {
                            filterData = (dataStore['total-clientes']||[]).filter(c => normalizeText(c['Negócio']||'Não Definido') === normalizeText(label));
                        }
                        if(filterData.length > 0) showDataInModal(filterData, `${title}: ${label}`);
                    }
                },
                onHover: (e, el) => { e.native.target.style.cursor = el[0] ? 'pointer' : 'default'; }
            }
        });
    }
    
    function renderOnboardingProductChart(data) {
        if(!data || !data.labels) return;
        const ctx = document.getElementById('onboardingProductChart').getContext('2d');
        if(chartInstances['onboardingProductChart']) chartInstances['onboardingProductChart'].destroy();
        chartInstances['onboardingProductChart'] = new Chart(ctx, {
            type: 'bar',
            data: { labels: data.labels, datasets: [{ label: 'Clientes', data: data.clientCount, backgroundColor: '#007BFF', yAxisID: 'y1' }, { label: 'Dias (Média)', data: data.avgTime, type: 'line', borderColor: '#ffc107', yAxisID: 'y2' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y1: { position: 'left' }, y2: { position: 'right', grid: { display: false } } } }
        });
    }

    // ============================================================
    //  5. LÓGICA DO DASHBOARD E WORKER HANDLERS
    // ============================================================

    function handleWorkerMessage(e) {
        const { type, payload } = e.data;
        switch(type) {
            case 'INIT_COMPLETE':
                console.log("Worker inicializado.");
                filterDataCache = payload.filterData; 
                populateFilters(); 
                if (!currentUser.isManager) {
                    const selectedCS = document.getElementById('select-cs').value;
                    if (selectedCS) {
                        const clientsOfLoggedInUser = rawClients.filter(client => client.CS?.trim() === selectedCS);
                        autoSelectSegment(clientsOfLoggedInUser);
                    }
                }
                renderDataTables(); 
                applyFilterLocks(); 
                document.querySelector('.tabs').style.display = 'flex';
                document.getElementById('status-message').style.display = 'none'; 
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('onboarding-dashboard').style.display = 'block';
                triggerCalculations(); 
                break;
            
            case 'CALCULATION_COMPLETE':
                dataStore = payload.dataStore; 
                onboardingDataStore = payload.onboardingDataStore; 
                renderOKRs(); // AGORA ESSA FUNÇÃO JÁ EXISTE PQ ESTÁ DECLARADA ABAIXO
                renderNewOnboardingView();
                renderOverdueView(payload.overdueMetrics); 
                
                const divMarker = document.getElementById('divergence-marker');
                const divText = document.getElementById('divergence-text');
                if (payload.divergentClientCount > 0 && document.getElementById('select-period').value === 'monthly') {
                    divText.textContent = `Atenção: ${payload.divergentClientCount} clientes fora da carteira receberam atividades. Clique para ver detalhes.`;
                    divMarker.style.display = 'flex';
                    divMarker.style.cursor = 'pointer';
                    divMarker.setAttribute('role', 'button');
                    divMarker.tabIndex = 0;
                } else {
                    divMarker.style.display = 'none';
                    divMarker.removeAttribute('role');
                    divMarker.removeAttribute('tabindex');
                    divMarker.style.cursor = 'default';
                }
                document.getElementById('status-message').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('period-view').style.display = 'none';
                break;

            case 'PERIOD_CALCULATION_COMPLETE':
                renderPeriodView(payload.periodData, payload.periodName);
                document.getElementById('status-message').style.display = 'none';
                break;

            case 'TREND_DATA_COMPLETE':
                renderTrendChart(payload.labels, payload.dataPoints, payload.title);
                break;

            case 'ERROR':
                console.error("Erro Worker:", payload.error);
                document.getElementById('status-message').textContent = `Erro: ${payload.error}`;
                document.getElementById('status-message').style.display = 'block';
                break;
        }
    }

    // --- RENDERIZAÇÃO DE UI (Cards e Grids) ---

    function renderOKRs() {
        const selectedSegmento = document.getElementById('select-segmento').value;
        document.getElementById('okr-title-header').textContent = `OKRs do Segmento: ${selectedSegmento}`;

        const generalGrid = document.getElementById('general-indicators-grid');
        const playbookGrid = document.getElementById('playbooks-grid');
        const okrGrid = document.getElementById('okr-grid-container');
        const businessCommercialGrid = document.getElementById('business-commercial-grid');

        businessCommercialGrid.innerHTML = `<div id="negocio-chart-container"></div><div id="comercial-chart-container"></div><div id="clientes-negocio-chart-container"></div>`;
        
        // AGORA ESSAS FUNÇÕES EXISTEM
        if(dataStore['contatos-por-negocio']) renderDoughnutChart('negocio-chart-container', 'negocioChart', 'Contatos por Negócio', dataStore['contatos-por-negocio']);
        if(dataStore['contatos-por-comercial']) renderDoughnutChart('comercial-chart-container', 'comercialChart', 'Contatos por Comercial', dataStore['contatos-por-comercial']);
        if(dataStore['clientes-por-negocio']) renderDoughnutChart('clientes-negocio-chart-container', 'clientesNegocioChart', 'Clientes por Negócio', dataStore['clientes-por-negocio']);

        // ... (Restante da lógica de RenderOKRs - Cards, Métricas, etc. Mantida igual)
        const totalCalls = (dataStore['contato-ligacao'] || []).length;
        const totalEmails = (dataStore['contato-email'] || []).length;
        const totalCsContacts = totalCalls + totalEmails;
        const percLigacao = totalCsContacts > 0 ? ((totalCalls / totalCsContacts) * 100).toFixed(0) : 0;
        const percEmail = totalCsContacts > 0 ? ((totalEmails / totalCsContacts) * 100).toFixed(0) : 0;
        const totalClassified = (dataStore['ligacoes-classificadas'] || []).length;
        let onboardingMetricHtml = '';
        const includeOnboarding = document.getElementById('include-onboarding-toggle').checked;
        const onboardingContacts = dataStore['onboarding-contacts-display'] || [];
        if (includeOnboarding && onboardingContacts.length > 0) {
            onboardingMetricHtml = `<div class="metric" data-metric-id="onboarding-contacts-display" data-metric-title="Contatos de Onboarding"><span class="metric-label"><i class="fas fa-user-plus"></i> Contatos Onboarding:</span><span class="metric-value">${onboardingContacts.length}</span></div>`;
        }
        const cardTiposDeContato = `<div class="card"><h3>Tipos de Contato (Mês)</h3><div class="card-content"><div class="metric" data-metric-id="contato-ligacao" data-metric-title="Contatos do CS por Ligação/Reunião"><span class="metric-label">📞 Ligação/Reunião (CS):</span><span class="metric-value">${totalCalls} <span class="sub-metric">(${percLigacao}%)</span></span></div><div class="metric" data-metric-id="contato-email" data-metric-title="Contatos do CS por E-mail/Whatsapp"><span class="metric-label">✉️ E-mail/Whatsapp (CS):</span><span class="metric-value">${totalEmails} <span class="sub-metric">(${percEmail}%)</span></span></div>${onboardingMetricHtml}</div></div>`;

        const totalClientesUnicosCS = dataStore['total-clientes-unicos-cs'] || 0;
        const clientesContatadosCount = dataStore['cob-carteira']?.length || 0;
        const cobCarteiraPerc = totalClientesUnicosCS > 0 ? (clientesContatadosCount / totalClientesUnicosCS) * 100 : 0;
        const cobCarteiraPerc_comp = dataStore['cob-carteira_comp_perc'];
        const sensescore_avg = dataStore['sensescore-avg'] || 0;
        const sensescore_comp = dataStore['sensescore-avg_comp'];
        const clientesFaltantes = dataStore['clientes-faltantes-meta-cobertura'] || 0;
        const distLigacao = dataStore['dist-faltante-ligacao'] || 0;
        const distEmail = dataStore['dist-faltante-email'] || 0;
        let distHtml = '';
        if (clientesFaltantes > 0) {
            distHtml = `<div class="metric" style="font-size: 0.9rem; padding-top: 5px;"><span class="metric-label">Faltante (Ligação):</span><span class="metric-value" style="color:var(--primary-color)">${distLigacao}</span></div><div class="metric" style="font-size: 0.9rem;"><span class="metric-label">Faltante (Email):</span><span class="metric-value" style="color:var(--primary-color)">${distEmail}</span></div>`;
        }
        const cardCobertura = createOkrCard('Cobertura de Carteira', cobCarteiraPerc, appGoals.coverage, '%', 'cob-carteira', null, null, cobCarteiraPerc_comp, clientesFaltantes, distHtml);
        const senseScoreCard = createOkrCard('Média Sense Score', sensescore_avg, appGoals.sensescore, ' pts', 'sensescore-avg', sensescore_avg.toFixed(1), null, sensescore_comp);
        generalGrid.innerHTML = `${createSimpleCard('Visão Geral da Carteira', 'total-clientes', 'Total de Clientes Únicos', (dataStore['total-clientes'] || []).length, 'cob-carteira', 'Clientes Contatados', clientesContatadosCount)} ${cardCobertura} ${senseScoreCard} ${cardTiposDeContato}`;

        const followupCard = createPrevistoRealizadoCard('Follow-Up Pós Loop', (dataStore['followup-previsto'] || []).length, (dataStore['followup-realizado'] || []).length, 'followup', null, (dataStore['followup-atrasado-concluido'] || []).length, (dataStore['followup-concluido-antecipado'] || []).length);
        const discoveryCard = createPrevistoRealizadoCard('Discovery Potencial', (dataStore['discovery-previsto'] || []).length, (dataStore['discovery-realizado'] || []).length, 'discovery', null, (dataStore['discovery-atrasado-concluido'] || []).length, (dataStore['discovery-concluido-antecipado'] || []).length);
        playbookGrid.innerHTML = `${createPrevistoRealizadoCard('Atividades de Plano de Ação', (dataStore['plano-previsto'] || []).length, (dataStore['plano-realizado'] || []).length, 'plano', null, (dataStore['plano-atrasado-concluido'] || []).length, (dataStore['plano-concluido-antecipado'] || []).length)}${createPrevistoRealizadoCard('Atividades de Adoção', (dataStore['adocao-previsto'] || []).length, (dataStore['adocao-realizado'] || []).length, 'adocao', null, (dataStore['adocao-atrasado-concluido'] || []).length, (dataStore['adocao-concluido-antecipado'] || []).length)}${followupCard}${(selectedSegmento !== 'MID/Enterprise') ? discoveryCard : ''}`;

        let okrHtml = '';
        const labsRealizadoCount = dataStore['ska-labs-realizado-list']?.length || 0;
        const totalLabsBase = dataStore['total-labs-eligible'] || 0;
        const labsRealizadoPerc = totalLabsBase > 0 ? (labsRealizadoCount / totalLabsBase) * 100 : 0;
        const labsRealizadoPerc_comp = dataStore['ska-labs-realizado-list_comp_perc'];
        const labsCard = createOkrCard('Participação SKA LABS (Tri)', labsRealizadoPerc, appGoals.labs, '%', 'ska-labs-realizado-list', labsRealizadoCount, totalLabsBase, labsRealizadoPerc_comp);

        if (selectedSegmento === 'MID/Enterprise') {
            okrHtml = `${createPrevistoRealizadoCard('Reuniões de QBR', (dataStore['reunioes-qbr-previsto'] || []).length, (dataStore['reunioes-qbr-realizado'] || []).length, 'reunioes-qbr', appGoals.qbr, (dataStore['reunioes-qbr-atrasado-concluido'] || []).length, (dataStore['reunioes-qbr-concluido-antecipado'] || []).length)}${createPrevistoRealizadoCard('Planos de Sucesso', (dataStore['planos-sucesso-previsto'] || []).length, (dataStore['planos-sucesso-realizado'] || []).length, 'planos-sucesso', appGoals.successplan, (dataStore['planos-sucesso-atrasado-concluido'] || []).length, (dataStore['planos-sucesso-concluido-antecipado'] || []).length)}${createPrevistoRealizadoCard('Baixo Engajamento (MID/ENT)', (dataStore['baixo-engajamento-mid-previsto'] || []).length, (dataStore['baixo-engajamento-mid-realizado'] || []).length, 'baixo-engajamento-mid', null, (dataStore['baixo-engajamento-mid-atrasado-concluido'] || []).length, (dataStore['baixo-engajamento-mid-concluido-antecipado'] || []).length)}${labsCard}`;
        } else {
            const totalRealizadoSMB = (dataStore['engajamento-smb-realizado'] || []).length + (dataStore['engajamento-smb-atrasado-concluido'] || []).length;
            const previstosSMB = (dataStore['engajamento-smb-previsto'] || []).length;
            const engajados = (dataStore['engajamento-smb-engajado'] || []).length;
            const desengajados = (dataStore['engajamento-smb-desengajado'] || []).length;
            const performancePerc = totalRealizadoSMB > 0 ? (engajados / totalRealizadoSMB) * 100 : 0;
            const realizadoVsPrevistoPerc = previstosSMB > 0 ? (totalRealizadoSMB / previstosSMB) * 100 : 0;

            const cardEngajamento = `<div class="card"><h3>Engajamento (Contato Consolidado)</h3><div class="card-content"><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;"><div><div class="metric" data-metric-id="engajamento-smb-previsto" data-metric-title="Contatos Previstos (SMB)"><span class="metric-label">Previsto:</span><span class="metric-value">${previstosSMB}</span></div><div class="metric" data-metric-id="engajamento-smb-realizado-total" data-metric-title="Total Realizado (SMB)"><span class="metric-label">Realizado:</span><span class="metric-value">${totalRealizadoSMB}</span></div></div><div><div class="metric" data-metric-id="engajamento-smb-engajado" data-metric-title="Total Engajado (SMB)"><span class="metric-label">Engajado:</span><span class="metric-value success">${engajados}</span></div><div class="metric" data-metric-id="engajamento-smb-desengajado" data-metric-title="Total Desengajado (SMB)"><span class="metric-label">Desengajado:</span><span class="metric-value danger">${desengajados}</span></div></div></div><div class="metric" style="border-top: 1px solid var(--border-color); padding-top: 15px;"><span class="metric-label">Performance:</span><span class="metric-value" style="color: ${performancePerc >= appGoals.engagement ? 'var(--secondary-color)' : 'var(--danger-color)'};">${performancePerc.toFixed(1)}% <span class="sub-metric">(Meta: ${appGoals.engagement}%)</span></span></div></div><div class="progress-bar-container" title="Realizado vs. Previsto: ${realizadoVsPrevistoPerc.toFixed(0)}%"><div class="progress-bar"><div class="progress-bar-fill" style="width: ${Math.min(realizadoVsPrevistoPerc, 100)}%;"></div></div><span class="progress-percentage">${realizadoVsPrevistoPerc.toFixed(0)}%</span></div></div>`;
            okrHtml += cardEngajamento;
            if (selectedSegmento === 'SMB CAD') {
                const preenchidos = (dataStore['modelo-negocio-preenchido'] || []).length;
                const faltantes = (dataStore['modelo-negocio-faltante'] || []).length;
                okrHtml += createSimpleCard('Adoção Modelo de Negócio', 'modelo-negocio-preenchido', 'Preenchido', preenchidos, 'modelo-negocio-faltante', 'Faltante', faltantes);
            }
            if (selectedSegmento.includes('SMB')) {
                 const preenchidos = (dataStore['cliente-potencial-preenchido'] || []).length;
                 const faltantes = (dataStore['cliente-potencial-faltante'] || []).length;
                 okrHtml += createSimpleCard('Mapeamento Potencial', 'cliente-potencial-preenchido', 'Mapeado', preenchidos, 'cliente-potencial-faltante', 'Faltante', faltantes);
            }
            okrHtml += labsCard;
        }
        okrGrid.innerHTML = okrHtml;
    }

    function renderNewOnboardingView() {
        const outcomesGrid = document.getElementById('onboarding-outcomes-grid');
        const npsTotal = onboardingDataStore.clientsWithGoLive?.length || 0;
        const npsRespondedCount = onboardingDataStore.npsResponded?.length || 0;
        const goLivesTotal = (onboardingDataStore.goLiveActivitiesConcluded?.length || 0) + (onboardingDataStore.goLiveActivitiesPredicted?.length || 0);

        outcomesGrid.innerHTML = `
            ${createOnboardingStageCard(onboardingDataStore.totalFilteredClients || 0, onboardingDataStore.stageCounts, onboardingDataStore.stageLists || {})}
            ${createOnboardingMetricCard('Go-Lives Realizados e Previstos', 'Total de Go-Lives concluídos e previstos para o mês.', goLivesTotal, `<strong>${onboardingDataStore.goLiveActivitiesConcluded?.length || 0}</strong> realizados, <strong>${onboardingDataStore.goLiveActivitiesPredicted?.length || 0}</strong> previstos.`, 'fa-rocket', 'onb-go-live-combined', [...(onboardingDataStore.goLiveActivitiesConcluded || []), ...(onboardingDataStore.goLiveActivitiesPredicted || [])])}
            ${createOnboardingMetricCard('NPS Pós Go-Live', 'Taxa de resposta dos clientes que tiveram Go-Live.', `${npsRespondedCount}/${npsTotal}`, `responderam`, 'fa-star-half-alt', 'onb-nps-responded', onboardingDataStore.npsResponded || [])}
            ${createOnboardingMetricCard('Tempo Médio de Onboarding', 'Duração média histórica.', `${onboardingDataStore.averageCompletedOnboardingTime || 0} dias`, `baseado em concluídos`, 'fa-check-circle', 'onb-completed-list', onboardingDataStore.completedOnboardingsList || [])}
            ${createTop5OnboardingCard(onboardingDataStore.top5LongestOnboardings || [], onboardingDataStore.clientsOver120Days || [])}
            ${createOnboardingMetricCard('Clientes Onboarding > R$50 mil', 'Clientes com alto valor.', onboardingDataStore.highValueClients?.length || 0, 'clientes', 'fa-dollar-sign', 'onb-high-value', onboardingDataStore.highValueClients || [])}
            <div class="card" id="onboarding-product-chart-card"><h3>Análise por Produto</h3><div class="card-content" style="height: 350px; padding-top: 20px;"><canvas id="onboardingProductChart"></canvas></div></div>
        `;
        renderOnboardingProductChart(onboardingDataStore.productChartData);

        const processGrid = document.getElementById('onboarding-process-grid');
        processGrid.innerHTML = `
            ${createOnboardingProcessCard('SLA: Contato de Welcome', 'Meta: 3 dias', (onboardingDataStore.welcomePrevisto || []).length, (onboardingDataStore.welcomeRealizado || []).length, 'fa-handshake', 'welcome')}
            ${createOnboardingProcessCard('SLA: Reunião Kickoff', 'Meta: 7 dias', (onboardingDataStore.kickoffPrevisto || []).length, (onboardingDataStore.kickoffRealizado || []).length, 'fa-users', 'kickoff')}
            ${createOnboardingProcessCard('Prazo: Planejamento', 'Etapa de planejamento.', (onboardingDataStore.planejamentoPrevisto || []).length, (onboardingDataStore.planejamentoRealizado || []).length, 'fa-clipboard-check', 'planejamento')}
            ${createOnboardingProcessCard('Prazo: Mapear Contatos', 'Etapa de stakeholders.', (onboardingDataStore.mapearContatosPrevisto || []).length, (onboardingDataStore.mapearContatosRealizado || []).length, 'fa-address-book', 'mapearContatos')}
            ${createOnboardingProcessCard('Prazo: Reunião de GO LIVE', 'Oficialização do Go-Live.', (onboardingDataStore.goLiveMeetingPrevisto || []).length, (onboardingDataStore.goLiveMeetingRealizado || []).length, 'fa-calendar-check', 'goLiveMeeting')}
            ${createOnboardingProcessCard('Prazo: Acompanhamento', 'Status reports.', (onboardingDataStore.acompanhamentoPrevisto || []).length, (onboardingDataStore.acompanhamentoRealizado || []).length, 'fa-sync-alt', 'acompanhamento')}
        `;
    }

    function renderPeriodView(periodData, periodName) {
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('period-view').style.display = 'block';
        const avgCoverageCard = createSimpleCard('Média de Cobertura', 'avg-cov', 'Média Mensal', `${periodData.averageCoverage.toFixed(1)}%`, 'total-unique', 'Clientes Únicos', periodData.totalUniqueClients);
        
        let playbookCardsHtml = '';
        const playbookTitles = {'plano': 'Planos de Ação', 'adocao': 'Adoção', 'followup': 'Follow-Up', 'discovery': 'Discovery', 'reunioes-qbr': 'Reuniões de QBR', 'planos-sucesso': 'Planos de Sucesso', 'engajamento-smb': 'Engajamento', 'baixo-engajamento-mid': 'Baixo Engajamento'};
        for (const key in playbookTitles) {
            const data = periodData.playbookTotals[key];
            if (data && (data.previsto > 0 || data.realizado > 0)) {
                playbookCardsHtml += createSimpleCard(`Total: ${playbookTitles[key]}`, `p-${key}-prev`, 'Previsto', data.previsto, `p-${key}-real`, 'Realizado', data.realizado);
            }
        }
        document.getElementById('period-view').innerHTML = `<div class="metric-group"><h2 class="group-title">Resumo do Período: ${periodName}</h2><div class="group-content">${avgCoverageCard}${playbookCardsHtml}</div></div>`;
    }

    function renderOverdueView(overdueMetrics) {
        if (!overdueMetrics) overdueMetrics = { overdueActivities: {} };
        const overdueGrid = document.getElementById('overdue-grid-container');
        let html = '';
        const playbookTitles = { 'plano': 'Planos de Ação', 'adocao': 'Atividades de Adoção', 'followup': 'Follow-Up', 'discovery': 'Discovery', 'reunioes-qbr': 'Reuniões de QBR', 'planos-sucesso': 'Planos de Sucesso', 'engajamento-smb': 'Engajamento', 'baixo-engajamento-mid': 'Baixo Engajamento' };
        let totalOverdue = 0;
        for (const key in playbookTitles) {
            const activities = overdueMetrics.overdueActivities[key] || [];
            totalOverdue += activities.length;
            if (activities.length > 0) {
                onboardingDataStore[`overdue-${key}`] = activities;
                html += `<div class="card"><h3>${playbookTitles[key]}</h3><div class="card-content"><div class="metric overdue-metric" style="border-top: none; margin-top: 0; padding-top: 0;" data-metric-id="overdue-${key}" data-metric-title="Atrasadas: ${playbookTitles[key]}"><span class="metric-label"><i class="fas fa-exclamation-triangle"></i> Total Atrasado:</span><span class="metric-value danger" style="font-size: 2rem;">${activities.length}</span></div></div></div>`;
            }
        }
        if (totalOverdue === 0) overdueGrid.innerHTML = `<div class="loader" style="color: var(--secondary-color); border-color: var(--secondary-color);"><i class="fas fa-check-circle" style="margin-right: 10px;"></i>Nenhuma atividade atrasada!</div>`;
        else overdueGrid.innerHTML = html;
    }

    // --- CARD FACTORY FUNCTIONS ---
    const createOkrCard = (title, value, goal, unit = '', metricId, cv = null, gv = null, comp = null, miss = null, distHtml = '') => {
        const perc = goal > 0 ? (value / goal) * 100 : 0;
        let valText = (cv !== null) ? (gv !== null ? `${cv} de ${gv} <span class="sub-metric">(${value.toFixed(1)}%)</span>` : `${cv}${unit}`) : `${unit === '%' ? value.toFixed(1) : value.toFixed(0)}${unit}`;
        let missHtml = (miss !== null && miss > 0) ? `<div class="metric overdue-metric"><span class="metric-label">Para a Meta:</span><span class="metric-value">${Math.ceil((dataStore['total-clientes-unicos-cs'] || 0) * (appGoals.coverage/100))} clientes (${miss} faltantes)</span></div>` : '';
        let trendHtml = (comp !== null) ? `<span class="trend-indicator ${value - comp > 0 ? 'trend-positive' : 'trend-negative'}">${(value - comp).toFixed(1)}pp</span>` : '';
        const trendBtn = currentUser.isManager ? `<button class="trend-chart-button" data-metric-id="${metricId}" data-metric-title="${title}" data-metric-type="okr"><i class="fas fa-chart-line"></i></button>` : '';
        return `<div class="card"><h3>${title}${trendBtn}</h3><div class="card-content"><div class="metric" data-metric-id="${metricId}" data-metric-title="${title}"><span class="metric-label">Meta: ${goal}${unit}</span><span class="metric-value">${valText}${trendHtml}</span></div>${missHtml}${distHtml}</div><div class="progress-bar-container"><div class="progress-bar"><div class="progress-bar-fill" style="width: ${Math.min(perc, 100)}%;"></div></div><span class="progress-percentage">${perc.toFixed(0)}%</span></div></div>`;
    };

    const createPrevistoRealizadoCard = (title, prev, real, id, goal = null, overdue = 0, ante = 0) => {
        const totalReal = real + overdue + ante;
        const totalProg = totalReal + prev;
        const perc = totalProg > 0 ? (totalReal / totalProg) * 100 : (totalReal > 0 ? 100 : 0);
        let metaHtml = (goal !== null && currentUser.isManager) ? `<div class="metric"><span class="metric-label">Meta:</span><span class="metric-value">${goal}</span></div>` : '';
        let anteHtml = ante > 0 ? `<div class="metric" data-metric-id="${id}-concluido-antecipado" data-metric-title="${title} (Antecipado)"><span class="metric-label">Antecipado:</span><span class="metric-value success">${ante}</span></div>` : '';
        let overHtml = overdue > 0 ? `<div class="metric overdue-metric" data-metric-id="${id}-atrasado-concluido" data-metric-title="${title} (Atraso)"><span class="metric-label">Atraso:</span><span class="metric-value">${overdue}</span></div>` : '';
        const trendBtn = currentUser.isManager ? `<button class="trend-chart-button" data-metric-id="${id}" data-metric-title="${title}" data-metric-type="playbook"><i class="fas fa-chart-line"></i></button>` : '';
        return `<div class="card"><h3>${title}${trendBtn}</h3><div class="card-content"><div class="metric" data-metric-id="${id}-realizado" data-metric-title="${title} (No Prazo)"><span class="metric-label">Realizado (Prazo):</span><span class="metric-value success">${real}</span></div>${anteHtml}${overHtml}<div class="metric" data-metric-id="${id}-previsto" data-metric-title="${title} (Pendentes)"><span class="metric-label">Pendentes:</span><span class="metric-value">${prev}</span></div>${metaHtml}</div><div class="progress-bar-container"><div class="progress-bar"><div class="progress-bar-fill" style="width: ${Math.min(perc, 100)}%;"></div></div><span class="progress-percentage">${perc.toFixed(0)}%</span></div></div>`;
    };

    const createSimpleCard = (title, id1, l1, v1, id2, l2, v2) => {
        let m2 = id2 ? `<div class="metric" data-metric-id="${id2}" data-metric-title="${l2}"><span class="metric-label">${l2}:</span><span class="metric-value">${v2}</span></div>` : '';
        return `<div class="card"><h3>${title}</h3><div class="card-content"><div class="metric" data-metric-id="${id1}" data-metric-title="${l1}"><span class="metric-label">${l1}:</span><span class="metric-value">${v1}</span></div>${m2}</div></div>`;
    };

    const createOnboardingMetricCard = (title, sub, val, det = '', icon, id = null, data = []) => {
        if(id) onboardingDataStore[id] = data;
        return `<div class="card" ${id ? `data-metric-id="${id}" data-metric-title="${title}" style="cursor:pointer"` : ''}><h3>${title}</h3><p style="font-style:italic;font-size:0.9rem;color:#888;margin:-10px 0 10px 0">${sub}</p><div class="card-content"><div class="metric"><span class="metric-value" style="font-size:2.5rem">${val}</span>${det?`<span class="metric-label" style="text-align:right">${det}</span>`:''}</div></div></div>`;
    };

    const createTop5OnboardingCard = (list, overdue) => {
        const lis = list.length > 0 ? list.map(i => `<li><span class="client-name">${i.Cliente}</span> <span class="duration">${i.onboardingDuration} dias</span></li>`).join('') : '<li>Sem dados</li>';
        onboardingDataStore['onb-over-120-days'] = overdue;
        return `<div class="card"><h3>Análise de Onboardings</h3><div class="card-content"><h4 style="margin:0 0 5px 0">Top 5 Tempo:</h4><ol class="onboarding-top5-list">${lis}</ol>${overdue.length > 0 ? `<button class="view-overdue-btn" data-metric-id="onb-over-120-days" data-metric-title="> 120 dias">Ver ${overdue.length} Clientes > 120 dias</button>` : ''}</div></div>`;
    };

    const createOnboardingProcessCard = (title, sub, prev, real, icon, idPrefix) => {
        const slaOkList = onboardingDataStore[`${idPrefix}SLAOk`];
        const anteList = onboardingDataStore[`${idPrefix}Antecipado`] || [];
        const atrasoList = onboardingDataStore[`${idPrefix}RealizadoAtrasado`] || [];
        const isSla = slaOkList !== undefined;
        let content = '';
        let totalConcluido = real + anteList.length + atrasoList.length; 
        
        if(isSla) {
            const realOk = slaOkList.length;
            const realFora = (onboardingDataStore[`${idPrefix}RealizadoForaPrazo`] || []).length;
            totalConcluido = realOk + realFora + anteList.length;
            content = `<div class="metric" data-metric-id="${idPrefix}Previsto" data-metric-title="Pendentes"><span class="metric-label">Pendentes:</span><span class="metric-value">${prev}</span></div><div class="metric" data-metric-id="${idPrefix}SLAOk" data-metric-title="No SLA"><span class="metric-label">No Prazo:</span><span class="metric-value success">${realOk}</span></div><div class="metric" data-metric-id="${idPrefix}RealizadoForaPrazo" data-metric-title="Fora SLA"><span class="metric-label">Fora Prazo:</span><span class="metric-value danger">${realFora}</span></div>`;
        } else {
             content = `<div class="metric" data-metric-id="${idPrefix}Previsto" data-metric-title="Pendentes"><span class="metric-label">Pendentes:</span><span class="metric-value">${prev}</span></div><div class="metric" data-metric-id="${idPrefix}Realizado" data-metric-title="Realizado"><span class="metric-label">Realizado (Prazo):</span><span class="metric-value success">${real}</span></div>${atrasoList.length > 0 ? `<div class="metric" data-metric-id="${idPrefix}RealizadoAtrasado" data-metric-title="Atrasado"><span class="metric-label">Atrasado:</span><span class="metric-value danger">${atrasoList.length}</span></div>` : ''}`;
        }
        const total = totalConcluido + prev;
        const perc = total > 0 ? (totalConcluido/total)*100 : (totalConcluido > 0 ? 100 : 0);
        return `<div class="card"><h3>${title}</h3><p style="font-style:italic;font-size:0.9rem;color:#888;margin:-10px 0 10px 0">${sub}</p><div class="card-content">${content}</div><div class="progress-bar-container"><div class="progress-bar"><div class="progress-bar-fill" style="width:${Math.min(perc, 100)}%"></div></div><span class="progress-percentage">${perc.toFixed(0)}%</span></div></div>`;
    };

    const createOnboardingStageCard = (total, counts, lists) => {
        if(!counts) return '';
        const stages = [{id:'preGoLive',t:'Pré GO LIVE',i:'fa-flag'},{id:'execucao',t:'Execução',i:'fa-cog'},{id:'inicio',t:'Início',i:'fa-play'},{id:'backlog',t:'Backlog',i:'fa-box'}];
        stages.forEach(s => onboardingDataStore[`onb-stage-${s.id}`] = lists[s.id]||[]);
        const html = stages.map(s => `<div class="metric" data-metric-id="onb-stage-${s.id}" data-metric-title="${s.t}" style="cursor:pointer"><span class="metric-label"><i class="fas ${s.i}"></i> ${s.t}:</span><span class="metric-value">${counts[s.id]||0}</span></div>`).join('');
        return `<div class="card"><h3>Clientes em Onboarding</h3><div class="card-content"><div class="metric" style="border-bottom:1px solid #eee;margin-bottom:10px"><span class="metric-label">Total:</span><span class="metric-value" style="font-size:2.2rem;color:var(--primary-color)">${total}</span></div>${html}</div></div>`;
    };

    // --- INIT ---
    async function initializeDashboard() {
        if (window.__dashboardInitialized) {
            return;
        }
        window.__dashboardInitialized = true;
        const storedVersion = localStorage.getItem('appVersion');
        if (storedVersion !== APP_VERSION) {
            await forceClearAllData(false);
            localStorage.setItem('appVersion', APP_VERSION);
            window.location.reload();
            return;
        }
        document.getElementById('app-version-marker').textContent = `Versão: ${APP_VERSION}`;
        
        const userInfoCard = document.getElementById('user-info-card');
        if (currentUser.name) {
            document.getElementById('user-info-text').innerHTML = `<i class="fas fa-user-check" style="margin-right: 8px; color: var(--secondary-color);"></i> ${currentUser.name}`;
            if (currentUser.isManager) userInfoCard.insertAdjacentHTML('beforeend', '<span class="admin-badge">Login ADM</span>');
            userInfoCard.style.display = 'flex';
        }
        document.getElementById('logout-button').addEventListener('click', logout);

        const themeToggle = document.getElementById('theme-toggle');
        const applyTheme = (isLight) => {
            if (isLight) { document.body.classList.add('light-theme'); localStorage.setItem('theme', 'light'); }
            else { document.body.classList.remove('light-theme'); localStorage.setItem('theme', 'dark'); }
        };
        themeToggle.addEventListener('change', () => {
            applyTheme(themeToggle.checked);
            if(dataStore['contatos-por-negocio']) renderOKRs(); // Redesenha para pegar cores novas
        });
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') { themeToggle.checked = true; applyTheme(true); } else { themeToggle.checked = false; applyTheme(false); }

        setupUserView();
        loadGoals();

        const cachedSnapshot = await restoreCachedDataIfAvailable();
        const snapshotAge = cachedSnapshot ? getSnapshotAgeMinutes(cachedSnapshot.storedAt) : null;
        const shouldBackgroundRefresh = !cachedSnapshot || snapshotAge === null || snapshotAge >= SNAPSHOT_AUTO_REFRESH_MINUTES;
        if (shouldBackgroundRefresh) {
            const silentRefresh = Boolean(cachedSnapshot);
            setTimeout(() => {
                loadDataFromAPI({ silent: silentRefresh }).catch((error) => console.error('Atualização automática falhou', error));
            }, silentRefresh ? 800 : 0);
        }
        
        // EVENTOS DE UI
        const inputs = ['select-cs', 'select-squad', 'select-segmento', 'select-month', 'select-year', 'include-onboarding-toggle', 'select-comparison', 'select-period', 'select-onboarding-team', 'select-ism'];
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('change', () => {
                if(id === 'select-squad' && currentUser.isManager) {
                    const val = document.getElementById(id).value;
                    const selCS = document.getElementById('select-cs');
                    if(val !== 'Todos') {
                        selCS.value = 'Todos'; selCS.disabled = true;
                        const csInSquad = Object.entries(filterDataCache.csToSquadMap || {}).filter(([k,v]) => v === val).map(([k]) => k);
                        document.getElementById('squad-cs-list').textContent = `CSs: ${csInSquad.join(', ')}`;
                    } else {
                        selCS.disabled = false;
                        document.getElementById('squad-cs-list').textContent = '';
                    }
                }
                if(id === 'select-cs') {
                    const csVal = document.getElementById('select-cs').value;
                    if(csVal !== 'Todos') {
                        const fil = (document.getElementById('include-onboarding-toggle').checked ? rawClients : rawClients.filter(c => normalizeText(c.Fase) !== 'onboarding')).filter(d => d.CS?.trim() === csVal);
                        autoSelectSegment(fil);
                    }
                }
                if(id === 'select-onboarding-team') updateIsmFilter();
                triggerCalculations();
            });
        });

        document.querySelector('.tabs').addEventListener('click', (e) => {
            if (e.target.matches('.tab-button')) {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById(e.target.dataset.tab).classList.add('active');
                if (e.target.dataset.tab === 'data-view') renderDataTables();
            }
        });

        document.body.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.activity-delete-btn');
            if (deleteBtn) {
                const activityId = deleteBtn.dataset.activityId;
                if (!activityId) return;
                if (!confirm('Remover esta atividade do espelho local?')) return;
                deleteBtn.disabled = true;
                deleteBtn.classList.add('loading');
                fetch(`${WORKER_URL}/api/delete-atividade?id=${encodeURIComponent(activityId)}`, { method: 'POST' })
                    .then(res => res.json())
                    .then(res => {
                        if (res.success && res.deleted) {
                            const row = deleteBtn.closest('tr');
                            if (row) row.remove();
                        } else {
                            alert(res.error || 'Não foi possível remover esta atividade.');
                            deleteBtn.disabled = false;
                            deleteBtn.classList.remove('loading');
                        }
                    })
                    .catch(() => {
                        alert('Erro ao comunicar com o servidor. Tente novamente.');
                        deleteBtn.disabled = false;
                        deleteBtn.classList.remove('loading');
                    });
                return;
            }
            const metricEl = e.target.closest('[data-metric-id]');
            if(metricEl) showDetailsModal(metricEl.dataset.metricId, metricEl.dataset.metricTitle);
            const trigger = e.target.closest('span.client-activity-trigger');
            if(trigger) showAnotacaoModal(trigger.dataset.anotacao);
            const trendBtn = e.target.closest('.trend-chart-button');
            if(trendBtn) { e.preventDefault(); showTrendChart(trendBtn.dataset.metricId, trendBtn.dataset.metricTitle, trendBtn.dataset.metricType); }
        });

        document.getElementById('settings-button').addEventListener('click', () => { loadGoals(); showModal(document.getElementById('settings-modal')); });
        document.getElementById('save-settings-button').addEventListener('click', saveGoals);
        document.querySelectorAll('.modal .close-button').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal'))));
        window.addEventListener('click', (e) => { if(e.target.classList.contains('modal')) closeModal(e.target); });
        document.getElementById('bulk-export-button').addEventListener('click', () => {
             const csSet = filterDataCache.csSet || new Set();
             const list = document.getElementById('cs-selection-list');
             list.innerHTML = '';
             [...csSet].sort().forEach(cs => { list.innerHTML += `<div class="cs-item"><label><input type="checkbox" class="cs-checkbox" value="${cs}" checked> ${cs}</label></div>`; });
             showModal(document.getElementById('bulk-export-modal'));
        });

        const divergenceMarker = document.getElementById('divergence-marker');
        if (divergenceMarker) {
            const openDivergenceDetails = () => {
                const divergentList = dataStore['divergent-activities'] || [];
                if (!divergentList.length) {
                    alert('Nenhuma atividade divergente disponível para exibir no momento.');
                    return;
                }
                showDataInModal(divergentList, 'Atividades para Clientes Fora da Carteira');
            };
            divergenceMarker.addEventListener('click', openDivergenceDetails);
            divergenceMarker.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openDivergenceDetails();
                }
            });
        }
    }
    
    // ============================================================
    //  6. FUNÇÕES DE APOIO E EXPORTAÇÃO
    // ============================================================

    function normalizeText(str = '') { return String(str).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }

    function updateIsmFilter() {
        const teamView = document.getElementById('select-onboarding-team').value;
        const cachedIsmSet = filterDataCache?.ismSet;
        const fallbackIsmSet = new Set(rawClients.map(c => c.ISM).filter(Boolean));
        const ismSet = cachedIsmSet && cachedIsmSet.size ? cachedIsmSet : fallbackIsmSet;
        if (!ismSet || ismSet.size === 0) return;
        const onboardingClients = rawClients.filter(c => normalizeText(c.Fase) === 'onboarding');
        let relevantClients = [];
        if (teamView === 'syneco') relevantClients = onboardingClients.filter(c => normalizeText(c.Cliente).includes('syneco'));
        else if (teamView === 'outros') relevantClients = onboardingClients.filter(c => !normalizeText(c.Cliente).includes('syneco'));
        else relevantClients = onboardingClients;
        const relevantIsmSet = new Set(relevantClients.map(c => c.ISM).filter(Boolean));
        const selectISM = document.getElementById('select-ism');
        selectISM.innerHTML = '<option value="Todos">Todos os ISMs</option>';
        [...relevantIsmSet].sort().forEach(ism => { const option = document.createElement('option'); option.value = ism; option.textContent = ism; selectISM.appendChild(option); });
    }

    function populateFilters() {
        const { csSet = new Set(), squadSet = new Set(), years = [] } = filterDataCache || {};
        const selectCS = document.getElementById('select-cs');
        const selectSquad = document.getElementById('select-squad');
        const selectMonth = document.getElementById('select-month');
        const selectYear = document.getElementById('select-year');
        const selectSegmento = document.getElementById('select-segmento');

        selectCS.innerHTML = ''; if (currentUser.isManager) selectCS.innerHTML += '<option value="Todos">Todos os CS</option>';
        [...csSet].sort().forEach(cs => { const option = document.createElement('option'); option.value = cs; option.textContent = cs; selectCS.appendChild(option); });
        
        if (currentUser.isManager) {
            selectSquad.innerHTML = '<option value="Todos">Todos os Squads</option>';
            [...squadSet].sort().forEach(squad => { const option = document.createElement('option'); option.value = squad; option.textContent = squad; selectSquad.appendChild(option); });
        }

        updateIsmFilter();

        if (!currentUser.isManager) {
            if (currentUser.userGroup === 'ongoing') {
                let foundCS = null;
                if ([...csSet].includes(currentUser.name)) foundCS = currentUser.name;
                else if (manualEmailToCsMap[currentUser.email]) foundCS = manualEmailToCsMap[currentUser.email];
                if (foundCS) selectCS.value = foundCS;
            } else if (currentUser.userGroup === 'onboarding') {
                const mappedISM = currentUser.selectedISM;
                if (mappedISM) document.getElementById('select-ism').value = mappedISM;
            }
        }

        const segments = ["SMB CAD", "SMB Multiprodutos", "MID/Enterprise"];
        selectSegmento.innerHTML = '';
        segments.forEach(seg => { const option = document.createElement('option'); option.value = seg; option.textContent = seg; selectSegmento.appendChild(option); });

        const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        selectMonth.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
        const sortedYears = [...years].sort((a, b) => b - a);
        selectYear.innerHTML = sortedYears.map(y => `<option value="${y}">${y}</option>`).join('');
        const today = new Date();
        selectMonth.value = today.getMonth();
        if (sortedYears.includes(today.getFullYear())) selectYear.value = today.getFullYear();
    }

    function autoSelectSegment(clients) {
        if (!clients || clients.length === 0) return;
        let mid = 0, smb = 0;
        clients.forEach(c => {
            const seg = normalizeText(c.Segmento || '');
            if (seg === 'mid-market' || seg === 'enterprise') mid++;
            else if (seg.includes('smb')) smb++;
        });
        document.getElementById('select-segmento').value = (mid > smb) ? 'MID/Enterprise' : 'SMB CAD'; 
    }

    function applyFilterLocks() {
        const els = ['select-squad', 'select-segmento', 'select-month', 'select-year', 'include-onboarding-toggle', 'select-period'].map(id => document.getElementById(id));
        els.forEach(el => el.disabled = false);
        const selectCS = document.getElementById('select-cs');
        const selectISM = document.getElementById('select-ism');
        const selectTeam = document.getElementById('select-onboarding-team');

        if (currentUser.isManager) {
            selectCS.disabled = false; selectISM.disabled = false; selectTeam.disabled = false;
        } else {
            if (currentUser.userGroup === 'ongoing') {
                selectCS.disabled = true; selectISM.disabled = false; selectTeam.disabled = false;
            } else if (currentUser.userGroup === 'onboarding') {
                selectCS.disabled = true; selectISM.disabled = true; selectTeam.disabled = true;
            }
        }
    }

    function triggerCalculations() {
        if (!dataWorker) return;
        const period = document.getElementById('select-period').value;
        const filters = {
            month: parseInt(document.getElementById('select-month').value, 10),
            year: parseInt(document.getElementById('select-year').value, 10),
            selectedCS: document.getElementById('select-cs').value,
            selectedSquad: document.getElementById('select-squad').value,
            includeOnboarding: document.getElementById('include-onboarding-toggle').checked,
            comparison: document.getElementById('select-comparison').value,
            segmento: document.getElementById('select-segmento').value,
            teamView: document.getElementById('select-onboarding-team').value,
            selectedISM: document.getElementById('select-ism').value,
            goals: appGoals
        };

        if (period === 'monthly') {
            document.getElementById('status-message').style.display = 'block';
            document.getElementById('status-message').textContent = 'Calculando...';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('period-view').style.display = 'none';
            dataWorker.postMessage({ type: 'CALCULATE_MONTHLY', payload: filters });
        } else {
            document.getElementById('status-message').style.display = 'block';
            document.getElementById('status-message').textContent = 'Calculando Período...';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('period-view').style.display = 'none';
            dataWorker.postMessage({ type: 'CALCULATE_PERIOD', payload: { ...filters, period } });
        }
    }

    function setupUserView() {
        const tabs = {
            dash: document.querySelector('[data-tab="dashboard-view"]'),
            onb: document.querySelector('[data-tab="onboarding-view"]'),
            overdue: document.querySelector('[data-tab="overdue-view"]'),
            data: document.querySelector('[data-tab="data-view"]')
        };
        const contents = { dash: document.getElementById('dashboard-view'), onb: document.getElementById('onboarding-view') };
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        if (currentUser.userGroup === 'admin') {
            Object.values(tabs).forEach(t => t.style.display = 'block');
            tabs.dash.classList.add('active'); contents.dash.classList.add('active');
        } else if (currentUser.userGroup === 'onboarding') {
            tabs.dash.style.display = 'none'; tabs.overdue.style.display = 'none'; tabs.data.style.display = 'none';
            tabs.onb.style.display = 'block';
            tabs.onb.classList.add('active'); contents.onb.classList.add('active');
        } else {
            tabs.onb.style.display = 'none';
            tabs.dash.style.display = 'block'; tabs.overdue.style.display = 'block'; tabs.data.style.display = 'block';
            tabs.dash.classList.add('active'); contents.dash.classList.add('active');
        }
    }

    function renderPaginatedTable(tId, pId, data, limit=100, columnOrder=null) {
        const tCon = document.getElementById(tId);
        const pCon = document.getElementById(pId);
        if(!tCon) return;
        let curr = 1;
        const total = Math.ceil(data.length / limit);
        const render = () => {
            tCon.innerHTML = createHtmlTable(data.slice((curr-1)*limit, curr*limit), { columnOrder });
            pCon.innerHTML = `<button id="${pId}-p" ${curr===1?'disabled':''}>&lt;</button> <span>${curr}/${total||1}</span> <button id="${pId}-n" ${curr===total||total===0?'disabled':''}>&gt;</button>`;
            document.getElementById(`${pId}-p`).onclick = () => { if(curr>1) { curr--; render(); } };
            document.getElementById(`${pId}-n`).onclick = () => { if(curr<total) { curr++; render(); } };
        };
        render();
    }

    function filterActivitiesDataset() {
        const filters = dataTableFilters.atividades;
        const searchTerm = normalizeText(filters.search || '');
        const csFilter = normalizeText(filters.cs || '');
        const startDate = filters.start ? new Date(filters.start) : null;
        const endDate = filters.end ? new Date(filters.end) : null;
        const startTs = startDate ? Date.UTC(startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), 0, 0, 0) : null;
        const endTs = endDate ? Date.UTC(endDate.getFullYear(), endDate.getMonth(), endDate.getDate(), 23, 59, 59) : null;

        return rawActivities.filter(activity => {
            const activityCSNorm = normalizeText(activity.CS || '');
            if (csFilter && activityCSNorm !== csFilter) return false;
            const createdAt = activity["Criado em"] instanceof Date ? activity["Criado em"] : (activity.CriadoEm instanceof Date ? activity.CriadoEm : null);
            if (startTs && (!createdAt || createdAt.getTime() < startTs)) return false;
            if (endTs && (!createdAt || createdAt.getTime() > endTs)) return false;
            if (searchTerm) {
            const haystack = [
                activity.Cliente,
                activity.Atividade,
                activity.Playbook,
                activity["Status Cliente"],
                activity["Anotações"]
            ].map(val => normalizeText(val || '')).join(' ');
                if (!haystack.includes(searchTerm)) return false;
            }
            return true;
        });
    }

    function filterClientsDataset() {
        const filters = dataTableFilters.clientes;
        const searchTerm = normalizeText(filters.search || '');
        const csFilter = normalizeText(filters.cs || '');
        const statusFilter = normalizeText(filters.status || '');
        return rawClients.filter(client => {
            const clientCS = normalizeText(client.CS || '');
            if (csFilter && clientCS !== csFilter) return false;
            const clientStatus = normalizeText(client.Status || client['Status Cliente'] || '');
            if (statusFilter && clientStatus !== statusFilter) return false;
            if (searchTerm) {
                const haystack = [
                    client.Cliente,
                    client.Segmento,
                    client.Status,
                    client['Status Cliente'],
                    client['Modelo de negócio'],
                    client['Potencial']
                ].map(val => normalizeText(val || '')).join(' ');
                if (!haystack.includes(searchTerm)) return false;
            }
            return true;
        });
    }

    function renderDataTables() {
        const filteredActivities = filterActivitiesDataset();
        const filteredClients = filterClientsDataset();
        renderPaginatedTable('atividades-table', 'atividades-pagination', filteredActivities, 100, ACTIVITY_COLUMN_ORDER);
        renderPaginatedTable('clientes-table', 'clientes-pagination', filteredClients, 100, CLIENT_COLUMN_ORDER);
    }

    const debouncedRenderDataTables = debounce(() => renderDataTables(), 200);

    function initializeDataTableFilterOptions() {
        const atividadesCsSelect = document.getElementById('atividades-cs-filter');
        const clientesCsSelect = document.getElementById('clientes-cs-filter');
        const clientesStatusSelect = document.getElementById('clientes-status-filter');
        const csValues = [...new Set(rawClients.map(client => client.CS).filter(Boolean))].sort((a, b) => a.localeCompare(b));
        const statusValues = [...new Set(rawClients.map(client => client.Status || client['Status Cliente']).filter(Boolean))].sort((a, b) => a.localeCompare(b));
        const atividadesSearch = document.getElementById('atividades-search');
        const atividadesStart = document.getElementById('atividades-date-start');
        const atividadesEnd = document.getElementById('atividades-date-end');
        const clientesSearch = document.getElementById('clientes-search');

        if (atividadesCsSelect) {
            atividadesCsSelect.innerHTML = '<option value="">Todos os CS</option>';
            csValues.forEach(cs => {
                const option = document.createElement('option');
                option.value = cs;
                option.textContent = cs;
                atividadesCsSelect.appendChild(option);
            });
            atividadesCsSelect.value = dataTableFilters.atividades.cs || '';
        }
        if (clientesCsSelect) {
            clientesCsSelect.innerHTML = '<option value="">Todos os CS</option>';
            csValues.forEach(cs => {
                const option = document.createElement('option');
                option.value = cs;
                option.textContent = cs;
                clientesCsSelect.appendChild(option);
            });
            clientesCsSelect.value = dataTableFilters.clientes.cs || '';
        }
        if (clientesStatusSelect) {
            clientesStatusSelect.innerHTML = '<option value="">Todos os status</option>';
            statusValues.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                clientesStatusSelect.appendChild(option);
            });
            clientesStatusSelect.value = dataTableFilters.clientes.status || '';
        }
        if (atividadesSearch) atividadesSearch.value = dataTableFilters.atividades.search || '';
        if (atividadesStart) atividadesStart.value = dataTableFilters.atividades.start || '';
        if (atividadesEnd) atividadesEnd.value = dataTableFilters.atividades.end || '';
        if (clientesSearch) clientesSearch.value = dataTableFilters.clientes.search || '';

        if (!dataTableFiltersInitialized) {
            dataTableFiltersInitialized = true;
            atividadesSearch?.addEventListener('input', (e) => {
                dataTableFilters.atividades.search = e.target.value;
                debouncedRenderDataTables();
            });
            atividadesCsSelect?.addEventListener('change', (e) => {
                dataTableFilters.atividades.cs = e.target.value;
                renderDataTables();
            });
            atividadesStart?.addEventListener('change', (e) => {
                dataTableFilters.atividades.start = e.target.value;
                renderDataTables();
            });
            atividadesEnd?.addEventListener('change', (e) => {
                dataTableFilters.atividades.end = e.target.value;
                renderDataTables();
            });
            clientesSearch?.addEventListener('input', (e) => {
                dataTableFilters.clientes.search = e.target.value;
                debouncedRenderDataTables();
            });
            clientesCsSelect?.addEventListener('change', (e) => {
                dataTableFilters.clientes.cs = e.target.value;
                renderDataTables();
            });
            clientesStatusSelect?.addEventListener('change', (e) => {
                dataTableFilters.clientes.status = e.target.value;
                renderDataTables();
            });
        }
    }

    function loadGoals() {
        const g = localStorage.getItem('dashboardOKRsGoals');
        appGoals = g ? JSON.parse(g) : { ...defaultGoals };
        Object.keys(appGoals).forEach(k => { const i = document.getElementById(`goal-${k}`); if(i) i.value = appGoals[k]; });
    }

    function saveGoals() {
        Object.keys(defaultGoals).forEach(k => { const i = document.getElementById(`goal-${k}`); if(i) appGoals[k] = parseFloat(i.value) || defaultGoals[k]; });
        localStorage.setItem('dashboardOKRsGoals', JSON.stringify(appGoals));
        alert('Metas salvas.');
        document.getElementById('settings-modal').style.display = 'none';
        triggerCalculations();
    }

    if (window.__pendingDashboardBootstrap && window.currentUser?.email) {
        window.__pendingDashboardBootstrap = false;
        initializeDashboard();
    }
    
    </script>
    
    <script type="text/javascript">
    var Tawk_API = Tawk_API || {}, Tawk_LoadStart = new Date();
    (function() {
        var s1 = document.createElement("script"), s0 = document.getElementsByTagName("script")[0];
        s1.async = true;
        s1.src = 'https://embed.tawk.to/6862f529ad6c8f190c6f8c38/1iv18rasf';
        s1.charset = 'UTF-8';
        s1.setAttribute('crossorigin', '*');
        s0.parentNode.insertBefore(s1, s0);
    })();
    </script>

</body>
</html>










