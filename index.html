<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de OKRs - CS (Autom√°tico)</title>
    <link rel="icon" type="image/png" href="icone.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app-version-marker"></div>
    
    <div id="login-container">
        <h1>Dashboard de OKRs</h1>
        <p>Por favor, fa√ßa login com sua conta Google para acessar os dados de performance.</p>
        <div id="g_id_onload" data-client_id="232267534625-oju4j8ob02rn6tim24tcdas26c5rh3j4.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
        <button id="force-clear-button" style="background: none; border: 1px solid var(--border-color); color: #888; padding: 10px 20px; margin-top: 30px; border-radius: 8px; cursor: pointer; font-family: sans-serif; font-size: 0.9rem; transition: all 0.3s ease;">
            <i class="fas fa-sync-alt" style="margin-right: 8px;"></i> Problemas para acessar? Limpar dados
        </button>
    </div>

    <div id="dashboard-wrapper" style="display: none;">
        <div class="container">
            <header>
                <div id="user-info-card" style="display: none;">
                    <span id="user-info-text"></span>
                    <button id="logout-button" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
                </div>
                <h1>Dashboard de OKRs</h1>
                <p>Avalia√ß√£o de Resultados e Performance</p>
                <div id="last-load-info" style="display: none;"></div>
                <div class="header-actions">
                    <div class="theme-switcher">
                        <i class="fas fa-sun"></i>
                        <label class="switch"><input type="checkbox" id="theme-toggle"><span class="slider"></span></label>
                        <i class="fas fa-moon"></i>
                    </div>
                    <button id="bulk-export-button" title="Exportar Relat√≥rios em Lote"><i class="fas fa-file-export"></i></button>
                    <button id="export-html-button" title="Exportar Relat√≥rio HTML"><i class="fas fa-file-invoice"></i></button>
                    <button id="export-csv-button" title="Exportar Resumo para CSV"><i class="fas fa-file-csv"></i></button>
                    <button id="settings-button" title="Configurar Metas"><i class="fas fa-cog"></i></button>
                </div>
            </header>

            <section class="controls">
                <div class="control-group">
                    <label style="color: var(--secondary-color); font-weight: bold;"><i class="fas fa-database"></i> Conex√£o SenseData</label>
                    <button id="btn-refresh-data" onclick="window.loadDataFromAPI()" style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                        <i class="fas fa-sync-alt"></i> Atualizar Agora
                    </button>
                </div>
                <div class="control-group">
                    <label for="select-period"><i class="fas fa-calendar-check"></i> An√°lise de Per√≠odo</label>
                    <select id="select-period">
                        <option value="monthly" selected>Mensal</option>
                        <option value="q1">1¬∫ Trimestre</option>
                        <option value="q2">2¬∫ Trimestre</option>
                        <option value="q3">3¬∫ Trimestre</option>
                        <option value="q4">4¬∫ Trimestre</option>
                        <option value="s1">1¬∫ Semestre</option>
                        <option value="s2">2¬∫ Semestre</option>
                        <option value="year">Ano Inteiro</option>
                    </select>
                </div>
                <div class="control-group"><label for="select-year"><i class="fas fa-calendar-week"></i> Ano</label><select id="select-year"></select></div>
                <div class="control-group"><label for="select-month"><i class="fas fa-calendar-alt"></i> M√™s</label><select id="select-month"></select></div>
                <div class="control-group"><label for="select-cs"><i class="fas fa-user-tie"></i> CS</label><select id="select-cs" disabled><option>Aguardando...</option></select></div>
                <div id="squad-filter-group" class="control-group">
                    <label for="select-squad"><i class="fas fa-users"></i> Squad</label>
                    <select id="select-squad" disabled><option>Aguardando...</option></select>
                </div>
                <div class="control-group"><label for="select-segmento"><i class="fas fa-chart-pie"></i> Segmento</label><select id="select-segmento" disabled><option>Aguardando...</option></select></div>
                <div class="control-group">
                    <label for="select-comparison"><i class="fas fa-exchange-alt"></i> Comparar com</label>
                    <select id="select-comparison">
                        <option value="none" selected>Nenhum</option>
                        <option value="prev_month">M√™s Anterior</option>
                        <option value="prev_year">Mesmo M√™s, Ano Anterior</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="include-onboarding-toggle">Incluir Onboarding</label>
                    <label class="switch"><input type="checkbox" id="include-onboarding-toggle"><span class="slider"></span></label>
                </div>
            </section>

            <div id="squad-cs-list" style="text-align: center; margin: -15px 0 20px 0; color: #aaa; font-style: italic;"></div>
            <div id="divergence-marker" class="divergence-info" style="display: none;"><span id="divergence-text"></span></div>
            <div id="status-message" class="loader">Aguardando login...</div>

            <div class="tabs" style="display: none;">
                <button class="tab-button active" data-tab="dashboard-view"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                <button class="tab-button" data-tab="onboarding-view"><i class="fas fa-rocket"></i> Onboarding</button>
                <button class="tab-button" data-tab="overdue-view" style="color: #dc3545;"><i class="fas fa-clock-rotate-left"></i> Atrasadas</button>
                <button class="tab-button" data-tab="data-view"><i class="fas fa-table"></i> Dados Carregados</button>
            </div>

            <main id="main-content">
                <div id="dashboard-view" class="tab-content active">
                    <div id="dashboard" style="display: none;">
                        <div class="metric-group"><h2 class="group-title">Indicadores Gerais da Carteira</h2><div class="group-content" id="general-indicators-grid"></div></div>
                        <div class="metric-group"><h2 class="group-title">Vis√£o por Neg√≥cio e Comercial</h2><div class="group-content" id="business-commercial-grid"></div></div>
                        <div class="metric-group"><h2 class="group-title">Acompanhamento de Playbooks</h2><div class="group-content" id="playbooks-grid"></div></div>
                        <div class="metric-group"><h2 class="group-title" id="okr-title-header">OKRs de Engajamento e Eventos</h2><div class="group-content" id="okr-grid-container"></div></div>
                    </div>
                    <div id="period-view" style="display: none;"></div>
                </div>

                <div id="onboarding-view" class="tab-content">
                    <div id="onboarding-dashboard" style="display: none;">
                        <section class="onboarding-controls">
                            <div class="control-group">
                                <label for="select-onboarding-team"><i class="fas fa-users-cog"></i> Vis√£o do Time</label>
                                <select id="select-onboarding-team" disabled>
                                    <option value="geral">Vis√£o Geral</option>
                                    <option value="syneco">Syneco (Time CP)</option>
                                    <option value="outros">Outros Produtos (Time CS)</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="select-ism"><i class="fas fa-user-astronaut"></i> ISM Respons√°vel</label>
                                <select id="select-ism" disabled><option>Aguardando...</option></select>
                            </div>
                        </section>
                        <div class="metric-group"><h2 class="group-title">Resultados e Performance do Onboarding</h2><div class="group-content" id="onboarding-outcomes-grid"><div class="loader">Calculando...</div></div></div>
                        <div class="metric-group"><h2 class="group-title">Efici√™ncia do Processo (M√™s Atual)</h2><div class="group-content" id="onboarding-process-grid"><div class="loader">Calculando...</div></div></div>
                    </div>
                </div>

                <div id="overdue-view" class="tab-content">
                    <div class="metric-group"><h2 class="group-title">Vis√£o de Atividades Atrasadas</h2><div class="group-content" id="overdue-grid-container"><div class="loader">Selecione um CS.</div></div></div>
                </div>

                <div id="data-view" class="tab-content">
                    <div class="data-table-wrapper"><h3><i class="fas fa-clipboard-list" style="margin-right:10px;"></i>Atividades</h3><div id="atividades-table" class="data-table-container"></div><div id="atividades-pagination" class="pagination-controls"></div></div>
                    <div class="data-table-wrapper"><h3><i class="fas fa-address-book" style="margin-right:10px;"></i>Clientes</h3><div id="clientes-table" class="data-table-container"></div><div id="clientes-pagination" class="pagination-controls"></div></div>
                </div>
            </main>

            <div id="details-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header"><h2 id="modal-title">Detalhes</h2><span class="close-button">&times;</span></div>
                    <div class="modal-search-container"><input type="search" id="modal-search-input" placeholder="Pesquisar..."></div>
                    <div id="modal-body" class="data-table-container"></div>
                </div>
            </div>

            <div id="settings-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header"><h2>Configurar Metas</h2><span class="close-button">&times;</span></div>
                    <div class="settings-grid">
                        <div class="control-group"><label for="goal-sensescore">M√©dia Sense Score</label><input type="number" id="goal-sensescore" step="1"></div>
                        <div class="control-group"><label for="goal-labs">Participa√ß√£o SKA LABS (%)</label><input type="number" id="goal-labs" step="1"></div>
                        <div class="control-group"><label for="goal-coverage">Cobertura de Carteira (%)</label><input type="number" id="goal-coverage" step="1"></div>
                        <div class="control-group"><label for="goal-qbr">Liga√ß√µes de QBR (n¬∫)</label><input type="number" id="goal-qbr" step="1"></div>
                        <div class="control-group"><label for="goal-successplan">Planos de Sucesso (n¬∫)</label><input type="number" id="goal-successplan" step="1"></div>
                        <div class="control-group"><label for="goal-engagement">Performance Engajamento SMB (%)</label><input type="number" id="goal-engagement" step="1"></div>
                        <button id="save-settings-button"><i class="fas fa-save"></i> Salvar Metas</button>
                    </div>
                </div>
            </div>

            <div id="client-360-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header"><h2 id="client-360-name">Vis√£o 360¬∞</h2><span class="close-button">&times;</span></div>
                    <div id="client-360-info" class="client-info"></div>
                    <div id="client-360-activities" class="data-table-wrapper" style="margin-bottom:0; box-shadow: none;"><div class="data-table-container"></div></div>
                </div>
            </div>

            <div id="trend-chart-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header"><h2 id="trend-chart-title">Gr√°fico de Tend√™ncia</h2><span class="close-button">&times;</span></div>
                    <div id="trend-chart-container" style="padding: 20px 0;"><canvas id="trend-chart-canvas"></canvas></div>
                </div>
            </div>

            <div id="bulk-export-modal" class="modal">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header"><h2>Exportar em Lote</h2><span class="close-button">&times;</span></div>
                    <div id="cs-selection-list" style="margin: 20px 0; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #ccc;"></div>
                    <button id="generate-bulk-reports-button" style="width: 100%; padding: 14px; background: #28a745; color: white; border: none; cursor: pointer;">Gerar Relat√≥rios</button>
                </div>
            </div>

            <div id="anotacao-modal" class="modal">
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header"><h2 id="anotacao-modal-title">Anota√ß√£o</h2><span class="close-button">&times;</span></div>
                    <div id="anotacao-modal-body" style="padding: 20px 5px; white-space: pre-wrap; word-wrap: break-word;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="ism_config.js"></script>

    <script>
    // ============================================================
    //  1. CONFIGURA√á√ïES GLOBAIS
    // ============================================================
    const WORKER_URL = "https://sensedata-api.sensedata-dash.workers.dev"; 
    let dataWorker, rawActivities = [], rawClients = [], dataStore = {}, onboardingDataStore = {}, appGoals = {}, filterDataCache = {}, chartInstances = {};
    const defaultGoals = { sensescore: 85, labs: 10, coverage: 40, qbr: 5, successplan: 5, engagement: 50 };
    const manualEmailToCsMap = {
        "email.dificil@provedor.com": "Nome Completo do CS",
        "gabriellermsviana@gmail.com": "Gabrielle Viana",
        "francielesilvadomingues@gmail.com": "Franciele Domingues",
        "okrmarina1@gmail.com": "Marina Santos",
        "deborahsimonearruda@gmail.com": "Deborah Arruda"
    };
    let currentUser = { email: null, name: null, isManager: false, userGroup: null };

    // ============================================================
    //  2. FUN√á√ïES GLOBAIS E HELPERS (DEFINI√á√ÉO ANTECIPADA)
    // ============================================================

    function normalizeText(str = '') { return String(str).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }
    
    function formatDate(date) {
        if (!(date instanceof Date) || isNaN(date)) return '';
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();
        return `${day}/${month}/${year}`;
    }

    function showModal(el) { if(el) el.style.display = 'block'; }
    function closeModal(el) { if(el) { el.style.display = 'none'; if(el.querySelector('input')) el.querySelector('input').value = ''; } }

    function createHtmlTable(data) {
        if (!data || data.length === 0) return '<p style="padding: 20px; text-align: center;">Sem dados.</p>';
        const headers = Object.keys(data[0]).filter(h => normalizeText(h) !== 'anotacoes');
        const head = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
        const body = `<tbody>${data.map(row => `<tr>${headers.map(h => {
            let val = row[h];
            if(val instanceof Date) val = formatDate(val);
            if(normalizeText(h) === 'cliente') return `<td><span class="client-activity-trigger" data-anotacao="${(row['Anota√ß√µes']||'').replace(/"/g,'&quot;')}">${val}</span></td>`;
            return `<td>${val !== null && val !== undefined ? val : ''}</td>`;
        }).join('')}</tr>`).join('')}</tbody>`;
        return `<table class="data-table">${head}${body}</table>`;
    }

    // Fun√ß√£o Global de Exibi√ß√£o de Modal de Dados
    window.showDataInModal = function(data, title) {
        if (!data || data.length === 0) { alert(`N√£o h√° dados.`); return; }
        const modal = document.getElementById('details-modal');
        modal.querySelector('#modal-title').textContent = title;
        const body = modal.querySelector('#modal-body');
        const input = modal.querySelector('#modal-search-input');
        
        input.value = '';
        input.oninput = () => {
            const term = normalizeText(input.value);
            const fil = data.filter(r => Object.values(r).some(v => normalizeText(String(v)).includes(term)));
            body.innerHTML = createHtmlTable(fil);
        };
        body.innerHTML = createHtmlTable(data);
        showModal(modal);
    };

    function showDetailsModal(id, title) { const data = dataStore[id] || onboardingDataStore[id]; window.showDataInModal(data, title); }
    function showAnotacaoModal(txt) { document.getElementById('anotacao-modal-body').textContent = txt || 'Sem anota√ß√µes.'; showModal(document.getElementById('anotacao-modal')); }

    // ============================================================
    //  3. CARGA DE DADOS E TRADU√á√ÉO (API)
    // ============================================================

    window.mapDatabaseToDashboard = (dbData, type) => {
        const translateType = (rawType) => {
            if (!rawType) return "";
            const t = rawType.toLowerCase();
            if (t.includes('phone') || t.includes('call')) return 'Liga√ß√£o';
            if (t.includes('meeting')) return 'Reuni√£o';
            if (t.includes('email') || t.includes('e-mail')) return 'E-mail';
            if (t.includes('whatsapp')) return 'Whatsapp';
            if (t.includes('task') || t.includes('tarefa')) return 'Tarefa';
            return rawType;
        };
        const translateStatus = (rawStatus) => {
            if (!rawStatus) return "";
            const s = rawStatus.toLowerCase();
            if (s === 'completed' || s === 'concluded' || s === 'done') return 'Conclu√≠da';
            if (s === 'open' || s === 'pending' || s === 'scheduled') return 'Agendada';
            if (s === 'canceled') return 'Cancelada';
            return rawStatus;
        };

        return dbData.map(row => {
            if (type === 'atividades') {
                return {
                    "Criado em": row.criado_em ? new Date(row.criado_em) : null,
                    "Cliente": row.cliente,
                    "CS": row.cs, 
                    "Playbook": row.playbook,
                    "Atividade": row.atividade,
                    "Tipo de Atividade": translateType(row.tipo_atividade), 
                    "Categoria": row.categoria || translateType(row.tipo_atividade),
                    "Status": translateStatus(row.status),
                    "Previs√£o de conclus√£o": row.previsao_conclusao ? new Date(row.previsao_conclusao) : null,
                    "Conclu√≠da em": row.concluida_em ? new Date(row.concluida_em) : null,
                    "Respons√°vel": row.responsavel,
                    "Status Cliente": row.status_cliente
                };
            } else if (type === 'clientes') {
                return {
                    "Cliente": row.cliente,
                    "CS": row.cs,
                    "Segmento": row.segmento,
                    "Fase": row.fase,
                    "ISM": row.ism,
                    "Neg√≥cio": row.negocio,
                    "Comercial": row.comercial,
                    "NPS onboarding": row.nps_onboarding,
                    "Valor total n√£o faturado": row.valor_total_em_aberto,
                    "Status": row.status,
                    "Squad CS": row.squad_cs, 
                    "Dias sem touch": row.dias_sem_touch,
                    "Situa√ß√£o": row.situacao,
                    "Modelo de neg√≥cio": row.modelo_de_negocio,
                    "Potencial": row.potencial
                };
            }
        });
    };

    window.loadDataFromAPI = async function() {
        const statusMsg = document.getElementById('status-message');
        const btn = document.getElementById('btn-refresh-data');
        if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Conectando...'; }
        if(statusMsg) { statusMsg.style.display = 'block'; statusMsg.className = 'loader'; statusMsg.textContent = 'Conectando ao banco de dados...'; }

        try {
            if(statusMsg) statusMsg.innerHTML = '<i class="fas fa-tasks"></i> Baixando Atividades (300k)...';
            const resAtividades = await fetch(`${WORKER_URL}/api/atividades?limit=300000`); 
            if (!resAtividades.ok) throw new Error("Erro ao baixar Atividades");
            const jsonAtividades = await resAtividades.json();

            if(statusMsg) statusMsg.innerHTML = '<i class="fas fa-users"></i> Baixando Clientes...';
            const resClientes = await fetch(`${WORKER_URL}/api/clientes`);
            if (!resClientes.ok) throw new Error("Erro ao baixar Clientes");
            const jsonClientes = await resClientes.json();

            if(statusMsg) statusMsg.innerHTML = '<i class="fas fa-cogs"></i> Processando...';
            rawActivities = window.mapDatabaseToDashboard(jsonAtividades, 'atividades');
            rawClients = window.mapDatabaseToDashboard(jsonClientes, 'clientes');

            console.log(`Sucesso: ${rawActivities.length} ativ. / ${rawClients.length} cli.`);

            if (dataWorker) dataWorker.terminate();
            dataWorker = new Worker('worker.js');
            dataWorker.onmessage = handleWorkerMessage;

            dataWorker.postMessage({
                type: 'INIT',
                payload: { rawActivities, rawClients, currentUser, manualEmailToCsMap }
            });
            
            const lastLoadDiv = document.getElementById('last-load-info');
            if(lastLoadDiv) {
                const agora = new Date();
                lastLoadDiv.style.display = 'inline-block';
                lastLoadDiv.innerHTML = `<i class="fas fa-check-circle"></i> Atualizado: ${agora.toLocaleTimeString()} (${rawActivities.length} regs)`;
            }
            if(statusMsg) { statusMsg.textContent = 'Dados OK!'; setTimeout(() => { statusMsg.style.display = 'none'; }, 1500); }

        } catch (error) {
            console.error(error);
            if(statusMsg) statusMsg.textContent = 'Erro: ' + error.message;
            alert("Erro de conex√£o. Verifique o Worker.");
        } finally {
            if(btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar Agora'; }
        }
    };

    // ============================================================
    //  4. RENDERIZA√á√ÉO GR√ÅFICA E CHARTS
    // ============================================================

    function customLegendClickHandler(e, legendItem, legend) {
        const chart = legend.chart;
        const index = legendItem.index;
        const meta = chart.getDatasetMeta(0);
        if (!chart.legendClickState) chart.legendClickState = { lastClickedIndex: null, clickCount: 0 };
        
        if (index !== chart.legendClickState.lastClickedIndex) {
            let visibleCount = 0;
            meta.data.forEach(dataPoint => { if (!dataPoint.hidden) visibleCount++; });
            const isIsolated = visibleCount === 1 && chart.data.labels.length > 1;
            if (isIsolated) meta.data.forEach(dataPoint => { dataPoint.hidden = false; });
            chart.legendClickState.clickCount = 0;
        }
        chart.legendClickState.lastClickedIndex = index;
        chart.legendClickState.clickCount++;

        if (chart.legendClickState.clickCount === 1) meta.data[index].hidden = !meta.data[index].hidden;
        else if (chart.legendClickState.clickCount === 2) meta.data.forEach((dataPoint, i) => { dataPoint.hidden = (i !== index); });
        else { meta.data.forEach(dataPoint => { dataPoint.hidden = false; }); chart.legendClickState.clickCount = 0; chart.legendClickState.lastClickedIndex = null; }
        chart.update();
    }

    function renderDoughnutChart(containerId, canvasId, title, data) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const labels = Object.keys(data);
        const values = Object.values(data);
        if (labels.length === 0) { container.innerHTML = `<div class="card"><h3>${title}</h3><div class="loader" style="padding:40px;font-size:1rem;">Sem dados.</div></div>`; return; }

        container.innerHTML = `<div class="card"><h3>${title}</h3><div class="card-content" style="position:relative;height:320px;padding-top:10px;"><canvas id="${canvasId}"></canvas></div></div>`;
        if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
        const ctx = document.getElementById(canvasId).getContext('2d');
        const colors = ['#007BFF', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2', '#fd7e14', '#20c997'];
        const backgroundColors = labels.map((_, i) => colors[i % colors.length]);
        const isLightTheme = document.body.classList.contains('light-theme');

        chartInstances[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: { labels, datasets: [{ data: values, backgroundColor: backgroundColors, borderColor: isLightTheme ? '#fff' : '#1a2238', borderWidth: 2 }] },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: '60%',
                plugins: {
                    legend: { position: 'bottom', labels: { color: isLightTheme ? '#2c3e50' : '#F0F2F5', padding: 15, boxWidth: 12 }, onClick: customLegendClickHandler },
                    tooltip: { callbacks: { label: (c) => `${c.label}: ${c.raw} (${((c.raw/c.dataset.data.reduce((a,b)=>a+b,0))*100).toFixed(1)}%)` } }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const label = labels[index];
                        let filterData = [];
                        // L√≥gica de Drilldown
                        if(containerId.includes('negocio')) filterData = (dataStore['cob-carteira']||[]).filter(c => normalizeText(c.Negocio||'N√£o Definido') === normalizeText(label));
                        else if(containerId.includes('comercial')) filterData = (dataStore['cob-carteira']||[]).filter(c => normalizeText(c.Comercial||'N√£o Definido') === normalizeText(label));
                        else if(containerId.includes('clientes')) filterData = (dataStore['total-clientes']||[]).filter(c => normalizeText(c['Neg√≥cio']||'N√£o Definido') === normalizeText(label));
                        
                        if(filterData.length > 0) window.showDataInModal(filterData, `${title}: ${label}`);
                    }
                },
                onHover: (e, el) => { e.native.target.style.cursor = el[0] ? 'pointer' : 'default'; }
            }
        });
    }

    function renderOnboardingProductChart(data) {
        if(!data || !data.labels) return;
        const ctx = document.getElementById('onboardingProductChart').getContext('2d');
        if(chartInstances['onboardingProductChart']) chartInstances['onboardingProductChart'].destroy();
        chartInstances['onboardingProductChart'] = new Chart(ctx, {
            type: 'bar',
            data: { labels: data.labels, datasets: [{ label: 'Clientes', data: data.clientCount, backgroundColor: '#007BFF', yAxisID: 'y1' }, { label: 'Dias (M√©dia)', data: data.avgTime, type: 'line', borderColor: '#ffc107', yAxisID: 'y2' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y1: { position: 'left' }, y2: { position: 'right', grid: { display: false } } } }
        });
    }
    
    let trendChartInstance = null;
    function showTrendChart(metricId, title, type) {
        const trendModal = document.getElementById('trend-chart-modal');
        document.getElementById('trend-chart-title').textContent = `Tend√™ncia: ${title}`;
        const container = document.getElementById('trend-chart-container');
        container.innerHTML = '<canvas id="trend-chart-canvas"></canvas>';
        showModal(trendModal);
        if(dataWorker) {
            dataWorker.postMessage({
                type: 'CALCULATE_TREND',
                payload: {
                    metricId, title, type,
                    baseMonth: parseInt(document.getElementById('select-month').value, 10),
                    baseYear: parseInt(document.getElementById('select-year').value, 10),
                    selectedCS: document.getElementById('select-cs').value,
                    selectedSquad: document.getElementById('select-squad').value,
                    includeOnboarding: document.getElementById('include-onboarding-toggle').checked,
                    segmento: document.getElementById('select-segmento').value
                }
            });
        }
    }

    function renderTrendChart(labels, dataPoints, title) {
        const ctx = document.getElementById('trend-chart-canvas').getContext('2d');
        if (trendChartInstance) trendChartInstance.destroy();
        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: title, data: dataPoints, fill: true, borderColor: '#007BFF', backgroundColor: 'rgba(0, 123, 255, 0.2)', pointBackgroundColor: '#007BFF', tension: 0.3 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }

    // ============================================================
    //  5. RENDERIZA√á√ÉO (UI)
    // ============================================================

    function renderOKRs() {
        const selectedSegmento = document.getElementById('select-segmento').value;
        document.getElementById('okr-title-header').textContent = `OKRs do Segmento: ${selectedSegmento}`;
        
        // Gr√°ficos
        document.getElementById('business-commercial-grid').innerHTML = `<div id="negocio-chart-container"></div><div id="comercial-chart-container"></div><div id="clientes-negocio-chart-container"></div>`;
        if(dataStore['contatos-por-negocio']) renderDoughnutChart('negocio-chart-container', 'negocioChart', 'Contatos por Neg√≥cio', dataStore['contatos-por-negocio']);
        if(dataStore['contatos-por-comercial']) renderDoughnutChart('comercial-chart-container', 'comercialChart', 'Contatos por Comercial', dataStore['contatos-por-comercial']);
        if(dataStore['clientes-por-negocio']) renderDoughnutChart('clientes-negocio-chart-container', 'clientesNegocioChart', 'Clientes por Neg√≥cio', dataStore['clientes-por-negocio']);

        const totalCalls = (dataStore['contato-ligacao'] || []).length;
        const totalEmails = (dataStore['contato-email'] || []).length;
        const totalCsContacts = totalCalls + totalEmails;
        const percLigacao = totalCsContacts > 0 ? ((totalCalls / totalCsContacts) * 100).toFixed(0) : 0;
        const percEmail = totalCsContacts > 0 ? ((totalEmails / totalCsContacts) * 100).toFixed(0) : 0;
        
        const includeOnboarding = document.getElementById('include-onboarding-toggle').checked;
        const onboardingContacts = dataStore['onboarding-contacts-display'] || [];
        let onboardingMetricHtml = includeOnboarding && onboardingContacts.length > 0 ? `<div class="metric" data-metric-id="onboarding-contacts-display" data-metric-title="Contatos Onboarding"><span class="metric-label"><i class="fas fa-user-plus"></i> Onboarding:</span><span class="metric-value">${onboardingContacts.length}</span></div>` : '';

        const cardTiposDeContato = `<div class="card"><h3>Tipos de Contato (M√™s)</h3><div class="card-content"><div class="metric" data-metric-id="contato-ligacao" data-metric-title="Liga√ß√µes/Reuni√µes"><span class="metric-label">üìû Liga√ß√£o/Reuni√£o:</span><span class="metric-value">${totalCalls} <span class="sub-metric">(${percLigacao}%)</span></span></div><div class="metric" data-metric-id="contato-email" data-metric-title="E-mail/Whatsapp"><span class="metric-label">‚úâÔ∏è E-mail/Whatsapp:</span><span class="metric-value">${totalEmails} <span class="sub-metric">(${percEmail}%)</span></span></div>${onboardingMetricHtml}</div></div>`;

        const totalClientesUnicosCS = dataStore['total-clientes-unicos-cs'] || 0;
        const clientesContatadosCount = dataStore['cob-carteira']?.length || 0;
        const cobCarteiraPerc = totalClientesUnicosCS > 0 ? (clientesContatadosCount / totalClientesUnicosCS) * 100 : 0;
        const clientesFaltantes = dataStore['clientes-faltantes-meta-cobertura'] || 0;
        
        let distHtml = '';
        if (clientesFaltantes > 0) {
            distHtml = `<div class="metric" style="font-size:0.9rem;padding-top:5px;"><span class="metric-label">Faltante (Liga√ß√£o):</span><span class="metric-value" style="color:var(--primary-color)">${dataStore['dist-faltante-ligacao']}</span></div><div class="metric" style="font-size:0.9rem;"><span class="metric-label">Faltante (Email):</span><span class="metric-value" style="color:var(--primary-color)">${dataStore['dist-faltante-email']}</span></div>`;
        }
        const cardCobertura = createOkrCard('Cobertura de Carteira', cobCarteiraPerc, appGoals.coverage, '%', 'cob-carteira', null, null, dataStore['cob-carteira_comp_perc'], clientesFaltantes, distHtml);
        const senseScoreCard = createOkrCard('M√©dia Sense Score', dataStore['sensescore-avg']||0, appGoals.sensescore, ' pts', 'sensescore-avg', (dataStore['sensescore-avg']||0).toFixed(1), null, dataStore['sensescore-avg_comp']);

        document.getElementById('general-indicators-grid').innerHTML = `${createSimpleCard('Vis√£o Geral', 'total-clientes', 'Total Clientes', (dataStore['total-clientes']||[]).length, 'cob-carteira', 'Contatados', clientesContatadosCount)} ${cardCobertura} ${senseScoreCard} ${cardTiposDeContato}`;

        const playbookGrid = document.getElementById('playbooks-grid');
        const followupCard = createPrevistoRealizadoCard('Follow-Up P√≥s Loop', (dataStore['followup-previsto']||[]).length, (dataStore['followup-realizado']||[]).length, 'followup', null, (dataStore['followup-atrasado-concluido']||[]).length, (dataStore['followup-concluido-antecipado']||[]).length);
        const discoveryCard = createPrevistoRealizadoCard('Discovery Potencial', (dataStore['discovery-previsto']||[]).length, (dataStore['discovery-realizado']||[]).length, 'discovery', null, (dataStore['discovery-atrasado-concluido']||[]).length, (dataStore['discovery-concluido-antecipado']||[]).length);
        
        playbookGrid.innerHTML = `${createPrevistoRealizadoCard('Atividades de Plano de A√ß√£o', (dataStore['plano-previsto']||[]).length, (dataStore['plano-realizado']||[]).length, 'plano', null, (dataStore['plano-atrasado-concluido']||[]).length, (dataStore['plano-concluido-antecipado']||[]).length)}${createPrevistoRealizadoCard('Atividades de Ado√ß√£o', (dataStore['adocao-previsto']||[]).length, (dataStore['adocao-realizado']||[]).length, 'adocao', null, (dataStore['adocao-atrasado-concluido']||[]).length, (dataStore['adocao-concluido-antecipado']||[]).length)}${followupCard}${(selectedSegmento !== 'MID/Enterprise') ? discoveryCard : ''}`;

        const labsCard = createOkrCard('Participa√ß√£o SKA LABS (Tri)', ((dataStore['ska-labs-realizado-list']?.length||0)*100)/(dataStore['total-labs-eligible']||1), appGoals.labs, '%', 'ska-labs-realizado-list', dataStore['ska-labs-realizado-list']?.length||0, dataStore['total-labs-eligible']||0, dataStore['ska-labs-realizado-list_comp_perc']);
        
        let okrHtml = '';
        if (selectedSegmento === 'MID/Enterprise') {
            okrHtml = `${createPrevistoRealizadoCard('Reuni√µes de QBR', (dataStore['reunioes-qbr-previsto']||[]).length, (dataStore['reunioes-qbr-realizado']||[]).length, 'reunioes-qbr', appGoals.qbr, (dataStore['reunioes-qbr-atrasado-concluido']||[]).length, (dataStore['reunioes-qbr-concluido-antecipado']||[]).length)}${createPrevistoRealizadoCard('Planos de Sucesso', (dataStore['planos-sucesso-previsto']||[]).length, (dataStore['planos-sucesso-realizado']||[]).length, 'planos-sucesso', appGoals.successplan, (dataStore['planos-sucesso-atrasado-concluido']||[]).length, (dataStore['planos-sucesso-concluido-antecipado']||[]).length)}${createPrevistoRealizadoCard('Baixo Engajamento (MID/ENT)', (dataStore['baixo-engajamento-mid-previsto']||[]).length, (dataStore['baixo-engajamento-mid-realizado']||[]).length, 'baixo-engajamento-mid', null, (dataStore['baixo-engajamento-mid-atrasado-concluido']||[]).length, (dataStore['baixo-engajamento-mid-concluido-antecipado']||[]).length)}${labsCard}`;
        } else {
             const trSMB = (dataStore['engajamento-smb-realizado']||[]).length + (dataStore['engajamento-smb-atrasado-concluido']||[]).length;
             const prevSMB = (dataStore['engajamento-smb-previsto']||[]).length;
             const eng = (dataStore['engajamento-smb-engajado']||[]).length;
             const deseng = (dataStore['engajamento-smb-desengajado']||[]).length;
             const perfPerc = trSMB > 0 ? (eng / trSMB) * 100 : 0;
             const realVsPrev = prevSMB > 0 ? (trSMB / prevSMB) * 100 : 0;

             okrHtml = `<div class="card"><h3>Engajamento (Contato Consolidado)</h3><div class="card-content"><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;"><div><div class="metric" data-metric-id="engajamento-smb-previsto" data-metric-title="Contatos Previstos (SMB)"><span class="metric-label">Previsto:</span><span class="metric-value">${prevSMB}</span></div><div class="metric" data-metric-id="engajamento-smb-realizado-total" data-metric-title="Total Realizado (SMB)"><span class="metric-label">Realizado:</span><span class="metric-value">${trSMB}</span></div></div><div><div class="metric" data-metric-id="engajamento-smb-engajado" data-metric-title="Total Engajado (SMB)"><span class="metric-label">Engajado:</span><span class="metric-value success">${eng}</span></div><div class="metric" data-metric-id="engajamento-smb-desengajado" data-metric-title="Total Desengajado (SMB)"><span class="metric-label">Desengajado:</span><span class="metric-value danger">${deseng}</span></div></div></div><div class="metric" style="border-top: 1px solid var(--border-color); padding-top: 15px;"><span class="metric-label">Performance:</span><span class="metric-value" style="color: ${perfPerc >= appGoals.engagement ? 'var(--secondary-color)' : 'var(--danger-color)'};">${perfPerc.toFixed(1)}% <span class="sub-metric">(Meta: ${appGoals.engagement}%)</span></span></div></div><div class="progress-bar-container"><div class="progress-bar"><div class="progress-bar-fill" style="width: ${Math.min(realVsPrev, 100)}%;"></div></div><span class="progress-percentage">${realVsPrev.toFixed(0)}%</span></div></div>`;
             
             if (selectedSegmento === 'SMB CAD') okrHtml += createSimpleCard('Ado√ß√£o Modelo', 'modelo-negocio-preenchido', 'Preenchido', (dataStore['modelo-negocio-preenchido']||[]).length, 'modelo-negocio-faltante', 'Faltante', (dataStore['modelo-negocio-faltante']||[]).length);
             if (selectedSegmento.includes('SMB')) okrHtml += createSimpleCard('Mapeamento Potencial', 'cliente-potencial-preenchido', 'Mapeado', (dataStore['cliente-potencial-preenchido']||[]).length, 'cliente-potencial-faltante', 'Faltante', (dataStore['cliente-potencial-faltante']||[]).length);
             okrHtml += labsCard;
        }
        document.getElementById('okr-grid-container').innerHTML = okrHtml;
    }

    function renderNewOnboardingView() {
        const outcomesGrid = document.getElementById('onboarding-outcomes-grid');
        const goLiveTotal = (onboardingDataStore.goLiveActivitiesConcluded?.length || 0) + (onboardingDataStore.goLiveActivitiesPredicted?.length || 0);
        
        outcomesGrid.innerHTML = `
            ${createOnboardingStageCard(onboardingDataStore.totalFilteredClients||0, onboardingDataStore.stageCounts, onboardingDataStore.stageLists||{})}
            ${createOnboardingMetricCard('Go-Lives', 'Realizados + Previstos', goLiveTotal, `<strong>${onboardingDataStore.goLiveActivitiesConcluded?.length||0}</strong> realizados`, 'fa-rocket', 'onb-go-live-combined', [...(onboardingDataStore.goLiveActivitiesConcluded||[]), ...(onboardingDataStore.goLiveActivitiesPredicted||[])])}
            ${createOnboardingMetricCard('NPS P√≥s Go-Live', 'Taxa de resposta', `${onboardingDataStore.npsResponded?.length||0}/${onboardingDataStore.clientsWithGoLive?.length||0}`, 'responderam', 'fa-star', 'onb-nps-responded', onboardingDataStore.npsResponded||[])}
            ${createOnboardingMetricCard('Tempo M√©dio Onboarding', 'Dura√ß√£o hist√≥rica', `${onboardingDataStore.averageCompletedOnboardingTime||0} dias`, 'em conclu√≠dos', 'fa-clock', 'onb-completed-list', onboardingDataStore.completedOnboardingsList||[])}
            ${createTop5OnboardingCard(onboardingDataStore.top5LongestOnboardings||[], onboardingDataStore.clientsOver120Days||[])}
            ${createOnboardingMetricCard('Onboarding > 50k', 'Alto valor', onboardingDataStore.highValueClients?.length||0, 'clientes', 'fa-dollar', 'onb-high-value', onboardingDataStore.highValueClients||[])}
            <div class="card" id="onboarding-product-chart-card"><h3>An√°lise por Produto</h3><div class="card-content" style="height:350px;padding-top:20px;"><canvas id="onboardingProductChart"></canvas></div></div>
        `;
        renderOnboardingProductChart(onboardingDataStore.productChartData);

        const processGrid = document.getElementById('onboarding-process-grid');
        processGrid.innerHTML = `
            ${createOnboardingProcessCard('SLA: Welcome', 'Meta: 3 dias', (onboardingDataStore.welcomePrevisto||[]).length, (onboardingDataStore.welcomeRealizado||[]).length, 'fa-handshake', 'welcome')}
            ${createOnboardingProcessCard('SLA: Kickoff', 'Meta: 7 dias', (onboardingDataStore.kickoffPrevisto||[]).length, (onboardingDataStore.kickoffRealizado||[]).length, 'fa-users', 'kickoff')}
            ${createOnboardingProcessCard('Prazo: Planejamento', 'Etapa', (onboardingDataStore.planejamentoPrevisto||[]).length, (onboardingDataStore.planejamentoRealizado||[]).length, 'fa-list', 'planejamento')}
            ${createOnboardingProcessCard('Prazo: Mapear Contatos', 'Etapa', (onboardingDataStore.mapearContatosPrevisto||[]).length, (onboardingDataStore.mapearContatosRealizado||[]).length, 'fa-address', 'mapearContatos')}
            ${createOnboardingProcessCard('Prazo: Reuni√£o Go-Live', 'Etapa', (onboardingDataStore.goLiveMeetingPrevisto||[]).length, (onboardingDataStore.goLiveMeetingRealizado||[]).length, 'fa-check', 'goLiveMeeting')}
            ${createOnboardingProcessCard('Prazo: Acompanhamento', 'Etapa', (onboardingDataStore.acompanhamentoPrevisto||[]).length, (onboardingDataStore.acompanhamentoRealizado||[]).length, 'fa-sync', 'acompanhamento')}
        `;
    }

    function renderPeriodView(periodData, periodName) {
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('period-view').style.display = 'block';
        
        let playbookCardsHtml = '';
        const playbookTitles = {'plano': 'Planos de A√ß√£o', 'adocao': 'Ado√ß√£o', 'followup': 'Follow-Up', 'discovery': 'Discovery', 'reunioes-qbr': 'Reuni√µes de QBR', 'planos-sucesso': 'Planos de Sucesso', 'engajamento-smb': 'Engajamento', 'baixo-engajamento-mid': 'Baixo Engajamento'};
        for (const key in playbookTitles) {
            const data = periodData.playbookTotals[key];
            if (data && (data.previsto > 0 || data.realizado > 0)) {
                playbookCardsHtml += createSimpleCard(`Total: ${playbookTitles[key]}`, `p-${key}-prev`, 'Previsto', data.previsto, `p-${key}-real`, 'Realizado', data.realizado);
            }
        }
        document.getElementById('period-view').innerHTML = `<div class="metric-group"><h2 class="group-title">Resumo: ${periodName}</h2><div class="group-content">${createSimpleCard('M√©dia Cobertura', 'avg-cov', 'M√©dia Mensal', `${periodData.averageCoverage.toFixed(1)}%`, 'tot-uni', 'Clientes √önicos', periodData.totalUniqueClients)}${playbookCardsHtml}</div></div>`;
    }

    function renderOverdueView(overdueMetrics) {
        const grid = document.getElementById('overdue-grid-container');
        let html = '';
        const playbookTitles = { 'plano': 'Planos de A√ß√£o', 'adocao': 'Atividades de Ado√ß√£o', 'followup': 'Follow-Up', 'discovery': 'Discovery', 'reunioes-qbr': 'Reuni√µes de QBR', 'planos-sucesso': 'Planos de Sucesso', 'engajamento-smb': 'Engajamento', 'baixo-engajamento-mid': 'Baixo Engajamento' };
        for (const key in playbookTitles) {
            const acts = overdueMetrics.overdueActivities[key] || [];
            if(acts.length > 0) {
                onboardingDataStore[`overdue-${key}`] = acts;
                html += `<div class="card"><h3>${playbookTitles[key]}</h3><div class="card-content"><div class="metric overdue-metric" data-metric-id="overdue-${key}" data-metric-title="Atrasadas"><span class="metric-label">Atrasadas:</span><span class="metric-value danger">${acts.length}</span></div></div></div>`;
            }
        }
        grid.innerHTML = html || '<div class="loader">Sem atrasos.</div>';
    }

    const createSimpleCard = (t, i1, l1, v1, i2, l2, v2) => `<div class="card"><h3>${t}</h3><div class="card-content"><div class="metric" data-metric-id="${i1}" data-metric-title="${l1}"><span class="metric-label">${l1}:</span><span class="metric-value">${v1}</span></div>${i2 ? `<div class="metric" data-metric-id="${i2}" data-metric-title="${l2}"><span class="metric-label">${l2}:</span><span class="metric-value">${v2}</span></div>` : ''}</div></div>`;

    // --- HANDLER PRINCIPAL ---
    function handleWorkerMessage(e) {
        const { type, payload } = e.data;
        if (type === 'INIT_COMPLETE') {
            filterDataCache = payload.filterData; populateFilters(); 
            if (!currentUser.isManager) {
                const selCS = document.getElementById('select-cs').value;
                if (selCS) autoSelectSegment(rawClients.filter(c => c.CS?.trim() === selCS));
            }
            renderDataTables(); applyFilterLocks(); 
            document.querySelector('.tabs').style.display = 'flex';
            document.getElementById('status-message').style.display = 'none'; 
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('onboarding-dashboard').style.display = 'block';
            triggerCalculations();
        }
        else if (type === 'CALCULATION_COMPLETE') {
            dataStore = payload.dataStore; onboardingDataStore = payload.onboardingDataStore; 
            renderOKRs(); renderNewOnboardingView(); renderOverdueView(payload.overdueMetrics);
            const div = document.getElementById('divergence-marker');
            if (payload.divergentClientCount > 0 && document.getElementById('select-period').value === 'monthly') {
                document.getElementById('divergence-text').textContent = `Aten√ß√£o: ${payload.divergentClientCount} clientes fora da carteira receberam atividades.`;
                div.style.display = 'flex';
            } else div.style.display = 'none';
        }
        else if (type === 'PERIOD_CALCULATION_COMPLETE') renderPeriodView(payload.periodData, payload.periodName);
        else if (type === 'TREND_DATA_COMPLETE') renderTrendChart(payload.labels, payload.dataPoints, payload.title);
        else if (type === 'ERROR') console.error(payload.error);
    }

    // --- LOGIN & INIT ---
    window.handleCredentialResponse = function(response) {
        function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }
        const decoded = parseJwt(response.credential);
        if (decoded) {
            localStorage.setItem('googleUserToken', response.credential);
            const email = decoded.email.toLowerCase();
            const name = decoded.name;
            const mappedISM = (typeof ISM_MAPPING !== 'undefined' && ISM_MAPPING[email]) ? ISM_MAPPING[email] : null;
            const managers = ['lorhanska@gmail.com', 'elianeokr@gmail.com', 'juliarail@gmail.com', 'jadecristianettirp@gmail.com'];
            
            let group = 'ongoing';
            let isMgr = managers.includes(email);
            if (isMgr) group = 'admin';
            else if (mappedISM) group = 'onboarding';

            let selCS = 'Todos', selISM = 'Todos';
            if (!isMgr) {
                if (group === 'ongoing') selCS = name;
                else if (group === 'onboarding') selISM = mappedISM || name;
            }

            currentUser = { email, name, userGroup: group, isManager: isMgr, selectedCS: selCS, selectedISM: selISM };
            localStorage.setItem('userProfile', JSON.stringify(currentUser));
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('dashboard-wrapper').style.display = 'block';
            
            window.loadDataFromAPI();
            initializeDashboard();
        }
    };

    function logout() { localStorage.removeItem('googleUserToken'); google.accounts.id.disableAutoSelect(); location.reload(); }

    (function() {
        const t = localStorage.getItem('googleUserToken');
        if(t) {
            const d = (function(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } })(t);
            if(d && d.exp * 1000 > Date.now()) window.handleCredentialResponse({ credential: t });
            else localStorage.removeItem('googleUserToken');
        }
    })();

    async function initializeDashboard() {
        const VER = '3.0.0-final';
        if (localStorage.getItem('appVersion') !== VER) { await forceClearAllData(false); localStorage.setItem('appVersion', VER); window.location.reload(); return; }
        document.getElementById('app-version-marker').textContent = `Vers√£o: ${VER}`;
        
        if (currentUser.name) {
            document.getElementById('user-info-text').innerHTML = `<i class="fas fa-user"></i> ${currentUser.name}`;
            document.getElementById('user-info-card').style.display = 'flex';
        }
        document.getElementById('logout-button').addEventListener('click', logout);
        
        setupUserView();
        loadGoals();
        
        const ids = ['select-cs', 'select-squad', 'select-segmento', 'select-month', 'select-year', 'include-onboarding-toggle', 'select-comparison', 'select-period', 'select-onboarding-team', 'select-ism'];
        ids.forEach(id => document.getElementById(id).addEventListener('change', triggerCalculations));
        document.querySelector('.tabs').addEventListener('click', (e) => {
             if(e.target.matches('.tab-button')) {
                 document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
                 document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
                 e.target.classList.add('active');
                 document.getElementById(e.target.dataset.tab).classList.add('active');
                 if(e.target.dataset.tab === 'data-view') renderDataTables();
             }
        });
        document.body.addEventListener('click', (e) => {
            const m = e.target.closest('[data-metric-id]');
            if(m) showDetailsModal(m.dataset.metricId, m.dataset.metricTitle);
            const t = e.target.closest('span.client-activity-trigger');
            if(t) showAnotacaoModal(t.dataset.anotacao);
            const tr = e.target.closest('.trend-chart-button');
            if(tr) { e.preventDefault(); showTrendChart(tr.dataset.metricId, tr.dataset.metricTitle, tr.dataset.metricType); }
        });
        document.getElementById('settings-button').addEventListener('click', () => showModal(document.getElementById('settings-modal')));
        document.getElementById('save-settings-button').addEventListener('click', saveGoals);
        document.querySelectorAll('.modal .close-button').forEach(b => b.addEventListener('click', (e) => closeModal(e.target.closest('.modal'))));
        window.addEventListener('click', (e) => { if(e.target.classList.contains('modal')) closeModal(e.target); });
        
        // Fun√ß√µes Auxiliares Simplificadas
        function setupUserView() { /* ... (J√° configurado via CSS/Logic no Handler) ... */ }
        function populateFilters() { /* ... (Mantido no topo) ... */ }
        function applyFilterLocks() { /* ... (Mantido no topo) ... */ }
    }
    
    // Fun√ß√µes de Apoio UI (Necess√°rias para o Init)
    function populateFilters() {
        const { csSet, squadSet, years } = filterDataCache;
        const sCS = document.getElementById('select-cs');
        const sSq = document.getElementById('select-squad');
        const sY = document.getElementById('select-year');
        const sM = document.getElementById('select-month');
        
        sCS.innerHTML = currentUser.isManager ? '<option value="Todos">Todos os CS</option>' : '';
        [...csSet].sort().forEach(c => sCS.add(new Option(c, c)));
        
        if(currentUser.isManager) {
             sSq.innerHTML = '<option value="Todos">Todos os Squads</option>';
             [...squadSet].sort().forEach(s => sSq.add(new Option(s, s)));
        }
        
        updateIsmFilter();
        
        if(!currentUser.isManager && currentUser.userGroup==='ongoing') {
             let found = [...csSet].includes(currentUser.name) ? currentUser.name : manualEmailToCsMap[currentUser.email];
             if(found) sCS.value = found;
        }

        const mNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        sM.innerHTML = mNames.map((m,i) => `<option value="${i}">${m}</option>`).join('');
        sY.innerHTML = [...years].sort((a,b)=>b-a).map(y => `<option value="${y}">${y}</option>`).join('');
        
        const d = new Date();
        sM.value = d.getMonth();
        if(years.includes(d.getFullYear())) sY.value = d.getFullYear();
    }
    
    function applyFilterLocks() {
        const els = ['select-squad','select-segmento','select-month','select-year','include-onboarding-toggle','select-period'].map(i=>document.getElementById(i));
        els.forEach(e=>e.disabled=false);
        const sCS = document.getElementById('select-cs');
        const sISM = document.getElementById('select-ism');
        const sTeam = document.getElementById('select-onboarding-team');
        
        if(currentUser.isManager) { sCS.disabled=false; sISM.disabled=false; sTeam.disabled=false; }
        else {
            if(currentUser.userGroup==='ongoing') { sCS.disabled=true; sISM.disabled=false; sTeam.disabled=false; }
            else { sCS.disabled=true; sISM.disabled=true; sTeam.disabled=true; }
        }
    }

    </script>
</body>
</html>
