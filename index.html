<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-signin-client_id" content="232267534625-oju4j8ob02rn6tim24tcdas26c5rh3j4.apps.googleusercontent.com">
    <title>Dashboard de OKRs - CS (Nova Versão)</title>
    <link rel="icon" type="image/png" href="icone.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app-version-marker"></div>
    <div id="login-container">
        <h1>Dashboard de OKRs</h1>
        <p>Por favor, faça login com sua conta Google para acessar os dados de performance.</p>
        <div id="g_id_onload" data-client_id="232267534625-oju4j8ob02rn6tim24tcdas26c5rh3j4.apps.googleusercontent.com" data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left">
        </div>

        <button id="force-clear-button" style="
        background: none;
        border: 1px solid var(--border-color);
        color: var(--text-light-color);
        padding: 10px 20px;
        margin-top: 30px;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-family: var(--font-family);
        font-size: 0.9rem;
        transition: all 0.3s ease;">
            <i class="fas fa-sync-alt" style="margin-right: 8px;"></i>
            Problemas para acessar? Limpar dados e recarregar
        </button>
    </div>

    <div id="dashboard-wrapper">
        <div class="container">
            <header>
                <div id="user-info-card" style="display: none;">
                    <span id="user-info-text"></span>
                    <button id="logout-button" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
                </div>
                <h1>Dashboard de OKRs</h1>
                <p>Avaliação de Resultados e Performance</p>
                <div id="last-load-info" style="display: none;"></div>
                <div class="header-actions">
                    <div class="theme-switcher">
                        <i class="fas fa-sun"></i>
                        <label class="switch">
                            <input type="checkbox" id="theme-toggle">
                            <span class="slider"></span>
                        </label>
                        <i class="fas fa-moon"></i>
                    </div>
                    <button id="bulk-export-button" title="Exportar Relatórios em Lote">
                        <i class="fas fa-file-export"></i>
                    </button>
                    <button id="export-html-button" title="Exportar Relatório HTML">
                        <i class="fas fa-file-invoice"></i>
                    </button>
                    <button id="export-csv-button" title="Exportar Resumo para CSV">
                        <i class="fas fa-file-csv"></i>
                    </button>
                    <button id="settings-button" title="Configurar Metas">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </header>

            <section class="controls">
                                <div class="control-group"><label for="file-atividades"><i class="fas fa-tasks"></i> 1. Planilha de Atividades</label><input type="file" id="file-atividades" accept=".csv, .xlsx, .txt"></div>
                                                <div class="control-group">
                    <label for="select-period"><i class="fas fa-calendar-check"></i> Análise de Período</label>
                    <select id="select-period">
                        <option value="monthly" selected>Mensal</option>
                        <option value="q1">1º Trimestre</option>
                        <option value="q2">2º Trimestre</option>
                        <option value="q3">3º Trimestre</option>
                        <option value="q4">4º Trimestre</option>
                        <option value="s1">1º Semestre</option>
                        <option value="s2">2º Semestre</option>
                        <option value="year">Ano Inteiro</option>
                    </select>
                </div>
                <div class="control-group"><label for="select-year"><i class="fas fa-calendar-week"></i> Ano</label><select id="select-year"></select></div>
                <div class="control-group"><label for="select-month"><i class="fas fa-calendar-alt"></i> Mês</label><select id="select-month"></select></div>
                <div class="control-group"><label for="select-cs"><i class="fas fa-user-tie"></i> CS</label><select id="select-cs" disabled><option>Aguardando...</option></select></div>
                <div id="squad-filter-group" class="control-group">
                    <label for="select-squad"><i class="fas fa-users"></i> Squad</label>
                    <select id="select-squad" disabled><option>Aguardando...</option></select>
                </div>
                <div class="control-group"><label for="select-segmento"><i class="fas fa-chart-pie"></i> Segmento</label><select id="select-segmento" disabled><option>Aguardando...</option></select></div>
                <div class="control-group">
                    <label for="select-comparison"><i class="fas fa-exchange-alt"></i> Comparar com</label>
                    <select id="select-comparison">
                        <option value="none" selected>Nenhum</option>
                        <option value="prev_month">Mês Anterior</option>
                        <option value="prev_year">Mesmo Mês, Ano Anterior</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="include-onboarding-toggle">Incluir Onboarding</label>
                    <label class="switch">
                        <input type="checkbox" id="include-onboarding-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </section>

            <div id="squad-cs-list" style="text-align: center; margin: -15px 0 20px 0; color: var(--text-light-color); font-style: italic;"></div>

            <div id="divergence-marker" class="divergence-info" style="display: none;">
                <span id="divergence-text"></span>
            </div>

                        <div id="status-message" class="loader">⏳ Carregando dados de clientes do servidor...</div>

            <div class="tabs" style="display: none;">
                <button class="tab-button active" data-tab="dashboard-view"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                <button class="tab-button" data-tab="onboarding-view"><i class="fas fa-rocket"></i> Onboarding</button>
                <button class="tab-button" data-tab="overdue-view" style="color: var(--danger-color);"><i class="fas fa-clock-rotate-left"></i> Atrasadas</button>
                <button class="tab-button" data-tab="data-view"><i class="fas fa-table"></i> Dados Carregados</button>
            </div>

            <main id="main-content">
                <div id="dashboard-view" class="tab-content active">
                    <div id="dashboard" style="display: none;">
                                            </div>
                    <div id="period-view" style="display: none;">
                    </div>
                </div>
                <div id="onboarding-view" class="tab-content">
                                    </div>
                <div id="overdue-view" class="tab-content">
                                    </div>
                <div id="data-view" class="tab-content">
                                    </div>
            </main>

                        <div id="details-modal" class="modal"> ... </div>
            <div id="settings-modal" class="modal"> ... </div>
            <div id="client-360-modal" class="modal"> ... </div>
            <div id="trend-chart-modal" class="modal"> ... </div>
            <div id="bulk-export-modal" class="modal"> ... </div>
            <div id="anotacao-modal" class="modal"> ... </div>

        </div>     </div>     
        <script src="frontend-integration.js"></script>

<script>
    // --- SCRIPT DE LIMPEZA FORÇADA E CONTROLE DE VERSÃO ---
    document.addEventListener('DOMContentLoaded', () => {
        const clearButton = document.getElementById('force-clear-button');

        if (clearButton) {
            clearButton.addEventListener('click', () => {
                if (confirm("Isso limpará todos os dados salvos da aplicação no seu navegador (tema, token, etc.).\n\nEsta ação é recomendada se você está com problemas para acessar ou visualizar os dados.\n\nDeseja continuar?")) {
                    forceClearAllData(true);
                }
            });
        }
    });

    /**
     * Limpa todos os dados de armazenamento do navegador para esta aplicação.
     * @param {boolean} showAlert - Se true, exibe um alerta ao final e recarrega a página.
     */
    async function forceClearAllData(showAlert = false) {
        console.log("Iniciando limpeza forçada dos dados de armazenamento...");
        try {
            localStorage.clear();
            console.log("localStorage limpo com sucesso.");

            sessionStorage.clear();
            console.log("sessionStorage limpo com sucesso.");

            if (showAlert) {
                alert("A limpeza foi concluída! A página será recarregada agora.");
                window.location.reload();
            }
        } catch (error) {
            console.error("Ocorreu um erro durante a limpeza forçada:", error);
            if (showAlert) {
                alert("Ocorreu um erro ao tentar limpar os dados. Por favor, tente limpar o cache do seu navegador manualmente.");
            }
        }
    }
    // --- FIM DO SCRIPT DE LIMPEZA FORÇADA ---

    // Adicione aqui os e-mails que não são detectados automaticamente.
    const manualEmailToCsMap = {
        "email.dificil@provedor.com": "Nome Completo do CS",
        "contato@empresa.com.br": "Outro CS",
        // Exemplo:
        // "joana.s@emailaleatorio.net": "Joana Souza"
        "gabriellermsviana@gmail.com": "Gabrielle Viana",
        "francielesilvadomingues@gmail.com": "Franciele Domingues",
        "okrmarina1@gmail.com": "Marina Santos",
        "deborahsimonearruda@gmail.com": "Deborah Arruda",
    };
    const onboardingEmails = [
        "lorhangames2@gmail.com",
        "naty.naveal@gmail.com",
        "outro.email@provedor.com"
        // Adicione aqui todos os e-mails do time de Onboarding e-mail onboarding
    ];

    // --- LOGIN AUTHENTICATION SCRIPT ---
    let currentUser = {
        email: null,
        name: null,
        isManager: false,
        userGroup: null // <-- 1. Nova propriedade
    };

    function parseJwt(token) {
        try {
            return JSON.parse(atob(token.split('.')[1]));
        } catch (e) {
            return null;
        }
    }

    function handleCredentialResponse(response) {
        const decodedToken = parseJwt(response.credential);

        if (decodedToken) {
            localStorage.setItem('googleUserToken', response.credential);

            currentUser.email = decodedToken.email;
            currentUser.name = decodedToken.name;

            const managerEmails = ['lorhanska@gmail.com', 'elianeokr@gmail.com', 'juliarail@gmail.com', 'jadecristianettirp@gmail.com'];
            
            // --- LÓGICA DE GRUPO ATUALIZADA ---
            currentUser.isManager = managerEmails.includes(currentUser.email);

            // 1. Prioriza o status de ADM
            if (currentUser.isManager) {
                currentUser.userGroup = 'admin';
            
            // 2. Separa os outros grupos
            } else if (onboardingEmails.includes(currentUser.email)) {
                currentUser.userGroup = 'onboarding';
            } else {
                currentUser.userGroup = 'ongoing';
            }
            // --- FIM DA LÓGICA ATUALIZADA ---

            document.getElementById('login-container').style.display = 'none';
            document.getElementById('dashboard-wrapper').style.display = 'block';

            initializeDashboard();
        } else {
            alert("Falha no login. Não foi possível verificar suas credenciais. Tente novamente.");
            localStorage.removeItem('googleUserToken');
        }
    }

    function logout() {
        localStorage.removeItem('googleUserToken');
        google.accounts.id.disableAutoSelect();
        location.reload();
    }

    (function checkLoginState() {
        const userToken = localStorage.getItem('googleUserToken');
        if (userToken) {
            const decodedToken = parseJwt(userToken);
            if (decodedToken && (decodedToken.exp * 1000 > Date.now())) {
                handleCredentialResponse({
                    credential: userToken
                });
            } else {
                localStorage.removeItem('googleUserToken');
            }
        }
    })();
        
    // --- INÍCIO DO SCRIPT DO DASHBOARD (Refatorado para Worker e API Híbrida) ---

    // O Dashboard só inicializa após o login
    async function initializeDashboard() {
        // --- CONTROLE DE VERSÃO E LIMPEZA AUTOMÁTICA DE CACHE ---
        const APP_VERSION = '1.5.0-hybrid-api'; // Nova versão para forçar limpeza

        const storedVersion = localStorage.getItem('appVersion');

        if (storedVersion !== APP_VERSION) {
            console.warn(`Versão da aplicação desatualizada detectada (Cache: ${storedVersion} | Atual: ${APP_VERSION}). Forçando limpeza completa.`);
            const userToken = localStorage.getItem('googleUserToken'); // Salva o token antes de limpar
            await forceClearAllData(false); // Limpa tudo
            localStorage.setItem('appVersion', APP_VERSION); // Define a nova versão
            if (userToken) {
                localStorage.setItem('googleUserToken', userToken); // Restaura o token
            }
            window.location.reload(); // Recarrega a página
            return; // Interrompe a execução atual
        }

        const versionMarker = document.getElementById('app-version-marker');
        if (versionMarker) {
            versionMarker.textContent = `Versão: ${APP_VERSION}`;
        }

        // --- Exibe o card de usuário e configura o botão de logout ---
        const userInfoCard = document.getElementById('user-info-card');
        const userInfoText = document.getElementById('user-info-text');
        const logoutButton = document.getElementById('logout-button');

        if (currentUser.name) {
            userInfoText.innerHTML = `<i class="fas fa-user-check" style="margin-right: 8px; color: var(--secondary-color);"></i> ${currentUser.name}`;
            if (currentUser.isManager) {
                userInfoCard.insertAdjacentHTML('beforeend', '<span class="admin-badge">Login ADM</span>');
            }
            userInfoCard.style.display = 'flex';
        }
        logoutButton.addEventListener('click', logout);

        // --- LÓGICA DO TEMA ---
        const themeToggle = document.getElementById('theme-toggle');
        const applyTheme = (isLight) => {
            if (isLight) {
                document.body.classList.add('light-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.body.classList.remove('light-theme');
                localStorage.setItem('theme', 'dark');
            }
        };

        themeToggle.addEventListener('change', () => {
            applyTheme(themeToggle.checked);
            // Redesenha os gráficos com as cores do novo tema (se já existirem)
            if (chartInstances['negocioChart']) renderDoughnutChart('negocio-chart-container', 'negocioChart', 'Contatos por Negócio', dataStore['contatos-por-negocio'] || {});
            if (chartInstances['comercialChart']) renderDoughnutChart('comercial-chart-container', 'comercialChart', 'Contatos por Comercial', dataStore['contatos-por-comercial'] || {});
            if (chartInstances['clientesNegocioChart']) renderDoughnutChart('clientes-negocio-chart-container', 'clientesNegocioChart', 'Clientes por Negócio', dataStore['clientes-por-negocio'] || {});
            if (chartInstances['onboardingProductChart']) renderOnboardingProductChart(onboardingDataStore.productChartData); // Redesenha gráfico de onboarding
        });

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            themeToggle.checked = true;
            applyTheme(true);
        } else {
            themeToggle.checked = false;
            applyTheme(false);
        }

        // --- SELETORES DE ELEMENTOS ---
        const fileAtividadesInput = document.getElementById('file-atividades'); // Mantém atividades
        // const fileClientesInput = document.getElementById('file-clientes'); // Remove clientes
        const selectCS = document.getElementById('select-cs'),
            selectSegmento = document.getElementById('select-segmento');
        const selectMonth = document.getElementById('select-month'),
            selectYear = document.getElementById('select-year');
        const selectPeriod = document.getElementById('select-period');
        const onboardingToggle = document.getElementById('include-onboarding-toggle');
        const statusMessage = document.getElementById('status-message'),
            dashboard = document.getElementById('dashboard');
        const periodView = document.getElementById('period-view');
        const okrGrid = document.getElementById('okr-grid-container'),
            generalGrid = document.getElementById('general-indicators-grid');
        const playbookGrid = document.getElementById('playbooks-grid'),
            okrTitleHeader = document.getElementById('okr-title-header');
        const tabsContainer = document.querySelector('.tabs');
        const detailsModal = document.getElementById('details-modal'),
            settingsModal = document.getElementById('settings-modal'),
            client360Modal = document.getElementById('client-360-modal');
        const anotacaoModal = document.getElementById('anotacao-modal');
        const onboardingDashboard = document.getElementById('onboarding-dashboard');
        const selectOnboardingTeam = document.getElementById('select-onboarding-team');
        const selectISM = document.getElementById('select-ism');
        const onboardingOutcomesGrid = document.getElementById('onboarding-outcomes-grid');
        const onboardingProcessGrid = document.getElementById('onboarding-process-grid');

        // Função setupUserView permanece a mesma
        function setupUserView() {
            console.log(`Configurando view para o grupo: ${currentUser.userGroup}`);
            const tabDashboard = document.querySelector('.tab-button[data-tab="dashboard-view"]');
            const tabOnboarding = document.querySelector('.tab-button[data-tab="onboarding-view"]');
            const tabOverdue = document.querySelector('.tab-button[data-tab="overdue-view"]');
            const tabData = document.querySelector('.tab-button[data-tab="data-view"]');
            const contentDashboard = document.getElementById('dashboard-view');
            const contentOnboarding = document.getElementById('onboarding-view');
            const contentOverdue = document.getElementById('overdue-view');
            const contentData = document.getElementById('data-view');

            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (currentUser.userGroup === 'admin') {
                document.querySelectorAll('.tab-button').forEach(b => b.style.display = 'block');
                tabDashboard.classList.add('active');
                contentDashboard.classList.add('active');
            } else if (currentUser.userGroup === 'onboarding') {
                tabDashboard.style.display = 'none';
                tabOverdue.style.display = 'none';
                tabData.style.display = 'none';
                tabOnboarding.style.display = 'block';
                tabOnboarding.classList.add('active');
                contentOnboarding.classList.add('active');
            } else { // ongoing
                tabOnboarding.style.display = 'none';
                tabDashboard.style.display = 'block';
                tabOverdue.style.display = 'block';
                tabData.style.display = 'block';
                tabDashboard.classList.add('active');
                contentDashboard.classList.add('active');
            }
        }

        // --- VARIÁVEIS GLOBAIS DA THREAD PRINCIPAL ---
        let dataWorker; // O nosso Web Worker
        let rawActivities = [], // Mantido na thread principal (do arquivo)
            rawClients = []; // Mantido na thread principal (da API)
        let dataStore = {}; // Armazenará os dados vindos do Worker
        let onboardingDataStore = {}; // Armazenará os dados de onboarding vindos do Worker
        let appGoals = {}; // Metas
        let filterDataCache = {}; // Cache dos dados para os filtros
        
        const defaultGoals = {
            sensescore: 85, labs: 10, coverage: 40, qbr: 5, successplan: 5, engagement: 50
        };
        
        // --- FUNÇÕES DE LEITURA E INICIALIZAÇÃO (Thread Principal) ---

        const normalizeText = (str = '') => String(str).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

        // `formatDate` e `parseDate` permanecem iguais
        const formatDate = (date) => {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            return `${day}/${month}/${year}`;
        };

        const parseDate = (dateInput) => {
            if (!dateInput) return null;
            if (dateInput instanceof Date && !isNaN(dateInput)) return dateInput;
            const dateStr = String(dateInput).trim();
            const dateOnlyStr = dateStr.split(' ')[0];
            let parts;
            parts = dateOnlyStr.split(/[-/]/);
            if (parts.length === 3 && parts[2].length === 4) { // dd/mm/yyyy or dd-mm-yyyy
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10);
                const year = parseInt(parts[2], 10);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    return new Date(Date.UTC(year, month - 1, day));
                }
            }
            if (parts.length === 3 && parts[0].length === 4) { // yyyy-mm-dd or yyyy/mm/dd
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10);
                const day = parseInt(parts[2], 10);
                if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                    return new Date(Date.UTC(year, month - 1, day));
                }
            }
            return null; // Retorna null se não conseguir parsear
        };

        // [HÍBRIDO] Função readFile mantida para processar o arquivo de atividades
        const readFile = (file) => new Promise((resolve, reject) => {
            const excelSerialToDateObject = (serial) => {
                const excelTimestamp = (serial - 25569) * 86400 * 1000;
                const date = new Date(excelTimestamp);
                const timezoneOffset = date.getTimezoneOffset() * 60000;
                return new Date(date.getTime() + timezoneOffset);
            }
            const transpilePipeToCommaCSV = (pipeText) => {
                let inQuotes = false;
                let newCsvText = '';
                for (let i = 0; i < pipeText.length; i++) {
                    const char = pipeText[i];
                    if (char === '"') inQuotes = !inQuotes;
                    newCsvText += (char === '|' && !inQuotes) ? ',' : char;
                }
                return newCsvText;
            };
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = event.target.result;
                    const fileName = file.name.toLowerCase();
                    let workbook;
                    if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        workbook = XLSX.read(data, { type: 'array' });
                    } else { // Assume CSV ou TXT (Pipe delimited)
                        const standardCsvText = transpilePipeToCommaCSV(data);
                        workbook = XLSX.read(standardCsvText, { type: 'string' });
                    }
                    const sheetName = workbook.SheetNames[0];
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });
                    const dateColumns = ["Criado em", "Previsão de conclusão", "Concluída em"];
                    jsonData.forEach(row => {
                        dateColumns.forEach(colName => {
                            if (row[colName]) {
                                // Tenta converter números de série do Excel
                                if (typeof row[colName] === 'number' && row[colName] > 10000) { // Heurística simples para data Excel
                                    row[colName] = excelSerialToDateObject(row[colName]);
                                } else { // Tenta parsear como string
                                    row[colName] = parseDate(row[colName]);
                                }
                            }
                        });
                    });
                    resolve(jsonData);
                } catch (e) {
                    console.error("Erro detalhado no processamento do arquivo:", e);
                    reject(new Error("Não foi possível processar o arquivo. Verifique o formato e se não está corrompido."));
                }
            };
            reader.onerror = (error) => {
                console.error("Erro no FileReader:", error);
                reject(new Error("Ocorreu um erro de hardware ou permissão ao tentar ler o arquivo."));
            };
            // Determina como ler baseado na extensão
            if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                reader.readAsArrayBuffer(file);
            } else { // Assume CSV ou TXT
                reader.readAsText(file, 'UTF-8'); // Tenta UTF-8 primeiro
            }
        });

        // Funções loadGoals e saveGoals permanecem iguais
        const loadGoals = () => {
            const savedGoals = localStorage.getItem('dashboardOKRsGoals');
            appGoals = savedGoals ? JSON.parse(savedGoals) : { ...defaultGoals };
            Object.keys(appGoals).forEach(key => {
                const input = document.getElementById(`goal-${key}`);
                if (input) input.value = appGoals[key];
            });
        };

        const saveGoals = () => {
            Object.keys(defaultGoals).forEach(key => {
                const input = document.getElementById(`goal-${key}`);
                if (input) {
                    appGoals[key] = parseFloat(input.value) || defaultGoals[key];
                }
            });
            localStorage.setItem('dashboardOKRsGoals', JSON.stringify(appGoals));
            alert('Metas salvas com sucesso!');
            settingsModal.style.display = 'none';
            triggerCalculations(); // Recalcula com as novas metas
        };
        
        // --- [MODIFICADO HÍBRIDO] ---
        let atividadesFile = null; // Para o upload manual
        let apiClientesData = null; // Para os dados da API
        
        // Função para tentar processar quando ambos os dados estiverem prontos
        const hybridAttemptProcess = () => {
            // Só processa se o arquivo de atividades foi carregado E os clientes da API chegaram
            if (atividadesFile && apiClientesData) {
                statusMessage.textContent = 'Lendo arquivo de atividades...';
                statusMessage.style.display = 'block';
                dashboard.style.display = 'none'; // Esconde enquanto processa

                // Lê apenas o arquivo de atividades
                readFile(atividadesFile)
                    .then(atividadesJson => {
                        rawActivities = atividadesJson; // Atualiza global de atividades
                        rawClients = apiClientesData; // Atualiza global de clientes (já veio da API)

                        console.log(`Dados combinados: ${rawActivities.length} atividades (arquivo), ${rawClients.length} clientes (API).`);
                        statusMessage.textContent = 'Processando dados combinados... Isso pode levar alguns instantes.';
                        
                        // Inicia ou reinicia o Worker
                        if (dataWorker) dataWorker.terminate();
                        dataWorker = new Worker('worker.js');
                        dataWorker.onmessage = handleWorkerMessage;
                        
                        // Envia os dados combinados para o worker
                        dataWorker.postMessage({
                            type: 'INIT',
                            payload: {
                                rawActivities: rawActivities, // Do arquivo
                                rawClients: rawClients,       // Da API
                                currentUser: currentUser,
                                manualEmailToCsMap: manualEmailToCsMap
                            }
                        });
                    })
                    .catch(err => {
                        statusMessage.textContent = 'Erro ao ler a planilha de atividades. Verifique o console (F12).';
                        console.error("Erro no readFile:", err);
                    });
            } else if (atividadesFile && !apiClientesData) {
                // Caso o usuário carregue o arquivo ANTES da API terminar
                statusMessage.textContent = '⏳ Arquivo de atividades recebido. Aguardando dados de clientes do servidor...';
            }
        };
        // --- [FIM MODIFICADO HÍBRIDO] ---

        // --- MANIPULAÇÃO DE MENSAGENS DO WORKER ---
        // Função handleWorkerMessage permanece a mesma
        function handleWorkerMessage(e) {
            const { type, payload } = e.data;
            switch(type) {
                case 'INIT_COMPLETE':
                    console.log("Worker inicializado e dados processados.");
                    filterDataCache = payload.filterData;
                    populateFilters();
                    if (!currentUser.isManager) {
                        const selectedCS = selectCS.value;
                        if (selectedCS && rawClients) { // Garante que rawClients exista
                            const clientsOfLoggedInUser = rawClients.filter(client => client && client.CS?.trim() === selectedCS);
                            autoSelectSegment(clientsOfLoggedInUser);
                        }
                    }
                    renderDataTables(); // Renderiza ambas as tabelas
                    [selectCS, document.getElementById('select-squad'), selectSegmento, selectMonth, selectYear, onboardingToggle, selectPeriod, selectOnboardingTeam, selectISM].forEach(el => el.disabled = false);
                    if (!currentUser.isManager) {
                        selectCS.disabled = true;
                        // Adiciona trava para ISM se for onboarding
                        if (currentUser.userGroup === 'onboarding') {
                            selectISM.disabled = true;
                        }
                    }
                    tabsContainer.style.display = 'flex';
                    statusMessage.style.display = 'none';
                    dashboard.style.display = 'block';
                    onboardingDashboard.style.display = 'block';
                    triggerCalculations();
                    break;
                case 'CALCULATION_COMPLETE':
                    console.log("Cálculos recebidos do worker.");
                    dataStore = payload.dataStore;
                    onboardingDataStore = payload.onboardingDataStore;
                    const overdueMetrics = payload.overdueMetrics;
                    renderOKRs();
                    renderNewOnboardingView();
                    renderOverdueView(overdueMetrics);
                    const divergenceMarker = document.getElementById('divergence-marker');
                    const divergenceText = document.getElementById('divergence-text');
                    const divergentClientCount = payload.divergentClientCount;
                    if (divergentClientCount > 0 && selectPeriod.value === 'monthly') {
                        divergenceText.textContent = `Atenção: ${divergentClientCount} clientes fora da carteira receberam atividades neste mês. Clique para ver detalhes.`;
                        divergenceMarker.style.display = 'flex';
                    } else {
                        divergenceMarker.style.display = 'none';
                    }
                    statusMessage.style.display = 'none';
                    dashboard.style.display = 'block';
                    periodView.style.display = 'none';
                    break;
                case 'PERIOD_CALCULATION_COMPLETE':
                    console.log("Cálculos de período recebidos.");
                    renderPeriodView(payload.periodData, payload.periodName);
                    statusMessage.style.display = 'none';
                    break;
                case 'TREND_DATA_COMPLETE':
                    console.log("Dados de tendência recebidos.");
                    renderTrendChart(payload.labels, payload.dataPoints, payload.title);
                    break;
                case 'ERROR':
                    console.error("Erro recebido do Worker:", payload.error);
                    statusMessage.textContent = `Erro no processamento: ${payload.error}`;
                    statusMessage.style.display = 'block';
                    break;
            }
        }
        
        // --- FUNÇÕES DE FILTRO E UI (Thread Principal) ---

        // [MODIFICADO HÍBRIDO] Listener apenas para o arquivo de atividades
        fileAtividadesInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
              atividadesFile = e.target.files[0];
              console.log(`Arquivo de atividades selecionado: ${atividadesFile.name}`);
              // Atualiza status e tenta processar
              if (!apiClientesData) {
                  statusMessage.textContent = '⏳ Arquivo de atividades selecionado. Aguardando dados de clientes do servidor...';
              } else {
                  statusMessage.textContent = '⏳ Combinando arquivo de atividades com dados de clientes...';
              }
              hybridAttemptProcess(); // Tenta processar com o novo arquivo
          } else {
              atividadesFile = null; // Limpa se o usuário cancelar a seleção
              // Poderia adicionar lógica para limpar o dashboard se necessário, ex:
              // dashboard.style.display = 'none';
              // statusMessage.textContent = 'Upload de atividades cancelado. Carregue o arquivo para ver o dashboard.';
              // statusMessage.style.display = 'block';
          }
        });
        // O listener para fileClientesInput foi removido

        // Funções updateIsmFilter, populateFilters, autoSelectSegment permanecem as mesmas
        const updateIsmFilter = () => { /* ... código ... */ };
        const populateFilters = () => { /* ... código ... */ };
        const autoSelectSegment = (clients) => { /* ... código ... */ };

        // --- FUNÇÕES DE DISPARO (Thread Principal) ---
        // Função triggerCalculations permanece a mesma
        function triggerCalculations() { /* ... código ... */ }
        const updateDashboard = () => triggerCalculations();

        // --- FUNÇÕES DE RENDERIZAÇÃO (Thread Principal) ---
        // Todas as funções de renderização (renderOverdueView, renderPeriodView, create...Card, renderDoughnutChart, renderOKRs, createHtmlTable, renderPaginatedTable, renderDataTables) permanecem as mesmas
        const renderOverdueView = (overdueMetrics) => { /* ... código ... */ };
        const renderPeriodView = (periodData, periodName) => { /* ... código ... */ };
        const createOnboardingStageCard = (totalClients, stageCounts, stageLists) => { /* ... código ... */ };
        function renderOnboardingProductChart(chartData) { /* ... código ... */ }
        const renderNewOnboardingView = () => { /* ... código ... */ };
        let chartInstances = {};
        function customLegendClickHandler(e, legendItem, legend) { /* ... código ... */ }
        function renderDoughnutChart(containerId, canvasId, title, data) { /* ... código ... */ }
        const renderOKRs = () => { /* ... código ... */ };
        const createOkrCard = (...) => { /* ... código ... */ };
        const createPrevistoRealizadoCard = (...) => { /* ... código ... */ };
        const createSimpleCard = (...) => { /* ... código ... */ };
        const createHtmlTable = (data) => { /* ... código ... */ };
        const renderPaginatedTable = (tableId, paginationId, fullData, rowsPerPage = 100) => { /* ... código ... */ };
        const renderDataTables = () => {
            // Renderiza ambas as tabelas com os dados globais rawActivities (arquivo) e rawClients (API)
            renderPaginatedTable('atividades-table', 'atividades-pagination', rawActivities, 100);
            renderPaginatedTable('clientes-table', 'clientes-pagination', rawClients, 100);
        };

        // --- FUNÇÕES DE MODAL (Thread Principal) ---
        // Funções showModal, closeModal, showDataInModal, showDetailsModal, showAnotacaoModal, showClient360Modal permanecem as mesmas
        const showModal = (modalElement) => { /* ... código ... */ };
        const closeModal = (modalElement) => { /* ... código ... */ };
        function showDataInModal(data, title) { /* ... código ... */ }
        const showDetailsModal = (metricId, title) => { /* ... código ... */ };
        function showAnotacaoModal(anotacaoText) { /* ... código ... */ };
        const showClient360Modal = (clientName) => { /* ... código ... */ };
        // Funções showTrendChart e renderTrendChart permanecem as mesmas
        let trendChartInstance = null;
        const showTrendChart = (metricId, title, type) => { /* ... código ... */ };
        const renderTrendChart = (labels, dataPoints, title) => { /* ... código ... */ };


        // --- EVENT LISTENERS (Thread Principal) ---
        // Listener para os filtros principais permanece o mesmo
        const selectSquad = document.getElementById('select-squad');
        const squadCsListDiv = document.getElementById('squad-cs-list');
        [selectCS, selectSquad, selectSegmento, selectMonth, selectYear, onboardingToggle, document.getElementById('select-comparison'), selectPeriod, selectOnboardingTeam, selectISM].forEach(el => {
            el.addEventListener('change', (event) => { /* ... código ... */ });
        });
        // Listener para as abas permanece o mesmo
        tabsContainer.addEventListener('click', (e) => { /* ... código ... */ });
        // Listener geral do body para cliques em métricas, anotações e botões de tendência permanece o mesmo
        document.body.addEventListener('click', (e) => { /* ... código ... */ });
        // Listener para o marcador de divergência permanece o mesmo
        document.getElementById('divergence-marker').addEventListener('click', () => { /* ... código ... */ });
        // Listeners para o modal de configurações permanecem os mesmos
        document.getElementById('settings-button').addEventListener('click', () => { /* ... código ... */ });
        document.getElementById('save-settings-button').addEventListener('click', saveGoals);

        // --- LÓGICA DE EXPORTAÇÃO (Thread Principal) ---
        // Funções generateExportData, exportDataToCSV, generateAndDownloadHtmlReport permanecem as mesmas
        const generateExportData = () => { /* ... código ... */ };
        const exportDataToCSV = (data) => { /* ... código ... */ };
        const generateAndDownloadHtmlReport = (csName, reportData, goals) => { /* ... código ... */ };
        // Listeners dos botões de exportação permanecem os mesmos
        document.getElementById('export-csv-button').addEventListener('click', () => { /* ... código ... */ });
        document.getElementById('export-html-button').addEventListener('click', () => { /* ... código ... */ });

        // Listeners para fechar modais permanecem os mesmos
        document.querySelectorAll('.modal .close-button').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal'))));
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target);
            }
        });

        // --- LÓGICA PARA EXPORTAÇÃO EM LOTE ---
        // Toda a lógica de exportação em lote permanece a mesma
        const bulkExportButton = document.getElementById('bulk-export-button');
        const bulkExportModal = document.getElementById('bulk-export-modal');
        const csSelectionList = document.getElementById('cs-selection-list');
        const generateBulkReportsButton = document.getElementById('generate-bulk-reports-button');
        bulkExportButton.addEventListener('click', () => { /* ... código ... */ });
        generateBulkReportsButton.addEventListener('click', async () => { /* ... código ... */ });
        bulkExportModal.querySelector('.close-button').addEventListener('click', () => closeModal(bulkExportModal));

        // --- CONTROLE DE ACESSO VISUAL ---
        // Toda a lógica de controle de acesso visual permanece a mesma
        if (!currentUser.isManager) { /* ... código ... */ }


        // --- [NOVO HÍBRIDO] LÓGICA DE CARREGAMENTO (API Clientes + Arquivo Atividades) ---
        async function inicializarDadosHibrido() {
            // 1. Defina a URL da sua API
            const API_URL = 'https://sensedata-api.sensedata-dash.workers.dev'; // <--- SUBSTITUA AQUI!
            const apiClient = new SensedataAPIClient(API_URL); 
            
            const statusDiv = document.getElementById('status-message');
            // Status inicial já está definido como "Carregando clientes..."
            
            try {
              // Carrega os dados de Clientes da API
              await apiClient.carregarDadosClientes(); 
                  
              // Converte clientes para o formato que o worker.js espera
              const clientesFormatados = apiClient.converterClientesParaFormatoOriginal();
              
              // Salva os clientes na variável global para uso posterior
              apiClientesData = clientesFormatados;
              rawClients = apiClientesData; // Atualiza também rawClients para a aba "Dados Carregados"
              
              console.log(`✅ API de Clientes carregada (${apiClientesData.length} registros).`);
              if (statusDiv) {
                // Se o arquivo de atividades JÁ foi selecionado (raro, mas pode acontecer), muda status e tenta processar
                if (atividadesFile) {
                    statusDiv.innerHTML = '✅ Dados de clientes carregados. <strong>Combinando com arquivo de atividades...</strong>';
                    hybridAttemptProcess();
                } else {
                    statusDiv.innerHTML = '✅ Dados de clientes carregados. <strong>Por favor, carregue a planilha de Atividades.</strong>';
                }
            }
              
              // Inicia a sincronização automática APENAS para Clientes
              apiClient.iniciarSincronizacaoAutomaticaClientes(5); // A cada 5 minutos
              
              // Listener para quando os clientes são sincronizados em background
              window.addEventListener('clientes-sincronizados', () => {
                  console.log('🔄 Clientes sincronizados em background. Atualizando dados...');
                  // Usa os dados mais recentes do apiClient que foram atualizados no intervalo
                  const novosClientesFormatados = apiClient.converterClientesParaFormatoOriginal();
                  apiClientesData = novosClientesFormatados;
                  rawClients = apiClientesData; // Atualiza global
                  
                  // Se o worker já estiver rodando (ou seja, a planilha de atividades foi carregada)
                  // e temos dados de atividades carregados manualmente
                  if (dataWorker && rawActivities && rawActivities.length > 0) {
                      console.log('Enviando clientes atualizados para o worker (mantendo atividades do arquivo)...');
                      // Reenvia os dados brutos para o worker REINICIAR com clientes atualizados
                      // Isso garante que os cálculos usem a lista de clientes mais recente
                      dataWorker.postMessage({
                          type: 'INIT', // Re-inicia o worker
                          payload: {
                              rawActivities: rawActivities, // Mantém as atividades do último arquivo carregado
                              rawClients: apiClientesData, // Usa os novos clientes da API
                              currentUser: currentUser,
                              manualEmailToCsMap: manualEmailToCsMap
                          }
                      });
                        // Atualiza a tabela de clientes na aba "Dados Carregados"
                        renderPaginatedTable('clientes-table', 'clientes-pagination', rawClients, 100);
                  } else {
                    // Se o worker não estiver ativo (usuário ainda não carregou atividades),
                    // apenas atualiza a tabela de clientes na aba "Dados Carregados"
                    console.log('Worker não ativo, apenas atualizando a tabela de clientes.');
                    renderPaginatedTable('clientes-table', 'clientes-pagination', rawClients, 100);
                }
              });
              
            } catch (error) {
              console.error('Erro fatal ao carregar dados de clientes da API:', error);
              if (statusDiv) statusDiv.innerHTML = '❌ Erro crítico ao carregar dados de clientes do servidor. Verifique o console e recarregue a página.';
                // Desativa o input de atividades se a API de clientes falhar
                fileAtividadesInput.disabled = true;
                fileAtividadesInput.parentElement.style.opacity = '0.5';
                fileAtividadesInput.parentElement.title = 'Erro ao carregar dados base de clientes. Upload desativado.';
            }
        }
        
        // --- INICIALIZAÇÃO GERAL ---
        setupUserView(); // Configura a interface baseada no tipo de usuário
        loadGoals(); // Carrega as metas salvas
        inicializarDadosHibrido(); // Inicia o processo de carregamento híbrido

    } // Fim da função initializeDashboard
</script>

<script type="text/javascript">
    var Tawk_API = Tawk_API || {},
        Tawk_LoadStart = new Date();
    (function() {
        var s1 = document.createElement("script"),
            s0 = document.getElementsByTagName("script")[0];
        s1.async = true;
        s1.src = 'https://embed.tawk.to/6862f529ad6c8f190c6f8c38/1iv18rasf';
        s1.charset = 'UTF-8';
        s1.setAttribute('crossorigin', '*');
        s0.parentNode.insertBefore(s1, s0);
    })();
</script>

</body>
</html>
