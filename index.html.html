<!DOCTYPE html>
<html lang="pt-BR" class="dark"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento Interno de OS - V1.9.5</title> <meta name="google-signin-client_id" content="232267534625-ti8c7jd14nfqigmmj3lnevv8nvds3i0t.apps.googleusercontent.com">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-body-light: #0f172a; --text-primary-light: #cbd5e1; --bg-sidebar-light: #020617;
            --text-sidebar-light: #94a3b8; --bg-card-light: #1e293b; --text-card-light: #cbd5e1;
            --border-card-light: #334155; --bg-table-header-light: #334155; --text-table-header-light: #94a3b8;
            --border-table-header-light: #475569; --text-table-row-light: #cbd5e1; --border-table-row-light: #334155;
            --bg-table-row-hover-light: #283447; --bg-input-light: #0f172a; --text-input-light: #cbd5e1;
            --border-input-light: #475569; --border-input-focus-light: #0ea5e9;
            --shadow-input-focus-light: rgba(14, 165, 233, 0.25); --bg-button-primary-light: #0ea5e9;
            --text-button-primary-light: #0f172a; --bg-button-primary-hover-light: #0284c7;
            --text-placeholder-light: #64748b; --text-link-light: #38bdf8;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body-light); color: var(--text-primary-light); display: flex; overflow-x: hidden; min-height: 100vh; }
        .sidebar { background-color: var(--bg-sidebar-light); color: var(--text-sidebar-light); width: 260px; transition: width 0.3s ease, background-color 0.3s, color 0.3s; box-shadow: 2px 0 6px rgba(0,0,0,0.1); height: 100vh; position: fixed; top: 0; left: 0; z-index: 50; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar.collapsed { width: 70px; }
        .sidebar-item { padding: 14px 18px; cursor: pointer; display: flex; align-items: center; transition: background-color 0.2s ease, color 0.2s ease; border-radius: 6px; margin: 4px 0; }
        .sidebar-item:hover { background-color: #1e293b; color: #f8fafc; }
        .sidebar-item.active { background-color: #0ea5e9; color: #ffffff; }
        .sidebar-item i { margin-right: 12px; min-width: 24px; text-align: center; font-size: 1.1em; }
        .sidebar.collapsed .sidebar-item span, .sidebar.collapsed #sidebar-title span { display: none; }
        .sidebar.collapsed .sidebar-item i { margin-right: 0; }
        .sidebar-header { padding: 14px 18px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #1e293b; margin-bottom:10px; }
        #sidebar-title span { font-size: 1.4em; font-weight: 600; color: #e2e8f0; }
        .content { background-color: var(--bg-body-light); flex-grow: 1; padding: 25px; transition: margin-left 0.3s ease, background-color 0.3s; margin-left: 260px; width: calc(100vw - 260px); overflow-y: auto; overflow-x: hidden; }
        .content.collapsed { margin-left: 70px; width: calc(100vw - 70px); }
        .card { background-color: var(--bg-card-light); color: var(--text-card-light); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.07); padding: 25px; margin-bottom: 25px; transition: background-color 0.3s, color 0.3s, border-color 0.3s; border: 1px solid var(--border-card-light); }
        .table-header th { background-color: var(--bg-table-header-light); color: var(--text-table-header-light); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.8rem; padding-top: 12px; padding-bottom: 12px; border-bottom: 2px solid var(--border-table-header-light); transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        .table-row td { color: var(--text-table-row-light); border-color: var(--border-table-row-light); padding: 10px 16px; transition: color 0.3s, border-color 0.3s, background-color 0.3s; vertical-align: middle; }
        .table-row:hover td { background-color: var(--bg-table-row-hover-light); }
        .input-field, .select-field { background-color: var(--bg-input-light); color: var(--text-input-light); border: 1px solid var(--border-input-light); border-radius: 6px; padding: 10px; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        .input-field:focus, .select-field:focus { border-color: var(--border-input-focus-light); box-shadow: 0 0 0 0.2rem var(--shadow-input-focus-light); outline: none; }
        .form-checkbox { border-color: var(--border-input-light); background-color: var(--bg-input-light); }
        .form-checkbox:checked { background-color: var(--border-input-focus-light); border-color: var(--border-input-focus-light); }
        .btn { padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: 500; text-transform: capitalize; display: inline-flex; align-items: center; gap: 8px; border: none; }
        .btn-primary { background-color: var(--bg-button-primary-light); color: var(--text-button-primary-light); }
        .btn-primary:hover { background-color: var(--bg-button-primary-hover-light); }
        .btn-secondary { background-color: #475569; color: #e2e8f0; } .btn-secondary:hover { background-color: #334155; }
        .btn-info { background-color: #5dade2; color: #1A202C; } .btn-info:hover { background-color: #3498db; }
        .btn-danger { background-color: #ef4444; color: white; } .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #22c55e; color: white; } .btn-success:hover { background-color: #16a34a; }
        .btn-warning { background-color: #f59e0b; color: white; } .btn-warning:hover { background-color: #d97706; }
        .btn-teal { background-color: #14b8a6; color: white; } .btn-teal:hover { background-color: #0d9488; }
        .btn-purple { background-color: #8b5cf6; color: white; } .btn-purple:hover { background-color: #7c3aed; }

        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--bg-card-light); color: var(--text-card-light); margin: auto; padding: 30px; border: 1px solid var(--border-card-light); width: 90%; max-width: 900px; border-radius: 8px; position: relative; animation: slideIn 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.15); max-height: 90vh; overflow-y: auto; }
        .close-button { color: #9ca3af; position: absolute; right: 15px; top: 15px; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .close-button:hover, .close-button:focus { color: #e2e8f0; text-decoration: none; }
        #recentActivityList li { border-bottom-color: var(--border-table-row-light); } #recentActivityList .text-placeholder { color: var(--text-placeholder-light); }
        #paginationControls span { color: var(--text-primary-light); }
        #google-login-container { margin-top: auto; padding: 15px; border-top: 1px solid #4b5563;}
        #user-info { display: flex; align-items: center; gap: 10px; } #user-info img { border-radius: 50%; width: 32px; height: 32px; border: 2px solid var(--border-card-light);}
        #user-info span { font-size: 0.9em; font-weight: 500; }
        .checkbox-cell { width: 1%; white-space: nowrap; }
        .priority-Alta { background-color: #fee2e2 !important; color: #b91c1c !important; } .priority-Urgente { background-color: #ffedd5 !important; color: #c2410c !important; animation: pulse 1.5s infinite; }
        .priority-M√©dia { background-color: #fef3c7 !important; color: #a16207 !important; } .priority-Baixa { background-color: #dcfce7 !important; color: #15803d !important; }
        .status-cell span { display: flex; align-items: center; }
        .manual-flag-toggle, .logistica-toggle { cursor: pointer; margin-left: 5px; }
        .status-tag { padding: 0.25rem 0.6rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; text-align: center; display: inline-block; border: 1px solid transparent; }
        .status-completa { background-color: #dcfce7; color: #166534; border-color: #6ee7b7; }
        .status-incompleta { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; }
        .status-provisoria { background-color: #ffedd5; color: #9a3412; border-color: #fdba74; }
        .status-conflitante { background-color: #fef3c7; color: #92400e; border-color: #fcd34d; }
        .status-default { background-color: var(--bg-input-light); color: var(--text-input-light); border-color: var(--border-input-light); }
        .motivos-popover { display: none; position: absolute; background-color: var(--bg-card-light); border: 1px solid var(--border-card-light); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 110; padding: 15px; width: 280px; }
        .motivos-popover label { display: block; margin-bottom: 8px; font-size: 0.875rem; }
        .motivos-popover input[type="checkbox"] { margin-right: 8px; }
        .motivos-popover button { margin-top: 10px; width: 100%; }
        .selected-motivos-display { font-size: 0.75rem; color: var(--text-placeholder-light); max-width: 150px; white-space: normal; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } } @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} } @keyframes slideIn { from {transform: translateY(-30px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        ::-webkit-scrollbar { width: 8px; height: 8px;} ::-webkit-scrollbar-track { background: #1e293b; } ::-webkit-scrollbar-thumb { background: #475569; } ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .g_id_signin div[role="button"] { background-color: #1e293b !important; color: #e2e8f0 !important; border: 1px solid #475569 !important;} .g_id_signin svg { fill: #e2e8f0 !important; }
        .home-card-link { cursor: pointer; transition: transform 0.2s ease-in-out; } .home-card-link:hover { transform: translateY(-3px); }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="flex"> <aside id="sidebar" class="sidebar p-3">
        <div>
            <div class="sidebar-header"> <div id="sidebar-title" class="flex items-center"> <i class="fas fa-tasks text-2xl text-sky-500"></i> <span class="text-xl font-semibold">Gest√£o OS</span> </div> <button id="toggleSidebar" class="text-slate-400 hover:text-white focus:outline-none p-1 rounded-md"> <i class="fas fa-bars text-lg"></i> </button> </div>
            <nav class="flex-grow mt-2">
                <ul>
                    <li class="sidebar-item active" onclick="showView('homeView', this)"> <i class="fas fa-home"></i> <span>Home</span> </li>
                    <li class="sidebar-item" onclick="showView('osListView', this)"> <i class="fas fa-list-alt"></i> <span>Ordens de Servi√ßo</span> </li>
                    <li class="sidebar-item" onclick="showView('reportsView', this)"> <i class="fas fa-chart-pie"></i> <span>Relat√≥rios</span> </li>
                    <li class="sidebar-item mt-4" onclick="openAddOSModal()"> <i class="fas fa-plus-circle text-green-500"></i> <span class="text-green-500">Nova OS</span> </li>
                </ul>
            </nav>
        </div>
        <div id="google-login-container" class="px-2">
            <div id="g_id_onload" data-client_id="232267534625-ti8c7jd14nfqigmmj3lnevv8nvds3i0t.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
            <div id="user-info" class="mt-2 hidden"> <img id="user-pic" src="" alt="User Pic" class="w-8 h-8 rounded-full mr-2"> <span id="user-name" class="text-sm font-medium"></span> <button onclick="handleSignOut()" class="btn btn-xs btn-danger !p-1.5 !text-xs ml-auto"><i class="fas fa-sign-out-alt"></i></button> </div>
        </div>
        <div class="mt-auto pb-2">
            <div class="sidebar-item" onclick="showView('settingsView', this)"> <i class="fas fa-cog"></i> <span>Configura√ß√µes</span> </div>
            <div class="sidebar-item text-sm text-slate-500 dark:text-slate-400"> <i class="fas fa-info-circle"></i> <span id="appVersion">Vers√£o X.Y.Z</span> </div>
        </div>
    </aside>

    <main id="mainContent" class="content">
      <div id="homeView" class="view-section card">
            <h2 class="text-3xl font-bold mb-6">P√°gina Inicial</h2>
            <div class="mb-6 p-4 bg-slate-800 rounded-lg border border-slate-700"> <h3 class="text-xl font-semibold mb-2">üéØ Objetivo do Site</h3>
                <p class="text-sm text-slate-300 leading-relaxed"> Este sistema foi desenvolvido para otimizar o Gerenciamento Interno de Ordens de Servi√ßo (OS). O objetivo principal √© fornecer uma plataforma centralizada e eficiente para o cadastro, acompanhamento detalhado, filtragem avan√ßada e gera√ß√£o de relat√≥rios perspicazes sobre todas as OS. Com isso, buscamos maior organiza√ß√£o, agilidade nos processos e melhor tomada de decis√£o. </p>
                <h3 class="text-xl font-semibold mt-6 mb-2">üìä Vis√£o Geral das Funcionalidades</h3>
                <ul class="list-disc list-inside text-sm text-slate-300 mt-2 space-y-1 pl-4">
                    <li><strong>Home:</strong> Vis√£o geral dos indicadores chave e acesso r√°pido √†s funcionalidades.</li>
                    <li><strong>Ordens de Servi√ßo:</strong> Liste, filtre (incluindo por marcadores manuais de "N√£o Realizada no Prazo" e "Log√≠stica OK"), edite, gerencie e importe OS em lote. Novo status "Conflitante" dispon√≠vel.</li>
                    <li><strong>Relat√≥rios:</strong> Gere relat√≥rios personalizados com gr√°ficos para an√°lises detalhadas. Exporte em CSV, PDF (com ou sem gr√°ficos) ou como imagem da lista. Adicionada coluna de Status e "Motivos" manuais para inconformidades.</li>
                    <li><strong>Nova OS:</strong> Crie novas Ordens de Servi√ßo de forma r√°pida e intuitiva, com op√ß√£o para os novos marcadores e status.</li>
                </ul>
                <p class="text-sm text-slate-300 leading-relaxed mt-3"> Utilize os cards abaixo para uma navega√ß√£o √°gil pelas principais m√©tricas e se√ß√µes do sistema. </p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-sky-500 to-sky-600 p-6 rounded-xl shadow-lg text-white home-card-link" onclick="navigateToOsListWithFilter('Aberta')"> <div class="flex justify-between items-center"> <h3 class="text-lg font-medium">OS Abertas</h3> <i class="fas fa-folder-open text-3xl opacity-70"></i> </div> <p id="osAbertasCount" class="text-4xl font-bold mt-2">0</p> </div>
                <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 p-6 rounded-xl shadow-lg text-white home-card-link" onclick="navigateToOsListWithFilter('Completa', true)"> <div class="flex justify-between items-center"> <h3 class="text-lg font-medium">OS Completas (M√™s)</h3> <i class="fas fa-check-circle text-3xl opacity-70"></i> </div> <p id="osCompletasMesCount" class="text-4xl font-bold mt-2">0</p> </div>
                <div class="bg-gradient-to-br from-amber-500 to-amber-600 p-6 rounded-xl shadow-lg text-white home-card-link" onclick="navigateToOsListWithFilter(['Pendente Informa√ß√£o', 'Aguardando Aprova√ß√£o'])"> <div class="flex justify-between items-center"> <h3 class="text-lg font-medium">OS Pendentes</h3> <i class="fas fa-exclamation-triangle text-3xl opacity-70"></i> </div> <p id="osPendentesCount" class="text-4xl font-bold mt-2">0</p> </div>
                <div class="bg-gradient-to-br from-rose-500 to-rose-600 p-6 rounded-xl shadow-lg text-white home-card-link" onclick="navigateToOsListWithFilter('Cancelada')"> <div class="flex justify-between items-center"> <h3 class="text-lg font-medium">OS Canceladas</h3> <i class="fas fa-times-circle text-3xl opacity-70"></i> </div> <p id="osCanceladasCount" class="text-4xl font-bold mt-2">0</p> </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card !p-0"> <div class="p-4 border-b border-slate-700"> <h3 class="text-xl font-semibold">Distribui√ß√£o de Status das OS</h3> </div> <div id="osStatusChartContainer" class="p-4 min-h-[300px]"> <canvas id="osStatusChart"></canvas> </div> </div>
                <div class="card"> <h3 class="text-xl font-semibold mb-3">Atividades Recentes</h3> <ul id="recentActivityList" class="space-y-3 max-h-80 overflow-y-auto"> <li class="text-sm text-placeholder">Nenhuma atividade recente.</li> </ul> </div>
            </div>
        </div>

        <div id="osListView" class="view-section card hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold">Ordens de Servi√ßo</h2>
                <div class="flex gap-2 flex-wrap items-center">
                    <div id="bulkActionsContainer" class="hidden flex gap-2 items-center mr-4"> <span id="selectedOsCount" class="text-sm">0 selecionadas</span>
                        <select id="bulkActionStatus" class="select-field p-2 rounded-md text-sm">
                            <option value="">Alterar Status para...</option> <option value="Aberta">Aberta</option> <option value="Em Andamento">Em Andamento</option> <option value="Pendente Informa√ß√£o">Pendente Informa√ß√£o</option> <option value="Aguardando Aprova√ß√£o">Aguardando Aprova√ß√£o</option> <option value="Completa">Completa</option> <option value="Incompleta">Incompleta</option> <option value="Provis√≥ria">Provis√≥ria</option> <option value="Conflitante">Conflitante</option> <option value="Cancelada">Cancelada</option>
                        </select>
                        <button class="btn btn-sm btn-primary" onclick="applyBulkAction()"><i class="fas fa-check"></i> Aplicar</button> <button class="btn btn-sm btn-danger" onclick="bulkDeleteSelectedOS()"><i class="fas fa-trash"></i> Excluir</button>
                    </div>
                    <button class="btn btn-success" onclick="exportTableToCSV('osTable', 'lista_os.csv')"><i class="fas fa-file-csv"></i>Exportar CSV</button>
                    <button class="btn btn-danger" onclick="exportTableToPDF('osTable', 'Lista de Ordens de Servi√ßo', 'osTableBody')"><i class="fas fa-file-pdf"></i>Exportar PDF</button>
                    <button class="btn btn-primary" onclick="openAddOSModal()"> <i class="fas fa-plus"></i> Adicionar OS </button>
                    <button class="btn btn-info" onclick="toggleImportSection()"><i class="fas fa-file-excel"></i> Importar OS em Lote</button>
                </div>
            </div>
            <div id="importOsLoteContainer" class="card hidden mb-6 bg-slate-800 border border-slate-700">
                <div class="flex justify-between items-center mb-3"> <h3 class="text-xl font-semibold text-slate-100"> <i class="fas fa-file-excel mr-2 text-green-500"></i>Importar OS em Lote </h3> <button onclick="toggleImportSection()" class="text-slate-400 hover:text-slate-200 text-xl">&times;</button> </div>
                <p class="text-xs text-slate-400 mb-3"> Selecione (.xlsx, .xls, .csv). Colunas prim√°rias: C√≥digo, Status (ex: Aberta, Completa, Incompleta, Provis√≥ria, Conflitante), Cliente, In√≠cio (dd/mm/aaaa hh:mm), T√©rmino (dd/mm/aaaa hh:mm), T√©cnico, Solicitante. </p>
                <div class="flex flex-col sm:flex-row gap-3 items-start"> <input type="file" id="excelFileInput" class="input-field p-2 rounded-md border-slate-600 text-sm w-full sm:w-auto file:mr-4 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sky-700 file:text-sky-200 hover:file:bg-sky-600 cursor-pointer flex-grow" accept=".xlsx, .xls, .csv"> <button id="processExcelButton" class="btn btn-sm btn-success whitespace-nowrap w-full sm:w-auto mt-2 sm:mt-0"> <i class="fas fa-upload"></i> Processar Arquivo </button> </div>
                <div id="importStatusMessage" class="mt-3 text-xs"> </div> <div id="importSummary" class="mt-2 text-xs hidden"> <p class="font-semibold mb-1"><strong>Resumo da Importa√ß√£o:</strong></p> <ul id="importSummaryList" class="list-disc list-inside pl-3 space-y-0.5 max-h-32 overflow-y-auto"></ul> </div>
            </div>
            <div class="w-full md:flex-grow">
                <div class="mb-6 p-4 bg-slate-800 rounded-lg border border-slate-700">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <input type="text" id="filterOsNumber" placeholder="N¬∫ OS" class="input-field p-2 rounded-md">
                        <input type="text" id="filterClient" placeholder="Cliente" class="input-field p-2 rounded-md">
                        <input type="text" id="filterDescription" placeholder="Buscar na Descri√ß√£o..." class="input-field p-2 rounded-md">
                        <select id="filterProduct" class="select-field p-2 rounded-md"> <option value="">Todos os Produtos</option> </select>
                        <select id="filterStatus" class="select-field p-2 rounded-md"> <option value="">Todos os Status</option> <option value="Aberta">Aberta</option> <option value="Em Andamento">Em Andamento</option> <option value="Pendente Informa√ß√£o">Pendente Informa√ß√£o</option> <option value="Aguardando Aprova√ß√£o">Aguardando Aprova√ß√£o</option> <option value="Completa">Completa</option> <option value="Incompleta">Incompleta</option> <option value="Provis√≥ria">Provis√≥ria</option> <option value="Conflitante">Conflitante</option> <option value="Cancelada">Cancelada</option></select>
                        <div> <label for="filterMarcadorAtraso" class="block text-xs font-medium mb-0.5">Atraso (Manual):</label> <select id="filterMarcadorAtraso" class="select-field p-2 rounded-md w-full text-sm"> <option value="">Todos</option> <option value="marcada">Marcada</option> <option value="nao_marcada">N√£o Marcada</option> </select> </div>
                        <div> <label for="filterLogisticaOk" class="block text-xs font-medium mb-0.5">Log√≠stica Pronta:</label> <select id="filterLogisticaOk" class="select-field p-2 rounded-md w-full text-sm"> <option value="">Todos</option> <option value="sim">Sim</option> <option value="nao">N√£o</option> </select> </div>
                    </div>
                    <div class="mt-4 flex flex-wrap gap-2 items-center"> <label for="savedFilters" class="text-sm font-medium">Filtros Salvos:</label> <select id="savedFilters" class="select-field p-2 rounded-md text-sm"> <option value="">Carregar filtro...</option> </select> <button class="btn btn-sm btn-secondary" onclick="loadSelectedFilter()"><i class="fas fa-download"></i> Carregar</button> <input type="text" id="newFilterName" placeholder="Nome do novo filtro" class="input-field p-2 rounded-md text-sm"> <button class="btn btn-sm btn-primary" onclick="saveCurrentFilters()"><i class="fas fa-save"></i> Salvar Filtro</button> <button class="btn btn-sm btn-danger" onclick="deleteSavedFilter()" title="Excluir filtro"><i class="fas fa-trash-alt"></i></button> </div>
                </div>
                <div class="overflow-x-auto shadow-md rounded-lg">
                    <table id="osTable" class="min-w-full">
                       <thead class="table-header"> <tr> <th class="py-3 px-2 text-center checkbox-cell"><input type="checkbox" id="selectAllOsCheckbox" onchange="toggleSelectAllOS(this)" class="form-checkbox h-4 w-4"></th><th class="py-3 px-4 text-left">N¬∫ OS</th> <th class="py-3 px-4 text-left">Cliente</th> <th class="py-3 px-4 text-left">Produto</th> <th class="py-3 px-4 text-left">Descri√ß√£o</th> <th class="py-3 px-4 text-left">Data Abertura</th> <th class="py-3 px-4 text-left">Prazo Final</th> <th class="py-3 px-4 text-left">Respons√°vel</th> <th class="py-3 px-4 text-left">Solicitante</th> <th class="py-3 px-4 text-left">Status</th><th class="py-3 px-4 text-left">Log√≠stica</th> <th class="py-3 px-4 text-left">Prioridade</th> <th class="py-3 px-4 text-left">A√ß√µes</th> </tr> </thead> <tbody id="osTableBody" class="divide-y divide-slate-700"></tbody> </table>
                </div> <div id="paginationControls" class="mt-6 flex justify-end items-center gap-2"></div>
            </div>
        </div>

        <div id="reportsView" class="view-section card hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold">Relat√≥rios Personalizados</h2>
                <div class="flex gap-2 flex-wrap items-center">
                    <button class="btn btn-success !py-1.5 !px-3 !text-xs" onclick="exportTableToCSV('reportsTable', 'relatorio_os_personalizado.csv')"><i class="fas fa-file-csv mr-1"></i> CSV</button>
                    <button class="btn btn-danger !py-1.5 !px-3 !text-xs" onclick="exportReportToPDFWithCharts('reportsTable', 'Relat√≥rio Detalhado de OS', 'reportsTableBody', ['reportChartByProduct', 'reportChartByUsuario', 'reportChartByStatus'], true)"><i class="fas fa-file-pdf mr-1"></i> PDF (c/ Gr√°ficos)</button>
                    <button class="btn btn-danger !py-1.5 !px-3 !text-xs" onclick="exportReportToPDFWithCharts('reportsTable', 'Relat√≥rio de Dados OS', 'reportsTableBody', [], false)"><i class="fas fa-file-alt mr-1"></i> PDF (Lista)</button>
                    <button class="btn btn-teal !py-1.5 !px-3 !text-xs" onclick="exportVisibleListToImage('reportTableContainer', 'imagem_lista_os.png', false)"><i class="fas fa-image mr-1"></i> Img (Lista)</button>
                    <button class="btn btn-purple !py-1.5 !px-3 !text-xs" onclick="exportVisibleListToImage('reportsView', 'imagem_relatorio_completo.png', true)"><i class="fas fa-palette mr-1"></i> Img (Completo)</button>
                </div>
            </div>
            <div class="mb-6 p-4 bg-slate-800 rounded-lg border border-slate-700">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                    <div> <label for="reportDateStartFilter" class="block text-sm font-medium mb-1">Data Inicial (Prazo):</label> <input type="date" id="reportDateStartFilter" name="reportDateStartFilter" class="input-field w-full p-2 rounded-md"> </div>
                    <div> <label for="reportDateEndFilter" class="block text-sm font-medium mb-1">Data Final (Prazo):</label> <input type="date" id="reportDateEndFilter" name="reportDateEndFilter" class="input-field w-full p-2 rounded-md"> </div>
                    <div> <label for="reportStatusFilter" class="block text-sm font-medium mb-1">Status OS:</label>
                        <select id="reportStatusFilter" class="select-field w-full p-2 rounded-md"> <option value="">Todos</option> <option value="Aberta">Aberta</option> <option value="Em Andamento">Em Andamento</option> <option value="Pendente Informa√ß√£o">Pendente Informa√ß√£o</option> <option value="Aguardando Aprova√ß√£o">Aguardando Aprova√ß√£o</option> <option value="Completa">Completa</option> <option value="Incompleta">Incompleta</option> <option value="Provis√≥ria">Provis√≥ria</option> <option value="Conflitante">Conflitante</option> <option value="Cancelada">Cancelada</option></select>
                    </div>
                    <div> <label for="reportFilterMarcadorAtraso" class="block text-sm font-medium mb-1">Atraso (Manual):</label> <select id="reportFilterMarcadorAtraso" class="select-field w-full p-2 rounded-md"> <option value="">Todos</option> <option value="marcada">Marcada</option> <option value="nao_marcada">N√£o Marcada</option> </select> </div>
                    <div class="md:col-span-2"> <label for="reportProductFilter" class="block text-sm font-medium mb-1">Produto:</label> <select id="reportProductFilter" class="select-field w-full p-2 rounded-md"> <option value="">Todos</option></select> </div>
                    <div class="md:col-span-2"> <label for="reportFilterLogisticaOk" class="block text-sm font-medium mb-1">Log√≠stica Pronta:</label> <select id="reportFilterLogisticaOk" class="select-field w-full p-2 rounded-md"> <option value="">Todos</option> <option value="sim">Sim</option> <option value="nao">N√£o</option> </select> </div>
                </div>
                <div class="mt-4"> <button class="btn btn-primary" onclick="generateCustomReport()"><i class="fas fa-filter"></i> Gerar Relat√≥rio</button> </div>
            </div>
            <div id="customReportChartsContainer" class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="card !shadow-lg flex flex-col p-4 min-h-[380px]">  <h4 class="text-lg font-semibold mb-3 text-center text-slate-200">OS por Produto</h4>  <div class="flex-grow relative w-full h-full min-h-[280px]"> <canvas id="reportChartByProduct"></canvas> </div>  </div>
                <div class="card !shadow-lg flex flex-col p-4 min-h-[380px]">  <h4 class="text-lg font-semibold mb-3 text-center text-slate-200">OS por Solicitante</h4>  <div class="flex-grow relative w-full h-full min-h-[280px]"> <canvas id="reportChartByUsuario"></canvas> </div>  </div>
                <div class="card !shadow-lg flex flex-col p-4 min-h-[380px]">  <h4 class="text-lg font-semibold mb-3 text-center text-slate-200">OS por Status (Relat√≥rio)</h4>  <div class="flex-grow relative w-full h-full min-h-[280px]"> <canvas id="reportChartByStatus"></canvas> </div>  </div>
            </div>
            <div id="reportTableContainer" class="overflow-x-auto shadow-md rounded-lg">
                <table id="reportsTable" class="min-w-full">
                    <thead class="table-header">
                        <tr>
                            <th class="py-3 px-4 text-left">C√≥digo OS</th> <th class="py-3 px-4 text-left">Solicitante</th> <th class="py-3 px-4 text-left">Cliente</th>
                            <th class="py-3 px-4 text-left">In√≠cio</th> <th class="py-3 px-4 text-left">T√©rmino</th> <th class="py-3 px-4 text-left">Respons√°vel</th>
                            <th class="py-3 px-4 text-left">Log√≠stica</th> <th class="py-3 px-4 text-left">Produto</th> <th class="py-3 px-4 text-center">Status OS</th>
                            <th class="py-3 px-4 text-left">Motivo Inconf.</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody" class="divide-y divide-slate-700"> <tr class="table-row"><td colspan="10" class="text-center py-10 text-slate-400">Selecione filtros e clique "Gerar Relat√≥rio".</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="settingsView" class="view-section card hidden">
            <h2 class="text-3xl font-bold mb-6">Configura√ß√µes</h2>
            <div class="space-y-8">
                <div> <h3 class="text-xl font-semibold mb-3 border-b pb-2 border-slate-700">Gest√£o da P√°gina</h3> <div class="space-y-4"> <div> <button class="btn btn-danger" onclick="confirmClearAllData()"><i class="fas fa-trash-alt"></i> Limpar Todos os Dados das OS</button> <p class="text-xs text-slate-400 mt-1">Aten√ß√£o: Irrevers√≠vel, apaga todas as OS salvas localmente.</p> </div> </div> </div>
                <div> <h3 class="text-xl font-semibold mb-3 border-b pb-2 border-slate-700">Visualiza√ß√£o</h3> <div class="space-y-4"> <div> <label for="itemsPerPageSetting" class="block text-sm font-medium mb-1">Itens por P√°gina na Lista de OS:</label> <input type="number" id="itemsPerPageSetting" value="10" min="5" max="50" step="5" class="input-field p-2 rounded-md w-full md:w-1/4"> <button class="btn btn-sm btn-primary ml-2" onclick="applyItemsPerPageSetting()">Aplicar</button> </div> </div> </div>
            </div>
        </div>
    </main>
    <div id="osModal" class="modal hidden"> <div class="modal-content"> <span class="close-button" onclick="closeOSModal()">&times;</span> <h3 id="modalTitle" class="text-2xl font-semibold mb-6">Adicionar Nova Ordem de Servi√ßo</h3> <form id="osForm"> <input type="hidden" id="osId">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-4">
            <div> <label for="osNumeroModal" class="block text-sm font-medium mb-1">N¬∫ OS <span class="text-red-500">*</span></label> <input type="text" id="osNumeroModal" name="osNumeroModal" class="input-field w-full p-2 rounded-md" required> </div>
            <div> <label for="osClienteModal" class="block text-sm font-medium mb-1">Cliente <span class="text-red-500">*</span></label> <input type="text" id="osClienteModal" name="osClienteModal" class="input-field w-full p-2 rounded-md" required> </div>
            <div> <label for="osProdutoModal" class="block text-sm font-medium mb-1">Produto/Servi√ßo <span class="text-red-500">*</span></label> <input type="text" id="osProdutoModal" name="osProdutoModal" list="productList" class="input-field w-full p-2 rounded-md" required> <datalist id="productList"></datalist> </div>
            <div> <label for="osSolicitanteModal" class="block text-sm font-medium mb-1">Solicitante</label> <input type="text" id="osSolicitanteModal" name="osSolicitanteModal" class="input-field w-full p-2 rounded-md"> </div>
        </div>
        <div class="mb-4"> <label for="osDescricaoModal" class="block text-sm font-medium mb-1">Descri√ß√£o Detalhada <span class="text-red-500">*</span></label> <textarea id="osDescricaoModal" name="osDescricaoModal" rows="3" class="input-field w-full p-2 rounded-md" required></textarea> </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-4">
            <div> <label for="osDataAberturaModal" class="block text-sm font-medium mb-1">Data de Abertura <span class="text-red-500">*</span></label> <input type="date" id="osDataAberturaModal" name="osDataAberturaModal" class="input-field w-full p-2 rounded-md" required> </div>
            <div> <label for="osPrazoFinalModal" class="block text-sm font-medium mb-1">Prazo Final <span class="text-red-500">*</span></label> <input type="date" id="osPrazoFinalModal" name="osPrazoFinalModal" class="input-field w-full p-2 rounded-md" required> </div>
            <div> <label for="osResponsavelModal" class="block text-sm font-medium mb-1">Respons√°vel (Colaborador) <span class="text-red-500">*</span></label> <input type="text" id="osResponsavelModal" name="osResponsavelModal" class="input-field w-full p-2 rounded-md" required> </div>
            <div> <label for="osStatusModal" class="block text-sm font-medium mb-1">Status <span class="text-red-500">*</span></label>
                <select id="osStatusModal" name="osStatusModal" class="select-field w-full p-2 rounded-md" required> <option value="Aberta">Aberta</option> <option value="Em Andamento">Em Andamento</option> <option value="Pendente Informa√ß√£o">Pendente Informa√ß√£o</option> <option value="Aguardando Aprova√ß√£o">Aguardando Aprova√ß√£o</option> <option value="Completa">Completa</option> <option value="Incompleta">Incompleta</option><option value="Provis√≥ria">Provis√≥ria</option> <option value="Conflitante">Conflitante</option> <option value="Cancelada">Cancelada</option></select>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 mb-6 items-center">
            <div> <label for="osPrioridadeModal" class="block text-sm font-medium mb-1">Prioridade <span class="text-red-500">*</span></label> <select id="osPrioridadeModal" name="osPrioridadeModal" class="select-field w-full p-2 rounded-md" required> <option value="Baixa">Baixa</option> <option value="M√©dia" selected>M√©dia</option> <option value="Alta">Alta</option> <option value="Urgente">Urgente</option> </select> </div>
            <div class="flex items-center pt-5"> <input type="checkbox" id="osMarcadorAtrasoModal" name="osMarcadorAtrasoModal" class="form-checkbox h-4 w-4 text-purple-600 border-slate-300 rounded focus:ring-purple-500 mr-2"> <label for="osMarcadorAtrasoModal" class="text-sm font-medium">Marcar "N√£o Realizada no Prazo"</label> </div>
            <div class="flex items-center pt-5"> <input type="checkbox" id="osLogisticaOkModal" name="osLogisticaOkModal" class="form-checkbox h-4 w-4 text-teal-600 border-slate-300 rounded focus:ring-teal-500 mr-2"> <label for="osLogisticaOkModal" class="text-sm font-medium">Log√≠stica Pronta/OK</label> </div>
        </div>
        <div class="flex justify-end gap-3"> <button type="button" class="btn btn-secondary" onclick="closeOSModal()">Cancelar</button> <button type="submit" class="btn btn-primary">Salvar OS</button> </div> </form>
    </div> </div>

    <div id="motivosPopover" class="motivos-popover">
        <h4 class="text-md font-semibold mb-3 text-slate-200">Selecionar Motivos</h4>
        <div id="motivosCheckboxContainer" class="space-y-2">
        </div>
        <div class="mt-4 flex gap-2">
            <button class="btn btn-sm btn-primary flex-1" onclick="closeMotivosPopover(true)">Confirmar</button>
            <button class="btn btn-sm btn-secondary flex-1" onclick="closeMotivosPopover(false)">Cancelar</button>
        </div>
    </div>
<script>
    // ==========================================================================
    // VARI√ÅVEIS GLOBAIS E CONFIGURA√á√ïES INICIAIS
    // ==========================================================================
    const APP_VERSION = "1.9.5"; // Nova vers√£o para este conjunto completo
    const ITEMS_PER_PAGE_DEFAULT = 10;
    let ITEMS_PER_PAGE = ITEMS_PER_PAGE_DEFAULT;
    let currentPage = 1;
    let ordensServico = [];
    let reportOsMotivos = {};
    let currentEditingOsIdForMotivos = null;

    const defaultProducts = ["WORKNC", "EDGECAM", "ESPRIT", "ALPHACAM", "LANTEK", "SOLIDWORKS CAD", "SOLIDWORKS PDM", "SYNECO", "HEXAGON Scanner", "Impressora 3D Markforged", "Servi√ßo de Consultoria", "Treinamento Software X", "Outro"];
    const motivoOptions = [
        "Sem Pr√©-OS", "Sem Anexos", "Sem informa√ß√µes",
        "Sem Atividades", "Sem Participantes", "Informa√ß√µes incompletas"
    ];
    const validStatusesGlobal = ["Aberta", "Em Andamento", "Pendente Informa√ß√£o", "Aguardando Aprova√ß√£o", "Completa", "Incompleta", "Provis√≥ria", "Conflitante", "Cancelada"];

    let googleUser = null;
    let savedFilters = {};

    let osStatusChartInstance = null;
    let reportChartByProductInstance = null;
    let reportChartByUsuarioInstance = null;
    let reportChartByStatusInstance = null;

    // Elementos DOM ser√£o definidos em DOMContentLoaded para garantir que existam
    let osModal, osForm, modalTitle, productDatalist, filterProductSelect, reportProductSelect;
    let recentActivityList, importStatusMessage, importSummaryDiv, importSummaryList;
    let sidebar, mainContent, toggleSidebarBtn, sidebarTitleDiv;


    // ==========================================================================
    // FUN√á√ïES AUXILIARES DE DATA, FORMATO E ESTILO
    // ==========================================================================
    function formatDateToBR(dateString) { if (!dateString) return 'N/A'; if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateString)) { const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; } const d = new Date(dateString); if (isNaN(d.getTime())) return 'N/A'; let day, month, year; if (typeof dateString === 'string' && dateString.includes('-')) { const parts = dateString.split('-'); year = parseInt(parts[0],10); month = parseInt(parts[1],10); day = parseInt(parts[2],10); const validDate = new Date(year, month - 1, day); return `${String(validDate.getDate()).padStart(2, '0')}/${String(validDate.getMonth() + 1).padStart(2, '0')}/${validDate.getFullYear()}`; } else { day = String(d.getUTCDate()).padStart(2, '0'); month = String(d.getUTCMonth() + 1).padStart(2, '0'); year = d.getUTCFullYear(); return `${day}/${month}/${year}`; } }
    function excelSerialDateToYYYYMMDD(serial) { if (serial === null || serial === undefined || serial === '' || isNaN(parseFloat(serial))) return null; const excelEpochDiff = 25569; let date; if (serial >= 60) { date = new Date(Math.round((serial - excelEpochDiff - 1) * 86400 * 1000)); } else { if (serial === 60) return null; date = new Date(Math.round((serial - excelEpochDiff) * 86400 * 1000));} if (isNaN(date.getTime())) return null; const year = date.getUTCFullYear(), month = String(date.getUTCMonth() + 1).padStart(2, '0'), day = String(date.getUTCDate()).padStart(2, '0'); if (year < 1890 || year > 2300) return null; return `${year}-${month}-${day}`; }
    function parseAndValidateDate(dateValue, fieldNameForLog = "Data") { if (dateValue === null || String(dateValue || '').trim() === '') return { date: null, error: `${fieldNameForLog} ausente.` }; let parsedDateObj = null; if (dateValue instanceof Date) { if (!isNaN(dateValue.getTime())) parsedDateObj = dateValue; } else if (typeof dateValue === 'number' && dateValue > 0 && dateValue < 200000) { const ymd = excelSerialDateToYYYYMMDD(dateValue); if (ymd) { const [year, month, day] = ymd.split('-').map(Number); parsedDateObj = new Date(Date.UTC(year, month - 1, day));}} else if (typeof dateValue === 'string') { let tempDateStr = String(dateValue).trim(), parts; const dateTimeRegex = /^(\d{1,2})[\\/\.-](\d{1,2})[\\/\.-](\d{2}|\d{4})(?:[ T_](\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?$/; if ((parts = tempDateStr.match(dateTimeRegex))) { const day = parseInt(parts[1],10), month = parseInt(parts[2],10)-1; let year = parseInt(parts[3],10); if(year<100) year+=2000; const hour = parts[4]?parseInt(parts[4],10):0, minute = parts[5]?parseInt(parts[5],10):0, second = parts[6]?parseInt(parts[6],10):0; if (month>=0&&month<=11&&day>=1&&day<=31) { parsedDateObj=new Date(Date.UTC(year,month,day,hour,minute,second)); if(parsedDateObj.getUTCFullYear()!==year||parsedDateObj.getUTCMonth()!==month||parsedDateObj.getUTCDate()!==day) parsedDateObj=null; }} else { const isoDateRegex = /^(\d{4})[\\/\.-](\d{1,2})[\\/\.-](\d{1,2})(?:[ T_](\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?$/; if ((parts = tempDateStr.match(isoDateRegex))) { const year = parseInt(parts[1],10), month = parseInt(parts[2],10)-1, day = parseInt(parts[3],10); const hour = parts[4]?parseInt(parts[4],10):0, minute = parts[5]?parseInt(parts[5],10):0, second = parts[6]?parseInt(parts[6],10):0; if (month>=0&&month<=11&&day>=1&&day<=31) { parsedDateObj=new Date(Date.UTC(year,month,day,hour,minute,second)); if(parsedDateObj.getUTCFullYear()!==year||parsedDateObj.getUTCMonth()!==month||parsedDateObj.getUTCDate()!==day) parsedDateObj=null; }}}} if (parsedDateObj && !isNaN(parsedDateObj.getTime())) { const year = parsedDateObj.getUTCFullYear(), monthStr = String(parsedDateObj.getUTCMonth()+1).padStart(2,'0'), dayStr = String(parsedDateObj.getUTCDate()).padStart(2,'0'); if (year < 1890 || year > 2300) return { date: null, error: `${fieldNameForLog} ("${String(dateValue).substring(0,20)}") ano inv√°lido (${year}).` }; return { date: `${year}-${monthStr}-${dayStr}`, error: null }; } return { date: null, error: `${fieldNameForLog} ("${String(dateValue).substring(0,30)}") formato inv√°lido/n√£o reconhecido.` }; }
    function getPriorityClass(priority) { switch (priority) { case 'Alta': return 'priority-Alta'; case 'Urgente': return 'priority-Urgente'; case 'M√©dia': return 'priority-M√©dia'; case 'Baixa': return 'priority-Baixa'; default: return 'bg-slate-700 text-slate-300'; } }
    function generateId() { return 'OS' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5).toUpperCase(); }
    function getStatusClass(status) { switch (status) { case 'Completa': return 'status-completa'; case 'Incompleta': return 'status-incompleta'; case 'Provis√≥ria': return 'status-provisoria'; case 'Conflitante': return 'status-conflitante'; default: return 'status-default text-xs'; } }

    // ==========================================================================
    // LOCALSTORAGE, PRODUTOS, ATIVIDADE RECENTE
    // ==========================================================================
    const LOCAL_STORAGE_KEY = `gestaoOsAppData_v${APP_VERSION.replace(/\./g, '_')}`; // Chave √∫nica por vers√£o major.minor.patch
    function saveDataToLocalStorage() { console.log(`Tentando salvar dados no localStorage (chave: ${LOCAL_STORAGE_KEY})...`); try { const dataToSave = { version: APP_VERSION, ordensServico: ordensServico, googleUser: googleUser, savedFilters: savedFilters, itemsPerPage: ITEMS_PER_PAGE }; localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave)); console.log(`Dados salvos com sucesso no localStorage (chave: ${LOCAL_STORAGE_KEY}).`); } catch (e) { console.error("Erro CR√çTICO ao salvar dados no localStorage:", e); alert("ATEN√á√ÉO: Erro ao salvar os dados. Verifique o console para detalhes e se o localStorage n√£o est√° cheio."); } }
    function loadDataFromLocalStorage() { console.log(`Tentando carregar dados do localStorage (chave: ${LOCAL_STORAGE_KEY})...`); const storedDataString = localStorage.getItem(LOCAL_STORAGE_KEY); if (storedDataString) { try { const storedData = JSON.parse(storedDataString); console.log(`Dados crus do localStorage (chave: ${LOCAL_STORAGE_KEY}):`, storedData); if (storedData.version === APP_VERSION) { ordensServico = storedData.ordensServico || []; googleUser = storedData.googleUser || null; savedFilters = storedData.savedFilters || {}; ITEMS_PER_PAGE = parseInt(storedData.itemsPerPage, 10) || ITEMS_PER_PAGE_DEFAULT; ordensServico.forEach(os => { if (os.marcadorAtrasoManual === undefined) os.marcadorAtrasoManual = false; if (os.logisticaOk === undefined) os.logisticaOk = false; if (os.produto === undefined) os.produto = ''; if (os.dataAbertura) { const parsedOpen = parseAndValidateDate(os.dataAbertura, `OS ${os.numero} Data Abertura`); if(parsedOpen.error) console.warn(`Erro ao parsear dataAbertura '${os.dataAbertura}' da OS ${os.numero} ao carregar: ${parsedOpen.error}. Usando data atual.`); os.dataAbertura = parsedOpen.date || new Date().toISOString().split('T')[0];} else { os.dataAbertura = new Date().toISOString().split('T')[0]; console.warn(`OS ${os.numero} sem dataAbertura ao carregar, definindo para hoje.`); } if (os.prazoFinal) { const parsedDue = parseAndValidateDate(os.prazoFinal, `OS ${os.numero} Prazo Final`); if(parsedDue.error) console.warn(`Erro ao parsear prazoFinal '${os.prazoFinal}' da OS ${os.numero} ao carregar: ${parsedDue.error}. Usando data atual.`); os.prazoFinal = parsedDue.date || new Date().toISOString().split('T')[0];} else { os.prazoFinal = new Date().toISOString().split('T')[0]; console.warn(`OS ${os.numero} sem prazoFinal ao carregar, definindo para hoje.`);} }); console.log("Dados carregados e normalizados do localStorage:", {ordensServico_count: ordensServico.length, googleUser, savedFilters_count: Object.keys(savedFilters).length, ITEMS_PER_PAGE}); } else { console.warn(`Vers√£o dos dados (${storedData.version}) difere da aplica√ß√£o (${APP_VERSION}). Carregando padr√µes. Dados antigos n√£o foram migrados.`); ordensServico = []; googleUser = null; savedFilters = {}; ITEMS_PER_PAGE = ITEMS_PER_PAGE_DEFAULT; } } catch (e) { console.error("Erro CR√çTICO ao carregar dados do localStorage:", e); ordensServico = []; googleUser = null; savedFilters = {}; ITEMS_PER_PAGE = ITEMS_PER_PAGE_DEFAULT; alert("Erro ao carregar dados salvos. Iniciando com dados limpos."); } } else { console.log(`Nenhum dado encontrado no localStorage para '${LOCAL_STORAGE_KEY}'. Iniciando com valores padr√£o.`);} const itemsPerPageSettingElement = document.getElementById('itemsPerPageSetting'); if (itemsPerPageSettingElement) itemsPerPageSettingElement.value = ITEMS_PER_PAGE; }
    function populateProductFilters() { if (!productDatalist || !filterProductSelect || !reportProductSelect) { console.warn("Elementos de filtro de produto n√£o encontrados no DOM para popular."); return; } const products = [...new Set(ordensServico.map(os => os.produto).concat(defaultProducts).filter(pr => pr && pr.trim() !== ""))].sort((a, b) => a.localeCompare(b)); productDatalist.innerHTML = ''; filterProductSelect.innerHTML = '<option value="">Todos Produtos</option>'; reportProductSelect.innerHTML = '<option value="">Todos Produtos</option>'; products.forEach(product => { const option = document.createElement('option'); option.value = product; option.textContent = product; productDatalist.appendChild(option.cloneNode(true)); filterProductSelect.appendChild(option.cloneNode(true)); reportProductSelect.appendChild(option.cloneNode(true)); }); }
    function addRecentActivity(action, userName = null) { if (!recentActivityList) { console.warn("Elemento recentActivityList n√£o encontrado para adicionar atividade."); return; } const listItem = document.createElement('li'); const now = new Date(); let userDisplay = userName ? ` <span class="font-medium text-sky-400">(${userName})</span>` : (googleUser ? ` <span class="font-medium text-slate-400">(${googleUser.given_name || googleUser.name})</span>` : ''); listItem.className = 'flex justify-between items-center text-sm pb-2 border-b border-slate-700'; listItem.innerHTML = `<span>${action}${userDisplay}</span><span class="text-slate-500 text-xs">${now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</span>`; const placeholder = recentActivityList.querySelector('.text-placeholder'); if (placeholder) recentActivityList.innerHTML = ''; recentActivityList.insertBefore(listItem, recentActivityList.firstChild); if (recentActivityList.children.length > 7) recentActivityList.removeChild(recentActivityList.lastChild); }

    // GOOGLE SIGN-IN
    function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }
    function handleCredentialResponse(response) { const payload = parseJwt(response.credential); googleUser = { id: payload.sub, name: payload.name, given_name: payload.given_name, picture: payload.picture, email: payload.email }; saveDataToLocalStorage(); updateLoginUI(); addRecentActivity(`Usu√°rio ${googleUser.name} logado.`); }
    function handleSignOut() { const userName = googleUser ? (googleUser.given_name || googleUser.name) : "Usu√°rio"; googleUser = null; saveDataToLocalStorage(); updateLoginUI(); addRecentActivity(`${userName} deslogado.`); if (typeof google !== 'undefined' && google.accounts && google.accounts.id) google.accounts.id.disableAutoSelect(); }
    function updateLoginUI() { const userInfoDiv = document.getElementById('user-info'), gSignInDiv = document.querySelector('.g_id_signin'), userNameEl = document.getElementById('user-name'), userPicEl = document.getElementById('user-pic'); if (!userInfoDiv || !gSignInDiv || !userNameEl || !userPicEl) { console.warn("Elementos da UI de login n√£o encontrados."); return;} if (googleUser) { userNameEl.textContent = googleUser.given_name || googleUser.name; userPicEl.src = googleUser.picture; userInfoDiv.classList.remove('hidden'); gSignInDiv.classList.add('hidden'); } else { userInfoDiv.classList.add('hidden'); gSignInDiv.classList.remove('hidden'); userNameEl.textContent = ''; userPicEl.src = ''; } }

    // FILTROS SALVOS
    function populateSavedFiltersSelect() { const select = document.getElementById('savedFilters'); if (!select) return; const currentValue = select.value; select.innerHTML = '<option value="">Carregar filtro...</option>'; for (const name in savedFilters) { const option = document.createElement('option'); option.value = name; option.textContent = name; select.appendChild(option); } if (currentValue && savedFilters[currentValue]) select.value = currentValue; }
    function saveCurrentFilters() { const nameInput = document.getElementById('newFilterName'); if (!nameInput) return; const name = nameInput.value.trim(); if (!name) { alert("Especifique um nome para o filtro salvo."); return; } if (savedFilters[name] && !confirm(`O filtro salvo "${name}" j√° existe. Deseja sobrescrev√™-lo?`)) return; const descInput = document.getElementById('filterDescription'); savedFilters[name] = { numero: document.getElementById('filterOsNumber').value, cliente: document.getElementById('filterClient').value, descricao: descInput ? descInput.value : "", produto: document.getElementById('filterProduct').value, status: document.getElementById('filterStatus').value, marcadorAtraso: document.getElementById('filterMarcadorAtraso').value, logisticaOk: document.getElementById('filterLogisticaOk').value }; nameInput.value = ''; populateSavedFiltersSelect(); saveDataToLocalStorage(); addRecentActivity(`Filtro "${name}" salvo.`); }
    function loadSelectedFilter() { const select = document.getElementById('savedFilters'); if (!select) return; const name = select.value; if (name && savedFilters[name]) { document.getElementById('filterOsNumber').value = savedFilters[name].numero || ""; document.getElementById('filterClient').value = savedFilters[name].cliente || ""; const descInput = document.getElementById('filterDescription'); if (descInput) descInput.value = savedFilters[name].descricao || ""; document.getElementById('filterProduct').value = savedFilters[name].produto || ""; document.getElementById('filterStatus').value = savedFilters[name].status || ""; document.getElementById('filterMarcadorAtraso').value = savedFilters[name].marcadorAtraso || ""; document.getElementById('filterLogisticaOk').value = savedFilters[name].logisticaOk || ""; applyFiltersAndRender(); addRecentActivity(`Filtro "${name}" carregado.`); } else if (name) alert("Filtro salvo n√£o encontrado."); }
    function deleteSavedFilter() { const select = document.getElementById('savedFilters'); if (!select) return; const name = select.value; if (name && savedFilters[name]) { if (confirm(`Tem certeza que deseja excluir o filtro salvo "${name}"?`)) { delete savedFilters[name]; populateSavedFiltersSelect(); saveDataToLocalStorage(); addRecentActivity(`Filtro "${name}" exclu√≠do.`); } } else if (name) alert("O filtro salvo n√£o existe."); else alert("Por favor, selecione um filtro salvo para excluir."); }

    // A√á√ïES EM MASSA
    function updateSelectedCount() { const countEl = document.getElementById('selectedOsCount'), bulkActionsEl = document.getElementById('bulkActionsContainer'), tableBody = document.getElementById('osTableBody'), selectAllCheckbox = document.getElementById('selectAllOsCheckbox'); if (!countEl || !bulkActionsEl || !tableBody || !selectAllCheckbox) return; const selectedCheckboxes = Array.from(tableBody.querySelectorAll('input[type="checkbox"][data-id]:checked')); countEl.textContent = `${selectedCheckboxes.length} selecionadas`; if (selectedCheckboxes.length > 0) { bulkActionsEl.classList.remove('hidden'); } else { bulkActionsEl.classList.add('hidden'); selectAllCheckbox.checked = false; } }
    function toggleSelectAllOS(masterCheckbox) { const tableBody = document.getElementById('osTableBody'); if (!tableBody || !masterCheckbox) return; const checkboxes = tableBody.querySelectorAll('input[type="checkbox"][data-id]'); checkboxes.forEach(cb => cb.checked = masterCheckbox.checked); updateSelectedCount(); }
    function applyBulkAction() { const statusSelect = document.getElementById('bulkActionStatus'), tableBody = document.getElementById('osTableBody'), selectAllCheckbox = document.getElementById('selectAllOsCheckbox'); if (!statusSelect || !tableBody || !selectAllCheckbox) return; const newStatus = statusSelect.value; if (!newStatus) { alert("Por favor, selecione um status para aplicar."); return; } const selectedCheckboxes = Array.from(tableBody.querySelectorAll('input[type="checkbox"][data-id]:checked')); if (selectedCheckboxes.length === 0) { alert("Nenhuma OS selecionada para a a√ß√£o em massa."); return; } selectedCheckboxes.forEach(cb => { const osId = cb.dataset.id; const osIndex = ordensServico.findIndex(os => os.id === osId); if (osIndex !== -1) ordensServico[osIndex].status = newStatus; }); addRecentActivity(`${selectedCheckboxes.length} OS(s) tiveram o status alterado para ${newStatus}.`); saveDataToLocalStorage(); refreshAllViews(); selectAllCheckbox.checked = false; updateSelectedCount(); }
    function bulkDeleteSelectedOS() { const tableBody = document.getElementById('osTableBody'), selectAllCheckbox = document.getElementById('selectAllOsCheckbox'); if (!tableBody || !selectAllCheckbox) return; const selectedCheckboxes = Array.from(tableBody.querySelectorAll('input[type="checkbox"][data-id]:checked')); if (selectedCheckboxes.length === 0) { alert("Nenhuma OS selecionada para exclus√£o."); return; } if (confirm(`Tem certeza que deseja excluir ${selectedCheckboxes.length} OS(s) selecionada(s)? Esta a√ß√£o √© irrevers√≠vel.`)) { const idsToDelete = selectedCheckboxes.map(cb => cb.dataset.id); ordensServico = ordensServico.filter(os => !idsToDelete.includes(os.id)); addRecentActivity(`${idsToDelete.length} OS(s) foram exclu√≠das.`); saveDataToLocalStorage(); if (currentPage > 1 && paginateData(getFilteredOS(), currentPage, ITEMS_PER_PAGE).length === 0) currentPage--; refreshAllViews(); selectAllCheckbox.checked = false; updateSelectedCount(); } }

    // RENDERIZA√á√ÉO DA TABELA DE OS (OS List View)
    function toggleMarcadorAtrasoManual(osId, event) { event.stopPropagation(); const osIndex = ordensServico.findIndex(os => os.id === osId); if (osIndex !== -1) { ordensServico[osIndex].marcadorAtrasoManual = !ordensServico[osIndex].marcadorAtrasoManual; addRecentActivity(`Marcador "N√£o Realizada no Prazo" ${ordensServico[osIndex].marcadorAtrasoManual ? 'aplicado' : 'removido'} para OS ${ordensServico[osIndex].numero}.`); saveDataToLocalStorage(); applyFiltersAndRender(); } }
    function toggleLogisticaOkManual(osId, event) { event.stopPropagation(); const osIndex = ordensServico.findIndex(os => os.id === osId); if (osIndex !== -1) { ordensServico[osIndex].logisticaOk = !ordensServico[osIndex].logisticaOk; addRecentActivity(`Marcador "Log√≠stica Pronta" ${ordensServico[osIndex].logisticaOk ? 'aplicado' : 'removido'} para OS ${ordensServico[osIndex].numero}.`); saveDataToLocalStorage(); applyFiltersAndRender(); } }
    function renderOSTable(filteredData = getFilteredOS()) { const tableBody = document.getElementById('osTableBody'), selectAllCheckbox = document.getElementById('selectAllOsCheckbox'); if (!tableBody || !selectAllCheckbox) { console.error("osTableBody ou selectAllOsCheckbox n√£o encontrado!"); return; } tableBody.innerHTML = ''; selectAllCheckbox.checked = false; updateSelectedCount(); if (!filteredData || filteredData.length === 0) { tableBody.innerHTML = `<tr><td colspan="13" class="text-center py-10 text-slate-400">Nenhuma Ordem de Servi√ßo encontrada.</td></tr>`; renderPagination(0, 0); return; } const paginatedData = paginateData(filteredData, currentPage, ITEMS_PER_PAGE); paginatedData.forEach(os => { const row = tableBody.insertRow(); row.className = 'table-row hover:bg-slate-700'; const markerAtrasoIconHTML = `<span class="manual-flag-toggle" onclick="toggleMarcadorAtrasoManual('${os.id}', event)" title="${os.marcadorAtrasoManual ? 'Desmarcar Atraso' : 'Marcar Atraso'}">${os.marcadorAtrasoManual ? '<i class="fas fa-flag text-purple-500"></i>' : '<i class="far fa-flag text-gray-400 hover:text-purple-500"></i>'}</span>`; const logisticaIconHTML = `<span class="logistica-toggle" onclick="toggleLogisticaOkManual('${os.id}', event)" title="${os.logisticaOk ? 'Desmarcar Log√≠stica OK' : 'Marcar Log√≠stica OK'}">${os.logisticaOk ? '<i class="fas fa-truck text-teal-500"></i>' : '<i class="fas fa-truck text-gray-400 hover:text-teal-500"></i>'}</span>`; row.innerHTML = `<td class="py-3 px-2 text-center checkbox-cell"><input type="checkbox" data-id="${os.id}" onchange="updateSelectedCount()" class="form-checkbox h-4 w-4"></td> <td class="py-3 px-4 text-sm font-medium">${markerAtrasoIconHTML} ${os.numero}</td> <td class="py-3 px-4 text-sm">${os.cliente}</td> <td class="py-3 px-4 text-sm">${os.produto||'N/A'}</td> <td class="py-3 px-4 text-sm truncate max-w-xs" title="${os.descricao}">${os.descricao}</td> <td class="py-3 px-4 text-sm">${formatDateToBR(os.dataAbertura)}</td> <td class="py-3 px-4 text-sm">${formatDateToBR(os.prazoFinal)}</td> <td class="py-3 px-4 text-sm">${os.responsavel}</td> <td class="py-3 px-4 text-sm">${os.solicitante||'N/A'}</td> <td class="py-3 px-4 text-sm"><select class="select-field status-select p-1 text-xs" data-id="${os.id}" onchange="updateStatus(this)"> ${validStatusesGlobal.map(s => `<option value="${s}" ${os.status===s?'selected':''}>${s === 'Pendente Informa√ß√£o' ? 'Pendente Info' : (s === 'Aguardando Aprova√ß√£o' ? 'Aguard. Aprov.' : s)}</option>`).join('')} </select></td> <td class="py-3 px-4 text-sm text-center">${logisticaIconHTML}</td> <td class="py-3 px-4 text-sm"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getPriorityClass(os.prioridade)}">${os.prioridade}</span></td> <td class="py-3 px-4 text-sm"><button class="text-sky-500 hover:text-sky-400 p-1 mr-2" title="Editar" onclick="editOS('${os.id}')"><i class="fas fa-edit"></i></button><button class="text-red-500 hover:text-red-400 p-1 mr-2" title="Excluir" onclick="deleteOS('${os.id}')"><i class="fas fa-trash"></i></button><button class="text-green-500 hover:text-green-400 p-1" title="Baixar .ics" onclick="downloadICS('${os.id}')"><i class="fas fa-calendar-plus"></i></button></td>`; }); renderPagination(filteredData.length, currentPage); }
    function paginateData(data, page, itemsPerPage) { const start = (page - 1) * itemsPerPage, end = start + itemsPerPage; return data.slice(start, end); }
    function renderPagination(totalItems, page) { const paginationControls = document.getElementById('paginationControls'); if (!paginationControls) return; paginationControls.innerHTML = ''; const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE); if (totalPages <= 1) return; const prevButton = document.createElement('button'); prevButton.innerHTML = '<i class="fas fa-chevron-left"></i> Anterior'; prevButton.className = 'btn btn-sm btn-secondary disabled:opacity-50'; prevButton.disabled = page === 1; prevButton.onclick = () => { if (page > 1) changePage(page - 1); }; paginationControls.appendChild(prevButton); const pageInfo = document.createElement('span'); pageInfo.className = 'text-sm px-3'; pageInfo.textContent = `P√°gina ${page} de ${totalPages}`; paginationControls.appendChild(pageInfo); const nextButton = document.createElement('button'); nextButton.innerHTML = 'Pr√≥ximo <i class="fas fa-chevron-right"></i>'; nextButton.className = 'btn btn-sm btn-secondary disabled:opacity-50'; nextButton.disabled = page === totalPages; nextButton.onclick = () => { if (page < totalPages) changePage(page + 1); }; paginationControls.appendChild(nextButton); }
    function changePage(newPage) { currentPage = newPage; renderOSTable(); }

    // CRUD DE OS E MODAL
    function updateStatus(selectElement) { const osId = selectElement.dataset.id, newStatus = selectElement.value, osIndex = ordensServico.findIndex(os => os.id === osId); if (osIndex !== -1) { ordensServico[osIndex].status = newStatus; addRecentActivity(`Status da OS ${ordensServico[osIndex].numero} alterado para ${newStatus}.`); saveDataToLocalStorage(); refreshAllViews(); } }
    function openAddOSModal() { console.log("Abrindo modal para adicionar OS..."); const currentOsForm = document.getElementById('osForm'), currentModalTitle = document.getElementById('modalTitle'), currentOsModal = document.getElementById('osModal'); if (!currentOsForm || !currentModalTitle || !currentOsModal) { console.error("Elementos do modal n√£o encontrados!"); return; } currentOsForm.reset(); document.getElementById('osId').value = ''; currentModalTitle.textContent = 'Adicionar Nova Ordem de Servi√ßo'; const dataAberturaEl = document.getElementById('osDataAberturaModal'); if (dataAberturaEl) dataAberturaEl.value = new Date().toISOString().split('T')[0]; document.getElementById('osMarcadorAtrasoModal').checked = false; document.getElementById('osLogisticaOkModal').checked = false; currentOsModal.classList.remove('hidden'); console.log("Modal de OS aberto."); }
    function closeOSModal() { const currentOsModal = document.getElementById('osModal'); if (!currentOsModal) return; currentOsModal.classList.add('hidden'); }
    function editOS(id) { console.log(`Tentando editar OS com ID: ${id}`); const currentOsModal = document.getElementById('osModal'), currentModalTitle = document.getElementById('modalTitle'); if (!currentOsModal || !currentModalTitle) { console.error("Elementos do modal de edi√ß√£o n√£o encontrados"); return; } const os = ordensServico.find(o => o.id === id); if (os) { currentModalTitle.textContent = `Editar OS - ${os.numero}`; document.getElementById('osId').value = os.id; document.getElementById('osNumeroModal').value = os.numero; document.getElementById('osClienteModal').value = os.cliente; document.getElementById('osProdutoModal').value = os.produto || ''; document.getElementById('osSolicitanteModal').value = os.solicitante || ''; document.getElementById('osDescricaoModal').value = os.descricao; document.getElementById('osDataAberturaModal').value = os.dataAbertura; document.getElementById('osPrazoFinalModal').value = os.prazoFinal; document.getElementById('osResponsavelModal').value = os.responsavel; document.getElementById('osStatusModal').value = os.status; document.getElementById('osPrioridadeModal').value = os.prioridade; document.getElementById('osMarcadorAtrasoModal').checked = os.marcadorAtrasoManual || false; document.getElementById('osLogisticaOkModal').checked = os.logisticaOk || false; currentOsModal.classList.remove('hidden'); console.log("OS carregada para edi√ß√£o:", os); } else { alert("OS n√£o encontrada para edi√ß√£o."); console.warn(`OS com ID ${id} n√£o encontrada para edi√ß√£o.`);} }
    function deleteOS(id) { const osToDelete = ordensServico.find(os => os.id === id); if (confirm(`Tem certeza que deseja excluir a OS ${osToDelete?.numero || id}? Esta a√ß√£o √© irrevers√≠vel.`)) { ordensServico = ordensServico.filter(os => os.id !== id); addRecentActivity(`OS ${osToDelete?.numero || 'ID ' + id} foi exclu√≠da.`); saveDataToLocalStorage(); if (currentPage > 1 && paginateData(getFilteredOS(), currentPage, ITEMS_PER_PAGE).length === 0) currentPage--; refreshAllViews(); } }

    // L√ìGICA DE IMPORTA√á√ÉO DE EXCEL/CSV
    function processAndValidateOSData(jsonData) { console.log("Iniciando processAndValidateOSData com jsonData (primeiras 5 linhas):", jsonData.slice(0,5)); const headersFromFile = jsonData[0].map(header => String(header || '').trim().toLowerCase()), dataRows = jsonData.slice(1); const validOSs = [], importLog = []; const expectedHeaderMapping = { codigo: 'c√≥digo', status: 'status', cliente: 'cliente', inicio: 'in√≠cio', termino: 't√©rmino', tecnico: 't√©cnico', solicitante: 'solicitante', cidade: 'cidade', duracao_h: 'dura√ß√£o (h)', produto_import: 'produto' }; const colIndices = {}; Object.keys(expectedHeaderMapping).forEach(key => colIndices[key] = headersFromFile.indexOf(expectedHeaderMapping[key])); console.log("√çndices das colunas mapeadas:", colIndices); const essentialCols = ['codigo', 'cliente', 'inicio', 'termino', 'tecnico']; let missingEssentialHeader = false; essentialCols.forEach(colKey => { if (colIndices[colKey] === -1) { const msg = `Erro Cr√≠tico: Coluna essencial "${expectedHeaderMapping[colKey]}" n√£o encontrada. Verifique se o nome da coluna no arquivo Excel/CSV est√° exatamente como esperado (ex: 'c√≥digo', 'in√≠cio', etc.).`; console.error(msg); importLog.push({ success: false, message: msg }); missingEssentialHeader = true; }}); if (missingEssentialHeader) { console.warn("Importa√ß√£o interrompida devido a cabe√ßalhos essenciais ausentes."); return { validOSs, importLog }; } dataRows.forEach((row, rowIndex) => { console.log(`Processando linha ${rowIndex + 2} da planilha:`, row); if (row.every(cell => cell === null || String(cell || '').trim() === '')) { console.log(`Linha ${rowIndex + 2} vazia, pulando.`); return; } const newOS = { id: generateId(), produto: colIndices.produto_import !== -1 && String(row[colIndices.produto_import] || '').trim() !== '' ? String(row[colIndices.produto_import]).trim() : "N/A (Importado)", prioridade: "M√©dia", marcadorAtrasoManual: false, logisticaOk: false }; let rowIsValid = true, currentLogMessages = []; newOS.numero = colIndices.codigo !== -1 ? String(row[colIndices.codigo] || '').trim() : ''; if (!newOS.numero) { currentLogMessages.push("N¬∫ OS ausente."); rowIsValid = false; } newOS.cliente = colIndices.cliente !== -1 ? String(row[colIndices.cliente] || '').trim() : ''; if (!newOS.cliente) { currentLogMessages.push("Cliente ausente."); rowIsValid = false; } newOS.status = colIndices.status !== -1 && String(row[colIndices.status] || '').trim() !== '' ? String(row[colIndices.status]).trim() : 'Aberta'; if (!validStatusesGlobal.includes(newOS.status)) { currentLogMessages.push(`Status "${newOS.status}" inv√°lido. Usando "Aberta".`); newOS.status = 'Aberta'; } const inicioVal = colIndices.inicio !== -1 ? row[colIndices.inicio] : null, terminoVal = colIndices.termino !== -1 ? row[colIndices.termino] : null; console.log(`Valores de data da linha ${rowIndex+2}: inicio='${inicioVal}' (tipo: ${typeof inicioVal}), termino='${terminoVal}' (tipo: ${typeof terminoVal})`); const dataAberturaResult = parseAndValidateDate(inicioVal, `Data In√≠cio (Linha ${rowIndex+2})`); if (dataAberturaResult.error) { currentLogMessages.push(dataAberturaResult.error); rowIsValid = false; console.warn(`Erro Data In√≠cio linha ${rowIndex+2}: ${dataAberturaResult.error}`); } newOS.dataAbertura = dataAberturaResult.date; const prazoFinalResult = parseAndValidateDate(terminoVal, `Data T√©rmino (Linha ${rowIndex+2})`); if (prazoFinalResult.error) { currentLogMessages.push(prazoFinalResult.error); rowIsValid = false; console.warn(`Erro Data T√©rmino linha ${rowIndex+2}: ${prazoFinalResult.error}`); } newOS.prazoFinal = prazoFinalResult.date; if (newOS.dataAbertura && newOS.prazoFinal && new Date(newOS.prazoFinal) < new Date(newOS.dataAbertura)) { currentLogMessages.push("Prazo Final anterior √† Data In√≠cio."); rowIsValid = false; } newOS.responsavel = colIndices.tecnico !== -1 ? String(row[colIndices.tecnico] || '').trim() : ''; if (!newOS.responsavel) { currentLogMessages.push("Respons√°vel ausente."); rowIsValid = false; } newOS.solicitante = colIndices.solicitante !== -1 ? String(row[colIndices.solicitante] || '').trim() : 'N/A (Importado)'; let descParts = []; const cidadeVal = colIndices.cidade !== -1 && row[colIndices.cidade] ? String(row[colIndices.cidade]).trim() : ''; if (cidadeVal) descParts.push(`Cidade: ${cidadeVal}`); const duracaoVal = colIndices.duracao_h !== -1 && row[colIndices.duracao_h] ? String(row[colIndices.duracao_h]).trim() : ''; if (duracaoVal) descParts.push(`Dura√ß√£o: ${duracaoVal}h`); newOS.descricao = descParts.length > 0 ? descParts.join(', ') + ". (OS Importada)" : "(OS Importada)"; console.log(`OS processada da linha ${rowIndex + 2}:`, { ...newOS }, `V√°lida: ${rowIsValid}`); if (rowIsValid) validOSs.push(newOS); else { const msg = `Linha ${rowIndex+2} (OS: ${newOS.numero||'S/N'}) ignorada: ${currentLogMessages.join('; ')}`; console.warn(msg); importLog.push({ success: false, message: msg });} }); console.log("processAndValidateOSData conclu√≠do. OSs V√°lidas:", validOSs.length, "Erros:", importLog.length); return { validOSs, importLog }; }
    function handleExcelImport() { console.log("handleExcelImport chamado"); const fileInput = document.getElementById('excelFileInput'), cISM = document.getElementById('importStatusMessage'), cISD = document.getElementById('importSummary'), cISL = document.getElementById('importSummaryList'); if (!fileInput || !cISM || !cISD || !cISL) { console.error("Elementos da UI de importa√ß√£o n√£o encontrados."); return; } cISM.textContent = ''; cISL.innerHTML = ''; cISD.classList.add('hidden'); if (!fileInput.files || fileInput.files.length === 0) { cISM.textContent = 'Por favor, selecione um arquivo Excel ou CSV para importar.'; cISM.className = 'mt-4 text-sm text-red-400'; return; } const file = fileInput.files[0]; const reader = new FileReader(); cISM.textContent = `Processando: ${file.name}...`; cISM.className = 'mt-4 text-sm text-sky-400'; reader.onload = function(event) { try { const data = event.target.result; if (typeof XLSX === 'undefined') throw new Error("Biblioteca XLSX n√£o carregada."); console.log("Lendo arquivo Excel com XLSX..."); const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: false, cellStyles: false }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 , raw: true, defval: null}); console.log("Dados crus do Excel (primeiras 5 linhas):", jsonData.slice(0,5)); while (jsonData.length > 0 && jsonData[jsonData.length-1].every(cell => cell === null || String(cell||'').trim() === '')) jsonData.pop(); if (jsonData.length < 2) throw new Error("Arquivo vazio ou apenas com cabe√ßalho. Verifique o conte√∫do da primeira aba do arquivo."); const { validOSs, importLog } = processAndValidateOSData(jsonData); if (validOSs.length > 0) { ordensServico.unshift(...validOSs); saveDataToLocalStorage(); populateProductFilters(); refreshAllViews(); addRecentActivity(`${validOSs.length} OS(s) importada(s) de ${file.name}.`); } let finalMessage = validOSs.length > 0 ? `${validOSs.length} OS(s) importada(s)! ` : "Nenhuma OS importada. "; cISM.className = `mt-4 text-sm ${validOSs.length > 0 ? 'text-green-400' : 'text-amber-400'}`; const errorsCount = importLog.filter(log => !log.success).length; if (errorsCount > 0) { finalMessage += `${errorsCount} linha(s) com erros. Veja resumo.`; cISM.className = `mt-4 text-sm ${validOSs.length > 0 ? 'text-amber-400' : 'text-red-400'}`; } if (validOSs.length === 0 && errorsCount === 0 && jsonData.slice(1).filter(r => !r.every(c => c === null || String(c||'').trim() === '')).length > 0) { finalMessage = `Arquivo lido, mas nenhuma OS v√°lida foi processada. Verifique o formato dos dados e se as colunas essenciais (C√≥digo, Cliente, In√≠cio, T√©rmino, T√©cnico) est√£o corretas e presentes na primeira linha da planilha.`; cISM.className = 'mt-4 text-sm text-amber-400'; } cISM.textContent = finalMessage.trim(); if (importLog.length > 0) { cISD.classList.remove('hidden'); importLog.forEach(log => { const li = document.createElement('li'); li.textContent = log.message; li.className = log.success ? 'text-green-300' : 'text-red-300'; cISL.appendChild(li); }); } } catch (error) { console.error("Erro CR√çTICO ao processar Excel/CSV:", error); cISM.textContent = `Erro: ${error.message}. Verifique o console.`; cISM.className = 'mt-4 text-sm text-red-400'; cISD.classList.add('hidden'); } finally { fileInput.value = ''; } }; reader.onerror = function(error) { console.error("Erro ao ler arquivo:", error); cISM.textContent = 'Erro ao ler arquivo.'; cISM.className = 'mt-4 text-sm text-red-400'; fileInput.value = ''; }; reader.readAsArrayBuffer(file); }
    function toggleImportSection() { const importSection = document.getElementById('importOsLoteContainer'); if (importSection) { importSection.classList.toggle('hidden'); if (!importSection.classList.contains('hidden')) addRecentActivity("Interface de importa√ß√£o em lote aberta."); else { addRecentActivity("Interface de importa√ß√£o em lote fechada."); const cISM = document.getElementById('importStatusMessage'), cISD = document.getElementById('importSummary'), cISL = document.getElementById('importSummaryList'); if(cISM) cISM.textContent = ''; if(cISL) cISL.innerHTML = ''; if(cISD) cISD.classList.add('hidden'); } } }

    // FUN√á√ïES DE EXPORTA√á√ÉO
    function exportTableToCSV(tableId, fileName) { let csv = []; const table = document.getElementById(tableId); if (!table) { console.error(`Tabela ${tableId} n√£o encontrada.`); return; } const rows = table.querySelectorAll("tr"); for (const row of rows) { const cols = row.querySelectorAll("td,th"); const rowData = []; let skipRow = false; if (tableId === 'reportsTable' && cols.length === 1 && cols[0].getAttribute('colspan') === "10" && cols[0].innerText.includes("Selecione filtros")) { skipRow = true; } if (skipRow) continue; for (const col of cols) { let cellText = col.innerText; if (col.querySelector('select')) cellText = col.querySelector('select').value; else if (col.querySelector('.status-tag')) cellText = col.querySelector('.status-tag').innerText;  else if (col.querySelector('.selected-motivos-display')) { const osIdForRow = row.dataset.osIdForMotivos; const motivos = osIdForRow ? (reportOsMotivos[osIdForRow] || []) : []; cellText = motivos.join('; '); } else if (col.querySelector('span[class*="priority-"]')) cellText = col.querySelector('span').innerText; if (tableId === 'osTable') { const isCheckboxColumn = col.querySelector('input[type="checkbox"]'); const isActionsColumn = Array.from(col.querySelectorAll('button[title]')).some(btn => ['Editar', 'Excluir', 'Baixar .ics'].includes(btn.title)); if (isCheckboxColumn || isActionsColumn) continue; if (col.querySelector('.fa-flag.text-purple-500')) cellText = "Atraso: Sim"; else if (col.querySelector('.far.fa-flag')) cellText = "Atraso: N√£o"; if (col.querySelector('.fa-truck.text-teal-500')) cellText = cellText.includes("Atraso:") ? cellText + " | Log√≠stica: Sim" : "Log√≠stica: Sim"; else if (col.querySelector('.fa-truck.text-gray-400')) cellText = cellText.includes("Atraso:") ? cellText + " | Log√≠stica: N√£o" : "Log√≠stica: N√£o"; if (col.cellIndex === 1 && !cellText.includes("Atraso:") && !cellText.includes("Log√≠stica:")) { const osNumeroMatch = col.innerText.match(/(\S+)$/); if (osNumeroMatch) cellText = osNumeroMatch[0]; } } rowData.push('"' + cellText.replace(/\s+/g, ' ').trim().replace(/"/g, '""') + '"'); } if (rowData.length > 0) csv.push(rowData.join(",")); } const csvFile = new Blob(["\uFEFF" + csv.join("\n")], { type: "text/csv;charset=utf-8;" }); const link = document.createElement("a"); link.href = URL.createObjectURL(csvFile); link.download = fileName; link.style.display = "none"; document.body.appendChild(link); link.click(); document.body.removeChild(link); addRecentActivity(`Arquivo CSV "${fileName}" exportado.`);}
    function exportTableToPDF(tableId, title, tableBodyId) { const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' }); const textColor = '#cbd5e1', headerColor = '#334155', headerTextColor = '#f8fafc', rowColor = '#1e293b', alternateRowColor = '#283447'; let currentY = 40; doc.setFontSize(18); doc.setTextColor(textColor); doc.text(title, doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' }); currentY += 30; const tableElement = document.getElementById(tableId); if (tableElement) { const head = []; const headersToExclude = ['a√ß√µes']; const checkboxHeaderPresent = tableElement.querySelector('thead th input[type=checkbox]'); tableElement.querySelectorAll('thead th').forEach((th, index) => { if (checkboxHeaderPresent && index === 0) return; if (!headersToExclude.includes(th.innerText.toLowerCase().trim())) head.push(th.innerText.trim()); }); const body = []; const tableBodyElement = document.getElementById(tableBodyId); if (tableBodyElement) { tableBodyElement.querySelectorAll('tr').forEach(tr => { const rowData = []; tr.querySelectorAll('td').forEach((td, index) => { if (checkboxHeaderPresent && index === 0) return; let headerIndex = checkboxHeaderPresent ? index + 1 : index; let thElements = Array.from(tableElement.querySelectorAll('thead th')); if(thElements[headerIndex] && headersToExclude.includes(thElements[headerIndex].innerText.toLowerCase().trim())) return; let cellText = td.innerText.trim(); if (td.querySelector('select')) cellText = td.querySelector('select').value; else if (td.querySelector('span[class*="priority-"]')) cellText = td.querySelector('span').innerText.trim(); else if (thElements[headerIndex] && thElements[headerIndex].innerText.trim().toLowerCase() === 'n¬∫ os') { const osNumeroMatch = cellText.match(/(\S+)$/); cellText = osNumeroMatch ? osNumeroMatch[0] : cellText; } else if (thElements[headerIndex] && thElements[headerIndex].innerText.trim().toLowerCase() === 'log√≠stica') cellText = td.querySelector('.fa-truck.text-teal-500') ? "Sim" : "N√£o"; rowData.push(cellText); }); if (rowData.length > 0) body.push(rowData); }); } if (body.length > 0 && !(body[0].length === 1 && body[0][0].includes("Nenhuma Ordem de Servi√ßo encontrada"))) { doc.autoTable({ startY: currentY, head: [head], body: body, theme: 'grid', headStyles: { fillColor: headerColor, textColor: headerTextColor, fontStyle: 'bold', fontSize: 8 }, styles: { textColor: textColor, cellPadding: 4, fontSize: 7, overflow: 'linebreak' }, alternateRowStyles: { fillColor: alternateRowColor }, didParseCell: function (data) { data.cell.styles.fillColor = data.row.index % 2 === 0 ? rowColor : alternateRowColor; data.cell.styles.textColor = textColor; if (data.section === 'head') { data.cell.styles.fillColor = headerColor; data.cell.styles.textColor = headerTextColor; } } }); } else doc.setFontSize(12).text("Nenhum dado na tabela.", 40, currentY); } else doc.setFontSize(12).text("Tabela n√£o encontrada.", 40, currentY); const generatedDate = `Gerado em: ${new Date().toLocaleString('pt-BR')}`; doc.setFontSize(8).text(generatedDate, doc.internal.pageSize.getWidth() - 40, doc.internal.pageSize.getHeight() - 20, { align: 'right' }); doc.save(title.replace(/[^a-z0-9_]+/gi, '_').toLowerCase() + '.pdf'); addRecentActivity(`PDF "${title}" exportado.`); }
    async function exportReportToPDFWithCharts(tableId, title, tableBodyId, chartCanvasIds = [], includeCharts = true) { const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' }); const pTextColor = '#e2e8f0', sTextColor = '#94a3b8', hBgColor = '#334155', hTextColor = '#f8fafc', rBgColor = '#1e293b', aRBgColor = '#283447', bColor = '#475569'; const pW = doc.internal.pageSize.getWidth(), pH = doc.internal.pageSize.getHeight(), margin = 30; let cY = margin; doc.setFontSize(18); doc.setTextColor(pTextColor); doc.text(title, pW / 2, cY, { align: 'center' }); cY += 25; doc.setFontSize(9); doc.setTextColor(sTextColor); doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, pW / 2, cY, { align: 'center' }); cY += 20; const rDSV=document.getElementById('reportDateStartFilter')?.value, rDEV=document.getElementById('reportDateEndFilter')?.value, rSV=document.getElementById('reportStatusFilter')?.value, rPV=document.getElementById('reportProductFilter')?.value, rFMAVal=document.getElementById('reportFilterMarcadorAtraso')?.value, rFLOKVal=document.getElementById('reportFilterLogisticaOk')?.value; let fT="Filtros Aplicados: ", hF=false; if(rDSV||rDEV){fT+=`Per√≠odo: ${rDSV?formatDateToBR(rDSV):'*'} a ${rDEV?formatDateToBR(rDEV):'*'}. `;hF=true} if(rSV){fT+=`Status OS: ${rSV}. `;hF=true} if(rPV){fT+=`Produto: ${rPV}. `;hF=true} if(rFMAVal){fT+=`Atraso: ${rFMAVal==="marcada"?"Marc.":"N/Marc."}. `;hF=true} if(rFLOKVal){fT+=`Log√≠stica: ${rFLOKVal==="sim"?"Sim":"N√£o"}. `;hF=true} if(!hF) fT="Filtros: Nenhum filtro espec√≠fico aplicado."; doc.setFontSize(8); doc.setTextColor(sTextColor); let splitF = doc.splitTextToSize(fT, pW-(2*margin)); doc.text(splitF, margin, cY); cY+=(splitF.length*10)+15; const tblEl = document.getElementById(tableId); if (tblEl) { const head = [['C√≥d. OS', 'Solicitante', 'Cliente', 'In√≠cio', 'T√©rmino', 'Respons√°vel', 'Log√≠stica', 'Produto', 'Status OS', 'Motivo Inconf.']]; const body = []; const tblBodyEl = document.getElementById(tableBodyId); if (tblBodyEl) { tblBodyEl.querySelectorAll('tr').forEach(tr => { if (tr.querySelector('td[colspan="10"]')) return; const rD = []; const osIdForRow = tr.dataset.osIdForMotivos; rD.push(tr.cells[0]?.innerText || ''); rD.push(tr.cells[1]?.innerText || ''); rD.push(tr.cells[2]?.innerText || ''); rD.push(tr.cells[3]?.innerText || ''); rD.push(tr.cells[4]?.innerText || ''); rD.push(tr.cells[5]?.innerText || ''); rD.push(tr.cells[6]?.innerText || ''); rD.push(tr.cells[7]?.innerText || ''); rD.push(tr.cells[8]?.querySelector('.status-tag')?.innerText || tr.cells[8]?.innerText || ''); const motivosText = osIdForRow ? (reportOsMotivos[osIdForRow] || []).join('; ') : ''; rD.push(motivosText); body.push(rD); }); } if (body.length > 0) { doc.autoTable({ startY: cY, head: head, body: body, theme: 'grid', headStyles: { fillColor: hBgColor, textColor: hTextColor, fontStyle: 'bold', halign: 'center', fontSize: 7, lineWidth: 0.5, lineColor: bColor }, styles: { textColor: pTextColor, cellPadding: 3, fontSize: 6, overflow: 'linebreak', halign: 'left', lineWidth: 0.5, lineColor: bColor }, alternateRowStyles: { fillColor: aRBgColor }, columnStyles: { 0: { cellWidth: 45, halign: 'center' }, 1: { cellWidth: 60 }, 2: { cellWidth: 70 }, 3: { cellWidth: 45, halign: 'center' }, 4: { cellWidth: 45, halign: 'center' }, 5: { cellWidth: 60 }, 6: { cellWidth: 40, halign: 'center' }, 7: { cellWidth: 65 }, 8: { cellWidth: 55, halign: 'center' }, 9: { cellWidth: 'auto' } }, didDrawPage: (data) => { cY = data.cursor.y + 20; if (cY > pH - margin - 50) cY = margin; }, didParseCell: function (data) { data.cell.styles.fillColor = data.row.index % 2 === 0 ? rBgColor : aRBgColor; data.cell.styles.textColor = pTextColor; if (data.section === 'head') { data.cell.styles.fillColor = hBgColor; data.cell.styles.textColor = hTextColor; } } }); cY = doc.autoTable.previous.finalY + 25; } else { doc.setFontSize(10); doc.text("Nenhum dado na tabela para os filtros.", margin, cY); cY += 20; } } else { doc.setFontSize(10); doc.text("Tabela de relat√≥rio n√£o encontrada.", margin, cY); cY += 20; } if (includeCharts && chartCanvasIds && chartCanvasIds.length > 0) { const chartW = (pW - (Math.min(chartCanvasIds.length, 3) + 1) * margin) / Math.min(chartCanvasIds.length, 3); const chartH = chartW * 0.60; let chartX = margin; let chartsOnPage = 0; if (cY + chartH + 40 > pH - margin ) { doc.addPage(); cY = margin; } doc.setFontSize(12); doc.setTextColor(pTextColor); doc.text("Visualiza√ß√£o Gr√°fica", pW / 2, cY, { align: 'center' }); cY += 25; for (const chartId of chartCanvasIds) { const canvas = document.getElementById(chartId); if (canvas && canvas.offsetParent !== null && canvas.width > 0 && canvas.height > 0) { if (chartX + chartW > pW - margin && chartsOnPage > 0 && chartsOnPage < 3) { doc.addPage(); cY = margin + 25; chartX = margin; chartsOnPage = 0; doc.setFontSize(12).setTextColor(pTextColor).text("Visualiza√ß√£o Gr√°fica (cont.)", pW/2, cY-15, {align:'center'}); } try { const imgData = canvas.toDataURL('image/png', 1.0); const cTitleEl = canvas.closest('.card')?.querySelector('h4'); let cTitleTxt = cTitleEl ? cTitleEl.innerText : (chartId === 'reportChartByUsuario' ? 'OS por Solicitante' : chartId.replace('reportChartBy','Gr√°fico ')); doc.setFontSize(9); doc.setTextColor(pTextColor); doc.text(cTitleTxt, chartX + chartW / 2, cY - 7, { align: 'center' }); doc.addImage(imgData, 'PNG', chartX, cY, chartW, chartH); chartX += chartW + margin; chartsOnPage++; if(chartsOnPage >= 3 && chartCanvasIds.indexOf(chartId) < chartCanvasIds.length -1){ doc.addPage(); cY = margin + 25; chartX = margin; chartsOnPage = 0; doc.setFontSize(12).setTextColor(pTextColor).text("Visualiza√ß√£o Gr√°fica (cont.)", pW/2, cY-15, {align:'center'});} } catch (e) { console.error("Erro ao adicionar gr√°fico:", e, chartId); doc.setTextColor(255,0,0).text(`Erro ${chartId}`, chartX, cY); doc.setTextColor(pTextColor); chartX += chartW + margin; chartsOnPage++; if(chartsOnPage >= 3 && chartCanvasIds.indexOf(chartId) < chartCanvasIds.length -1){ doc.addPage(); cY = margin + 25; chartX = margin; chartsOnPage = 0; doc.setFontSize(12).setTextColor(pTextColor).text("Visualiza√ß√£o Gr√°fica (cont.)", pW/2, cY-15, {align:'center'});} } } } } const pageCount = doc.internal.getNumberOfPages(); for (let i = 1; i <= pageCount; i++) { doc.setPage(i); doc.setFontSize(7); doc.setTextColor(sTextColor); const footerText = `P√°gina ${i} de ${pageCount} | Gest√£o OS - ${APP_VERSION}`; doc.text(footerText, pW - margin, pH - 15, { align: 'right' }); } doc.save(title.replace(/[^a-z0-9_]+/gi, '_').toLowerCase() + (includeCharts ? '_completo' : '_dados') + '.pdf'); addRecentActivity(`PDF "${title}" ${includeCharts?'completo':'s√≥ dados'} exportado.`);}
    async function exportVisibleListToImage(elementIdOrFullView, fileName = 'relatorio.png', captureFullView = false) { console.log(`Chamando exportVisibleListToImage: elementIdOrFullView='${elementIdOrFullView}', fileName='${fileName}', captureFullView=${captureFullView}`); let targetElement; let tempFileName = fileName; if (captureFullView) { targetElement = document.getElementById(elementIdOrFullView) || document.getElementById('reportsView'); tempFileName = fileName.replace('.png', '_visao_completa.png'); console.log("Captura completa, elemento alvo:", targetElement ? targetElement.id : "NULO"); } else { targetElement = document.getElementById('reportTableContainer'); tempFileName = fileName.replace('.png', '_apenas_lista.png'); console.log("Captura apenas lista, elemento alvo:", targetElement ? targetElement.id : "NULO"); } if (!targetElement) { alert('Elemento n√£o encontrado para gerar imagem.'); console.error(`Elemento para imagem n√£o encontrado: ${elementIdOrFullView} ou 'reportTableContainer'`); return; } let btnSelectorBase = ''; if (elementIdOrFullView === 'reportsView' && captureFullView) { btnSelectorBase = `button[onclick*="exportVisibleListToImage('reportsView'"][onclick*="true"]`; } else if (elementIdOrFullView === 'reportTableContainer' && !captureFullView) { btnSelectorBase = `button[onclick*="exportVisibleListToImage('reportTableContainer'"][onclick*="false"]`; } const clickedButton = btnSelectorBase ? document.querySelector(btnSelectorBase) : null; const originalButtonHTML = clickedButton ? clickedButton.innerHTML : null; if(clickedButton) { clickedButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...'; clickedButton.disabled = true; } try { const canvas = await html2canvas(targetElement, { scale: 1.5, useCORS: true, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-card-light').trim(), onclone: (clonedDoc) => { const el = clonedDoc.getElementById(targetElement.id); if(el) { el.style.overflow = 'visible'; el.style.maxHeight = 'none'; clonedDoc.querySelectorAll('.motivos-popover').forEach(pop => pop.style.display = 'none'); } } }); const image = canvas.toDataURL('image/png'); const link = document.createElement('a'); link.href = image; link.download = tempFileName; document.body.appendChild(link); link.click(); document.body.removeChild(link); addRecentActivity(`Imagem "${tempFileName}" exportada.`); } catch(err) { console.error('Erro ao gerar imagem:', err); alert('Erro ao gerar imagem.'); } finally { if(clickedButton && originalButtonHTML) { clickedButton.innerHTML = originalButtonHTML; clickedButton.disabled = false; } } }
    function downloadICS(osId) { const os = ordensServico.find(o => o.id === osId); if (!os) { alert("OS n√£o encontrada para .ics."); return; } const nowF = new Date().toISOString().replace(/-/g,'').replace(/:/g,'').substring(0,15)+'Z'; const desc = `OS: ${os.numero}\\nCliente: ${os.cliente}\\nProduto: ${os.produto||'N/A'}\\nDescri√ß√£o: ${os.descricao.replace(/\n/g,'\\n')}\\nResp: ${os.responsavel}\\nPrio: ${os.prioridade}\\nStatus: ${os.status}${os.marcadorAtrasoManual?'\\nATR: SIM':''}${os.logisticaOk?'\\nLOG: OK':''}`; const ics = ["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//SKA//GestaoOS//PT","BEGIN:VEVENT",`UID:${os.id}@gestaoska.com`,`DTSTAMP:${nowF}`,`DTSTART;VALUE=DATE:${os.dataAbertura.replace(/-/g,'')}`,`DTEND;VALUE=DATE:${new Date(new Date(os.prazoFinal).getTime()+864e5).toISOString().split('T')[0].replace(/-/g,'')}`,`SUMMARY:Prazo OS ${os.numero} - ${os.cliente}`,`DESCRIPTION:${desc}`,"LOCATION:Cliente "+os.cliente,"BEGIN:VALARM","ACTION:DISPLAY","DESCRIPTION:Lembrete Prazo OS","TRIGGER:-PT1D","END:VALARM","END:VEVENT","END:VCALENDAR"].join("\r\n"); const blob = new Blob([ics],{type:'text/calendar;charset=utf-8'}); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `OS_${os.numero}_${os.cliente.replace(/[^a-z0-9]/gi,'_')}.ics`; document.body.appendChild(link); link.click(); document.body.removeChild(link); addRecentActivity(`.ics para OS ${os.numero} gerado.`); }

    // FUN√á√ïES PARA GERENCIAR POPOVER DE MOTIVOS
    function openMotivosPopover(osId, targetButton) { console.log(`Abrindo popover de motivos para OS ID: ${osId}`); currentEditingOsIdForMotivos = osId; const popover = document.getElementById('motivosPopover'); const checkboxContainer = document.getElementById('motivosCheckboxContainer'); if (!popover || !checkboxContainer) { console.error("Elementos do popover de motivos n√£o encontrados!"); return; } checkboxContainer.innerHTML = ''; const currentMotivos = reportOsMotivos[osId] || []; console.log(`Motivos atuais para ${osId}:`, currentMotivos); motivoOptions.forEach(motivo => { const checkboxId = `motivo-${osId}-${motivo.replace(/\s+/g, '-')}`; const label = document.createElement('label'); label.htmlFor = checkboxId; label.className = 'flex items-center text-sm text-slate-300 cursor-pointer hover:text-sky-400 transition-colors'; const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = checkboxId; checkbox.value = motivo; checkbox.checked = currentMotivos.includes(motivo); checkbox.className = 'form-checkbox h-4 w-4 text-sky-500 border-slate-600 rounded focus:ring-sky-400 mr-2 bg-slate-700 checked:bg-sky-500'; label.appendChild(checkbox); label.appendChild(document.createTextNode(motivo)); checkboxContainer.appendChild(label); }); const rect = targetButton.getBoundingClientRect(); popover.style.top = `${window.scrollY + rect.bottom + 5}px`; let leftPosition = window.scrollX + rect.left; if (leftPosition + popover.offsetWidth > window.innerWidth - 20) { leftPosition = window.innerWidth - popover.offsetWidth - 20; } popover.style.left = `${leftPosition}px`; popover.style.display = 'block'; }
    function closeMotivosPopover(saveChanges) { const popover = document.getElementById('motivosPopover'); if (!popover) return; if (saveChanges && currentEditingOsIdForMotivos) { console.log(`Salvando motivos para OS ID: ${currentEditingOsIdForMotivos}`); const checkboxContainer = document.getElementById('motivosCheckboxContainer'); const selectedMotivos = []; checkboxContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => { selectedMotivos.push(cb.value); }); reportOsMotivos[currentEditingOsIdForMotivos] = selectedMotivos; console.log(`Motivos salvos para ${currentEditingOsIdForMotivos}:`, selectedMotivos); updateMotivosDisplay(currentEditingOsIdForMotivos); addRecentActivity(`Motivos de inconformidade atualizados para OS na lista de relat√≥rio.`); } else { console.log("Popover de motivos fechado sem salvar altera√ß√µes."); } popover.style.display = 'none'; currentEditingOsIdForMotivos = null; }
    function updateMotivosDisplay(osId) { const displayElement = document.getElementById(`motivos-display-${osId}`); if (displayElement) { const motivos = reportOsMotivos[osId] || []; if (motivos.length > 0) { displayElement.innerHTML = `<span class="text-xs text-sky-400">${motivos.join(', ')}</span>`; displayElement.title = motivos.join('\n'); } else { displayElement.textContent = ''; displayElement.title = ''; } } else { console.warn(`Elemento de display de motivos n√£o encontrado para OS ID: ${osId} (motivos-display-${osId})`); } }

    // FUN√á√ïES DE NAVEGA√á√ÉO E EXIBI√á√ÉO DE VIEWS
    function showView(viewId, clickedElement) { console.log(`showView chamada para: ${viewId}`); document.querySelectorAll('.view-section').forEach(section => section.classList.add('hidden')); const targetView = document.getElementById(viewId); if (targetView) { targetView.classList.remove('hidden'); console.log(`${viewId} agora est√° vis√≠vel.`);} else { document.getElementById('homeView').classList.remove('hidden'); console.error(`View '${viewId}' n√£o encontrada, exibindo Home.`); viewId = 'homeView'; } document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active')); if (clickedElement && clickedElement.classList.contains('sidebar-item')) { clickedElement.classList.add('active'); } if (viewId === 'homeView') { recentActivityList = document.getElementById('recentActivityList'); updateHomeCounts(); renderOSStatusChart(); } else if (viewId === 'osListView') { importStatusMessage = document.getElementById('importStatusMessage'); importSummaryDiv = document.getElementById('importSummary'); importSummaryList = document.getElementById('importSummaryList'); populateSavedFiltersSelect(); populateProductFilters(); applyFiltersAndRender(); } else if (viewId === 'reportsView') { populateProductFilters(); reportOsMotivos = {}; generateCustomReport(); } else if (viewId === 'settingsView') { const itemsInput = document.getElementById('itemsPerPageSetting'); if (itemsInput) itemsInput.value = ITEMS_PER_PAGE; } const importContainer = document.getElementById('importOsLoteContainer'); if (viewId !== 'osListView' && importContainer && !importContainer.classList.contains('hidden')) { importContainer.classList.add('hidden'); if(importStatusMessage) importStatusMessage.textContent = ''; if(importSummaryList) importSummaryList.innerHTML = ''; if(importSummaryDiv) importSummaryDiv.classList.add('hidden');} if (viewId !== 'reportsView') { if (reportChartByProductInstance) { reportChartByProductInstance.destroy(); reportChartByProductInstance = null; } if (reportChartByUsuarioInstance) { reportChartByUsuarioInstance.destroy(); reportChartByUsuarioInstance = null; } if (reportChartByStatusInstance) { reportChartByStatusInstance.destroy(); reportChartByStatusInstance = null; }} console.log(`View ${viewId} exibida e l√≥gica espec√≠fica executada.`);}
    
    // L√ìGICA DE FILTROS DA LISTA PRINCIPAL, HOME VIEW E ATUALIZA√á√ÉO GERAL
    function getFilteredOS() { const fONV = document.getElementById('filterOsNumber')?.value.toLowerCase()||"", fCV = document.getElementById('filterClient')?.value.toLowerCase()||"", fSV = document.getElementById('filterStatus')?.value||"", fPV = document.getElementById('filterProduct')?.value||"", fDV = document.getElementById('filterDescription')?.value.toLowerCase()||"", fMAV = document.getElementById('filterMarcadorAtraso')?.value||"", fLOV = document.getElementById('filterLogisticaOk')?.value||""; return ordensServico.filter(os => { const mN=(os.numero?.toLowerCase()||"").includes(fONV), mC=(os.cliente?.toLowerCase()||"").includes(fCV), mS=fSV?os.status===fSV:true, mP=fPV?os.produto===fPV:true, mD=(os.descricao?.toLowerCase()||"").includes(fDV); let mMA=true; if(fMAV==="marcada")mMA=os.marcadorAtrasoManual===true; else if(fMAV==="nao_marcada")mMA=os.marcadorAtrasoManual===false||os.marcadorAtrasoManual===undefined; let mLO=true; if(fLOV==="sim")mLO=os.logisticaOk===true; else if(fLOV==="nao")mLO=os.logisticaOk===false||os.logisticaOk===undefined; return mN && mC && mS && mP && mD && mMA && mLO; }); }
    function applyFiltersAndRender() { currentPage = 1; renderOSTable(); }
    function updateHomeCounts() { const oAE=document.getElementById('osAbertasCount'), oCME=document.getElementById('osCompletasMesCount'), oPE=document.getElementById('osPendentesCount'), oCaE=document.getElementById('osCanceladasCount'); if(oAE)oAE.textContent=ordensServico.filter(os=>os.status==='Aberta').length; const t=new Date(), fDM=new Date(t.getFullYear(),t.getMonth(),1), lDM=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999); if(oCME)oCME.textContent=ordensServico.filter(os=>{if(os.status!=='Completa')return false; const cDS=os.dataFechamento||os.prazoFinal; if(!cDS)return false; const cD=new Date(cDS+"T00:00:00Z"); return cD>=fDM&&cD<=lDM;}).length; if(oPE)oPE.textContent=ordensServico.filter(os=>os.status==='Pendente Informa√ß√£o'||os.status==='Aguardando Aprova√ß√£o').length; if(oCaE)oCaE.textContent=ordensServico.filter(os=>os.status==='Cancelada').length;}
    function renderOSStatusChart() { const cC=document.getElementById('osStatusChart'), cCo=document.getElementById('osStatusChartContainer'); if(!cC||!cCo||cCo.offsetParent===null)return; const ctx=cC.getContext('2d'); const sCounts=ordensServico.reduce((acc,os)=>{acc[os.status]=(acc[os.status]||0)+1;return acc},{}); const sColors={'Aberta':'rgba(54,162,235,0.8)','Em Andamento':'rgba(255,159,64,0.8)','Pendente Informa√ß√£o':'rgba(255,205,86,0.8)','Aguardando Aprova√ß√£o':'rgba(153,102,255,0.8)','Completa':'rgba(75,192,192,0.8)','Cancelada':'rgba(255,99,132,0.8)','Incompleta':'rgba(201,203,207,0.8)','Provis√≥ria':'rgba(160,160,160,0.8)','Conflitante':'rgba(245,158,11,0.8)'}; const bgColors=Object.keys(sCounts).map(s=>sColors[s]||'rgba(201,203,207,0.8)'); const data={labels:Object.keys(sCounts),datasets:[{label:'OS por Status',data:Object.values(sCounts),backgroundColor:bgColors,borderColor:getComputedStyle(document.documentElement).getPropertyValue('--bg-card-light').trim(),borderWidth:2,hoverOffset:8}]}; if(osStatusChartInstance)osStatusChartInstance.destroy(); osStatusChartInstance=new Chart(ctx,{type:'doughnut',data:data,options:{responsive:true,maintainAspectRatio:false,animation:{animateScale:true,animateRotate:true},plugins:{legend:{position:'bottom',labels:{padding:15,font:{size:11},color:getComputedStyle(document.documentElement).getPropertyValue('--text-primary-light').trim()}},tooltip:{backgroundColor:'rgba(30,41,59,0.9)',titleColor:'#f1f5f9',bodyColor:'#cbd5e1',borderColor:'#475569',borderWidth:1,callbacks:{label:function(ctxL){const p=((ctxL.parsed/ctxL.chart.getDatasetMeta(0).total)*100).toFixed(1);return`${ctxL.label||''}: ${ctxL.parsed||0} (${p}%)`}}}}}}); }
    function navigateToOsListWithFilter(sF) { const fSI=document.getElementById('filterStatus'),fONI=document.getElementById('filterOsNumber'),fCI=document.getElementById('filterClient'),fPI=document.getElementById('filterProduct'),fDI=document.getElementById('filterDescription'),fMAI=document.getElementById('filterMarcadorAtraso'),fLOKI=document.getElementById('filterLogisticaOk'); if(fONI)fONI.value="";if(fCI)fCI.value="";if(fPI)fPI.value="";if(fDI)fDI.value="";if(fMAI)fMAI.value="";if(fLOKI)fLOKI.value=""; if(fSI){if(Array.isArray(sF)){fSI.value="";addRecentActivity("Visualizando OS. Refine filtros para pendentes.");}else{fSI.value=sF;}} showView('osListView',document.querySelector('.sidebar-item[onclick*="osListView"]'));}
    function refreshAllViews() { console.log("Atualizando todas as visualiza√ß√µes..."); renderOSTable(); updateHomeCounts(); if(document.getElementById('homeView')&&!document.getElementById('homeView').classList.contains('hidden'))renderOSStatusChart(); const rVE=document.getElementById('reportsView'); if(rVE&&!rVE.classList.contains('hidden'))generateCustomReport(); console.log("Visualiza√ß√µes atualizadas."); }

    // RELAT√ìRIOS PERSONALIZADOS
    function generateCustomReport() { console.log("Gerando relat√≥rio personalizado..."); const rTB = document.getElementById('reportsTableBody'), rDSI = document.getElementById('reportDateStartFilter'), rDEI = document.getElementById('reportDateEndFilter'), rSI = document.getElementById('reportStatusFilter'), rPI = document.getElementById('reportProductFilter'), rFMAI = document.getElementById('reportFilterMarcadorAtraso'), rFLOKI = document.getElementById('reportFilterLogisticaOk'); if (!rTB || !rDSI || !rDEI || !rSI || !rPI || !rFMAI || !rFLOKI) { console.error("Elementos do filtro de relat√≥rio n√£o encontrados."); return; } rTB.innerHTML = ''; reportOsMotivos = {}; if (reportChartByProductInstance) { reportChartByProductInstance.destroy(); reportChartByProductInstance = null; } if (reportChartByUsuarioInstance) { reportChartByUsuarioInstance.destroy(); reportChartByUsuarioInstance = null; } if (reportChartByStatusInstance) { reportChartByStatusInstance.destroy(); reportChartByStatusInstance = null; } document.getElementById('customReportChartsContainer').querySelectorAll('canvas').forEach(c => { const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); }); const dSV=rDSI.value, dEV=rDEI.value, sV=rSI.value, pV=rPI.value, fMAVal=rFMAI.value, fLOKVal=rFLOKI.value; console.log("Filtros do relat√≥rio:", {dSV,dEV,sV,pV,fMAVal,fLOKVal}); if (dSV&&dEV&&new Date(dEV)<new Date(dSV)) { alert("Data Final anterior √† Data Inicial."); rTB.innerHTML='<tr><td colspan="10" class="text-center py-10 text-red-500">Erro: Data Final anterior √† Data Inicial.</td></tr>'; return; } const fRD = ordensServico.filter(os => { let matchPrazo=true; if(os.prazoFinal){const pFD=new Date(os.prazoFinal+"T00:00:00Z"); if(dSV&&dEV)matchPrazo=pFD>=new Date(dSV+"T00:00:00Z")&&pFD<=new Date(dEV+"T23:59:59Z"); else if(dSV)matchPrazo=pFD>=new Date(dSV+"T00:00:00Z"); else if(dEV)matchPrazo=pFD<=new Date(dEV+"T23:59:59Z");}else if(dSV||dEV)matchPrazo=false; const mS=sV?os.status===sV:true, mP=pV?os.produto===pV:true; let mMA=true; if(fMAVal==="marcada")mMA=os.marcadorAtrasoManual===true; else if(fMAVal==="nao_marcada")mMA=os.marcadorAtrasoManual===false||os.marcadorAtrasoManual===undefined; let mLO=true; if(fLOKVal==="sim")mLO=os.logisticaOk===true; else if(fLOKVal==="nao")mLO=os.logisticaOk===false||os.logisticaOk===undefined; return matchPrazo && mS && mP && mMA && mLO; }); console.log(`Relat√≥rio: ${fRD.length} OSs encontradas ap√≥s filtros.`); if (fRD.length === 0) { rTB.innerHTML = '<tr><td colspan="10" class="text-center py-10 text-slate-400">Nenhuma OS encontrada para os filtros.</td></tr>'; return; } fRD.sort((a,b)=>new Date(a.dataAbertura)-new Date(b.dataAbertura)); fRD.forEach(os => { const rw = rTB.insertRow(); rw.className = 'table-row hover:bg-slate-700'; rw.dataset.osIdForMotivos = os.id; const osStatusClass = getStatusClass(os.status); const motivosButtonId = `motivo-btn-${os.id}`; const motivosDisplayId = `motivos-display-${os.id}`; rw.innerHTML = `<td class="py-2 px-3 text-sm">${os.numero}</td> <td class="py-2 px-3 text-sm">${os.solicitante||'N/A'}</td> <td class="py-2 px-3 text-sm">${os.cliente}</td> <td class="py-2 px-3 text-sm">${formatDateToBR(os.dataAbertura)}</td> <td class="py-2 px-3 text-sm">${formatDateToBR(os.prazoFinal)}</td> <td class="py-2 px-3 text-sm">${os.responsavel||'N/A'}</td> <td class="py-2 px-3 text-sm text-center">${os.logisticaOk?'Sim':'N√£o'}</td> <td class="py-2 px-3 text-sm">${os.produto||'N/A'}</td> <td class="py-2 px-3 text-sm text-center"><span class="status-tag ${osStatusClass}">${os.status}</span></td> <td class="py-2 px-3 text-sm"> <button id="${motivosButtonId}" class="btn btn-xs btn-info !py-1 !px-2 !text-xs" onclick="openMotivosPopover('${os.id}', this)">Gerenciar Motivos</button> <div id="${motivosDisplayId}" class="selected-motivos-display mt-1 text-xs"></div> </td>`; updateMotivosDisplay(os.id); }); addRecentActivity("Relat√≥rio personalizado gerado."); renderReportCharts(fRD); }
    function renderReportCharts(d) { const cCO=(tTJS=null)=>({responsive:true,maintainAspectRatio:false,animation:{duration:1e3,easing:'easeInOutQuart',animateScale:true,animateRotate:true},plugins:{legend:{display:true,position:'bottom',labels:{color:'#cbd5e1',padding:15,boxWidth:12,font:{size:11}}},title:{display:!!tTJS,text:tTJS,color:'#cbd5e1',font:{size:14,weight:'normal'}},tooltip:{backgroundColor:'rgba(30,41,59,0.95)',titleColor:'#f1f5f9',bodyColor:'#cbd5e1',borderColor:'#475569',borderWidth:1,padding:10,callbacks:{label:function(c){const t=c.chart.getDatasetMeta(0).total;const p=t>0?((c.parsed/t)*100).toFixed(1)+'%':'0%';return`${c.label||''}: ${c.parsed||0} (${p})`}}}},scales:{y:{beginAtZero:true,ticks:{color:'#94a3b8',stepSize:1,precision:0},grid:{color:'#334155',drawBorder:false}},x:{ticks:{color:'#94a3b8',autoSkip:true,maxRotation:45,minRotation:0},grid:{display:false}}}}); const cCl=['rgba(54,162,235,0.8)','rgba(255,159,64,0.8)','rgba(75,192,192,0.8)','rgba(255,99,132,0.8)','rgba(153,102,255,0.8)','rgba(255,205,86,0.8)','rgba(245,158,11,0.8)','rgba(123,239,178,0.8)','rgba(250,130,49,0.8)','rgba(179,57,57,0.8)','rgba(72,126,176,0.8)','rgba(246,229,141,0.8)','rgba(113,88,226,0.8)']; const cBC='rgba(15,23,42,0.8)'; const pC=d.reduce((acc,os)=>{acc[os.produto||'N/Esp.']=(acc[os.produto||'N/Esp.']||0)+1;return acc},{}); if(document.getElementById('reportChartByProduct')){if(reportChartByProductInstance)reportChartByProductInstance.destroy();reportChartByProductInstance=new Chart(document.getElementById('reportChartByProduct').getContext('2d'),{type:'bar',data:{labels:Object.keys(pC),datasets:[{label:'OS',data:Object.values(pC),backgroundColor:cCl,borderColor:cBC,borderWidth:1.5}]},options:cCO()})} const solC=d.reduce((acc,os)=>{const sol=os.solicitante||'N/Atrib.';acc[sol]=(acc[sol]||0)+1;return acc},{}); if(document.getElementById('reportChartByUsuario')){if(reportChartByUsuarioInstance)reportChartByUsuarioInstance.destroy();reportChartByUsuarioInstance=new Chart(document.getElementById('reportChartByUsuario').getContext('2d'),{type:'pie',data:{labels:Object.keys(solC),datasets:[{label:'OS',data:Object.values(solC),backgroundColor:cCl,borderColor:cBC,borderWidth:1.5,hoverOffset:8}]},options:{...cCO(),scales:{}}});} const sCR=d.reduce((acc,os)=>{acc[os.status]=(acc[os.status]||0)+1;return acc},{}); const sCM={'Aberta':'rgba(54,162,235,0.8)','Em Andamento':'rgba(255,159,64,0.8)','Pendente Informa√ß√£o':'rgba(255,205,86,0.8)','Aguardando Aprova√ß√£o':'rgba(153,102,255,0.8)','Completa':'rgba(75,192,192,0.8)','Cancelada':'rgba(255,99,132,0.8)','Incompleta':'rgba(201,203,207,0.8)','Provis√≥ria':'rgba(160,160,160,0.8)','Conflitante':'rgba(245,158,11,0.8)'}; if(document.getElementById('reportChartByStatus')){if(reportChartByStatusInstance)reportChartByStatusInstance.destroy();reportChartByStatusInstance=new Chart(document.getElementById('reportChartByStatus').getContext('2d'),{type:'doughnut',data:{labels:Object.keys(sCR),datasets:[{label:'OS',data:Object.values(sCR),backgroundColor:Object.keys(sCR).map((s,i)=>sCM[s]||cCl[i%cCl.length]),borderColor:cBC,borderWidth:1.5,hoverOffset:8}]},options:{...cCO(),scales:{}}});}}
    const clearReportOnChange = () => { if(document.getElementById('reportsView')&&!document.getElementById('reportsView').classList.contains('hidden')){document.getElementById('reportsTableBody').innerHTML='<tr><td colspan="10" class="text-center py-10 text-slate-400">Filtros alterados. Clique "Gerar Relat√≥rio".</td></tr>'; reportOsMotivos = {}; if(reportChartByProductInstance){reportChartByProductInstance.destroy();reportChartByProductInstance=null} if(reportChartByUsuarioInstance){reportChartByUsuarioInstance.destroy();reportChartByUsuarioInstance=null} if(reportChartByStatusInstance){reportChartByStatusInstance.destroy();reportChartByStatusInstance=null} document.getElementById('customReportChartsContainer').querySelectorAll('canvas').forEach(c=>{const ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height)})}};

    // FUN√á√ïES DE CONFIGURA√á√ïES DA APLICA√á√ÉO
    function confirmClearAllData() { if (confirm("ATEN√á√ÉO!\nLimpar TODOS os dados de OS, Filtros e Configs Locais?\nIRREVERS√çVEL!")) { if (confirm("CONFIRMA√á√ÉO FINAL:\nTodos os dados locais ser√£o permanentemente apagados. Continuar?")) { ordensServico=[];savedFilters={};ITEMS_PER_PAGE=ITEMS_PER_PAGE_DEFAULT;localStorage.removeItem(LOCAL_STORAGE_KEY);addRecentActivity("Todos dados locais limpos.");currentPage=1;refreshAllViews();populateSavedFiltersSelect();const iPSI=document.getElementById('itemsPerPageSetting');if(iPSI)iPSI.value=ITEMS_PER_PAGE;alert("Dados locais limpos."); } else alert("Limpeza cancelada."); } else alert("Limpeza cancelada."); }
    function applyItemsPerPageSetting() { const iPSI=document.getElementById('itemsPerPageSetting'); if(!iPSI)return; const nIPP=parseInt(iPSI.value,10); if(nIPP>=5&&nIPP<=50){ITEMS_PER_PAGE=nIPP;currentPage=1;saveDataToLocalStorage();renderOSTable();addRecentActivity(`Itens por p√°gina: ${ITEMS_PER_PAGE}.`);}else{alert("Insira valor entre 5 e 50.");iPSI.value=ITEMS_PER_PAGE;}}

    // INICIALIZA√á√ÉO DA APLICA√á√ÉO E EVENTOS GLOBAIS
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM completamente carregado. Iniciando aplica√ß√£o V" + APP_VERSION);
        // Inicializa refer√™ncias a elementos DOM principais
        sidebar = document.getElementById('sidebar');
        mainContent = document.getElementById('mainContent');
        toggleSidebarBtn = document.getElementById('toggleSidebar');
        sidebarTitleDiv = document.getElementById('sidebar-title');
        osModal=document.getElementById('osModal'); osForm=document.getElementById('osForm'); modalTitle=document.getElementById('modalTitle'); productDatalist=document.getElementById('productList'); filterProductSelect=document.getElementById('filterProduct'); reportProductSelect=document.getElementById('reportProductFilter'); // Corrigido para reportProductFilter
        recentActivityList=document.getElementById('recentActivityList'); importStatusMessage=document.getElementById('importStatusMessage'); importSummaryDiv=document.getElementById('importSummary'); importSummaryList=document.getElementById('importSummaryList');
        
        try {
            loadDataFromLocalStorage();
        } catch (e) {
            console.error("Erro cr√≠tico durante loadDataFromLocalStorage na inicializa√ß√£o:", e);
            alert("Um erro ocorreu ao carregar os dados iniciais. A aplica√ß√£o pode n√£o funcionar como esperado.");
        }
        
        const appVersionSpan = document.getElementById('appVersion');
        if (appVersionSpan) {
            appVersionSpan.textContent = `Vers√£o ${APP_VERSION}`;
        } else {
            console.warn("Elemento 'appVersion' n√£o encontrado para definir o texto da vers√£o.");
        }
        
        const homeSI = document.querySelector('.sidebar-item[onclick*="homeView"]');
        if (homeSI) {
            showView('homeView', homeSI);
        } else {
            console.error("Item do menu 'Home' n√£o encontrado, n√£o foi poss√≠vel definir a view inicial.");
            showView('homeView', null);
        }
        
        const dAModalEl=document.getElementById('osDataAberturaModal'); if(dAModalEl&&!dAModalEl.value)dAModalEl.value=new Date().toISOString().split('T')[0];
        const pExcelBtn = document.getElementById('processExcelButton'); if (pExcelBtn) { pExcelBtn.addEventListener('click', handleExcelImport); console.log("Listener para 'processExcelButton' adicionado."); } else { console.error("'processExcelButton' n√£o encontrado! Funcionalidade de importa√ß√£o n√£o funcionar√°.");}
        
        if (toggleSidebarBtn && sidebar && mainContent && sidebarTitleDiv) { if (window.innerWidth < 1024 && !sidebar.classList.contains('collapsed')) { sidebar.classList.add('collapsed'); mainContent.classList.add('collapsed'); const iC=sidebar.classList.contains('collapsed'); toggleSidebarBtn.innerHTML=iC?'<i class="fas fa-chevron-right text-lg"></i>':'<i class="fas fa-bars text-lg"></i>'; const tS=sidebarTitleDiv.querySelector('span');if(tS)tS.style.display=iC?'none':'inline'; const tI=sidebarTitleDiv.querySelector('i');if(tI)tI.style.marginRight=iC?'0':'0.5rem'; }}
        addRecentActivity(`Sistema V${APP_VERSION} inicializado.`); updateLoginUI();

        if (osForm) {
            console.log("Adicionando listener de submit para 'osForm'.");
            osForm.addEventListener('submit', function (e) {
                e.preventDefault();
                console.log("Formul√°rio OS submetido.");
                try {
                    const id = document.getElementById('osId').value;
                    const dAVal = document.getElementById('osDataAberturaModal').value;
                    const pFVal = document.getElementById('osPrazoFinalModal').value;
                    console.log("Valores do formul√°rio OS:", {id, dAVal, pFVal});

                    if (!dAVal || !pFVal) { alert("Datas de Abertura e Prazo Final s√£o obrigat√≥rias."); console.warn("Datas obrigat√≥rias n√£o preenchidas."); return; }
                    
                    const osD = {
                        numero: document.getElementById('osNumeroModal').value.trim(),
                        cliente: document.getElementById('osClienteModal').value.trim(),
                        produto: document.getElementById('osProdutoModal').value.trim(),
                        solicitante: document.getElementById('osSolicitanteModal').value.trim() || 'N/A',
                        descricao: document.getElementById('osDescricaoModal').value.trim(),
                        dataAbertura: dAVal, prazoFinal: pFVal,
                        responsavel: document.getElementById('osResponsavelModal').value.trim(),
                        status: document.getElementById('osStatusModal').value,
                        prioridade: document.getElementById('osPrioridadeModal').value,
                        marcadorAtrasoManual: document.getElementById('osMarcadorAtrasoModal').checked,
                        logisticaOk: document.getElementById('osLogisticaOkModal').checked
                    };
                    console.log("Objeto osD constru√≠do:", osD);

                    if (!osD.numero||!osD.cliente||!osD.produto||!osD.descricao||!osD.responsavel||!osD.status||!osD.prioridade) { alert("Preencha todos os campos obrigat√≥rios (*)."); console.warn("Campos obrigat√≥rios da OS n√£o preenchidos."); return; }
                    if (new Date(osD.prazoFinal) < new Date(osD.dataAbertura)) { alert("Prazo Final anterior √† Data Abertura."); console.warn("Erro de l√≥gica de datas: Prazo Final < Data Abertura."); return; }
                    
                    if (id) {
                        const osIX = ordensServico.findIndex(o=>o.id===id);
                        if (osIX!==-1) { ordensServico[osIX]={...ordensServico[osIX],...osD}; addRecentActivity(`OS ${osD.numero} editada.`); console.log(`OS ${id} editada.`);}
                        else { alert("Erro ao editar OS: N√£o encontrada."); console.error(`Erro ao editar: OS ${id} n√£o encontrada.`); return; }
                    } else {
                        osD.id = generateId(); ordensServico.unshift(osD); addRecentActivity(`Nova OS ${osD.numero} adicionada.`); console.log(`Nova OS adicionada: ${osD.id}`, osD);
                    }
                    saveDataToLocalStorage(); populateProductFilters(); closeOSModal(); currentPage=1; refreshAllViews();
                } catch (er) { console.error("Erro CR√çTICO ao salvar OS:", er); alert("Erro ao salvar OS. Verifique o console."); }
            });
        } else {
            console.error("'osForm' n√£o encontrado no DOM! Funcionalidade de adicionar OS n√£o funcionar√°.");
        }
        
        const addListenersToElements = (elementsAndListeners) => { elementsAndListeners.forEach(({selector, event, handler, options = {}}) => { const element = document.getElementById(selector); if (element) { if (options.flagAttribute && element.getAttribute(options.flagAttribute)) { return; } element.addEventListener(event, handler); if (options.flagAttribute) { element.setAttribute(options.flagAttribute, 'true'); } } else { /* console.warn(`Elemento com ID '${selector}' n√£o encontrado para listener.`); */ } }); };
        const osListFilters = [ { selector: 'filterOsNumber', event: 'input', handler: applyFiltersAndRender }, { selector: 'filterClient', event: 'input', handler: applyFiltersAndRender }, { selector: 'filterStatus', event: 'change', handler: applyFiltersAndRender }, { selector: 'filterProduct', event: 'change', handler: applyFiltersAndRender }, { selector: 'filterDescription', event: 'input', handler: applyFiltersAndRender }, { selector: 'filterMarcadorAtraso', event: 'change', handler: applyFiltersAndRender }, { selector: 'filterLogisticaOk', event: 'change', handler: applyFiltersAndRender }, ]; addListenersToElements(osListFilters);
        const reportFilters = [ { selector: 'reportDateStartFilter', event: 'change', handler: clearReportOnChange }, { selector: 'reportDateEndFilter', event: 'change', handler: clearReportOnChange }, { selector: 'reportStatusFilter', event: 'change', handler: clearReportOnChange, options: { flagAttribute: 'dlset_rsf' } }, { selector: 'reportProductFilter', event: 'change', handler: clearReportOnChange, options: { flagAttribute: 'dlset_rpf' } }, { selector: 'reportFilterMarcadorAtraso', event: 'change', handler: clearReportOnChange, options: { flagAttribute: 'dlset_rfma' } }, { selector: 'reportFilterLogisticaOk', event: 'change', handler: clearReportOnChange, options: { flagAttribute: 'dlset_rflo' } }, ]; addListenersToElements(reportFilters);
        console.log("Listeners de filtro e inicializa√ß√£o DOMContentLoaded conclu√≠dos.");
    });

    window.onclick = function (event) {
        const cOsModal = document.getElementById('osModal'); if (cOsModal && event.target == cOsModal) closeOSModal();
        const popover = document.getElementById('motivosPopover');
        if (popover && popover.style.display === 'block' && !popover.contains(event.target) && !event.target.closest('button[id*="motivo-btn-"]')) {
            console.log("Clique fora do popover de motivos, fechando sem salvar.");
            closeMotivosPopover(false);
        }
    };
    window.onkeydown = function (event) { const cOsModal = document.getElementById('osModal'); if (cOsModal && !cOsModal.classList.contains('hidden') && event.key === "Escape") closeOSModal(); const popover = document.getElementById('motivosPopover'); if (popover && popover.style.display === 'block' && event.key === "Escape") closeMotivosPopover(false); };
    console.log("Script principal (V" + APP_VERSION + ") completamente carregado e pronto.");
</script>
</body>
</html>