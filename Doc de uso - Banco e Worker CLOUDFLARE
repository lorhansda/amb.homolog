Guia de Opera√ß√£o do Espelho SenseData
1. Sincroniza√ß√£o Autom√°tica
Cron executado a cada 15 min (*/15 * * * *) chama runDailySync(env, { maxPages: 1 }).
Busca apenas o delta desde sync_state.last_activity_update / last_client_update.
Limita a 1 p√°gina (‚âà100 registros) por rodada para n√£o estourar limites do plano free.
Cursor incremental: se o cursor estiver NULL, usa ‚Äúhoje ‚àí 3 dias‚Äù como fallback e, ao final da execu√ß√£o, grava o maior updated_at retornado. Assim, cada exec. pega apenas o que mudou desde a √∫ltima rodada.
2. Limpeza Mensal
Cron mensal (0 2 1 * * *) chama purgeOldActivities(env).
Remove de atividades todas as linhas cujo coalesce(atualizado_em, criado_em) seja anterior a 4 meses (CLEANUP_MONTHS = 4).
Endpoint manual: https://sensedata-api.sensedata-dash.workers.dev/api/purge-old-atividades.
3. Endpoints Dispon√≠veis
| Endpoint | M√©todo | Descri√ß√£o | | --- | --- | --- | | /api/sync | GET | Rodada manual da sincroniza√ß√£o (usa o cursor; respeita ?pages=n). | | /api/sync-atividades | GET | S√≥ sincroniza atividades (com ?pages=n). | | /api/sync-clientes | GET | S√≥ sincroniza clientes (com ?pages=n). | | /api/sync-deletados | GET | Consulta deletados na janela atual (opcional; n√£o roda no cron). | | /api/delete-atividade?id=<id> | POST/GET | Remove do D1 a atividade com id_sensedata=<id> (usado pelo bot√£o üóë no dashboard). | | /api/purge-old-atividades | POST/GET | Executa a limpeza de registros com mais de 4 meses. | | /api/atividades?limit=...&since=... | GET | Retorna os dados para o dashboard (por padr√£o √∫ltimos 90 dias, MIRROR_WINDOW_DAYS). | | /api/clientes | GET | Lista de clientes para o dashboard. |

4. Par√¢metros Ajust√°veis
LOOKBACK_DAYS (atual): 3 ‚Äî fallback para primeira sincroniza√ß√£o sem cursor.
MAX_PAGES: 1 (no cron) ‚Äî pode ser aumentado manualmente via ?pages=n quando se deseja processar mais itens em um √∫nico disparo.
CLEANUP_MONTHS: 4 ‚Äî per√≠odo de reten√ß√£o do D1.
Para alterar:

Em cloudflare-worker.js, ajuste os valores e republique (wrangler publish).
Atualize os cron schedules no painel (Workers & Pages ‚Üí Triggers) conforme desejado.
5. Fluxo do Dashboard
As tabelas exibem uma coluna de a√ß√µes (bot√£o üóë) quando __activityId est√° presente. Ao clicar:
Chamada autom√°tica a https://sensedata-api.sensedata-dash.workers.dev/api/delete-atividade?id=<ID>.
Em caso de sucesso, a linha √© removida da UI; em falha, o bot√£o reabilita e mostra alerta.
mapDatabaseToDashboard injeta __activityId a partir de id_sensedata para permitir esse comportamento.
6. Uso Manual (quando necess√°rio)
For√ßar sincroniza√ß√£o: https://sensedata-api.sensedata-dash.workers.dev/api/sync?pages=2
Rodar apenas atividades ou clientes: /api/sync-atividades?pages=2 ou /api/sync-clientes?pages=2.
Limpar manualmente: /api/purge-old-atividades.
Remover item detectado via dashboard: clique no bot√£o ou use /api/delete-atividade?id=<id>.
7. Observability / Logs
Logs importantes:
[sync-deletados] Processado id=...
[sync-deletados] raw-sample-single={...}
Para ver os logs, use Observability ‚Üí Logs no painel, ou wrangler tail --service=sensedata-api.
8. Manuten√ß√£o Recorrente
Verificar sync_state ocasionalmente (SELECT * FROM sync_state;) para confirmar que os cursores est√£o avan√ßando.
Caso alguma sincroniza√ß√£o pare (ex.: feed do SenseData retorna erro), os logs mostrar√£o last_error.
Se precisar resetar o cursor (por ex., reprocessar um per√≠odo maior), zere last_activity_update / last_client_update:
UPDATE sync_state SET last_activity_update = NULL, last_client_update = NULL WHERE id = 1;
Na pr√≥xima execu√ß√£o ele voltar√° a usar ‚Äúhoje ‚àí LOOKBACK_DAYS‚Äù.
