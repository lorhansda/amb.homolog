<!DOCTYPE html>
<html lang="pt-BR" class="dark"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento Interno de OS - V1.9.1</title> <meta name="google-signin-client_id" content="232267534625-ti8c7jd14nfqigmmj3lnevv8nvds3i0t.apps.googleusercontent.com">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Dark theme variables are now the default */
        :root {
            --bg-body-light: #0f172a; --text-primary-light: #cbd5e1; --bg-sidebar-light: #020617;
            --text-sidebar-light: #94a3b8; --bg-card-light: #1e293b; --text-card-light: #cbd5e1;
            --border-card-light: #334155; --bg-table-header-light: #334155; --text-table-header-light: #94a3b8;
            --border-table-header-light: #475569; --text-table-row-light: #cbd5e1; --border-table-row-light: #334155;
            --bg-table-row-hover-light: #283447; --bg-input-light: #0f172a; --text-input-light: #cbd5e1;
            --border-input-light: #475569; --border-input-focus-light: #0ea5e9;
            --shadow-input-focus-light: rgba(14, 165, 233, 0.25); --bg-button-primary-light: #0ea5e9;
            --text-button-primary-light: #0f172a; --bg-button-primary-hover-light: #0284c7;
            --text-placeholder-light: #64748b; --text-link-light: #38bdf8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body-light);
            color: var(--text-primary-light);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            overflow-x: hidden;
            min-height: 100vh;
        }
        .sidebar {
            background-color: var(--bg-sidebar-light);
            color: var(--text-sidebar-light);
            width: 260px;
            transition: width 0.3s ease, background-color 0.3s, color 0.3s;
            box-shadow: 2px 0 6px rgba(0,0,0,0.1);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 50;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar.collapsed { width: 70px; }
        .sidebar-item { padding: 14px 18px; cursor: pointer; display: flex; align-items: center; transition: background-color 0.2s ease, color 0.2s ease; border-radius: 6px; margin: 4px 0; }
        .sidebar-item:hover { background-color: #1e293b; color: #f8fafc; }
        .sidebar-item.active { background-color: #0ea5e9; color: #ffffff; }
        .sidebar-item i { margin-right: 12px; min-width: 24px; text-align: center; font-size: 1.1em; }
        .sidebar.collapsed .sidebar-item span, .sidebar.collapsed #sidebar-title span { display: none; }
        .sidebar.collapsed .sidebar-item i { margin-right: 0; }
        .sidebar-header { padding: 14px 18px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #1e293b; margin-bottom:10px; }
        #sidebar-title span { font-size: 1.4em; font-weight: 600; color: #e2e8f0; }

        .content {
            background-color: var(--bg-body-light);
            flex-grow: 1;
            padding: 25px;
            transition: margin-left 0.3s ease, background-color 0.3s;
            margin-left: 260px;
            width: calc(100vw - 260px);
            overflow-y: auto;
            overflow-x: hidden;
        }
        .content.collapsed {
            margin-left: 70px;
            width: calc(100vw - 70px);
        }
        .card {
            background-color: var(--bg-card-light);
            color: var(--text-card-light);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.07);
            padding: 25px;
            margin-bottom: 25px;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            border: 1px solid var(--border-card-light);
        }
        .table-header th {
            background-color: var(--bg-table-header-light);
            color: var(--text-table-header-light);
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.8rem;
            padding-top: 12px; padding-bottom: 12px;
            border-bottom: 2px solid var(--border-table-header-light);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .table-row td {
            color: var(--text-table-row-light);
            border-color: var(--border-table-row-light);
            padding: 10px 16px;
            transition: color 0.3s, border-color 0.3s, background-color 0.3s;
        }
        .table-row:hover td { background-color: var(--bg-table-row-hover-light); }
        .input-field, .select-field {
            background-color: var(--bg-input-light); color: var(--text-input-light);
            border: 1px solid var(--border-input-light); border-radius: 6px; padding: 10px;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .input-field:focus, .select-field:focus {
            border-color: var(--border-input-focus-light);
            box-shadow: 0 0 0 0.2rem var(--shadow-input-focus-light); outline: none;
        }
        .form-checkbox { border-color: var(--border-input-light); background-color: var(--bg-input-light); }
        .form-checkbox:checked { background-color: var(--border-input-focus-light); border-color: var(--border-input-focus-light); }
        .btn { padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: 500; text-transform: capitalize; display: inline-flex; align-items: center; gap: 8px; border: none; }
        .btn-primary { background-color: var(--bg-button-primary-light); color: var(--text-button-primary-light); }
        .btn-primary:hover { background-color: var(--bg-button-primary-hover-light); }
        .btn-secondary { background-color: #475569; color: #e2e8f0; }
        .btn-secondary:hover { background-color: #334155; }
        .btn-info { background-color: #5dade2; color: #1A202C; }
        .btn-info:hover { background-color: #3498db; }
        .btn-danger { background-color: #ef4444; color: white; } .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #22c55e; color: white; } .btn-success:hover { background-color: #16a34a; }
        .btn-warning { background-color: #f59e0b; color: white; } .btn-warning:hover { background-color: #d97706; }
        .btn-teal { background-color: #14b8a6; color: white; } /* Novo botão teal */
        .btn-teal:hover { background-color: #0d9488; }


        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--bg-card-light); color: var(--text-card-light); margin: auto; padding: 30px; border: 1px solid var(--border-card-light); width: 90%; max-width: 900px; border-radius: 8px; position: relative; animation: slideIn 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.15); max-height: 90vh; overflow-y: auto; }
        .close-button { color: #9ca3af; position: absolute; right: 15px; top: 15px; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .close-button:hover, .close-button:focus { color: #e2e8f0; text-decoration: none; }

        #recentActivityList li { border-bottom-color: var(--border-table-row-light); }
        #recentActivityList .text-placeholder { color: var(--text-placeholder-light); }
        #paginationControls span { color: var(--text-primary-light); }
        #google-login-container { margin-top: auto; padding: 15px; border-top: 1px solid #4b5563;}
        #user-info { display: flex; align-items: center; gap: 10px; }
        #user-info img { border-radius: 50%; width: 32px; height: 32px; border: 2px solid var(--border-card-light);}
        #user-info span { font-size: 0.9em; font-weight: 500; }
        .checkbox-cell { width: 1%; white-space: nowrap; }
        .priority-Alta { background-color: #fee2e2 !important; color: #b91c1c !important; }
        .priority-Urgente { background-color: #ffedd5 !important; color: #c2410c !important; animation: pulse 1.5s infinite; }
        .priority-Média { background-color: #fef3c7 !important; color: #a16207 !important; }
        .priority-Baixa { background-color: #dcfce7 !important; color: #15803d !important; }
        .status-cell span { display: flex; align-items: center; }
        .manual-flag-toggle, .logistica-toggle { cursor: pointer; margin-left: 5px; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideIn { from {transform: translateY(-30px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .g_id_signin div[role="button"] { background-color: #1e293b !important; color: #e2e8f0 !important; border: 1px solid #475569 !important;}
        .g_id_signin svg { fill: #e2e8f0 !important; }

        .home-card-link { cursor: pointer; transition: transform 0.2s ease-in-out; }
        .home-card-link:hover { transform: translateY(-3px); }

        .card .overflow-x-auto {
        }
        .card .overflow-x-auto table {
        }

    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="flex"> <aside id="sidebar" class="sidebar p-3">
        <div>
            <div class="sidebar-header">
                <div id="sidebar-title" class="flex items-center"> <i class="fas fa-tasks text-2xl text-sky-500"></i> <span class="text-xl font-semibold">Gestão OS</span> </div>
                <button id="toggleSidebar" class="text-slate-400 hover:text-white focus:outline-none p-1 rounded-md"> <i class="fas fa-bars text-lg"></i> </button>
            </div>
            <nav class="flex-grow mt-2">
                <ul>
                    <li class="sidebar-item active" onclick="showView('homeView', this)"> <i class="fas fa-home"></i> <span>Home</span> </li>
                    <li class="sidebar-item" onclick="showView('osListView', this)"> <i class="fas fa-list-alt"></i> <span>Ordens de Serviço</span> </li>
                    <li class="sidebar-item" onclick="showView('reportsView', this)"> <i class="fas fa-chart-pie"></i> <span>Relatórios</span> </li>
                    <li class="sidebar-item mt-4" onclick="openAddOSModal()"> <i class="fas fa-plus-circle text-green-500"></i> <span class="text-green-500">Nova OS</span> </li>
                </ul>
            </nav>
        </div>
        <div id="google-login-container" class="px-2">
            <div id="g_id_onload" data-client_id="232267534625-ti8c7jd14nfqigmmj3lnevv8nvds3i0t.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
            <div id="user-info" class="mt-2 hidden"> <img id="user-pic" src="" alt="User Pic" class="w-8 h-8 rounded-full mr-2"> <span id="user-name" class="text-sm font-medium"></span> <button onclick="handleSignOut()" class="btn btn-xs btn-danger !p-1.5 !text-xs ml-auto"><i class="fas fa-sign-out-alt"></i></button> </div>
        </div>
        <div class="mt-auto pb-2">
            <div class="sidebar-item" onclick="showView('settingsView', this)"> <i class="fas fa-cog"></i> <span>Configurações</span> </div>
            <div class="sidebar-item text-sm text-slate-500 dark:text-slate-400"> <i class="fas fa-info-circle"></i> <span id="appVersion">Versão 1.9.1</span> </div>
        </div>
    </aside>

    <main id="mainContent" class="content">
      <div id="homeView" class="view-section card">
            <h2 class="text-3xl font-bold mb-6">Página Inicial</h2>
            <div class="mb-6 p-4 bg-slate-800 rounded-lg border border-slate-700"> <h3 class="text-xl font-semibold mb-2">🎯 Objetivo do Site</h3>
                <p class="text-sm text-slate-300 leading-relaxed"> Este sistema foi desenvolvido para otimizar o Gerenciamento Interno de Ordens de Serviço (OS). O objetivo principal é fornecer uma plataforma centralizada e eficiente para o cadastro, acompanhamento detalhado, filtragem avançada e geração de relatórios perspicazes sobre todas as OS. Com isso, buscamos maior organização, agilidade nos processos e melhor tomada de decisão. </p>
                <h3 class="text-xl font-semibold mt-6 mb-2">📊 Visão Geral das Funcionalidades</h3>
                <p class="text-sm text-slate-300 leading-relaxed"> Explore as diversas seções do sistema para ter controle total sobre suas Ordens de Serviço: </p>
                <ul class="list-disc list-inside text-sm text-slate-300 mt-2 space-y-1 pl-4">
                    <li><strong>Home:</strong> Visão geral dos indicadores chave e acesso rápido às funcionalidades.</li>
                    <li><strong>Ordens de Serviço:</strong> Liste, filtre (incluindo por marcadores manuais de "Não Realizada no Prazo" e "Logística OK"), edite, gerencie e importe OS em lote.</li>
                    <li><strong>Relatórios:</strong> Gere relatórios personalizados com gráficos para análises detalhadas, incluindo filtro por marcadores manuais e novos campos de dados. Exporte em PDF aprimorado ou como imagem.</li>
                    <li><strong>Nova OS:</strong> Crie novas Ordens de Serviço de forma rápida e intuitiva, com opção para os novos marcadores.</li>
                </ul>
                <p class="text-sm text-slate-300 leading-relaxed mt-3"> Utilize os cards abaixo para uma navegação ágil pelas principais métricas e seções do sistema. </p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-sky-500 to-sky-600 p-6 rounded-xl shadow-lg text-white home-card-link" onclick="navigateToOsListWithFilter('Aberta')"> <div class="flex justify-between items-center"> <h3 class="text-lg font-medium">OS Abertas</h3> <i class="fas fa-folder-open text-3xl opacity-70"></i> </div> <p id="osAbertasCount" class="text-4xl font-bold mt-2">0</p> </div>
                <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 p-6 rounded-xl shadow-lg text-white home-card-link" onclick="navigateToOsListWithFilter('Completa', true)"> <div class="flex justify-between items-center"> <h3 class="text-lg font-medium">OS Completas (Mês)</h3> <i class="fas fa-check-circle text-3xl opacity-70"></i> </div> <p id="osCompletasMesCount" class="text-4xl font-bold mt-2">0</p> </div>
                <div class="bg-gradient-to-br from-amber-500 to-amber-600 p-6 rounded-xl shadow-lg text-white home-card-link" onclick="navigateToOsListWithFilter(['Pendente Informação', 'Aguardando Aprovação'])"> <div class="flex justify-between items-center"> <h3 class="text-lg font-medium">OS Pendentes</h3> <i class="fas fa-exclamation-triangle text-3xl opacity-70"></i> </div> <p id="osPendentesCount" class="text-4xl font-bold mt-2">0</p> </div>
                <div class="bg-gradient-to-br from-rose-500 to-rose-600 p-6 rounded-xl shadow-lg text-white home-card-link" onclick="navigateToOsListWithFilter('Cancelada')"> <div class="flex justify-between items-center"> <h3 class="text-lg font-medium">OS Canceladas</h3> <i class="fas fa-times-circle text-3xl opacity-70"></i> </div> <p id="osCanceladasCount" class="text-4xl font-bold mt-2">0</p> </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card !p-0"> <div class="p-4 border-b border-slate-700"> <h3 class="text-xl font-semibold">Distribuição de Status das OS</h3> </div> <div id="osStatusChartContainer" class="p-4 min-h-[300px]"> <canvas id="osStatusChart"></canvas> </div> </div>
                <div class="card"> <h3 class="text-xl font-semibold mb-3">Atividades Recentes</h3> <ul id="recentActivityList" class="space-y-3 max-h-80 overflow-y-auto"> <li class="text-sm text-placeholder">Nenhuma atividade recente.</li> </ul> </div>
            </div>
        </div>

        <div id="osListView" class="view-section card hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold">Ordens de Serviço</h2>
                <div class="flex gap-2 flex-wrap items-center">
                    <div id="bulkActionsContainer" class="hidden flex gap-2 items-center mr-4"> <span id="selectedOsCount" class="text-sm">0 selecionadas</span> <select id="bulkActionStatus" class="select-field p-2 rounded-md text-sm"> <option value="">Alterar Status para...</option> <option value="Aberta">Aberta</option> <option value="Em Andamento">Em Andamento</option> <option value="Pendente Informação">Pendente Informação</option> <option value="Aguardando Aprovação">Aguardando Aprovação</option> <option value="Completa">Completa</option> <option value="Incompleta">Incompleta</option> <option value="Provisória">Provisória</option> <option value="Cancelada">Cancelada</option> </select> <button class="btn btn-sm btn-primary" onclick="applyBulkAction()"><i class="fas fa-check"></i> Aplicar</button> <button class="btn btn-sm btn-danger" onclick="bulkDeleteSelectedOS()"><i class="fas fa-trash"></i> Excluir</button> </div>
                    <button class="btn btn-success" onclick="exportTableToCSV('osTable', 'lista_os.csv')"><i class="fas fa-file-csv"></i>Exportar CSV</button>
                    <button class="btn btn-danger" onclick="exportTableToPDF('osTable', 'Lista de Ordens de Serviço', 'osTableBody')"><i class="fas fa-file-pdf"></i>Exportar PDF</button>
                    <button class="btn btn-primary" onclick="openAddOSModal()"> <i class="fas fa-plus"></i> Adicionar OS </button>
                    <button class="btn btn-info" onclick="toggleImportSection()"><i class="fas fa-file-excel"></i> Importar OS em Lote</button>
                </div>
            </div>
            
            <div id="importOsLoteContainer" class="card hidden mb-6 bg-slate-800 border border-slate-700"> <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-semibold text-slate-100"> <i class="fas fa-file-excel mr-2 text-green-500"></i>Importar OS em Lote </h3>
                    <button onclick="toggleImportSection()" class="text-slate-400 hover:text-slate-200 text-xl">&times;</button>
                </div>
                <p class="text-xs text-slate-400 mb-3"> Selecione (.xlsx, .xls, .csv). Colunas primárias: Código, Status (ex: Aberta, Completa, Incompleta, Provisória), Cliente, Início (dd/mm/aaaa hh:mm), Término (dd/mm/aaaa hh:mm), Técnico, Solicitante. </p>
                <div class="flex flex-col sm:flex-row gap-3 items-start">
                    <input type="file" id="excelFileInput" class="input-field p-2 rounded-md border-slate-600 text-sm w-full sm:w-auto file:mr-4 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sky-700 file:text-sky-200 hover:file:bg-sky-600 cursor-pointer flex-grow" accept=".xlsx, .xls, .csv"> <button id="processExcelButton" class="btn btn-sm btn-success whitespace-nowrap w-full sm:w-auto mt-2 sm:mt-0"> <i class="fas fa-upload"></i> Processar Arquivo </button>
                </div>
                <div id="importStatusMessage" class="mt-3 text-xs"> </div>
                <div id="importSummary" class="mt-2 text-xs hidden"> <p class="font-semibold mb-1"><strong>Resumo da Importação:</strong></p> <ul id="importSummaryList" class="list-disc list-inside pl-3 space-y-0.5 max-h-32 overflow-y-auto"></ul> </div>
            </div>

            <div class="w-full md:flex-grow">
                <div class="mb-6 p-4 bg-slate-800 rounded-lg border border-slate-700"> <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <input type="text" id="filterOsNumber" placeholder="Nº OS" class="input-field p-2 rounded-md">
                        <input type="text" id="filterClient" placeholder="Cliente" class="input-field p-2 rounded-md">
                        <input type="text" id="filterDescription" placeholder="Buscar na Descrição..." class="input-field p-2 rounded-md">
                        <select id="filterProduct" class="select-field p-2 rounded-md"> <option value="">Todos os Produtos</option> </select>
                        <select id="filterStatus" class="select-field p-2 rounded-md"> <option value="">Todos os Status</option> <option value="Aberta">Aberta</option> <option value="Em Andamento">Em Andamento</option> <option value="Pendente Informação">Pendente Informação</option> <option value="Aguardando Aprovação">Aguardando Aprovação</option> <option value="Completa">Completa</option> <option value="Incompleta">Incompleta</option> <option value="Provisória">Provisória</option> <option value="Cancelada">Cancelada</option></select>
                        <div>
                            <label for="filterMarcadorAtraso" class="block text-xs font-medium mb-0.5">Atraso (Manual):</label>
                            <select id="filterMarcadorAtraso" class="select-field p-2 rounded-md w-full text-sm">
                                <option value="">Todos</option>
                                <option value="marcada">Marcada</option>
                                <option value="nao_marcada">Não Marcada</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterLogisticaOk" class="block text-xs font-medium mb-0.5">Logística Pronta:</label>
                            <select id="filterLogisticaOk" class="select-field p-2 rounded-md w-full text-sm">
                                <option value="">Todos</option>
                                <option value="sim">Sim</option>
                                <option value="nao">Não</option>
                            </select>
                        </div>
                    </div>
                     <div class="mt-4 flex flex-wrap gap-2 items-center"> <label for="savedFilters" class="text-sm font-medium">Filtros Salvos:</label> <select id="savedFilters" class="select-field p-2 rounded-md text-sm"> <option value="">Carregar filtro...</option> </select> <button class="btn btn-sm btn-secondary" onclick="loadSelectedFilter()"><i class="fas fa-download"></i> Carregar</button> <input type="text" id="newFilterName" placeholder="Nome do novo filtro" class="input-field p-2 rounded-md text-sm"> <button class="btn btn-sm btn-primary" onclick="saveCurrentFilters()"><i class="fas fa-save"></i> Salvar Filtro</button> <button class="btn btn-sm btn-danger" onclick="deleteSavedFilter()" title="Excluir filtro"><i class="fas fa-trash-alt"></i></button> </div>
                </div>

                <div class="overflow-x-auto shadow-md rounded-lg">
                    <table id="osTable" class="min-w-full">
                       <thead class="table-header"> <tr> <th class="py-3 px-2 text-center checkbox-cell"><input type="checkbox" id="selectAllOsCheckbox" onchange="toggleSelectAllOS(this)" class="form-checkbox h-4 w-4"></th><th class="py-3 px-4 text-left">Nº OS</th> <th class="py-3 px-4 text-left">Cliente</th> <th class="py-3 px-4 text-left">Produto</th> <th class="py-3 px-4 text-left">Descrição</th> <th class="py-3 px-4 text-left">Data Abertura</th> <th class="py-3 px-4 text-left">Prazo Final</th> <th class="py-3 px-4 text-left">Responsável</th> <th class="py-3 px-4 text-left">Solicitante</th> <th class="py-3 px-4 text-left">Status</th><th class="py-3 px-4 text-left">Logística</th> <th class="py-3 px-4 text-left">Prioridade</th> <th class="py-3 px-4 text-left">Ações</th> </tr> </thead> <tbody id="osTableBody" class="divide-y divide-slate-700"></tbody> </table>
                </div>
                <div id="paginationControls" class="mt-6 flex justify-end items-center gap-2"></div>
            </div>
        </div>

        <div id="reportsView" class="view-section card hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold">Relatórios Personalizados</h2>
                <div class="flex gap-2 flex-wrap items-center">
                    <button class="btn btn-success" onclick="exportTableToCSV('reportsTable', 'relatorio_os_personalizado.csv')"><i class="fas fa-file-csv"></i> CSV</button>
                    <button class="btn btn-danger" onclick="exportReportToPDFWithCharts('reportsTable', 'Relatório Personalizado de OS', 'reportsTableBody', ['reportChartByProduct', 'reportChartByUsuario', 'reportChartByStatus'])"><i class="fas fa-file-pdf"></i> PDF Detalhado</button>
                    <button class="btn btn-teal" onclick="exportVisibleListToImage('reportsTable', 'relatorio_lista_os.png')"><i class="fas fa-image"></i> Imagem da Lista</button>
                </div>
            </div>
            <div class="mb-6 p-4 bg-slate-800 rounded-lg border border-slate-700"> <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                    <div> <label for="reportDateStartFilter" class="block text-sm font-medium mb-1">Data Inicial (Prazo):</label> <input type="date" id="reportDateStartFilter" name="reportDateStartFilter" class="input-field w-full p-2 rounded-md"> </div>
                    <div> <label for="reportDateEndFilter" class="block text-sm font-medium mb-1">Data Final (Prazo):</label> <input type="date" id="reportDateEndFilter" name="reportDateEndFilter" class="input-field w-full p-2 rounded-md"> </div>
                    <div> <label for="reportStatusFilter" class="block text-sm font-medium mb-1">Status:</label> <select id="reportStatusFilter" class="select-field w-full p-2 rounded-md"> <option value="">Todos</option> <option value="Aberta">Aberta</option> <option value="Em Andamento">Em Andamento</option> <option value="Pendente Informação">Pendente Informação</option> <option value="Aguardando Aprovação">Aguardando Aprovação</option> <option value="Completa">Completa</option> <option value="Incompleta">Incompleta</option> <option value="Provisória">Provisória</option> <option value="Cancelada">Cancelada</option></select> </div>
                    <div>
                        <label for="reportFilterMarcadorAtraso" class="block text-sm font-medium mb-1">Atraso (Manual):</label>
                        <select id="reportFilterMarcadorAtraso" class="select-field w-full p-2 rounded-md">
                            <option value="">Todos</option>
                            <option value="marcada">Marcada</option>
                            <option value="nao_marcada">Não Marcada</option>
                        </select>
                    </div>
                    <div class="md:col-span-2"> <label for="reportProductFilter" class="block text-sm font-medium mb-1">Produto:</label> <select id="reportProductFilter" class="select-field w-full p-2 rounded-md"> <option value="">Todos</option></select> </div>
                    <div class="md:col-span-2">
                        <label for="reportFilterLogisticaOk" class="block text-sm font-medium mb-1">Logística Pronta:</label>
                        <select id="reportFilterLogisticaOk" class="select-field w-full p-2 rounded-md">
                            <option value="">Todos</option>
                            <option value="sim">Sim</option>
                            <option value="nao">Não</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4"> <button class="btn btn-primary" onclick="generateCustomReport()"><i class="fas fa-filter"></i> Gerar Relatório</button> </div>
            </div>
            <div id="customReportChartsContainer" class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="card !shadow-lg flex flex-col p-4 min-h-[380px]">  <h4 class="text-lg font-semibold mb-3 text-center text-slate-200">OS por Produto</h4>  <div class="flex-grow relative w-full h-full min-h-[280px]"> <canvas id="reportChartByProduct"></canvas> </div>  </div>
                <div class="card !shadow-lg flex flex-col p-4 min-h-[380px]">  <h4 class="text-lg font-semibold mb-3 text-center text-slate-200">OS por Solicitante</h4>  <div class="flex-grow relative w-full h-full min-h-[280px]"> <canvas id="reportChartByUsuario"></canvas> </div>  </div> <div class="card !shadow-lg flex flex-col p-4 min-h-[380px]">  <h4 class="text-lg font-semibold mb-3 text-center text-slate-200">OS por Status (Relatório)</h4>  <div class="flex-grow relative w-full h-full min-h-[280px]"> <canvas id="reportChartByStatus"></canvas> </div>  </div>
            </div>
            <div class="overflow-x-auto shadow-md rounded-lg"> 
                <table id="reportsTable" class="min-w-full"> 
                    <thead class="table-header"> 
                        <tr> 
                            <th class="py-3 px-4 text-left">Código OS</th> 
                            <th class="py-3 px-4 text-left">Solicitante</th> 
                            <th class="py-3 px-4 text-left">Cliente</th> 
                            <th class="py-3 px-4 text-left">Data Início</th> 
                            <th class="py-3 px-4 text-left">Data Término</th> 
                            <th class="py-3 px-4 text-left">Solicitante</th> <th class="py-3 px-4 text-left">Logística Pronta</th> 
                            <th class="py-3 px-4 text-left">Produto</th> 
                        </tr> 
                    </thead> 
                    <tbody id="reportsTableBody" class="divide-y divide-slate-700"> <tr class="table-row"><td colspan="8" class="text-center py-10 text-slate-400">Selecione filtros e clique "Gerar Relatório".</td></tr> 
                    </tbody> 
                </table> 
            </div>
        </div>
        <div id="settingsView" class="view-section card hidden">
            <h2 class="text-3xl font-bold mb-6">Configurações</h2>
            <div class="space-y-8">
                <div> <h3 class="text-xl font-semibold mb-3 border-b pb-2 border-slate-700">Gestão da Página</h3> <div class="space-y-4"> <div> <button class="btn btn-danger" onclick="confirmClearAllData()"><i class="fas fa-trash-alt"></i> Limpar Todos os Dados das OS</button> <p class="text-xs text-slate-400 mt-1">Atenção: Irreversível, apaga todas as OS salvas localmente.</p> </div> </div> </div>
                <div> <h3 class="text-xl font-semibold mb-3 border-b pb-2 border-slate-700">Visualização</h3> <div class="space-y-4"> <div> <label for="itemsPerPageSetting" class="block text-sm font-medium mb-1">Itens por Página na Lista de OS:</label> <input type="number" id="itemsPerPageSetting" value="10" min="5" max="50" step="5" class="input-field p-2 rounded-md w-full md:w-1/4"> <button class="btn btn-sm btn-primary ml-2" onclick="applyItemsPerPageSetting()">Aplicar</button> </div> </div> </div>
            </div>
        </div>
    </main>
    <div id="osModal" class="modal hidden"> <div class="modal-content"> <span class="close-button" onclick="closeOSModal()">&times;</span> <h3 id="modalTitle" class="text-2xl font-semibold mb-6">Adicionar Nova Ordem de Serviço</h3> <form id="osForm"> <input type="hidden" id="osId"> <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-4"> <div> <label for="osNumeroModal" class="block text-sm font-medium mb-1">Nº OS <span class="text-red-500">*</span></label> <input type="text" id="osNumeroModal" name="osNumeroModal" class="input-field w-full p-2 rounded-md" required> </div> <div> <label for="osClienteModal" class="block text-sm font-medium mb-1">Cliente <span class="text-red-500">*</span></label> <input type="text" id="osClienteModal" name="osClienteModal" class="input-field w-full p-2 rounded-md" required> </div> <div> <label for="osProdutoModal" class="block text-sm font-medium mb-1">Produto/Serviço <span class="text-red-500">*</span></label> <input type="text" id="osProdutoModal" name="osProdutoModal" list="productList" class="input-field w-full p-2 rounded-md" required> <datalist id="productList"></datalist> </div> <div> <label for="osSolicitanteModal" class="block text-sm font-medium mb-1">Solicitante</label> <input type="text" id="osSolicitanteModal" name="osSolicitanteModal" class="input-field w-full p-2 rounded-md"> </div> </div> <div class="mb-4"> <label for="osDescricaoModal" class="block text-sm font-medium mb-1">Descrição Detalhada <span class="text-red-500">*</span></label> <textarea id="osDescricaoModal" name="osDescricaoModal" rows="3" class="input-field w-full p-2 rounded-md" required></textarea> </div> <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-4"> <div> <label for="osDataAberturaModal" class="block text-sm font-medium mb-1">Data de Abertura <span class="text-red-500">*</span></label> <input type="date" id="osDataAberturaModal" name="osDataAberturaModal" class="input-field w-full p-2 rounded-md" required> </div> <div> <label for="osPrazoFinalModal" class="block text-sm font-medium mb-1">Prazo Final <span class="text-red-500">*</span></label> <input type="date" id="osPrazoFinalModal" name="osPrazoFinalModal" class="input-field w-full p-2 rounded-md" required> </div> <div> <label for="osResponsavelModal" class="block text-sm font-medium mb-1">Responsável (Colaborador) <span class="text-red-500">*</span></label> <input type="text" id="osResponsavelModal" name="osResponsavelModal" class="input-field w-full p-2 rounded-md" required> </div> <div> <label for="osStatusModal" class="block text-sm font-medium mb-1">Status <span class="text-red-500">*</span></label> <select id="osStatusModal" name="osStatusModal" class="select-field w-full p-2 rounded-md" required> <option value="Aberta">Aberta</option> <option value="Em Andamento">Em Andamento</option> <option value="Pendente Informação">Pendente Informação</option> <option value="Aguardando Aprovação">Aguardando Aprovação</option> <option value="Completa">Completa</option> <option value="Incompleta">Incompleta</option><option value="Provisória">Provisória</option> <option value="Cancelada">Cancelada</option></select> </div> </div> <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 mb-6 items-center"> <div> <label for="osPrioridadeModal" class="block text-sm font-medium mb-1">Prioridade <span class="text-red-500">*</span></label> <select id="osPrioridadeModal" name="osPrioridadeModal" class="select-field w-full p-2 rounded-md" required> <option value="Baixa">Baixa</option> <option value="Média" selected>Média</option> <option value="Alta">Alta</option> <option value="Urgente">Urgente</option> </select> </div> <div class="flex items-center pt-5"> <input type="checkbox" id="osMarcadorAtrasoModal" name="osMarcadorAtrasoModal" class="form-checkbox h-4 w-4 text-purple-600 border-slate-300 rounded focus:ring-purple-500 mr-2"> <label for="osMarcadorAtrasoModal" class="text-sm font-medium">Marcar "Não Realizada no Prazo"</label> </div> <div class="flex items-center pt-5"> <input type="checkbox" id="osLogisticaOkModal" name="osLogisticaOkModal" class="form-checkbox h-4 w-4 text-teal-600 border-slate-300 rounded focus:ring-teal-500 mr-2"> <label for="osLogisticaOkModal" class="text-sm font-medium">Logística Pronta/OK</label> </div></div> <div class="flex justify-end gap-3"> <button type="button" class="btn btn-secondary" onclick="closeOSModal()">Cancelar</button> <button type="submit" class="btn btn-primary">Salvar OS</button> </div> </form> </div> </div>
<script>
    // ==========================================================================
    // VARIÁVEIS GLOBAIS E CONFIGURAÇÕES INICIAIS
    // ==========================================================================
    const APP_VERSION = "1.9.1"; // Definindo a versão da aplicação
    const ITEMS_PER_PAGE_DEFAULT = 10;
    let ITEMS_PER_PAGE = ITEMS_PER_PAGE_DEFAULT;
    let currentPage = 1;
    let ordensServico = [];
    const defaultProducts = ["WORKNC", "EDGECAM", "ESPRIT", "ALPHACAM", "LANTEK", "SOLIDWORKS CAD", "SOLIDWORKS PDM", "SYNECO", "HEXAGON Scanner", "Impressora 3D Markforged", "Serviço de Consultoria", "Treinamento Software X", "Outro"];
    let googleUser = null;
    let savedFilters = {};

    let osStatusChartInstance = null;
    let reportChartByProductInstance = null;
    let reportChartByUsuarioInstance = null;
    let reportChartByStatusInstance = null;

    // Elementos DOM principais (alguns são definidos no DOMContentLoaded ou quando a view é mostrada)
    let osModal;
    let osForm;
    let modalTitle;
    let productDatalist;
    let filterProductSelect;
    let reportProductSelect;
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    const sidebarTitleDiv = document.getElementById('sidebar-title');
    let recentActivityList;
    let importStatusMessage;
    let importSummaryDiv;
    let importSummaryList;


    // ==========================================================================
    // FUNÇÕES AUXILIARES DE DATA E FORMATO
    // ==========================================================================
    function formatDateToBR(dateString) {
        if (!dateString) return 'N/A';
        if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        const d = new Date(dateString);
        if (isNaN(d.getTime())) return 'N/A';

        let day, month, year;
        // Check if it's already in YYYY-MM-DD from an input type="date"
        if (typeof dateString === 'string' && dateString.includes('-')) {
            const parts = dateString.split('-');
            year = parseInt(parts[0],10);
            month = parseInt(parts[1],10);
            day = parseInt(parts[2],10);
             // Ensure it's a valid date object before formatting to avoid issues with timezone and UTC conversion
             const validDate = new Date(year, month - 1, day);
             return `${String(validDate.getDate()).padStart(2, '0')}/${String(validDate.getMonth() + 1).padStart(2, '0')}/${validDate.getFullYear()}`;
        } else { // Original logic for Date objects
            day = String(d.getUTCDate()).padStart(2, '0');
            month = String(d.getUTCMonth() + 1).padStart(2, '0');
            year = d.getUTCFullYear();
            return `${day}/${month}/${year}`;
        }
    }

    function excelSerialDateToYYYYMMDD(serial) {
        if (serial === null || serial === undefined || serial === '' || isNaN(parseFloat(serial))) return null;
        const excelEpochDiff = 25569; 
        let date;
         if (serial >= 60) { 
            date = new Date(Math.round((serial - excelEpochDiff -1) * 86400 * 1000));
        } else {
             if (serial === 60) return null; 
            date = new Date(Math.round((serial - excelEpochDiff) * 86400 * 1000));
        }
        if (isNaN(date.getTime())) return null;

        const year = date.getUTCFullYear();
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const day = String(date.getUTCDate()).padStart(2, '0');

        if (year < 1890 || year > 2300) return null;
        return `${year}-${month}-${day}`;
    }

    function parseAndValidateDate(dateValue, fieldNameForLog = "Data") {
        if (dateValue === null || String(dateValue || '').trim() === '') {
            return { date: null, error: `${fieldNameForLog} ausente.` };
        }

        let parsedDateObj = null;

        if (dateValue instanceof Date) {
            if (!isNaN(dateValue.getTime())) {
                parsedDateObj = dateValue;
            }
        }
        else if (typeof dateValue === 'number' && dateValue > 0 && dateValue < 200000) { // Excel serial date
            const ymd = excelSerialDateToYYYYMMDD(dateValue);
            if (ymd) {
                const [year, month, day] = ymd.split('-').map(Number);
                parsedDateObj = new Date(Date.UTC(year, month - 1, day));
            }
        }
        else if (typeof dateValue === 'string') {
            let tempDateStr = String(dateValue).trim();
            let parts;

            // Try DD/MM/YYYY HH:MM:SS or DD-MM-YYYY HH:MM:SS or DD.MM.YYYY HH:MM:SS
            const dateTimeRegex = /^(\d{1,2})[\\/\.-](\d{1,2})[\\/\.-](\d{2}|\d{4})(?:[ T_](\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?$/;
            if ((parts = tempDateStr.match(dateTimeRegex))) {
                const day = parseInt(parts[1], 10);
                const month = parseInt(parts[2], 10) - 1; // Month is 0-indexed
                let year = parseInt(parts[3], 10);
                if (year < 100) year += 2000; // Handle YY format

                const hour = parts[4] ? parseInt(parts[4], 10) : 0;
                const minute = parts[5] ? parseInt(parts[5], 10) : 0;
                const second = parts[6] ? parseInt(parts[6], 10) : 0;

                if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                    parsedDateObj = new Date(Date.UTC(year, month, day, hour, minute, second));
                    // Validate if the created date matches the input parts (e.g., day 31 in a 30-day month)
                    if (parsedDateObj.getUTCFullYear() !== year ||
                        parsedDateObj.getUTCMonth() !== month ||
                        parsedDateObj.getUTCDate() !== day) {
                        parsedDateObj = null; // Invalid date components
                    }
                }
            } else {
                // Try YYYY-MM-DD HH:MM:SS (ISO-like, common from <input type="date"> or databases)
                const isoDateRegex = /^(\d{4})[\\/\.-](\d{1,2})[\\/\.-](\d{1,2})(?:[ T_](\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?$/;
                if ((parts = tempDateStr.match(isoDateRegex))) {
                    const year = parseInt(parts[1], 10);
                    const month = parseInt(parts[2], 10) - 1; // Month is 0-indexed
                    const day = parseInt(parts[3], 10);
                    const hour = parts[4] ? parseInt(parts[4], 10) : 0;
                    const minute = parts[5] ? parseInt(parts[5], 10) : 0;
                    const second = parts[6] ? parseInt(parts[6], 10) : 0;

                    if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                        parsedDateObj = new Date(Date.UTC(year, month, day, hour, minute, second));
                        if (parsedDateObj.getUTCFullYear() !== year ||
                            parsedDateObj.getUTCMonth() !== month ||
                            parsedDateObj.getUTCDate() !== day) {
                            parsedDateObj = null;
                        }
                    }
                }
            }
        }

        if (parsedDateObj && !isNaN(parsedDateObj.getTime())) {
            const year = parsedDateObj.getUTCFullYear();
            const monthStr = String(parsedDateObj.getUTCMonth() + 1).padStart(2, '0');
            const dayStr = String(parsedDateObj.getUTCDate()).padStart(2, '0');

            if (year < 1890 || year > 2300) { // Basic sanity check for year
                return { date: null, error: `${fieldNameForLog} ("${String(dateValue).substring(0,20)}") ano inválido (${year}).` };
            }
            return { date: `${year}-${monthStr}-${dayStr}`, error: null }; // Return in YYYY-MM-DD format
        }

        return { date: null, error: `${fieldNameForLog} ("${String(dateValue).substring(0,30)}") formato inválido/não reconhecido.` };
    }


    function getPriorityClass(priority) {
        switch (priority) {
            case 'Alta': return 'priority-Alta';
            case 'Urgente': return 'priority-Urgente';
            case 'Média': return 'priority-Média';
            case 'Baixa': return 'priority-Baixa';
            default: return 'bg-slate-700 text-slate-300';
        }
    }
    function generateId() { return 'OS' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5).toUpperCase(); }

    // ==========================================================================
    // LOCALSTORAGE, PRODUTOS, ATIVIDADE RECENTE
    // ==========================================================================
    function saveDataToLocalStorage() {
        try {
            const dataToSave = {
                version: APP_VERSION,
                ordensServico: ordensServico,
                googleUser: googleUser,
                savedFilters: savedFilters,
                itemsPerPage: ITEMS_PER_PAGE
            };
            localStorage.setItem('gestaoOsAppData', JSON.stringify(dataToSave));
        } catch (e) {
            console.error("Erro ao salvar dados no localStorage:", e);
            // alert("Ocorreu um problema ao tentar salvar os dados. Algumas informações podem não ser persistidas.");
        }
    }

    function loadDataFromLocalStorage() {
        const storedDataString = localStorage.getItem('gestaoOsAppData');
        if (storedDataString) {
            try {
                const storedData = JSON.parse(storedDataString);
                // Basic version check, can be expanded for more complex migration logic
                if (storedData.version === APP_VERSION || storedData.version === "1.9.0") { // Allow loading from 1.9.0
                    ordensServico = storedData.ordensServico || [];
                    googleUser = storedData.googleUser || null;
                    savedFilters = storedData.savedFilters || {};
                    ITEMS_PER_PAGE = parseInt(storedData.itemsPerPage, 10) || ITEMS_PER_PAGE_DEFAULT;

                    // Data migration/normalization if needed from older structures
                    ordensServico.forEach(os => {
                        if (os.marcadorAtrasoManual === undefined) os.marcadorAtrasoManual = false;
                        if (os.logisticaOk === undefined) os.logisticaOk = false;
                        if (os.produto === undefined) os.produto = '';
                        // Ensure dates are in YYYY-MM-DD format
                        if (os.dataAbertura) {
                            const parsedOpen = parseAndValidateDate(os.dataAbertura, "Data Abertura (load)");
                            os.dataAbertura = parsedOpen.date || new Date().toISOString().split('T')[0];
                        }
                        if (os.prazoFinal) {
                            const parsedDue = parseAndValidateDate(os.prazoFinal, "Prazo Final (load)");
                            os.prazoFinal = parsedDue.date || new Date().toISOString().split('T')[0];
                        }
                    });

                } else {
                    console.warn(`Versão dos dados armazenados (${storedData.version}) é diferente da versão da aplicação (${APP_VERSION}). Carregando dados padrão.`);
                    // Optionally, implement migration logic or clear old data
                    // For now, just falls back to defaults if version mismatch is critical
                    ordensServico = [];
                    googleUser = null;
                    savedFilters = {};
                    ITEMS_PER_PAGE = ITEMS_PER_PAGE_DEFAULT;
                }
            } catch (e) {
                console.error("Erro ao carregar dados do localStorage:", e);
                ordensServico = []; googleUser = null; savedFilters = {}; ITEMS_PER_PAGE = ITEMS_PER_PAGE_DEFAULT;
            }
        }
        // Update UI elements related to loaded data
        const itemsPerPageSettingElement = document.getElementById('itemsPerPageSetting');
        if (itemsPerPageSettingElement) itemsPerPageSettingElement.value = ITEMS_PER_PAGE;
    }


    function populateProductFilters() {
        if (!productDatalist || !filterProductSelect || !reportProductSelect) return;
        const products = [...new Set(ordensServico.map(os => os.produto).concat(defaultProducts).filter(pr => pr && pr.trim() !== ""))].sort((a, b) => a.localeCompare(b));
        productDatalist.innerHTML = '';
        filterProductSelect.innerHTML = '<option value="">Todos Produtos</option>';
        reportProductSelect.innerHTML = '<option value="">Todos Produtos</option>';
        products.forEach(product => {
            const option = document.createElement('option');
            option.value = product;
            option.textContent = product;
            productDatalist.appendChild(option.cloneNode(true));
            filterProductSelect.appendChild(option.cloneNode(true));
            reportProductSelect.appendChild(option.cloneNode(true));
        });
    }
    function addRecentActivity(action, userName = null) {
        if (!recentActivityList) return;
        const listItem = document.createElement('li');
        const now = new Date();
        let userDisplay = userName ? ` <span class="font-medium text-sky-400">(${userName})</span>` : (googleUser ? ` <span class="font-medium text-slate-400">(${googleUser.given_name || googleUser.name})</span>` : '');
        listItem.className = 'flex justify-between items-center text-sm pb-2 border-b border-slate-700';
        listItem.innerHTML = `<span>${action}${userDisplay}</span><span class="text-slate-500 text-xs">${now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</span>`;
        const placeholder = recentActivityList.querySelector('.text-placeholder');
        if (placeholder) recentActivityList.innerHTML = '';
        recentActivityList.insertBefore(listItem, recentActivityList.firstChild);
        if (recentActivityList.children.length > 7) recentActivityList.removeChild(recentActivityList.lastChild);
    }

    // ==========================================================================
    // GOOGLE SIGN-IN
    // ==========================================================================
    function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }
    function handleCredentialResponse(response) { const payload = parseJwt(response.credential); googleUser = { id: payload.sub, name: payload.name, given_name: payload.given_name, picture: payload.picture, email: payload.email }; saveDataToLocalStorage(); updateLoginUI(); addRecentActivity(`Usuário ${googleUser.name} logado.`); }
    function handleSignOut() { const userName = googleUser ? (googleUser.given_name || googleUser.name) : "Usuário"; googleUser = null; saveDataToLocalStorage(); updateLoginUI(); addRecentActivity(`${userName} deslogado.`); if (typeof google !== 'undefined' && google.accounts && google.accounts.id) google.accounts.id.disableAutoSelect(); }
    function updateLoginUI() {
        const userInfoDiv = document.getElementById('user-info');
        const gSignInDiv = document.querySelector('.g_id_signin');
        const userNameEl = document.getElementById('user-name');
        const userPicEl = document.getElementById('user-pic');
        if (!userInfoDiv || !gSignInDiv || !userNameEl || !userPicEl) return;
        if (googleUser) {
            userNameEl.textContent = googleUser.given_name || googleUser.name;
            userPicEl.src = googleUser.picture;
            userInfoDiv.classList.remove('hidden');
            gSignInDiv.classList.add('hidden');
        } else {
            userInfoDiv.classList.add('hidden');
            gSignInDiv.classList.remove('hidden');
            userNameEl.textContent = '';
            userPicEl.src = '';
        }
    }

    // ==========================================================================
    // FILTROS SALVOS
    // ==========================================================================
    function populateSavedFiltersSelect() { const select = document.getElementById('savedFilters'); if (!select) return; const currentValue = select.value; select.innerHTML = '<option value="">Carregar filtro...</option>'; for (const name in savedFilters) { const option = document.createElement('option'); option.value = name; option.textContent = name; select.appendChild(option); } if (currentValue && savedFilters[currentValue]) select.value = currentValue; }
    function saveCurrentFilters() {
        const nameInput = document.getElementById('newFilterName'); if (!nameInput) return; const name = nameInput.value.trim(); if (!name) { alert("Especifique um nome para o filtro salvo."); return; }
        if (savedFilters[name] && !confirm(`O filtro salvo "${name}" já existe. Deseja sobrescrevê-lo?`)) return;
        const descInput = document.getElementById('filterDescription');
        savedFilters[name] = {
            numero: document.getElementById('filterOsNumber').value, cliente: document.getElementById('filterClient').value,
            descricao: descInput ? descInput.value : "", produto: document.getElementById('filterProduct').value,
            status: document.getElementById('filterStatus').value, marcadorAtraso: document.getElementById('filterMarcadorAtraso').value,
            logisticaOk: document.getElementById('filterLogisticaOk').value
        };
        nameInput.value = ''; populateSavedFiltersSelect(); saveDataToLocalStorage(); addRecentActivity(`Filtro "${name}" salvo.`);
    }
    function loadSelectedFilter() {
        const select = document.getElementById('savedFilters'); if (!select) return; const name = select.value;
        if (name && savedFilters[name]) {
            document.getElementById('filterOsNumber').value = savedFilters[name].numero || "";
            document.getElementById('filterClient').value = savedFilters[name].cliente || "";
            const descInput = document.getElementById('filterDescription'); if (descInput) descInput.value = savedFilters[name].descricao || "";
            document.getElementById('filterProduct').value = savedFilters[name].produto || "";
            document.getElementById('filterStatus').value = savedFilters[name].status || "";
            document.getElementById('filterMarcadorAtraso').value = savedFilters[name].marcadorAtraso || "";
            document.getElementById('filterLogisticaOk').value = savedFilters[name].logisticaOk || "";
            applyFiltersAndRender(); addRecentActivity(`Filtro "${name}" carregado.`);
        } else if (name) alert("Filtro salvo não encontrado.");
    }
    function deleteSavedFilter() {
        const select = document.getElementById('savedFilters'); if (!select) return; const name = select.value;
        if (name && savedFilters[name]) { if (confirm(`Tem certeza que deseja excluir o filtro salvo "${name}"?`)) { delete savedFilters[name]; populateSavedFiltersSelect(); saveDataToLocalStorage(); addRecentActivity(`Filtro "${name}" excluído.`); } }
        else if (name) alert("O filtro salvo não existe."); else alert("Por favor, selecione um filtro salvo para excluir.");
    }

    // ==========================================================================
    // AÇÕES EM MASSA PARA ORDENS DE SERVIÇO
    // ==========================================================================
    function updateSelectedCount() { const countEl = document.getElementById('selectedOsCount'); const bulkActionsEl = document.getElementById('bulkActionsContainer'); const tableBody = document.getElementById('osTableBody'); const selectAllCheckbox = document.getElementById('selectAllOsCheckbox'); if (!countEl || !bulkActionsEl || !tableBody || !selectAllCheckbox) return; const selectedCheckboxes = Array.from(tableBody.querySelectorAll('input[type="checkbox"][data-id]:checked')); countEl.textContent = `${selectedCheckboxes.length} selecionadas`; if (selectedCheckboxes.length > 0) { bulkActionsEl.classList.remove('hidden'); } else { bulkActionsEl.classList.add('hidden'); selectAllCheckbox.checked = false; } }
    function toggleSelectAllOS(masterCheckbox) { const tableBody = document.getElementById('osTableBody'); if (!tableBody || !masterCheckbox) return; const checkboxes = tableBody.querySelectorAll('input[type="checkbox"][data-id]'); checkboxes.forEach(cb => cb.checked = masterCheckbox.checked); updateSelectedCount(); }
    function applyBulkAction() {
        const statusSelect = document.getElementById('bulkActionStatus'); const tableBody = document.getElementById('osTableBody'); const selectAllCheckbox = document.getElementById('selectAllOsCheckbox'); if (!statusSelect || !tableBody || !selectAllCheckbox) return; const newStatus = statusSelect.value; if (!newStatus) { alert("Por favor, selecione um status para aplicar."); return; }
        const selectedCheckboxes = Array.from(tableBody.querySelectorAll('input[type="checkbox"][data-id]:checked')); if (selectedCheckboxes.length === 0) { alert("Nenhuma OS selecionada para a ação em massa."); return; }
        selectedCheckboxes.forEach(cb => { const osId = cb.dataset.id; const osIndex = ordensServico.findIndex(os => os.id === osId); if (osIndex !== -1) ordensServico[osIndex].status = newStatus; });
        addRecentActivity(`${selectedCheckboxes.length} OS(s) tiveram o status alterado para ${newStatus}.`); saveDataToLocalStorage(); refreshAllViews(); selectAllCheckbox.checked = false; updateSelectedCount();
    }
    function bulkDeleteSelectedOS() {
        const tableBody = document.getElementById('osTableBody'); const selectAllCheckbox = document.getElementById('selectAllOsCheckbox'); if (!tableBody || !selectAllCheckbox) return; const selectedCheckboxes = Array.from(tableBody.querySelectorAll('input[type="checkbox"][data-id]:checked')); if (selectedCheckboxes.length === 0) { alert("Nenhuma OS selecionada para exclusão."); return; }
        if (confirm(`Tem certeza que deseja excluir ${selectedCheckboxes.length} OS(s) selecionada(s)? Esta ação é irreversível.`)) { const idsToDelete = selectedCheckboxes.map(cb => cb.dataset.id); ordensServico = ordensServico.filter(os => !idsToDelete.includes(os.id)); addRecentActivity(`${idsToDelete.length} OS(s) foram excluídas.`); saveDataToLocalStorage(); if (currentPage > 1 && paginateData(getFilteredOS(), currentPage, ITEMS_PER_PAGE).length === 0) currentPage--; refreshAllViews(); selectAllCheckbox.checked = false; updateSelectedCount(); }
    }

    // ==========================================================================
    // RENDERIZAÇÃO DA TABELA DE OS E PAGINAÇÃO
    // ==========================================================================
    function toggleMarcadorAtrasoManual(osId, event) {
        event.stopPropagation();
        const osIndex = ordensServico.findIndex(os => os.id === osId);
        if (osIndex !== -1) {
            ordensServico[osIndex].marcadorAtrasoManual = !ordensServico[osIndex].marcadorAtrasoManual;
            addRecentActivity(`Marcador "Não Realizada no Prazo" ${ordensServico[osIndex].marcadorAtrasoManual ? 'aplicado' : 'removido'} para OS ${ordensServico[osIndex].numero}.`);
            saveDataToLocalStorage();
            applyFiltersAndRender(); // Refresh only the OS list view
        }
    }

    function toggleLogisticaOkManual(osId, event) {
        event.stopPropagation();
        const osIndex = ordensServico.findIndex(os => os.id === osId);
        if (osIndex !== -1) {
            ordensServico[osIndex].logisticaOk = !ordensServico[osIndex].logisticaOk;
            addRecentActivity(`Marcador "Logística Pronta" ${ordensServico[osIndex].logisticaOk ? 'aplicado' : 'removido'} para OS ${ordensServico[osIndex].numero}.`);
            saveDataToLocalStorage();
            applyFiltersAndRender(); // Refresh only the OS list view
        }
    }

    function renderOSTable(filteredData = getFilteredOS()) {
        const tableBody = document.getElementById('osTableBody');
        const selectAllCheckbox = document.getElementById('selectAllOsCheckbox');
        if (!tableBody || !selectAllCheckbox) { console.error("Elemento osTableBody ou selectAllOsCheckbox não encontrado no DOM!"); return; }
        tableBody.innerHTML = '';
        selectAllCheckbox.checked = false;
        updateSelectedCount();

        if (!filteredData || filteredData.length === 0) { tableBody.innerHTML = `<tr><td colspan="13" class="text-center py-10 text-slate-400">Nenhuma Ordem de Serviço encontrada com os filtros atuais.</td></tr>`; renderPagination(0, 0); return; }

        const paginatedData = paginateData(filteredData, currentPage, ITEMS_PER_PAGE);
        paginatedData.forEach(os => {
            const row = tableBody.insertRow();
            row.className = 'table-row hover:bg-slate-700';

            const markerAtrasoIconHTML = `
                <span class="manual-flag-toggle" onclick="toggleMarcadorAtrasoManual('${os.id}', event)" title="${os.marcadorAtrasoManual ? 'Desmarcar OS como Não Realizada no Prazo' : 'Marcar OS como Não Realizada no Prazo'}">
                    ${os.marcadorAtrasoManual ? '<i class="fas fa-flag text-purple-500"></i>' : '<i class="far fa-flag text-gray-400 hover:text-purple-500"></i>'}
                </span>`;

            const logisticaIconHTML = `
                <span class="logistica-toggle" onclick="toggleLogisticaOkManual('${os.id}', event)" title="${os.logisticaOk ? 'Marcar Logística como Não Pronta' : 'Marcar Logística como Pronta/OK'}">
                    ${os.logisticaOk ? '<i class="fas fa-truck text-teal-500"></i>' : '<i class="fas fa-truck text-gray-400 hover:text-teal-500"></i>'}
                </span>`;

            row.innerHTML = `<td class="py-3 px-2 text-center checkbox-cell"><input type="checkbox" data-id="${os.id}" onchange="updateSelectedCount()" class="form-checkbox h-4 w-4"></td>
                        <td class="py-3 px-4 text-sm font-medium">${markerAtrasoIconHTML} ${os.numero}</td>
                        <td class="py-3 px-4 text-sm">${os.cliente}</td>
                        <td class="py-3 px-4 text-sm">${os.produto || 'N/A'}</td>
                        <td class="py-3 px-4 text-sm truncate max-w-xs" title="${os.descricao}">${os.descricao}</td>
                        <td class="py-3 px-4 text-sm">${formatDateToBR(os.dataAbertura)}</td>
                        <td class="py-3 px-4 text-sm">${formatDateToBR(os.prazoFinal)}</td>
                        <td class="py-3 px-4 text-sm">${os.responsavel}</td>
                        <td class="py-3 px-4 text-sm">${os.solicitante || 'N/A'}</td>
                        <td class="py-3 px-4 text-sm"><select class="select-field status-select p-1 text-xs" data-id="${os.id}" onchange="updateStatus(this)">
                            <option value="Aberta" ${os.status === 'Aberta' ? 'selected' : ''}>Aberta</option>
                            <option value="Em Andamento" ${os.status === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option>
                            <option value="Pendente Informação" ${os.status === 'Pendente Informação' ? 'selected' : ''}>Pendente Info</option>
                            <option value="Aguardando Aprovação" ${os.status === 'Aguardando Aprovação' ? 'selected' : ''}>Aguard. Aprov.</option>
                            <option value="Completa" ${os.status === 'Completa' ? 'selected' : ''}>Completa</option>
                            <option value="Incompleta" ${os.status === 'Incompleta' ? 'selected' : ''}>Incompleta</option>
                            <option value="Provisória" ${os.status === 'Provisória' ? 'selected' : ''}>Provisória</option>
                            <option value="Cancelada" ${os.status === 'Cancelada' ? 'selected' : ''}>Cancelada</option>
                        </select></td>
                        <td class="py-3 px-4 text-sm text-center">${logisticaIconHTML}</td>
                        <td class="py-3 px-4 text-sm"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getPriorityClass(os.prioridade)}">${os.prioridade}</span></td>
                        <td class="py-3 px-4 text-sm"><button class="text-sky-500 hover:text-sky-400 p-1 mr-2" title="Editar" onclick="editOS('${os.id}')"><i class="fas fa-edit"></i></button><button class="text-red-500 hover:text-red-400 p-1 mr-2" title="Excluir" onclick="deleteOS('${os.id}')"><i class="fas fa-trash"></i></button><button class="text-green-500 hover:text-green-400 p-1" title="Baixar .ics" onclick="downloadICS('${os.id}')"><i class="fas fa-calendar-plus"></i></button></td>`
        });
        renderPagination(filteredData.length, currentPage);
    }
    function paginateData(data, page, itemsPerPage) { const start = (page - 1) * itemsPerPage; const end = start + itemsPerPage; return data.slice(start, end); }
    function renderPagination(totalItems, page) {
        const paginationControls = document.getElementById('paginationControls'); if (!paginationControls) return; paginationControls.innerHTML = ''; const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE); if (totalPages <= 1) return;
        const prevButton = document.createElement('button'); prevButton.innerHTML = '<i class="fas fa-chevron-left"></i> Anterior'; prevButton.className = 'btn btn-sm btn-secondary disabled:opacity-50'; prevButton.disabled = page === 1; prevButton.onclick = () => { if (page > 1) changePage(page - 1); }; paginationControls.appendChild(prevButton);
        const pageInfo = document.createElement('span'); pageInfo.className = 'text-sm px-3'; pageInfo.textContent = `Página ${page} de ${totalPages}`; paginationControls.appendChild(pageInfo);
        const nextButton = document.createElement('button'); nextButton.innerHTML = 'Próximo <i class="fas fa-chevron-right"></i>'; nextButton.className = 'btn btn-sm btn-secondary disabled:opacity-50'; nextButton.disabled = page === totalPages; nextButton.onclick = () => { if (page < totalPages) changePage(page + 1); }; paginationControls.appendChild(nextButton);
    }
    function changePage(newPage) { currentPage = newPage; renderOSTable(); }

    // ==========================================================================
    // CRUD DE OS E MODAL (CRIAÇÃO, EDIÇÃO, EXCLUSÃO)
    // ==========================================================================
    function updateStatus(selectElement) { const osId = selectElement.dataset.id; const newStatus = selectElement.value; const osIndex = ordensServico.findIndex(os => os.id === osId); if (osIndex !== -1) { ordensServico[osIndex].status = newStatus; addRecentActivity(`Status da OS ${ordensServico[osIndex].numero} alterado para ${newStatus}.`); saveDataToLocalStorage(); refreshAllViews(); } }
    function openAddOSModal() {
        const currentOsForm = document.getElementById('osForm');
        const currentModalTitle = document.getElementById('modalTitle');
        const currentOsModal = document.getElementById('osModal');
        if (!currentOsForm || !currentModalTitle || !currentOsModal) return;
        currentOsForm.reset();
        document.getElementById('osId').value = '';
        currentModalTitle.textContent = 'Adicionar Nova Ordem de Serviço';
        const dataAberturaEl = document.getElementById('osDataAberturaModal');
        if (dataAberturaEl) dataAberturaEl.value = new Date().toISOString().split('T')[0]; // Default to today
        document.getElementById('osMarcadorAtrasoModal').checked = false;
        document.getElementById('osLogisticaOkModal').checked = false;
        currentOsModal.classList.remove('hidden');
    }
    function closeOSModal() { const currentOsModal = document.getElementById('osModal'); if (!currentOsModal) return; currentOsModal.classList.add('hidden'); }
    function editOS(id) {
        const currentOsModal = document.getElementById('osModal');
        const currentModalTitle = document.getElementById('modalTitle');
        if (!currentOsModal || !currentModalTitle) return;
        const os = ordensServico.find(o => o.id === id);
        if (os) {
            currentModalTitle.textContent = `Editar OS - ${os.numero}`;
            document.getElementById('osId').value = os.id;
            document.getElementById('osNumeroModal').value = os.numero;
            document.getElementById('osClienteModal').value = os.cliente;
            document.getElementById('osProdutoModal').value = os.produto || '';
            document.getElementById('osSolicitanteModal').value = os.solicitante || '';
            document.getElementById('osDescricaoModal').value = os.descricao;
            document.getElementById('osDataAberturaModal').value = os.dataAbertura; // Already YYYY-MM-DD
            document.getElementById('osPrazoFinalModal').value = os.prazoFinal;   // Already YYYY-MM-DD
            document.getElementById('osResponsavelModal').value = os.responsavel;
            document.getElementById('osStatusModal').value = os.status;
            document.getElementById('osPrioridadeModal').value = os.prioridade;
            document.getElementById('osMarcadorAtrasoModal').checked = os.marcadorAtrasoManual || false;
            document.getElementById('osLogisticaOkModal').checked = os.logisticaOk || false;
            currentOsModal.classList.remove('hidden');
        } else alert("OS não encontrada para edição.");
    }
    function deleteOS(id) { const osToDelete = ordensServico.find(os => os.id === id); if (confirm(`Tem certeza que deseja excluir a OS ${osToDelete?.numero || id}? Esta ação é irreversível.`)) { ordensServico = ordensServico.filter(os => os.id !== id); addRecentActivity(`OS ${osToDelete?.numero || 'ID ' + id} foi excluída.`); saveDataToLocalStorage(); if (currentPage > 1 && paginateData(getFilteredOS(), currentPage, ITEMS_PER_PAGE).length === 0) currentPage--; refreshAllViews(); } }

    // ==========================================================================
    // LÓGICA DE IMPORTAÇÃO DE EXCEL/CSV (Função de processamento de dados)
    // ==========================================================================
    function processAndValidateOSData(jsonData) {
        const headersFromFile = jsonData[0].map(header => String(header || '').trim().toLowerCase());
        const dataRows = jsonData.slice(1);
        const validOSs = [];
        const importLog = [];

        const expectedHeaderMapping = {
            codigo: 'código', status: 'status', cliente: 'cliente', inicio: 'início', termino: 'término',
            tecnico: 'técnico', solicitante: 'solicitante', cidade: 'cidade', duracao_h: 'duração (h)',
            produto_import: 'produto' // Renamed to avoid conflict with os.produto
        };
        const colIndices = {};
        for (const internalKey in expectedHeaderMapping) {
            colIndices[internalKey] = headersFromFile.indexOf(expectedHeaderMapping[internalKey]);
        }

        // Colunas essenciais para validação de uma OS
        const essentialCols = ['codigo', 'cliente', 'inicio', 'termino', 'tecnico']; // Solicitante não é mais obrigatório aqui, mas pode ser em 'addOS'
        let missingEssentialHeader = false;
        for (const colKey of essentialCols) {
            if (colIndices[colKey] === -1) {
                importLog.push({ success: false, message: `Erro Crítico: A coluna essencial "${expectedHeaderMapping[colKey]}" não foi encontrada no arquivo. Verifique o cabeçalho da planilha.` });
                missingEssentialHeader = true;
            }
        }
        if (missingEssentialHeader) {
             return { validOSs, importLog }; // Interrompe se faltar cabeçalho essencial
        }


        dataRows.forEach((row, rowIndex) => {
            if (row.every(cell => cell === null || String(cell || '').trim() === '')) return; // Skip empty rows

            const newOS = {
                id: generateId(),
                produto: colIndices.produto_import !== -1 && String(row[colIndices.produto_import] || '').trim() !== '' ? String(row[colIndices.produto_import]).trim() : "N/A (Importado)",
                prioridade: "Média", // Default
                marcadorAtrasoManual: false,
                logisticaOk: false
            };
            let rowIsValid = true;
            let currentLogMessages = [];

            newOS.numero = colIndices.codigo !== -1 ? String(row[colIndices.codigo] || '').trim() : '';
            if (!newOS.numero) { currentLogMessages.push("Nº OS (Coluna 'Código') ausente ou vazia."); rowIsValid = false; }

            newOS.cliente = colIndices.cliente !== -1 ? String(row[colIndices.cliente] || '').trim() : '';
            if (!newOS.cliente) { currentLogMessages.push("Cliente (Coluna 'Cliente') ausente ou vazio."); rowIsValid = false; }

            newOS.status = colIndices.status !== -1 && String(row[colIndices.status] || '').trim() !== '' ? String(row[colIndices.status]).trim() : 'Aberta';
            const validStatuses = ["Aberta", "Em Andamento", "Pendente Informação", "Aguardando Aprovação", "Completa", "Incompleta", "Provisória", "Cancelada"];
            if (!validStatuses.includes(newOS.status)) {
                currentLogMessages.push(`Status "${newOS.status}" inválido. Será usado "Aberta".`); newOS.status = 'Aberta';
            }

            const inicioVal = colIndices.inicio !== -1 ? row[colIndices.inicio] : null;
            const terminoVal = colIndices.termino !== -1 ? row[colIndices.termino] : null;

            const dataAberturaResult = parseAndValidateDate(inicioVal, `Data Início (Linha ${rowIndex + 2}, Coluna 'Início')`);
            if (dataAberturaResult.error) { currentLogMessages.push(dataAberturaResult.error); rowIsValid = false; }
            newOS.dataAbertura = dataAberturaResult.date;

            const prazoFinalResult = parseAndValidateDate(terminoVal, `Data Término (Linha ${rowIndex + 2}, Coluna 'Término')`);
            if (prazoFinalResult.error) { currentLogMessages.push(prazoFinalResult.error); rowIsValid = false; }
            newOS.prazoFinal = prazoFinalResult.date;

            if (newOS.dataAbertura && newOS.prazoFinal && new Date(newOS.prazoFinal) < new Date(newOS.dataAbertura)) {
                currentLogMessages.push(`Data de Prazo Final (${formatDateToBR(newOS.prazoFinal)}) não pode ser anterior à Data de Início (${formatDateToBR(newOS.dataAbertura)}).`); rowIsValid = false;
            }

            newOS.responsavel = colIndices.tecnico !== -1 ? String(row[colIndices.tecnico] || '').trim() : '';
            if (!newOS.responsavel) { currentLogMessages.push("Responsável (Coluna 'Técnico') ausente ou vazio."); rowIsValid = false; }

            // Solicitante é opcional na importação, mas se presente, é usado.
            newOS.solicitante = colIndices.solicitante !== -1 ? String(row[colIndices.solicitante] || '').trim() : 'N/A (Importado)';


            let descParts = [];
            const cidadeVal = colIndices.cidade !== -1 && row[colIndices.cidade] ? String(row[colIndices.cidade]).trim() : '';
            if (cidadeVal) descParts.push(`Cidade: ${cidadeVal}`);

            const duracaoVal = colIndices.duracao_h !== -1 && row[colIndices.duracao_h] ? String(row[colIndices.duracao_h]).trim() : '';
            if (duracaoVal) descParts.push(`Duração: ${duracaoVal}h`);
            
            newOS.descricao = descParts.length > 0 ? descParts.join(', ') + ". (OS Importada)" : "(OS Importada)";


            if (rowIsValid) {
                validOSs.push(newOS);
            } else {
                importLog.push({ success: false, message: `Linha ${rowIndex + 2} da planilha (OS: ${newOS.numero || 'Sem Número'}) ignorada: ${currentLogMessages.join('; ')}` });
            }
        });
        return { validOSs, importLog };
    }


    // ==========================================================================
    // FUNÇÃO PRINCIPAL PARA LIDAR COM A IMPORTAÇÃO DE ARQUIVO EXCEL/CSV
    // ==========================================================================
    function handleExcelImport() {
        const fileInput = document.getElementById('excelFileInput');
        const currentImportStatusMessage = document.getElementById('importStatusMessage');
        const currentImportSummaryDiv = document.getElementById('importSummary');
        const currentImportSummaryList = document.getElementById('importSummaryList');

        if (!fileInput || !currentImportStatusMessage || !currentImportSummaryDiv || !currentImportSummaryList) {
            console.error("Elementos da interface de importação não encontrados no DOM.");
            alert("Erro interno na interface de importação. Verifique o console para mais detalhes.");
            return;
        }

        currentImportStatusMessage.textContent = ''; 
        currentImportSummaryList.innerHTML = '';
        currentImportSummaryDiv.classList.add('hidden');

        if (!fileInput.files || fileInput.files.length === 0) {
            currentImportStatusMessage.textContent = 'Por favor, selecione um arquivo Excel ou CSV para importar.';
            currentImportStatusMessage.className = 'mt-4 text-sm text-red-400';
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        currentImportStatusMessage.textContent = `Iniciando processamento do arquivo: ${file.name}...`;
        currentImportStatusMessage.className = 'mt-4 text-sm text-sky-400';

        reader.onload = function(event) {
            try {
                const data = event.target.result;
                if (typeof XLSX === 'undefined') {
                    throw new Error("A biblioteca SheetJS (XLSX) não está carregada. Verifique o link CDN no HTML.");
                }
                // Adicionado {cellDates: true} para tentar preservar datas, mas a validação manual ainda é crucial
                const workbook = XLSX.read(data, { type: 'array', cellDates: true }); 
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                // Usar raw: false pode ajudar com datas se cellDates funcionar bem, mas raw: true é mais seguro para outros tipos
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 , raw: true, defval: null});


                while (jsonData.length > 0 && jsonData[jsonData.length - 1].every(cell => cell === null || String(cell || '').trim() === '')) {
                    jsonData.pop(); // Remove trailing empty rows
                }

                if (jsonData.length < 2) { // Must have header + at least one data row
                    throw new Error("O arquivo parece estar vazio ou contém apenas o cabeçalho. Nenhuma linha de dados para importar.");
                }

                const { validOSs, importLog } = processAndValidateOSData(jsonData);

                if (validOSs.length > 0) {
                    ordensServico.unshift(...validOSs); // Add new OSs to the beginning
                    saveDataToLocalStorage();
                    populateProductFilters(); // Repopulate product filters if new products were imported
                    refreshAllViews(); // This will re-render the table and update counts
                    addRecentActivity(`${validOSs.length} OS(s) foram importada(s) com sucesso do arquivo: ${file.name}.`);
                }

                let finalMessage = validOSs.length > 0 ? `${validOSs.length} OS(s) importada(s) com sucesso! ` : "Nenhuma OS foi importada com sucesso. ";
                currentImportStatusMessage.className = `mt-4 text-sm ${validOSs.length > 0 ? 'text-green-400' : 'text-amber-400'}`;

                const errorsCount = importLog.filter(log => !log.success).length;
                if (errorsCount > 0) {
                    finalMessage += `${errorsCount} linha(s) da planilha continham erros e foram ignoradas. Veja o resumo abaixo para detalhes.`;
                    currentImportStatusMessage.className = `mt-4 text-sm ${validOSs.length > 0 ? 'text-amber-400' : 'text-red-400'}`;
                }
                 if (validOSs.length === 0 && errorsCount === 0 && jsonData.slice(1).filter(r => !r.every(c => c === null || String(c || '').trim() === '')).length > 0) {
                    finalMessage = `Arquivo lido, mas nenhuma OS válida foi processada. Verifique o formato dos dados e se as colunas essenciais (Código, Cliente, Início, Término, Técnico) estão corretas e presentes na primeira linha da planilha.`;
                    currentImportStatusMessage.className = 'mt-4 text-sm text-amber-400';
                }


                currentImportStatusMessage.textContent = finalMessage.trim();

                if (importLog.length > 0) {
                    currentImportSummaryDiv.classList.remove('hidden');
                    importLog.forEach(log => {
                        const listItem = document.createElement('li');
                        listItem.textContent = log.message;
                        listItem.className = log.success ? 'text-green-300' : 'text-red-300';
                        currentImportSummaryList.appendChild(listItem);
                    });
                }

            } catch (error) {
                console.error("Erro detalhado ao processar o arquivo Excel/CSV:", error);
                currentImportStatusMessage.textContent = `Erro crítico durante o processamento: ${error.message}. Verifique o console para mais informações.`;
                currentImportStatusMessage.className = 'mt-4 text-sm text-red-400';
                currentImportSummaryDiv.classList.add('hidden'); // Hide summary on critical error
            } finally {
                fileInput.value = ''; // Clear the file input
            }
        };
        reader.onerror = function(error) { 
            console.error("Erro ao ler o arquivo:", error);
            currentImportStatusMessage.textContent = 'Ocorreu um erro ao tentar ler o arquivo. Verifique se é um arquivo Excel/CSV válido e tente novamente.';
            currentImportStatusMessage.className = 'mt-4 text-sm text-red-400';
            fileInput.value = ''; 
        };
        reader.readAsArrayBuffer(file); // Use readAsArrayBuffer for XLSX library
    }

    function toggleImportSection() {
        const importSection = document.getElementById('importOsLoteContainer');
        if (importSection) {
            importSection.classList.toggle('hidden');
            if (!importSection.classList.contains('hidden')) {
                addRecentActivity("Interface de importação em lote aberta.");
            } else {
                addRecentActivity("Interface de importação em lote fechada.");
                // Limpar mensagens ao fechar
                const currentImportStatusMessage = document.getElementById('importStatusMessage');
                const currentImportSummaryDiv = document.getElementById('importSummary');
                const currentImportSummaryList = document.getElementById('importSummaryList');
                if(currentImportStatusMessage) currentImportStatusMessage.textContent = '';
                if(currentImportSummaryList) currentImportSummaryList.innerHTML = '';
                if(currentImportSummaryDiv) currentImportSummaryDiv.classList.add('hidden');
            }
        }
    }


    // ==========================================================================
    // FUNÇÕES DE EXPORTAÇÃO (CSV, PDF Melhorado, Imagem da Lista)
    // ==========================================================================
    function exportTableToCSV(tableId, fileName) {
        let csv = [];
        const table = document.getElementById(tableId);
        if (!table) { console.error(`Tabela com ID '${tableId}' não encontrada para exportação CSV.`); return; }
        const rows = table.querySelectorAll("tr");
        for (const row of rows) {
            const cols = row.querySelectorAll("td,th");
            const rowData = [];
            for (const col of cols) {
                let cellText = col.innerText;
                if (col.querySelector('select')) cellText = col.querySelector('select').value;
                else if (col.querySelector('span[class*="priority-"]')) cellText = col.querySelector('span').innerText;
                
                // Handling manual flags for CSV
                if (tableId === 'osTable' || tableId === 'reportsTable') { // Specific to tables with these flags
                    const isCheckboxColumn = col.querySelector('input[type="checkbox"]');
                    const isActionsColumn = col.innerText.toLowerCase() === 'ações' || (col.children.length > 0 && col.children[0].tagName === 'BUTTON');

                    if (isCheckboxColumn || isActionsColumn) continue; // Skip checkbox and actions columns for osTable in CSV

                    if (col.querySelector('.fa-flag.text-purple-500')) cellText = "Atraso: Sim";
                    else if (col.querySelector('.far.fa-flag')) cellText = "Atraso: Não";

                    if (col.querySelector('.fa-truck.text-teal-500')) cellText = cellText.includes("Atraso:") ? cellText + " | Logística: Sim" : "Logística: Sim";
                    else if (col.querySelector('.fa-truck.text-gray-400')) cellText = cellText.includes("Atraso:") ? cellText + " | Logística: Não" : "Logística: Não";

                    // If only Nº OS and no flags, keep just the number
                    if (col.cellIndex === 1 && tableId === 'osTable' && !cellText.includes("Atraso:") && !cellText.includes("Logística:")) {
                         // For osTable's "Nº OS" column, extract only the number if no flags are set on it.
                        const osNumeroMatch = col.innerText.match(/(\S+)$/); // Get text after flag icons
                        if (osNumeroMatch) cellText = osNumeroMatch[0];
                    }
                }
                rowData.push('"' + cellText.replace(/\s+/g, ' ').trim().replace(/"/g, '""') + '"');
            }
            if(rowData.length > 0) csv.push(rowData.join(","));
        }
        const csvFile = new Blob(["\uFEFF" + csv.join("\n")], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(csvFile);
        link.download = fileName;
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        addRecentActivity(`Arquivo CSV "${fileName}" exportado com sucesso.`);
    }
    
    // Função de exportar PDF geral (para lista de OS)
    function exportTableToPDF(tableId, title, tableBodyId) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
        const textColor = '#cbd5e1'; // Light text for dark background
        const headerColor = '#334155'; // Darker header
        const headerTextColor = '#f8fafc'; // White text for header
        const rowColor = '#1e293b'; // Base row color
        const alternateRowColor = '#283447'; // Slightly lighter for alternate rows

        let currentY = 40;
        doc.setFontSize(18);
        doc.setTextColor(textColor);
        doc.text(title, doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });
        currentY += 30;

        const tableElement = document.getElementById(tableId);
        if (tableElement) {
            const head = [];
            const headersToExclude = ['ações']; // Always exclude actions from PDF
            const checkboxHeaderPresent = tableElement.querySelector('thead th input[type=checkbox]');

            tableElement.querySelectorAll('thead th').forEach((th, index) => {
                if (checkboxHeaderPresent && index === 0) return; // Skip checkbox header
                if (!headersToExclude.includes(th.innerText.toLowerCase().trim())) {
                    head.push(th.innerText.trim());
                }
            });

            const body = [];
            const tableBodyElement = document.getElementById(tableBodyId);
            if (tableBodyElement) {
                tableBodyElement.querySelectorAll('tr').forEach(tr => {
                    const rowData = [];
                    tr.querySelectorAll('td').forEach((td, index) => {
                        if (checkboxHeaderPresent && index === 0) return; // Skip checkbox data cell

                        // Align td with its actual header, accounting for skipped checkbox
                        let headerIndex = checkboxHeaderPresent ? index + 1 : index;
                        let thElements = Array.from(tableElement.querySelectorAll('thead th'));
                        if(thElements[headerIndex] && headersToExclude.includes(thElements[headerIndex].innerText.toLowerCase().trim())) return;

                        let cellText = td.innerText.trim();
                        if (td.querySelector('select')) {
                            cellText = td.querySelector('select').value;
                        } else if (td.querySelector('span[class*="priority-"]')) {
                            cellText = td.querySelector('span').innerText.trim();
                        } else if (thElements[headerIndex] && thElements[headerIndex].innerText.trim().toLowerCase() === 'nº os') {
                            // For "Nº OS" column, extract only the number part, removing flags
                            const osNumeroMatch = cellText.match(/(\S+)$/); // Get text after flag icons
                            cellText = osNumeroMatch ? osNumeroMatch[0] : cellText;
                        } else if (thElements[headerIndex] && thElements[headerIndex].innerText.trim().toLowerCase() === 'logística') {
                             cellText = td.querySelector('.fa-truck.text-teal-500') ? "Sim" : "Não";
                        }
                        rowData.push(cellText);
                    });
                    if (rowData.length > 0) body.push(rowData);
                });
            }

            if (body.length > 0 && !(body[0].length === 1 && body[0][0].includes("Nenhuma Ordem de Serviço encontrada"))) {
                doc.autoTable({
                    startY: currentY,
                    head: [head],
                    body: body,
                    theme: 'grid', // or 'striped' or 'plain'
                    headStyles: { fillColor: headerColor, textColor: headerTextColor, fontStyle: 'bold', fontSize: 8 },
                    styles: { textColor: textColor, cellPadding: 4, fontSize: 7, overflow: 'linebreak' },
                    alternateRowStyles: { fillColor: alternateRowColor },
                    didParseCell: function (data) { // Apply dark theme colors directly
                        data.cell.styles.fillColor = data.row.index % 2 === 0 ? rowColor : alternateRowColor;
                        data.cell.styles.textColor = textColor;
                        if (data.section === 'head') {
                            data.cell.styles.fillColor = headerColor;
                            data.cell.styles.textColor = headerTextColor;
                        }
                    }
                });
            } else {
                doc.setFontSize(12).text("Nenhum dado na tabela para exportar.", 40, currentY);
            }
        } else {
            doc.setFontSize(12).text("Tabela não encontrada para exportação.", 40, currentY);
        }

        const generatedDate = `Gerado em: ${new Date().toLocaleString('pt-BR')}`;
        doc.setFontSize(8).text(generatedDate, doc.internal.pageSize.getWidth() - 40, doc.internal.pageSize.getHeight() - 20, { align: 'right' });
        doc.save(title.replace(/[^a-z0-9_]+/gi, '_').toLowerCase() + '.pdf');
        addRecentActivity(`Arquivo PDF "${title}" exportado com sucesso.`);
    }


    // PDF Detalhado para Relatórios - Aprimorado
    async function exportReportToPDFWithCharts(tableId, title, tableBodyId, chartCanvasIds = []) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

        const primaryTextColor = '#e2e8f0'; // Light grey for text on dark background
        const secondaryTextColor = '#94a3b8'; // Softer grey for less important text
        const headerBackgroundColor = '#334155'; // Dark slate for table headers
        const headerTextColor = '#f8fafc'; // White for table header text
        const rowBackgroundColor = '#1e293b'; // Dark blue-grey for row backgrounds
        const altRowBackgroundColor = '#283447'; // Slightly lighter dark blue-grey for alternate rows
        const borderColor = '#475569'; // Border color for table

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 30;
        let currentY = margin;

        // Título Principal do Documento
        doc.setFontSize(20);
        doc.setTextColor(primaryTextColor);
        doc.text(title, pageWidth / 2, currentY, { align: 'center' });
        currentY += 25;

        // Subtítulo com Data de Geração
        const generationDate = `Relatório gerado em: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}`;
        doc.setFontSize(9);
        doc.setTextColor(secondaryTextColor);
        doc.text(generationDate, pageWidth / 2, currentY, { align: 'center' });
        currentY += 20;

        // Filtros Aplicados
        const reportDateStartVal = document.getElementById('reportDateStartFilter')?.value;
        const reportDateEndVal = document.getElementById('reportDateEndFilter')?.value;
        const reportStatusVal = document.getElementById('reportStatusFilter')?.value;
        const reportProductVal = document.getElementById('reportProductFilter')?.value;
        const reportMarkerAtrasoVal = document.getElementById('reportFilterMarcadorAtraso')?.value;
        const reportLogisticaVal = document.getElementById('reportFilterLogisticaOk')?.value;

        let filtersText = "Filtros Aplicados: ";
        let hasFilters = false;
        if (reportDateStartVal || reportDateEndVal) { filtersText += `Período: ${reportDateStartVal ? formatDateToBR(reportDateStartVal) : '*'} a ${reportDateEndVal ? formatDateToBR(reportDateEndVal) : '*'}. `; hasFilters = true; }
        if (reportStatusVal) { filtersText += `Status: ${reportStatusVal}. `; hasFilters = true; }
        if (reportProductVal) { filtersText += `Produto: ${reportProductVal}. `; hasFilters = true; }
        if (reportMarkerAtrasoVal) { filtersText += `Atraso Manual: ${reportMarkerAtrasoVal === "marcada" ? "Marcadas" : (reportMarkerAtrasoVal === "nao_marcada" ? "Não Marcadas" : "Todos")}. `; hasFilters = true;}
        if (reportLogisticaVal) { filtersText += `Logística Pronta: ${reportLogisticaVal === "sim" ? "Sim" : (reportLogisticaVal === "nao" ? "Não" : "Todas")}. `; hasFilters = true;}
        if (!hasFilters) filtersText = "Filtros: Nenhum filtro específico aplicado ao relatório tabular.";
        
        doc.setFontSize(8);
        doc.setTextColor(secondaryTextColor);
        let splitFilters = doc.splitTextToSize(filtersText, pageWidth - (2 * margin));
        doc.text(splitFilters, margin, currentY);
        currentY += (splitFilters.length * 10) + 15; // Espaçamento maior após filtros

        // Tabela de Dados
        const tableElement = document.getElementById(tableId);
        if (tableElement) {
            const head = [['Cód. OS', 'Solicitante', 'Cliente', 'Início', 'Término', 'Resp./Equipe', 'Logística', 'Produto']]; // Ajuste no header para "Resp./Equipe"
            const body = [];
            const tableBodyElement = document.getElementById(tableBodyId);
            if (tableBodyElement) {
                tableBodyElement.querySelectorAll('tr').forEach(tr => {
                    if (tr.querySelector('td[colspan="8"]')) return; 
                    const rowData = [];
                    rowData.push(tr.cells[0]?.innerText || ''); 
                    rowData.push(tr.cells[1]?.innerText || ''); 
                    rowData.push(tr.cells[2]?.innerText || ''); 
                    rowData.push(tr.cells[3]?.innerText || ''); 
                    rowData.push(tr.cells[4]?.innerText || ''); 
                    rowData.push(tr.cells[5]?.innerText || ''); // Anteriormente Solicitante, agora interpretado como Responsável/Equipe
                    rowData.push(tr.cells[6]?.innerText || ''); 
                    rowData.push(tr.cells[7]?.innerText || ''); 
                    body.push(rowData);
                });
            }

            if (body.length > 0) {
                doc.autoTable({
                    startY: currentY,
                    head: head,
                    body: body,
                    theme: 'grid',
                    headStyles: {
                        fillColor: headerBackgroundColor,
                        textColor: headerTextColor,
                        fontStyle: 'bold',
                        halign: 'center',
                        fontSize: 8,
                        lineWidth: 0.5,
                        lineColor: borderColor
                    },
                    styles: {
                        textColor: primaryTextColor,
                        cellPadding: 4,
                        fontSize: 7,
                        overflow: 'linebreak',
                        halign: 'left',
                        lineWidth: 0.5,
                        lineColor: borderColor
                    },
                    alternateRowStyles: { fillColor: altRowBackgroundColor },
                    columnStyles: {
                        0: { cellWidth: 55, halign: 'center' }, // Cód OS
                        1: { cellWidth: 75 }, // Solicitante
                        2: { cellWidth: 100 },// Cliente
                        3: { cellWidth: 60, halign: 'center' }, // Data Início
                        4: { cellWidth: 60, halign: 'center' }, // Data Término
                        5: { cellWidth: 85 }, // Resp./Equipe
                        6: { cellWidth: 55, halign: 'center' }, // Logística
                        7: { cellWidth: 'auto' } // Produto
                    },
                    didDrawPage: (data) => { currentY = data.cursor.y + 20; if (currentY > pageHeight - margin - 50) currentY = margin; },
                    didParseCell: function (data) { // Garante cores do tema escuro
                        data.cell.styles.fillColor = data.row.index % 2 === 0 ? rowBackgroundColor : altRowBackgroundColor;
                        data.cell.styles.textColor = primaryTextColor;
                        if (data.section === 'head') {
                            data.cell.styles.fillColor = headerBackgroundColor;
                            data.cell.styles.textColor = headerTextColor;
                        }
                    }
                });
                currentY = doc.autoTable.previous.finalY + 25; // Espaço após a tabela
            } else {
                doc.setFontSize(10); doc.text("Nenhum dado na tabela para os filtros atuais.", margin, currentY); currentY += 20;
            }
        } else {
            doc.setFontSize(10); doc.text("Tabela de relatório não encontrada.", margin, currentY); currentY += 20;
        }

        // Gráficos
        if (chartCanvasIds && chartCanvasIds.length > 0) {
            const chartWidth = (pageWidth - (chartCanvasIds.length + 1) * margin) / chartCanvasIds.length; // Ajusta dinamicamente
            const chartHeight = chartWidth * 0.65; // Proporção do gráfico
            let chartX = margin;
            let chartsOnThisPage = 0;

            // Verifica se há espaço para os gráficos na página atual ou adiciona nova
            if (currentY + chartHeight + 40 > pageHeight - margin) { // 40 para título do gráfico e espaçamento
                doc.addPage();
                currentY = margin;
            }
            
            doc.setFontSize(12);
            doc.setTextColor(primaryTextColor);
            doc.text("Visualização Gráfica dos Dados Filtrados", pageWidth / 2, currentY, { align: 'center' });
            currentY += 25;


            for (const chartId of chartCanvasIds) {
                const canvas = document.getElementById(chartId);
                if (canvas && canvas.offsetParent !== null && canvas.width > 0 && canvas.height > 0) {
                     if (chartX + chartWidth > pageWidth - margin && chartsOnThisPage > 0) { // Se não couber mais na linha
                        doc.addPage();
                        currentY = margin + 25; // Y inicial para gráficos em nova página
                        chartX = margin;
                        chartsOnThisPage = 0;
                        
                        doc.setFontSize(12);
                        doc.setTextColor(primaryTextColor);
                        doc.text("Visualização Gráfica dos Dados Filtrados (continuação)", pageWidth / 2, currentY -15 , { align: 'center' });
                        // currentY += 25;
                    }


                    try {
                        const imgData = canvas.toDataURL('image/png', 1.0);
                        const chartTitleElement = canvas.closest('.card')?.querySelector('h4');
                        let chartTitleText = chartTitleElement ? chartTitleElement.innerText : (chartId === 'reportChartByUsuario' ? 'OS por Solicitante' : chartId.replace('reportChartBy', 'Gráfico '));
                        
                        // Título do Gráfico
                        doc.setFontSize(10);
                        doc.setTextColor(primaryTextColor);
                        doc.text(chartTitleText, chartX + chartWidth / 2, currentY - 8, { align: 'center' });
                        doc.addImage(imgData, 'PNG', chartX, currentY, chartWidth, chartHeight);
                        
                        chartX += chartWidth + margin;
                        chartsOnThisPage++;

                    } catch (e) {
                        console.error("Erro ao adicionar gráfico ao PDF:", e, chartId);
                        doc.setTextColor(255, 0, 0);
                        doc.text(`Erro ao renderizar ${chartId}`, chartX, currentY);
                        doc.setTextColor(primaryTextColor);
                        chartX += chartWidth + margin;
                        chartsOnThisPage++;
                    }
                }
            }
        }


        // Paginação e Rodapé
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(7);
            doc.setTextColor(secondaryTextColor);
            const footerText = `Página ${i} de ${pageCount}  |  Gestão Interna OS - ${APP_VERSION}`;
            doc.text(footerText, pageWidth - margin, pageHeight - 15, { align: 'right' });
        }

        doc.save(title.replace(/[^a-z0-9_]+/gi, '_').toLowerCase() + '_detalhado.pdf');
        addRecentActivity(`Arquivo PDF Detalhado Aprimorado "${title}" exportado com sucesso.`);
    }


    // Nova Função para Exportar Lista Visível como Imagem
    function exportVisibleListToImage(tableId, fileName = 'lista_relatorio.png') {
        const tableElement = document.getElementById(tableId);
        if (!tableElement) {
            alert('Tabela de relatório não encontrada para gerar imagem.');
            console.error(`Elemento com ID '${tableId}' não encontrado.`);
            return;
        }
        
        // Mostra uma mensagem de carregamento (opcional, mas bom para UX)
        const originalButtonText = document.querySelector(`button[onclick*="exportVisibleListToImage"]`)?.innerHTML;
        if(document.querySelector(`button[onclick*="exportVisibleListToImage"]`)) {
            document.querySelector(`button[onclick*="exportVisibleListToImage"]`).innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
            document.querySelector(`button[onclick*="exportVisibleListToImage"]`).disabled = true;
        }

        // Use a div container se a tabela em si não tiver um fundo, para garantir que o fundo do card seja capturado
        const reportCard = tableElement.closest('.card'); // Tenta pegar o card pai
        const elementToCapture = reportCard || tableElement; // Captura o card ou a tabela diretamente

        html2canvas(elementToCapture, {
            scale: 1.5, // Aumenta a escala para melhor resolução, ajuste conforme necessário
            useCORS: true, // Se houver imagens externas (improvável neste contexto)
            backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-card-light').trim(), // Usa a cor de fundo do card
            onclone: (clonedDoc) => {
                // Ajustes no clone antes da captura, se necessário
                // Por exemplo, garantir que todos os estilos Tailwind sejam aplicados
                // Aqui pode-se forçar estilos para garantir a aparência no canvas
                const clonedTable = clonedDoc.getElementById(tableId);
                if (clonedTable) {
                    clonedTable.style.minWidth = '100%'; // Garante que a tabela use a largura total
                    // Poderia adicionar mais estilos para a captura aqui se a aparência estiver diferente
                }
            }
        }).then(canvas => {
            const image = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = image;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            addRecentActivity(`Imagem da lista de relatório "${fileName}" exportada.`);
        }).catch(err => {
            console.error('Erro ao gerar imagem com html2canvas:', err);
            alert('Ocorreu um erro ao gerar a imagem da lista.');
        }).finally(() => {
            // Restaura o botão
            if(document.querySelector(`button[onclick*="exportVisibleListToImage"]`) && originalButtonText) {
                document.querySelector(`button[onclick*="exportVisibleListToImage"]`).innerHTML = originalButtonText;
                document.querySelector(`button[onclick*="exportVisibleListToImage"]`).disabled = false;
            }
        });
    }

    function downloadICS(osId) {
        const os = ordensServico.find(o => o.id === osId);
        if (!os) { alert("OS não encontrada para gerar arquivo .ics."); return; }
        const nowFormatted = new Date().toISOString().replace(/-/g, '').replace(/:/g, '').substring(0, 15) + 'Z';
        const description = `OS: ${os.numero}\\nCliente: ${os.cliente}\\nProduto: ${os.produto || 'N/A'}\\nDescrição: ${os.descricao.replace(/\n/g, '\\n')}\\nResponsável: ${os.responsavel}\\nPrioridade: ${os.prioridade}\\nStatus: ${os.status}${os.marcadorAtrasoManual ? '\\nMARCADA: NÃO REALIZADA NO PRAZO' : ''}${os.logisticaOk ? '\\nLOGÍSTICA: OK' : ''}`;
        const icsContent = [
            "BEGIN:VCALENDAR", "VERSION:2.0", "PRODID:-//SeuNomeOuEmpresa//GestaoOS//PT",
            "BEGIN:VEVENT",
            `UID:${os.id}@${window.location.hostname || 'gestao-os.com'}`,
            `DTSTAMP:${nowFormatted}`,
            `DTSTART;VALUE=DATE:${os.dataAbertura.replace(/-/g, '')}`,
            `DTEND;VALUE=DATE:${new Date(new Date(os.prazoFinal).getTime() + 864e5).toISOString().split('T')[0].replace(/-/g, '')}`, // Adiciona 1 dia ao prazo final para eventos de dia inteiro
            `SUMMARY:Prazo OS ${os.numero} - ${os.cliente}`,
            `DESCRIPTION:${description}`,
            `LOCATION:Cliente ${os.cliente}`, // Pode ser mais específico se houver campo de endereço
            "BEGIN:VALARM", "ACTION:DISPLAY", "DESCRIPTION:Lembrete Prazo OS", "TRIGGER:-PT1D", // Lembrete 1 dia antes
            "END:VALARM", "END:VEVENT", "END:VCALENDAR"
        ].join("\r\n");
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `OS_${os.numero}_${os.cliente.replace(/[^a-z0-9]/gi, '_')}.ics`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        addRecentActivity(`Arquivo .ics para OS ${os.numero} gerado.`);
    }
    // Continua na Parte 3...
// Continuação da Parte 2...
    // ==========================================================================
    // FUNÇÕES DE NAVEGAÇÃO E EXIBIÇÃO DE VIEWS
    // ==========================================================================
    function showView(viewId, clickedElement) {
        document.querySelectorAll('.view-section').forEach(section => section.classList.add('hidden'));
        const targetView = document.getElementById(viewId);
        if (targetView) targetView.classList.remove('hidden');
        else { document.getElementById('homeView').classList.remove('hidden'); console.error(`View '${viewId}' não encontrada, exibindo Home.`); }
        document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
        if (clickedElement && clickedElement.classList.contains('sidebar-item')) clickedElement.classList.add('active');

        // Specific initializations or cleanups when a view is shown
        if (viewId === 'homeView') {
            recentActivityList = document.getElementById('recentActivityList'); // Ensure it's set
             updateHomeCounts(); // Update counts when home is shown
             renderOSStatusChart(); // Render chart when home is shown
        } else if (viewId === 'osListView') {
            importStatusMessage = document.getElementById('importStatusMessage');
            importSummaryDiv = document.getElementById('importSummary');
            importSummaryList = document.getElementById('importSummaryList');
            populateSavedFiltersSelect();
            populateProductFilters(); // Ensure product filters are up-to-date
            applyFiltersAndRender(); // Render OS table
        } else if (viewId === 'reportsView') {
            populateProductFilters(); // Ensure product filters are up-to-date
            generateCustomReport(); // Initial generation or clear existing
        }


        // Hide import section if not on osListView
        const importOsLoteContainer = document.getElementById('importOsLoteContainer');
        if (viewId !== 'osListView' && importOsLoteContainer && !importOsLoteContainer.classList.contains('hidden')) {
             importOsLoteContainer.classList.add('hidden');
             if(importStatusMessage) importStatusMessage.textContent = '';
             if(importSummaryList) importSummaryList.innerHTML = '';
             if(importSummaryDiv) importSummaryDiv.classList.add('hidden');
        }

        // Destroy report charts if not on reportsView to free resources
        if (viewId !== 'reportsView') {
            if (reportChartByProductInstance) { reportChartByProductInstance.destroy(); reportChartByProductInstance = null; }
            if (reportChartByUsuarioInstance) { reportChartByUsuarioInstance.destroy(); reportChartByUsuarioInstance = null; }
            if (reportChartByStatusInstance) { reportChartByStatusInstance.destroy(); reportChartByStatusInstance = null; }
        }
         // Specific actions for certain views
        if (viewId === 'settingsView') { const itemsPerPageInput = document.getElementById('itemsPerPageSetting'); if (itemsPerPageInput) itemsPerPageInput.value = ITEMS_PER_PAGE; }
    }

    const mainSidebar = document.getElementById('sidebar');
    const mainContentArea = document.getElementById('mainContent');
    const mainToggleSidebarBtn = document.getElementById('toggleSidebar');

    if (mainToggleSidebarBtn && mainSidebar && mainContentArea && sidebarTitleDiv) {
        mainToggleSidebarBtn.addEventListener('click', () => {
            mainSidebar.classList.toggle('collapsed');
            mainContentArea.classList.toggle('collapsed');
            const isCollapsed = mainSidebar.classList.contains('collapsed');
            mainToggleSidebarBtn.innerHTML = isCollapsed ? '<i class="fas fa-chevron-right text-lg"></i>' : '<i class="fas fa-bars text-lg"></i>';
            const titleSpan = sidebarTitleDiv.querySelector('span'); if (titleSpan) titleSpan.style.display = isCollapsed ? 'none' : 'inline';
            const titleIcon = sidebarTitleDiv.querySelector('i'); if (titleIcon) titleIcon.style.marginRight = isCollapsed ? '0' : '0.5rem';

            // Resize charts after sidebar transition (300ms + small buffer)
            setTimeout(() => {
                if (!isCollapsed && document.getElementById('homeView') && !document.getElementById('homeView').classList.contains('hidden') && osStatusChartInstance) osStatusChartInstance.resize();
                if (!isCollapsed && document.getElementById('reportsView') && !document.getElementById('reportsView').classList.contains('hidden')) {
                    if (reportChartByProductInstance) reportChartByProductInstance.resize();
                    if (reportChartByUsuarioInstance) reportChartByUsuarioInstance.resize();
                    if (reportChartByStatusInstance) reportChartByStatusInstance.resize();
                }
            }, 350);
        });
    }

    // ==========================================================================
    // LÓGICA DE FILTROS DA LISTA PRINCIPAL, HOME VIEW E ATUALIZAÇÃO GERAL
    // ==========================================================================
    function getFilteredOS() {
        const filterOsNumValue = document.getElementById('filterOsNumber')?.value.toLowerCase() || "";
        const filterClientValue = document.getElementById('filterClient')?.value.toLowerCase() || "";
        const filterStatusValue = document.getElementById('filterStatus')?.value || "";
        const filterProductValue = document.getElementById('filterProduct')?.value || "";
        const filterDescriptionValue = document.getElementById('filterDescription')?.value.toLowerCase() || "";
        const filterMarcadorAtrasoValue = document.getElementById('filterMarcadorAtraso')?.value || "";
        const filterLogisticaOkValue = document.getElementById('filterLogisticaOk')?.value || "";

        return ordensServico.filter(os => {
            const matchNumero = (os.numero?.toLowerCase() || "").includes(filterOsNumValue);
            const matchCliente = (os.cliente?.toLowerCase() || "").includes(filterClientValue);
            const matchStatus = filterStatusValue ? os.status === filterStatusValue : true;
            const matchProduto = filterProductValue ? os.produto === filterProductValue : true;
            const matchDescricao = (os.descricao?.toLowerCase() || "").includes(filterDescriptionValue);

            let matchMarcadorAtraso = true;
            if (filterMarcadorAtrasoValue === "marcada") matchMarcadorAtraso = os.marcadorAtrasoManual === true;
            else if (filterMarcadorAtrasoValue === "nao_marcada") matchMarcadorAtraso = os.marcadorAtrasoManual === false || os.marcadorAtrasoManual === undefined; // Inclui não definidos como não marcados

            let matchLogisticaOk = true;
            if (filterLogisticaOkValue === "sim") matchLogisticaOk = os.logisticaOk === true;
            else if (filterLogisticaOkValue === "nao") matchLogisticaOk = os.logisticaOk === false || os.logisticaOk === undefined; // Inclui não definidos como não

            return matchNumero && matchCliente && matchStatus && matchProduto && matchDescricao && matchMarcadorAtraso && matchLogisticaOk;
        });
    }
    function applyFiltersAndRender() { currentPage = 1; renderOSTable(); }
    function updateHomeCounts() {
        const osAbertasEl = document.getElementById('osAbertasCount');
        const osCompletasMesEl = document.getElementById('osCompletasMesCount');
        const osPendentesEl = document.getElementById('osPendentesCount');
        const osCanceladasEl = document.getElementById('osCanceladasCount');

        if (osAbertasEl) osAbertasEl.textContent = ordensServico.filter(os => os.status === 'Aberta').length;

        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59, 999);
        if (osCompletasMesEl) osCompletasMesEl.textContent = ordensServico.filter(os => {
            if (os.status !== 'Completa') return false;
            // Usar prazoFinal se dataFechamento não existir para contagem do mês
            const completionDateStr = os.dataFechamento || os.prazoFinal;
            if (!completionDateStr) return false;
            const completionDate = new Date(completionDateStr + "T00:00:00Z"); // Assume YYYY-MM-DD and interpret as UTC midnight
            return completionDate >= firstDayOfMonth && completionDate <= lastDayOfMonth;
        }).length;

        if (osPendentesEl) osPendentesEl.textContent = ordensServico.filter(os => os.status === 'Pendente Informação' || os.status === 'Aguardando Aprovação').length;
        if (osCanceladasEl) osCanceladasEl.textContent = ordensServico.filter(os => os.status === 'Cancelada').length;
    }
    function renderOSStatusChart() {
        const chartCanvas = document.getElementById('osStatusChart');
        const chartContainer = document.getElementById('osStatusChartContainer');
        if (!chartCanvas || !chartContainer || chartContainer.offsetParent === null) return; // Don't render if not visible
        const ctx = chartCanvas.getContext('2d');

        const statusCounts = ordensServico.reduce((acc, os) => { acc[os.status] = (acc[os.status] || 0) + 1; return acc; }, {});
        const statusColors = { 'Aberta': 'rgba(54,162,235,0.8)', 'Em Andamento': 'rgba(255,159,64,0.8)', 'Pendente Informação': 'rgba(255,205,86,0.8)', 'Aguardando Aprovação': 'rgba(153,102,255,0.8)', 'Completa': 'rgba(75,192,192,0.8)', 'Cancelada': 'rgba(255,99,132,0.8)', 'Incompleta': 'rgba(201, 203, 207, 0.8)', 'Provisória': 'rgba(160, 160, 160, 0.8)' };
        const backgroundColors = Object.keys(statusCounts).map(status => statusColors[status] || 'rgba(201,203,207,0.8)');

        const data = {
            labels: Object.keys(statusCounts),
            datasets: [{
                label: 'OS por Status', data: Object.values(statusCounts),
                backgroundColor: backgroundColors,
                borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-card-light').trim(), // For dark theme
                borderWidth: 2, hoverOffset: 8
            }]
        };
        if (osStatusChartInstance) osStatusChartInstance.destroy();
        osStatusChartInstance = new Chart(ctx, {
            type: 'doughnut', data: data,
            options: {
                responsive: true, maintainAspectRatio: false, animation: { animateScale: true, animateRotate: true },
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 15, font: { size: 11 }, color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary-light').trim() } }, // For dark theme
                    tooltip: {
                        backgroundColor: 'rgba(30,41,59,0.9)', titleColor: '#f1f5f9', bodyColor: '#cbd5e1',
                        borderColor: '#475569', borderWidth: 1,
                        callbacks: { label: function (context) { const percentage = ((context.parsed / context.chart.getDatasetMeta(0).total) * 100).toFixed(1); return `${context.label || ''}: ${context.parsed || 0} (${percentage}%)`; } }
                    }
                }
            }
        });
    }
    function navigateToOsListWithFilter(statusFilter, filterCurrentMonthOnly = false) {
        const filterStatusInput = document.getElementById('filterStatus');
        const filterOsNumberInput = document.getElementById('filterOsNumber');
        const filterClientInput = document.getElementById('filterClient');
        const filterProductInput = document.getElementById('filterProduct');
        const filterDescriptionInput = document.getElementById('filterDescription');
        const filterMarcadorAtrasoInput = document.getElementById('filterMarcadorAtraso');
        const filterLogisticaOkInput = document.getElementById('filterLogisticaOk');

        // Reset other filters
        if (filterOsNumberInput) filterOsNumberInput.value = "";
        if (filterClientInput) filterClientInput.value = "";
        if (filterProductInput) filterProductInput.value = "";
        if (filterDescriptionInput) filterDescriptionInput.value = "";
        if (filterMarcadorAtrasoInput) filterMarcadorAtrasoInput.value = "";
        if (filterLogisticaOkInput) filterLogisticaOkInput.value = "";

        if (filterStatusInput) {
            if (Array.isArray(statusFilter)) {
                filterStatusInput.value = ""; // Can't set multiple, user needs to refine for pendentes
                addRecentActivity("Visualizando OS. Refine os filtros para visualizar OS pendentes.");
            } else {
                filterStatusInput.value = statusFilter;
            }
        }
        // The filterCurrentMonthOnly logic would need to be implemented in getFilteredOS if we want to pre-filter by date
        // For now, it just navigates and sets the status filter.
        showView('osListView', document.querySelector('.sidebar-item[onclick*="osListView"]'));
    }
    function refreshAllViews() {
        renderOSTable(); // This calls getFilteredOS internally
        updateHomeCounts();
        if (document.getElementById('homeView') && !document.getElementById('homeView').classList.contains('hidden')) {
            renderOSStatusChart();
        }
        const reportsViewElement = document.getElementById('reportsView');
        if (reportsViewElement && !reportsViewElement.classList.contains('hidden')) {
            generateCustomReport(); // This will also re-render report charts
        }
    }


    // ==========================================================================
    // RELATÓRIOS PERSONALIZADOS
    // ==========================================================================
    function generateCustomReport() {
        const reportsTableBody = document.getElementById('reportsTableBody');
        const reportDateStartInput = document.getElementById('reportDateStartFilter');
        const reportDateEndInput = document.getElementById('reportDateEndFilter');
        const reportStatusInput = document.getElementById('reportStatusFilter');
        const reportProductInput = document.getElementById('reportProductFilter');
        const reportFilterMarcadorAtrasoInput = document.getElementById('reportFilterMarcadorAtraso');
        const reportFilterLogisticaOkInput = document.getElementById('reportFilterLogisticaOk');


        if (!reportsTableBody || !reportDateStartInput || !reportDateEndInput || !reportStatusInput || !reportProductInput || !reportFilterMarcadorAtrasoInput || !reportFilterLogisticaOkInput) return;
        reportsTableBody.innerHTML = ''; // Clear previous results
        // Clear existing charts before generating new ones
        if (reportChartByProductInstance) { reportChartByProductInstance.destroy(); reportChartByProductInstance = null; }
        if (reportChartByUsuarioInstance) { reportChartByUsuarioInstance.destroy(); reportChartByUsuarioInstance = null; }
        if (reportChartByStatusInstance) { reportChartByStatusInstance.destroy(); reportChartByStatusInstance = null; }
        document.getElementById('customReportChartsContainer').querySelectorAll('canvas').forEach(canvas => {
            const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas
        });


        const dateStartValue = reportDateStartInput.value;
        const dateEndValue = reportDateEndInput.value;
        const statusValue = reportStatusInput.value;
        const productValue = reportProductInput.value;
        const filterMAValue = reportFilterMarcadorAtrasoInput.value;
        const filterLOKValue = reportFilterLogisticaOkInput.value;

        if (dateStartValue && dateEndValue && new Date(dateEndValue) < new Date(dateStartValue)) {
            alert("A Data Final do relatório não pode ser anterior à Data Inicial.");
            reportsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-10 text-red-500">Erro: Data Final anterior à Data Inicial.</td></tr>';
            return;
        }

        const filteredReportData = ordensServico.filter(os => {
            let matchPrazo = true;
            if (os.prazoFinal) {
                // Ensure dates are compared correctly as YYYY-MM-DD by creating Date objects at UTC midnight
                const prazoFinalDate = new Date(os.prazoFinal + "T00:00:00Z");
                if (dateStartValue && dateEndValue) {
                    matchPrazo = prazoFinalDate >= new Date(dateStartValue + "T00:00:00Z") && prazoFinalDate <= new Date(dateEndValue + "T23:59:59Z");
                } else if (dateStartValue) {
                    matchPrazo = prazoFinalDate >= new Date(dateStartValue + "T00:00:00Z");
                } else if (dateEndValue) {
                    matchPrazo = prazoFinalDate <= new Date(dateEndValue + "T23:59:59Z");
                }
            } else if (dateStartValue || dateEndValue) { // If date filters are set, but OS has no prazoFinal, it doesn't match
                matchPrazo = false;
            }

            const matchStatus = statusValue ? os.status === statusValue : true;
            const matchProduct = productValue ? os.produto === productValue : true;

            let matchMarcadorAtraso = true;
            if (filterMAValue === "marcada") matchMarcadorAtraso = os.marcadorAtrasoManual === true;
            else if (filterMAValue === "nao_marcada") matchMarcadorAtraso = os.marcadorAtrasoManual === false || os.marcadorAtrasoManual === undefined;

            let matchLogistica = true;
            if (filterLOKValue === "sim") matchLogistica = os.logisticaOk === true;
            else if (filterLOKValue === "nao") matchLogistica = os.logisticaOk === false || os.logisticaOk === undefined;


            return matchPrazo && matchStatus && matchProduct && matchMarcadorAtraso && matchLogistica;
        });

        if (filteredReportData.length === 0) {
            reportsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-10 text-slate-400">Nenhuma Ordem de Serviço encontrada para os filtros selecionados.</td></tr>';
            return;
        }

        filteredReportData.sort((a, b) => new Date(a.dataAbertura) - new Date(b.dataAbertura)); // Sort by opening date
        filteredReportData.forEach(os => {
            const row = reportsTableBody.insertRow();
            row.className = 'table-row hover:bg-slate-700';
            // Headers: Código OS, Solicitante, Cliente, Data Início, Data Término, Solicitante (era Técnico), Logística Pronta, Produto
            row.innerHTML = `<td class="py-3 px-4 text-sm">${os.numero}</td>
                            <td class="py-3 px-4 text-sm">${os.solicitante || 'N/A'}</td>
                            <td class="py-3 px-4 text-sm">${os.cliente}</td>
                            <td class="py-3 px-4 text-sm">${formatDateToBR(os.dataAbertura)}</td>
                            <td class="py-3 px-4 text-sm">${formatDateToBR(os.prazoFinal)}</td>
                            <td class="py-3 px-4 text-sm">${os.responsavel || 'N/A'}</td> 
                            <td class="py-3 px-4 text-sm">${os.logisticaOk ? 'Sim' : 'Não'}</td>
                            <td class="py-3 px-4 text-sm">${os.produto || 'N/A'}</td>`;
        });
        addRecentActivity("Relatório personalizado gerado com sucesso.");
        renderReportCharts(filteredReportData);
    }

    function renderReportCharts(data) {
        const chartCommonOptions = (titleText = null) => ({
            responsive: true, maintainAspectRatio: false, animation: { duration: 1000, easing: 'easeInOutQuart', animateScale: true, animateRotate: true },
            plugins: {
                legend: { display: true, position: 'bottom', labels: { color: '#cbd5e1', padding: 15, boxWidth: 12, font: { size: 11 } } },
                title: { display: !!titleText, text: titleText, color: '#cbd5e1', font: { size: 14, weight: 'normal' } },
                tooltip: {
                    backgroundColor: 'rgba(30,41,59,0.95)', titleColor: '#f1f5f9', bodyColor: '#cbd5e1',
                    borderColor: '#475569', borderWidth: 1, padding: 10,
                    callbacks: { label: function (context) { const total = context.chart.getDatasetMeta(0).total; const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) + '%' : '0%'; return `${context.label || ''}: ${context.parsed || 0} (${percentage})`; } }
                }
            },
            scales: { // Specific for bar chart, pie/doughnut don't use scales this way
                y: { beginAtZero: true, ticks: { color: '#94a3b8', stepSize: 1, precision: 0 }, grid: { color: '#334155', drawBorder: false } },
                x: { ticks: { color: '#94a3b8', autoSkip: true, maxRotation: 45, minRotation: 0 }, grid: { display: false } }
            }
        });
        const chartColors = ['rgba(54,162,235,0.8)', 'rgba(255,159,64,0.8)', 'rgba(75,192,192,0.8)', 'rgba(255,99,132,0.8)', 'rgba(153,102,255,0.8)', 'rgba(255,205,86,0.8)', 'rgba(123,239,178,0.8)', 'rgba(250,130,49,0.8)', 'rgba(179,57,57,0.8)', 'rgba(72,126,176,0.8)', 'rgba(246,229,141,0.8)', 'rgba(113,88,226,0.8)'];
        const chartBorderColor = 'rgba(15,23,42,0.8)'; // Dark border for chart elements

        // OS por Produto (Bar Chart)
        const productCounts = data.reduce((acc, os) => { acc[os.produto || 'N/Especificado'] = (acc[os.produto || 'N/Especificado'] || 0) + 1; return acc; }, {});
        const productChartCanvas = document.getElementById('reportChartByProduct');
        if (productChartCanvas) {
            if (reportChartByProductInstance) reportChartByProductInstance.destroy();
            reportChartByProductInstance = new Chart(productChartCanvas.getContext('2d'), {
                type: 'bar',
                data: { labels: Object.keys(productCounts), datasets: [{ label: 'OS', data: Object.values(productCounts), backgroundColor: chartColors, borderColor: chartBorderColor, borderWidth: 1.5 }] },
                options: chartCommonOptions() // Default options without specific title for bar
            });
        }

        // OS por Solicitante (Pie Chart) - Canvas ID is reportChartByUsuario
        const solicitanteCounts = data.reduce((acc, os) => { const solicitante = os.solicitante || 'N/Atribuído'; acc[solicitante] = (acc[solicitante] || 0) + 1; return acc; }, {});
        const solicitanteChartCanvas = document.getElementById('reportChartByUsuario');
        if (solicitanteChartCanvas) {
            if (reportChartByUsuarioInstance) reportChartByUsuarioInstance.destroy();
            reportChartByUsuarioInstance = new Chart(solicitanteChartCanvas.getContext('2d'), {
                type: 'pie',
                data: { labels: Object.keys(solicitanteCounts), datasets: [{ label: 'OS', data: Object.values(solicitanteCounts), backgroundColor: chartColors, borderColor: chartBorderColor, borderWidth: 1.5, hoverOffset: 8 }] },
                options: { ...chartCommonOptions(), scales: {} } // Remove scales for pie
            });
        }

        // OS por Status (Doughnut Chart)
        const statusCountsReport = data.reduce((acc, os) => { acc[os.status] = (acc[os.status] || 0) + 1; return acc; }, {});
        const statusColorsMap = { 'Aberta': 'rgba(54,162,235,0.8)', 'Em Andamento': 'rgba(255,159,64,0.8)', /* ... add all status colors ... */ 'Cancelada': 'rgba(255,99,132,0.8)', 'Incompleta':'rgba(201, 203, 207, 0.8)', 'Provisória': 'rgba(160, 160, 160, 0.8)'};
        const statusChartCanvas = document.getElementById('reportChartByStatus');
        if (statusChartCanvas) {
            if (reportChartByStatusInstance) reportChartByStatusInstance.destroy();
            reportChartByStatusInstance = new Chart(statusChartCanvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCountsReport),
                    datasets: [{ label: 'OS', data: Object.values(statusCountsReport), backgroundColor: Object.keys(statusCountsReport).map((status, i) => statusColorsMap[status] || chartColors[i % chartColors.length]), borderColor: chartBorderColor, borderWidth: 1.5, hoverOffset: 8 }]
                },
                options: { ...chartCommonOptions(), scales: {} } // Remove scales for doughnut
            });
        }
    }
    const clearReportOnChange = () => {
        if (document.getElementById('reportsView') && !document.getElementById('reportsView').classList.contains('hidden')) {
            document.getElementById('reportsTableBody').innerHTML = '<tr><td colspan="8" class="text-center py-10 text-slate-400">Os filtros foram alterados. Clique em "Gerar Relatório" para atualizar.</td></tr>';
            if (reportChartByProductInstance) { reportChartByProductInstance.destroy(); reportChartByProductInstance = null; }
            if (reportChartByUsuarioInstance) { reportChartByUsuarioInstance.destroy(); reportChartByUsuarioInstance = null; }
            if (reportChartByStatusInstance) { reportChartByStatusInstance.destroy(); reportChartByStatusInstance = null; }
            document.getElementById('customReportChartsContainer').querySelectorAll('canvas').forEach(canvas => { const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height); });
        }
    };


    // ==========================================================================
    // FUNÇÕES DE CONFIGURAÇÕES DA APLICAÇÃO
    // ==========================================================================
    function confirmClearAllData() {
        if (confirm("ATENÇÃO!\nTem certeza que deseja limpar TODOS os dados de Ordens de Serviço, Filtros Salvos e Configurações Locais?\nEsta ação é IRREVERSÍVEL e todos os dados salvos localmente serão perdidos.")) {
            if (confirm("CONFIRMAÇÃO FINAL:\nTodos os dados de OS, filtros e configurações locais serão permanentemente apagados. Deseja continuar?")) {
                ordensServico = [];
                savedFilters = {};
                ITEMS_PER_PAGE = ITEMS_PER_PAGE_DEFAULT; // Reset to default
                localStorage.removeItem('gestaoOsAppData'); // Remove the main data item
                addRecentActivity("Todos os dados locais foram limpos do sistema.");
                currentPage = 1;
                refreshAllViews();
                populateSavedFiltersSelect();
                const itemsPerPageInput = document.getElementById('itemsPerPageSetting');
                if(itemsPerPageInput) itemsPerPageInput.value = ITEMS_PER_PAGE;
                alert("Todos os dados locais foram limpos com sucesso.");
            } else alert("Limpeza de dados cancelada pelo usuário.");
        } else alert("Limpeza de dados cancelada pelo usuário.");
    }
    function applyItemsPerPageSetting() {
        const itemsPerPageInput = document.getElementById('itemsPerPageSetting'); if (!itemsPerPageInput) return;
        const newItemsPerPage = parseInt(itemsPerPageInput.value, 10);
        if (newItemsPerPage >= 5 && newItemsPerPage <= 50) {
            ITEMS_PER_PAGE = newItemsPerPage;
            currentPage = 1; // Reset to first page
            saveDataToLocalStorage();
            renderOSTable(); // Re-render OS table with new pagination
            addRecentActivity(`Número de itens por página alterado para ${ITEMS_PER_PAGE}.`);
        } else {
            alert("Por favor, insira um valor entre 5 e 50 para itens por página.");
            itemsPerPageInput.value = ITEMS_PER_PAGE; // Revert to current value
        }
    }

    // ==========================================================================
    // INICIALIZAÇÃO DA APLICAÇÃO E EVENTOS GLOBAIS
    // ==========================================================================
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize DOM elements that are frequently accessed
        osModal = document.getElementById('osModal');
        osForm = document.getElementById('osForm');
        modalTitle = document.getElementById('modalTitle');
        productDatalist = document.getElementById('productList');
        filterProductSelect = document.getElementById('filterProduct');
        reportProductSelect = document.getElementById('reportProduct');
        recentActivityList = document.getElementById('recentActivityList'); // Initialize here as it's on home view
        importStatusMessage = document.getElementById('importStatusMessage'); // For OS List view
        importSummaryDiv = document.getElementById('importSummary');         // For OS List view
        importSummaryList = document.getElementById('importSummaryList');     // For OS List view


        loadDataFromLocalStorage();
        document.getElementById('appVersion').textContent = `Versão ${APP_VERSION}`;


        const homeSidebarItem = document.querySelector('.sidebar-item[onclick*="homeView"]');
        showView('homeView', homeSidebarItem || null); // Show home view by default

        const dataAberturaModalEl = document.getElementById('osDataAberturaModal');
        if (dataAberturaModalEl && !dataAberturaModalEl.value) dataAberturaModalEl.value = new Date().toISOString().split('T')[0];

        const processExcelButton = document.getElementById('processExcelButton');
        if (processExcelButton) {
            processExcelButton.addEventListener('click', handleExcelImport);
        }

        // Collapse sidebar on smaller screens initially
        if (mainToggleSidebarBtn && mainSidebar && mainContentArea && sidebarTitleDiv) {
            if (window.innerWidth < 1024 && !mainSidebar.classList.contains('collapsed')) {
                mainSidebar.classList.add('collapsed');
                mainContentArea.classList.add('collapsed');
                const isCollapsed = mainSidebar.classList.contains('collapsed');
                mainToggleSidebarBtn.innerHTML = isCollapsed ? '<i class="fas fa-chevron-right text-lg"></i>' : '<i class="fas fa-bars text-lg"></i>';
                const titleSpan = sidebarTitleDiv.querySelector('span'); if (titleSpan) titleSpan.style.display = isCollapsed ? 'none' : 'inline';
                const titleIcon = sidebarTitleDiv.querySelector('i'); if (titleIcon) titleIcon.style.marginRight = isCollapsed ? '0' : '0.5rem';
            }
        }
        addRecentActivity(`Sistema V${APP_VERSION} inicializado.`);
        updateLoginUI(); // Update login UI based on stored user or lack thereof

        if (osForm) {
            osForm.addEventListener('submit', function (e) {
                e.preventDefault();
                try {
                    const id = document.getElementById('osId').value;
                    // Validate and parse dates from modal inputs
                    const dataAberturaValue = document.getElementById('osDataAberturaModal').value;
                    const prazoFinalValue = document.getElementById('osPrazoFinalModal').value;

                    if (!dataAberturaValue || !prazoFinalValue) {
                        alert("Datas de Abertura e Prazo Final são obrigatórias.");
                        return;
                    }
                    
                    const osData = {
                        numero: document.getElementById('osNumeroModal').value.trim(),
                        cliente: document.getElementById('osClienteModal').value.trim(),
                        produto: document.getElementById('osProdutoModal').value.trim(),
                        solicitante: document.getElementById('osSolicitanteModal').value.trim() || 'N/A', // Default if empty
                        descricao: document.getElementById('osDescricaoModal').value.trim(),
                        dataAbertura: dataAberturaValue, // Already YYYY-MM-DD
                        prazoFinal: prazoFinalValue,     // Already YYYY-MM-DD
                        responsavel: document.getElementById('osResponsavelModal').value.trim(),
                        status: document.getElementById('osStatusModal').value,
                        prioridade: document.getElementById('osPrioridadeModal').value,
                        marcadorAtrasoManual: document.getElementById('osMarcadorAtrasoModal').checked,
                        logisticaOk: document.getElementById('osLogisticaOkModal').checked
                    };

                    if (!osData.numero || !osData.cliente || !osData.produto || !osData.descricao || !osData.responsavel || !osData.status || !osData.prioridade) {
                        alert("Por favor, preencha todos os campos obrigatórios (*).");
                        return;
                    }
                    if (new Date(osData.prazoFinal) < new Date(osData.dataAbertura)) {
                        alert("A Data de Prazo Final não pode ser anterior à Data de Abertura.");
                        return;
                    }

                    if (id) { // Editing existing OS
                        const osIndex = ordensServico.findIndex(o => o.id === id);
                        if (osIndex !== -1) {
                            ordensServico[osIndex] = { ...ordensServico[osIndex], ...osData };
                            addRecentActivity(`OS ${osData.numero} foi editada.`);
                        } else {
                            alert("Erro ao tentar editar a OS. OS não encontrada."); return;
                        }
                    } else { // Adding new OS
                        osData.id = generateId();
                        ordensServico.unshift(osData); // Add to the beginning for immediate visibility
                        addRecentActivity(`Nova OS ${osData.numero} foi adicionada.`);
                    }
                    saveDataToLocalStorage();
                    populateProductFilters(); // Update product list if new one was added
                    closeOSModal();
                    currentPage = 1; // Go to first page if adding/editing might change current page content
                    refreshAllViews(); // Update all relevant parts of the UI
                } catch (err) {
                    console.error("Erro ao salvar OS:", err);
                    alert("Ocorreu um erro ao tentar salvar a Ordem de Serviço. Verifique o console para detalhes.");
                }
            });
        }

        // Event listeners for main OS list filters
        const filterOsNumEl = document.getElementById('filterOsNumber'); if (filterOsNumEl) filterOsNumEl.addEventListener('input', applyFiltersAndRender);
        const filterClientEl = document.getElementById('filterClient'); if (filterClientEl) filterClientEl.addEventListener('input', applyFiltersAndRender);
        const filterStatusEl = document.getElementById('filterStatus'); if (filterStatusEl) filterStatusEl.addEventListener('change', applyFiltersAndRender);
        const filterProductSelectGlobal = document.getElementById('filterProduct'); if (filterProductSelectGlobal) filterProductSelectGlobal.addEventListener('change', applyFiltersAndRender);
        const filterDescriptionInput = document.getElementById('filterDescription'); if (filterDescriptionInput) filterDescriptionInput.addEventListener('input', applyFiltersAndRender);
        const filterMarcadorAtrasoEl = document.getElementById('filterMarcadorAtraso'); if (filterMarcadorAtrasoEl) filterMarcadorAtrasoEl.addEventListener('change', applyFiltersAndRender);
        const filterLogisticaOkEl = document.getElementById('filterLogisticaOk'); if (filterLogisticaOkEl) filterLogisticaOkEl.addEventListener('change', applyFiltersAndRender);

        // Event listeners for report filters to clear report content on change
        const reportDateStartListener = document.getElementById('reportDateStartFilter'); if (reportDateStartListener) reportDateStartListener.addEventListener('change', clearReportOnChange);
        const reportDateEndListener = document.getElementById('reportDateEndFilter'); if (reportDateEndListener) reportDateEndListener.addEventListener('change', clearReportOnChange);
        const reportStatusListener = document.getElementById('reportStatusFilter'); if (reportStatusListener && !reportStatusListener.getAttribute('data-listener-set')) { reportStatusListener.addEventListener('change', clearReportOnChange); reportStatusListener.setAttribute('data-listener-set', 'true'); }
        const reportProductListener = document.getElementById('reportProductFilter'); if (reportProductListener && !reportProductListener.getAttribute('data-listener-set')) { reportProductListener.addEventListener('change', clearReportOnChange); reportProductListener.setAttribute('data-listener-set', 'true'); }
        const reportMarcadorAtrasoListener = document.getElementById('reportFilterMarcadorAtraso'); if (reportMarcadorAtrasoListener && !reportMarcadorAtrasoListener.getAttribute('data-listener-set-report')) { reportMarcadorAtrasoListener.addEventListener('change', clearReportOnChange); reportMarcadorAtrasoListener.setAttribute('data-listener-set-report', 'true'); }
        const reportLogisticaOkListener = document.getElementById('reportFilterLogisticaOk'); if (reportLogisticaOkListener && !reportLogisticaOkListener.getAttribute('data-listener-set-report')) { reportLogisticaOkListener.addEventListener('change', clearReportOnChange); reportLogisticaOkListener.setAttribute('data-listener-set-report', 'true'); }
    });

    window.onclick = function (event) {
        const currentOsModal = document.getElementById('osModal');
        if (currentOsModal && event.target == currentOsModal) closeOSModal(); // Close modal if clicked outside content
    };

    window.onkeydown = function (event) {
        const currentOsModal = document.getElementById('osModal');
        if (currentOsModal && !currentOsModal.classList.contains('hidden') && event.key === "Escape") closeOSModal(); // Close modal on Escape key
    };
</script>
</body>
</html>