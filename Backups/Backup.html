<!DOCTYPE html>
<html lang="pt-BR" class=""> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento Interno de OS - V1.9.0</title> <meta name="google-signin-client_id" content="232267534625-ti8c7jd14nfqigmmj3lnevv8nvds3i0t.apps.googleusercontent.com">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg-body-light: #f0f4f8; --text-primary-light: #1e293b; --bg-sidebar-light: #1f2937;
            --text-sidebar-light: #e2e8f0; --bg-card-light: #ffffff; --text-card-light: #1e293b;
            --border-card-light: #e2e8f0; --bg-table-header-light: #f8fafc; --text-table-header-light: #334155;
            --border-table-header-light: #cbd5e1; --text-table-row-light: #475569; --border-table-row-light: #e2e8f0;
            --bg-table-row-hover-light: #f1f5f9; --bg-input-light: #ffffff; --text-input-light: #1e293b;
            --border-input-light: #cbd5e1; --border-input-focus-light: #0ea5e9;
            --shadow-input-focus-light: rgba(14, 165, 233, 0.25); --bg-button-primary-light: #0ea5e9;
            --text-button-primary-light: white; --bg-button-primary-hover-light: #0284c7;
            --text-placeholder-light: #64748b; --text-link-light: #0ea5e9;
        }
        html.dark {
            --bg-body-light: #0f172a; --text-primary-light: #cbd5e1; --bg-sidebar-light: #020617;
            --text-sidebar-light: #94a3b8; --bg-card-light: #1e293b; --text-card-light: #cbd5e1;
            --border-card-light: #334155; --bg-table-header-light: #334155; --text-table-header-light: #94a3b8;
            --border-table-header-light: #475569; --text-table-row-light: #cbd5e1; --border-table-row-light: #334155;
            --bg-table-row-hover-light: #283447; --bg-input-light: #0f172a; --text-input-light: #cbd5e1;
            --border-input-light: #475569; --border-input-focus-light: #0ea5e9;
            --shadow-input-focus-light: rgba(14, 165, 233, 0.25); --bg-button-primary-light: #0ea5e9;
            --text-button-primary-light: #0f172a; --bg-button-primary-hover-light: #0284c7;
            --text-placeholder-light: #64748b; --text-link-light: #38bdf8;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body-light); color: var(--text-primary-light); transition: background-color 0.3s, color 0.3s; }
        .sidebar { background-color: var(--bg-sidebar-light); color: var(--text-sidebar-light); width: 260px; transition: width 0.3s ease, background-color 0.3s, color 0.3s; box-shadow: 2px 0 6px rgba(0,0,0,0.1); height: 100vh; position: fixed; top: 0; left: 0; z-index: 50; display: flex; flex-direction: column; }
        .sidebar.collapsed { width: 70px; }
        .sidebar-item { padding: 14px 18px; cursor: pointer; display: flex; align-items: center; transition: background-color 0.2s ease, color 0.2s ease; border-radius: 6px; margin: 4px 0; }
        .dark .sidebar-item:hover { background-color: #1e293b; color: #f8fafc; } html:not(.dark) .sidebar-item:hover { background-color: #334155; color: #ffffff; }
        .dark .sidebar-item.active { background-color: #0ea5e9; color: #ffffff; } html:not(.dark) .sidebar-item.active { background-color: #0ea5e9; color: #ffffff; }
        .sidebar-item i { margin-right: 12px; min-width: 24px; text-align: center; font-size: 1.1em; }
        .sidebar.collapsed .sidebar-item span, .sidebar.collapsed #sidebar-title span { display: none; } .sidebar.collapsed .sidebar-item i { margin-right: 0; }
        .sidebar-header { padding: 14px 18px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #334155; margin-bottom:10px; }
        .dark .sidebar-header { border-bottom-color: #1e293b; } #sidebar-title span { font-size: 1.4em; font-weight: 600; color: #f8fafc; } .dark #sidebar-title span { color: #e2e8f0; }
        .content { background-color: var(--bg-body-light); flex-grow: 1; padding: 25px; transition: margin-left 0.3s ease, background-color 0.3s; margin-left: 260px; }
        .content.collapsed { margin-left: 70px; }
        .card { background-color: var(--bg-card-light); color: var(--text-card-light); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.07); padding: 25px; margin-bottom: 25px; transition: background-color 0.3s, color 0.3s, border-color 0.3s; border: 1px solid var(--border-card-light); }
        .table-header th { background-color: var(--bg-table-header-light); color: var(--text-table-header-light); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.8rem; padding-top: 12px; padding-bottom: 12px; border-bottom: 2px solid var(--border-table-header-light); transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        .table-row td { color: var(--text-table-row-light); border-color: var(--border-table-row-light); padding: 10px 16px; transition: color 0.3s, border-color 0.3s, background-color 0.3s; }
        .table-row:hover td { background-color: var(--bg-table-row-hover-light); }
        .input-field, .select-field { background-color: var(--bg-input-light); color: var(--text-input-light); border: 1px solid var(--border-input-light); border-radius: 6px; padding: 10px; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        .input-field:focus, .select-field:focus { border-color: var(--border-input-focus-light); box-shadow: 0 0 0 0.2rem var(--shadow-input-focus-light); outline: none; }
        .form-checkbox { border-color: var(--border-input-light); } .dark .form-checkbox { background-color: var(--bg-input-light); } .form-checkbox:checked { background-color: var(--border-input-focus-light); border-color: var(--border-input-focus-light); }
        .btn { padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: 500; text-transform: capitalize; display: inline-flex; align-items: center; gap: 8px; border: none; }
        .btn-primary { background-color: var(--bg-button-primary-light); color: var(--text-button-primary-light); } .btn-primary:hover { background-color: var(--bg-button-primary-hover-light); }
        html:not(.dark) .btn-secondary { background-color: #7f8c8d; color: white; } html:not(.dark) .btn-secondary:hover { background-color: #6c7a7b; }
        .dark .btn-secondary { background-color: #475569; color: #e2e8f0; } .dark .btn-secondary:hover { background-color: #334155; }
        html:not(.dark) .btn-info { background-color: #3498db; color: white; } html:not(.dark) .btn-info:hover { background-color: #2980b9; }
        .dark .btn-info { background-color: #5dade2; color: #1A202C; } .dark .btn-info:hover { background-color: #3498db; }
        .btn-danger { background-color: #ef4444; color: white; } .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #22c55e; color: white; } .btn-success:hover { background-color: #16a34a; }
        .btn-warning { background-color: #f59e0b; color: white; } .btn-warning:hover { background-color: #d97706; }
        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--bg-card-light); color: var(--text-card-light); margin: auto; padding: 30px; border: 1px solid var(--border-card-light); width: 90%; max-width: 900px; border-radius: 8px; position: relative; animation: slideIn 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.15); max-height: 90vh; overflow-y: auto; }
        .close-button { color: #64748b; position: absolute; right: 15px; top: 15px; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .dark .close-button { color: #9ca3af; } .close-button:hover, .close-button:focus { color: #1e293b; text-decoration: none; } .dark .close-button:hover, .dark .close-button:focus { color: #e2e8f0; }
        #recentActivityList li { border-bottom-color: var(--border-table-row-light); } #recentActivityList .text-placeholder { color: var(--text-placeholder-light); }
        #paginationControls span { color: var(--text-primary-light); } #google-login-container { margin-top: auto; padding: 15px; border-top: 1px solid #334155;}
        .dark #google-login-container { border-top-color: #4b5563; } #user-info { display: flex; align-items: center; gap: 10px; }
        #user-info img { border-radius: 50%; width: 32px; height: 32px; border: 2px solid var(--border-card-light);} #user-info span { font-size: 0.9em; font-weight: 500; }
        .checkbox-cell { width: 1%; white-space: nowrap; }
        .priority-Alta { background-color: #fee2e2 !important; color: #b91c1c !important; } .priority-Urgente { background-color: #ffedd5 !important; color: #c2410c !important; animation: pulse 1.5s infinite; }
        .priority-Média { background-color: #fef3c7 !important; color: #a16207 !important; } .priority-Baixa { background-color: #dcfce7 !important; color: #15803d !important; }
        .status-cell span { display: flex; align-items: center; }
        .manual-flag-toggle, .logistica-toggle { cursor: pointer; margin-left: 5px; } /* Classe para ícones clicáveis */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } } @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideIn { from {transform: translateY(-30px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        ::-webkit-scrollbar { width: 8px; height: 8px;} html:not(.dark) ::-webkit-scrollbar-track { background: #e2e8f0; }
        html:not(.dark) ::-webkit-scrollbar-thumb { background: #cbd5e1; } html:not(.dark) ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; } .dark ::-webkit-scrollbar-thumb { background: #475569; } .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .dark .g_id_signin div[role="button"] { background-color: #1e293b !important; color: #e2e8f0 !important; border: 1px solid #475569 !important;}
        .dark .g_id_signin svg { fill: #e2e8f0 !important; }
        .home-card-link { cursor: pointer; transition: transform 0.2s ease-in-out; } .home-card-link:hover { transform: translateY(-3px); }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="flex">
    <aside id="sidebar" class="sidebar p-3">
        <div>
            <div class="sidebar-header">
                <div id="sidebar-title" class="flex items-center"> <i class="fas fa-tasks text-2xl text-sky-500"></i> <span class="text-xl font-semibold">Gestão OS</span> </div>
                <button id="toggleSidebar" class="text-slate-400 hover:text-white focus:outline-none p-1 rounded-md"> <i class="fas fa-bars text-lg"></i> </button>
            </div>
            <nav class="flex-grow mt-2">
                <ul>
                    <li class="sidebar-item active" onclick="showView('homeView', this)"> <i class="fas fa-home"></i> <span>Home</span> </li>
                    <li class="sidebar-item" onclick="showView('osListView', this)"> <i class="fas fa-list-alt"></i> <span>Ordens de Serviço</span> </li>
                    <li class="sidebar-item" onclick="showView('reportsView', this)"> <i class="fas fa-chart-pie"></i> <span>Relatórios</span> </li>
                    <li class="sidebar-item mt-4" onclick="openAddOSModal()"> <i class="fas fa-plus-circle text-green-500"></i> <span class="text-green-500">Nova OS</span> </li>
                </ul>
            </nav>
        </div>
        <div id="google-login-container" class="px-2">
            <div id="g_id_onload" data-client_id="232267534625-ti8c7jd14nfqigmmj3lnevv8nvds3i0t.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
            <div id="user-info" class="mt-2 hidden"> <img id="user-pic" src="" alt="User Pic" class="w-8 h-8 rounded-full mr-2"> <span id="user-name" class="text-sm font-medium"></span> <button onclick="handleSignOut()" class="btn btn-xs btn-danger !p-1.5 !text-xs ml-auto"><i class="fas fa-sign-out-alt"></i></button> </div>
        </div>
        <div class="mt-auto pb-2">
            <div class="sidebar-item" onclick="toggleDarkMode()"> <i id="darkModeIcon" class="fas fa-moon"></i> <span>Modo Escuro</span> </div>
            <div class="sidebar-item" onclick="showView('settingsView', this)"> <i class="fas fa-cog"></i> <span>Configurações</span> </div>
            <div class="sidebar-item text-sm text-slate-500 dark:text-slate-400"> <i class="fas fa-info-circle"></i> <span>Versão 1.9.0</span> </div> </div>
    </aside>

    <main id="mainContent" class="content">
      <div id="homeView" class="view-section card">
            <h2 class="text-3xl font-bold mb-6">Página Inicial</h2>
            <div class="mb-6 p-4 bg-slate-100 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700">
                <h3 class="text-xl font-semibold mb-2">🎯 Objetivo do Site</h3>
                <p class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed"> Este sistema foi desenvolvido para otimizar o Gerenciamento Interno de Ordens de Serviço (OS). O objetivo principal é fornecer uma plataforma centralizada e eficiente para o cadastro, acompanhamento detalhado, filtragem avançada e geração de relatórios perspicazes sobre todas as OS. Com isso, buscamos maior organização, agilidade nos processos e melhor tomada de decisão. </p>
                <h3 class="text-xl font-semibold mt-6 mb-2">📊 Visão Geral das Funcionalidades</h3>
                <p class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed"> Explore as diversas seções do sistema para ter controle total sobre suas Ordens de Serviço: </p>
                <ul class="list-disc list-inside text-sm text-slate-700 dark:text-slate-300 mt-2 space-y-1 pl-4">
                    <li><strong>Home:</strong> Visão geral dos indicadores chave e acesso rápido às funcionalidades.</li>
                    <li><strong>Ordens de Serviço:</strong> Liste, filtre (incluindo por marcadores manuais de "Não Realizada no Prazo" e "Logística OK"), edite, gerencie e importe OS em lote.</li>
                    <li><strong>Relatórios:</strong> Gere relatórios personalizados com gráficos para análises detalhadas, incluindo filtro por marcadores manuais e novos campos de dados.</li>
                    <li><strong>Nova OS:</strong> Crie novas Ordens de Serviço de forma rápida e intuitiva, com opção para os novos marcadores.</li>
                </ul>
                <p class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed mt-3"> Utilize os cards abaixo para uma navegação ágil pelas principais métricas e seções do sistema. </p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-sky-500 to-sky-600 p-6 rounded-xl shadow-lg text-white home-card-link" onclick="navigateToOsListWithFilter('Aberta')"> <div class="flex justify-between items-center"> <h3 class="text-lg font-medium">OS Abertas</h3> <i class="fas fa-folder-open text-3xl opacity-70"></i> </div> <p id="osAbertasCount" class="text-4xl font-bold mt-2">0</p> </div>
                <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 p-6 rounded-xl shadow-lg text-white home-card-link" onclick="navigateToOsListWithFilter('Completa', true)"> <div class="flex justify-between items-center"> <h3 class="text-lg font-medium">OS Completas (Mês)</h3> <i class="fas fa-check-circle text-3xl opacity-70"></i> </div> <p id="osCompletasMesCount" class="text-4xl font-bold mt-2">0</p> </div>
                <div class="bg-gradient-to-br from-amber-500 to-amber-600 p-6 rounded-xl shadow-lg text-white home-card-link" onclick="navigateToOsListWithFilter(['Pendente Informação', 'Aguardando Aprovação'])"> <div class="flex justify-between items-center"> <h3 class="text-lg font-medium">OS Pendentes</h3> <i class="fas fa-exclamation-triangle text-3xl opacity-70"></i> </div> <p id="osPendentesCount" class="text-4xl font-bold mt-2">0</p> </div>
                <div class="bg-gradient-to-br from-rose-500 to-rose-600 p-6 rounded-xl shadow-lg text-white home-card-link" onclick="navigateToOsListWithFilter('Cancelada')"> <div class="flex justify-between items-center"> <h3 class="text-lg font-medium">OS Canceladas</h3> <i class="fas fa-times-circle text-3xl opacity-70"></i> </div> <p id="osCanceladasCount" class="text-4xl font-bold mt-2">0</p> </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card !p-0"> <div class="p-4 border-b border-slate-200 dark:border-slate-700"> <h3 class="text-xl font-semibold">Distribuição de Status das OS</h3> </div> <div id="osStatusChartContainer" class="p-4 min-h-[300px]"> <canvas id="osStatusChart"></canvas> </div> </div>
                <div class="card"> <h3 class="text-xl font-semibold mb-3">Atividades Recentes</h3> <ul id="recentActivityList" class="space-y-3 max-h-80 overflow-y-auto"> <li class="text-sm text-placeholder">Nenhuma atividade recente.</li> </ul> </div>
            </div>
        </div>

        <div id="osListView" class="view-section card hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold">Ordens de Serviço</h2>
                <div class="flex gap-2 flex-wrap items-center">
                    <div id="bulkActionsContainer" class="hidden flex gap-2 items-center mr-4"> <span id="selectedOsCount" class="text-sm">0 selecionadas</span> <select id="bulkActionStatus" class="select-field p-2 rounded-md text-sm"> <option value="">Alterar Status para...</option> <option value="Aberta">Aberta</option> <option value="Em Andamento">Em Andamento</option> <option value="Pendente Informação">Pendente Informação</option> <option value="Aguardando Aprovação">Aguardando Aprovação</option> <option value="Completa">Completa</option> <option value="Incompleta">Incompleta</option> <option value="Provisória">Provisória</option> <option value="Cancelada">Cancelada</option> </select> <button class="btn btn-sm btn-primary" onclick="applyBulkAction()"><i class="fas fa-check"></i> Aplicar</button> <button class="btn btn-sm btn-danger" onclick="bulkDeleteSelectedOS()"><i class="fas fa-trash"></i> Excluir</button> </div>
                    <button class="btn btn-success" onclick="exportTableToCSV('osTable', 'lista_os.csv')"><i class="fas fa-file-csv"></i>Exportar CSV</button>
                    <button class="btn btn-danger" onclick="exportTableToPDF('osTable', 'Lista de Ordens de Serviço', 'osTableBody')"><i class="fas fa-file-pdf"></i>Exportar PDF</button>
                    <button class="btn btn-primary" onclick="openAddOSModal()"> <i class="fas fa-plus"></i> Adicionar OS </button>
                    <button class="btn btn-info" onclick="toggleImportSection()"><i class="fas fa-file-excel"></i> Importar OS em Lote</button>
                </div>
            </div>
            
            <div id="importOsLoteContainer" class="card hidden mb-6 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-100"> <i class="fas fa-file-excel mr-2 text-green-600 dark:text-green-500"></i>Importar OS em Lote </h3>
                    <button onclick="toggleImportSection()" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 text-xl">&times;</button>
                </div>
                <p class="text-xs text-slate-600 dark:text-slate-400 mb-3"> Selecione (.xlsx, .xls, .csv). Colunas primárias: Código, Status (ex: Aberta, Completa, Incompleta, Provisória), Cliente, Início (dd/mm/aaaa hh:mm), Término (dd/mm/aaaa hh:mm), Técnico, Solicitante. </p>
                <div class="flex flex-col sm:flex-row gap-3 items-start">
                    <input type="file" id="excelFileInput" class="input-field p-2 rounded-md border-slate-300 dark:border-slate-600 text-sm w-full sm:w-auto file:mr-4 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sky-100 dark:file:bg-sky-700 file:text-sky-200 dark:file:text-sky-200 hover:file:bg-sky-200 dark:hover:file:bg-sky-600 cursor-pointer flex-grow" accept=".xlsx, .xls, .csv">
                    <button id="processExcelButton" class="btn btn-sm btn-success whitespace-nowrap w-full sm:w-auto mt-2 sm:mt-0"> <i class="fas fa-upload"></i> Processar Arquivo </button>
                </div>
                <div id="importStatusMessage" class="mt-3 text-xs"> </div>
                <div id="importSummary" class="mt-2 text-xs hidden"> <p class="font-semibold mb-1"><strong>Resumo da Importação:</strong></p> <ul id="importSummaryList" class="list-disc list-inside pl-3 space-y-0.5 max-h-32 overflow-y-auto"></ul> </div>
            </div>

            <div class="w-full md:flex-grow">
                <div class="mb-6 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700">
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <input type="text" id="filterOsNumber" placeholder="Nº OS" class="input-field p-2 rounded-md">
                        <input type="text" id="filterClient" placeholder="Cliente" class="input-field p-2 rounded-md">
                        <input type="text" id="filterDescription" placeholder="Buscar na Descrição..." class="input-field p-2 rounded-md">
                        <select id="filterProduct" class="select-field p-2 rounded-md"> <option value="">Todos os Produtos</option> </select>
                        <select id="filterStatus" class="select-field p-2 rounded-md"> <option value="">Todos os Status</option> <option value="Aberta">Aberta</option> <option value="Em Andamento">Em Andamento</option> <option value="Pendente Informação">Pendente Informação</option> <option value="Aguardando Aprovação">Aguardando Aprovação</option> <option value="Completa">Completa</option> <option value="Incompleta">Incompleta</option> <option value="Provisória">Provisória</option> <option value="Cancelada">Cancelada</option></select>
                        <div>
                            <label for="filterMarcadorAtraso" class="block text-xs font-medium mb-0.5">Atraso (Manual):</label>
                            <select id="filterMarcadorAtraso" class="select-field p-2 rounded-md w-full text-sm">
                                <option value="">Todos</option>
                                <option value="marcada">Marcada</option>
                                <option value="nao_marcada">Não Marcada</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterLogisticaOk" class="block text-xs font-medium mb-0.5">Logística Pronta:</label>
                            <select id="filterLogisticaOk" class="select-field p-2 rounded-md w-full text-sm">
                                <option value="">Todos</option>
                                <option value="sim">Sim</option>
                                <option value="nao">Não</option>
                            </select>
                        </div>
                    </div>
                     <div class="mt-4 flex flex-wrap gap-2 items-center"> <label for="savedFilters" class="text-sm font-medium">Filtros Salvos:</label> <select id="savedFilters" class="select-field p-2 rounded-md text-sm"> <option value="">Carregar filtro...</option> </select> <button class="btn btn-sm btn-secondary" onclick="loadSelectedFilter()"><i class="fas fa-download"></i> Carregar</button> <input type="text" id="newFilterName" placeholder="Nome do novo filtro" class="input-field p-2 rounded-md text-sm"> <button class="btn btn-sm btn-primary" onclick="saveCurrentFilters()"><i class="fas fa-save"></i> Salvar Filtro</button> <button class="btn btn-sm btn-danger" onclick="deleteSavedFilter()" title="Excluir filtro"><i class="fas fa-trash-alt"></i></button> </div>
                </div>

                <div class="overflow-x-auto shadow-md rounded-lg">
                    <table id="osTable" class="min-w-full">
                       <thead class="table-header"> <tr> <th class="py-3 px-2 text-center checkbox-cell"><input type="checkbox" id="selectAllOsCheckbox" onchange="toggleSelectAllOS(this)" class="form-checkbox h-4 w-4"></th><th class="py-3 px-4 text-left">Nº OS</th> <th class="py-3 px-4 text-left">Cliente</th> <th class="py-3 px-4 text-left">Produto</th> <th class="py-3 px-4 text-left">Descrição</th> <th class="py-3 px-4 text-left">Data Abertura</th> <th class="py-3 px-4 text-left">Prazo Final</th> <th class="py-3 px-4 text-left">Responsável</th> <th class="py-3 px-4 text-left">Solicitante</th> <th class="py-3 px-4 text-left">Status</th><th class="py-3 px-4 text-left">Logística</th> <th class="py-3 px-4 text-left">Prioridade</th> <th class="py-3 px-4 text-left">Ações</th> </tr> </thead> <tbody id="osTableBody" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                    </table>
                </div>
                <div id="paginationControls" class="mt-6 flex justify-end items-center gap-2"></div>
            </div>
        </div>

        <div id="reportsView" class="view-section card hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold">Relatórios Personalizados</h2>
                <div class="flex gap-2 flex-wrap items-center">
                    <button class="btn btn-success" onclick="exportTableToCSV('reportsTable', 'relatorio_os_personalizado.csv')"><i class="fas fa-file-csv"></i> CSV</button>
                    <button class="btn btn-danger" onclick="exportReportToPDFWithCharts('reportsTable', 'Relatório Personalizado de OS', 'reportsTableBody', ['reportChartByProduct', 'reportChartByUsuario', 'reportChartByStatus'])"><i class="fas fa-file-pdf"></i> PDF Detalhado</button>
                </div>
            </div>
            <div class="mb-6 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                    <div> <label for="reportDateStartFilter" class="block text-sm font-medium mb-1">Data Inicial (Prazo):</label> <input type="date" id="reportDateStartFilter" name="reportDateStartFilter" class="input-field w-full p-2 rounded-md"> </div>
                    <div> <label for="reportDateEndFilter" class="block text-sm font-medium mb-1">Data Final (Prazo):</label> <input type="date" id="reportDateEndFilter" name="reportDateEndFilter" class="input-field w-full p-2 rounded-md"> </div>
                    <div> <label for="reportStatusFilter" class="block text-sm font-medium mb-1">Status:</label> <select id="reportStatusFilter" class="select-field w-full p-2 rounded-md"> <option value="">Todos</option> <option value="Aberta">Aberta</option> <option value="Em Andamento">Em Andamento</option> <option value="Pendente Informação">Pendente Informação</option> <option value="Aguardando Aprovação">Aguardando Aprovação</option> <option value="Completa">Completa</option> <option value="Incompleta">Incompleta</option> <option value="Provisória">Provisória</option> <option value="Cancelada">Cancelada</option></select> </div>
                    <div>
                        <label for="reportFilterMarcadorAtraso" class="block text-sm font-medium mb-1">Atraso (Manual):</label>
                        <select id="reportFilterMarcadorAtraso" class="select-field w-full p-2 rounded-md">
                            <option value="">Todos</option>
                            <option value="marcada">Marcada</option>
                            <option value="nao_marcada">Não Marcada</option>
                        </select>
                    </div>
                    <div class="md:col-span-2"> <label for="reportProductFilter" class="block text-sm font-medium mb-1">Produto:</label> <select id="reportProductFilter" class="select-field w-full p-2 rounded-md"> <option value="">Todos</option></select> </div>
                    <div class="md:col-span-2">
                        <label for="reportFilterLogisticaOk" class="block text-sm font-medium mb-1">Logística Pronta:</label>
                        <select id="reportFilterLogisticaOk" class="select-field w-full p-2 rounded-md">
                            <option value="">Todos</option>
                            <option value="sim">Sim</option>
                            <option value="nao">Não</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4"> <button class="btn btn-primary" onclick="generateCustomReport()"><i class="fas fa-filter"></i> Gerar Relatório</button> </div>
            </div>
            <div id="customReportChartsContainer" class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="card !shadow-lg flex flex-col p-4 min-h-[380px]">  <h4 class="text-lg font-semibold mb-3 text-center text-slate-700 dark:text-slate-200">OS por Produto</h4>  <div class="flex-grow relative w-full h-full min-h-[280px]"> <canvas id="reportChartByProduct"></canvas> </div>  </div>
                <div class="card !shadow-lg flex flex-col p-4 min-h-[380px]">  <h4 class="text-lg font-semibold mb-3 text-center text-slate-700 dark:text-slate-200">OS por Responsável</h4>  <div class="flex-grow relative w-full h-full min-h-[280px]"> <canvas id="reportChartByUsuario"></canvas> </div>  </div>
                <div class="card !shadow-lg flex flex-col p-4 min-h-[380px]">  <h4 class="text-lg font-semibold mb-3 text-center text-slate-700 dark:text-slate-200">OS por Status (Relatório)</h4>  <div class="flex-grow relative w-full h-full min-h-[280px]"> <canvas id="reportChartByStatus"></canvas> </div>  </div>
            </div>
            <div class="overflow-x-auto shadow-md rounded-lg"> 
                <table id="reportsTable" class="min-w-full"> 
                    <thead class="table-header"> 
                        <tr> 
                            <th class="py-3 px-4 text-left">Código OS</th> 
                            <th class="py-3 px-4 text-left">Solicitante</th> 
                            <th class="py-3 px-4 text-left">Cliente</th> 
                            <th class="py-3 px-4 text-left">Data Início</th> 
                            <th class="py-3 px-4 text-left">Data Término</th> 
                            <th class="py-3 px-4 text-left">Técnico/Responsável</th> 
                            <th class="py-3 px-4 text-left">Logística Pronta</th> 
                            <th class="py-3 px-4 text-left">Produto</th> 
                        </tr> 
                    </thead> 
                    <tbody id="reportsTableBody" class="divide-y divide-slate-200 dark:divide-slate-700"> 
                        <tr class="table-row"><td colspan="8" class="text-center py-10 text-slate-500 dark:text-slate-400">Selecione filtros e clique "Gerar Relatório".</td></tr> 
                    </tbody> 
                </table> 
            </div>
        </div>
        <div id="settingsView" class="view-section card hidden">
            <h2 class="text-3xl font-bold mb-6">Configurações</h2>
            <div class="space-y-8">
                <div> <h3 class="text-xl font-semibold mb-3 border-b pb-2 border-slate-200 dark:border-slate-700">Gestão da Página</h3> <div class="space-y-4"> <div> <button class="btn btn-danger" onclick="confirmClearAllData()"><i class="fas fa-trash-alt"></i> Limpar Todos os Dados das OS</button> <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Atenção: Irreversível, apaga todas as OS salvas localmente.</p> </div> </div> </div>
                <div> <h3 class="text-xl font-semibold mb-3 border-b pb-2 border-slate-200 dark:border-slate-700">Visualização</h3> <div class="space-y-4"> <div> <label for="itemsPerPageSetting" class="block text-sm font-medium mb-1">Itens por Página na Lista de OS:</label> <input type="number" id="itemsPerPageSetting" value="10" min="5" max="50" step="5" class="input-field p-2 rounded-md w-full md:w-1/4"> <button class="btn btn-sm btn-primary ml-2" onclick="applyItemsPerPageSetting()">Aplicar</button> </div> </div> </div>
            </div>
        </div>
    </main>
    <div id="osModal" class="modal hidden"> <div class="modal-content"> <span class="close-button" onclick="closeOSModal()">&times;</span> <h3 id="modalTitle" class="text-2xl font-semibold mb-6">Adicionar Nova Ordem de Serviço</h3> <form id="osForm"> <input type="hidden" id="osId"> <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-4"> <div> <label for="osNumeroModal" class="block text-sm font-medium mb-1">Nº OS <span class="text-red-500">*</span></label> <input type="text" id="osNumeroModal" name="osNumeroModal" class="input-field w-full p-2 rounded-md" required> </div> <div> <label for="osClienteModal" class="block text-sm font-medium mb-1">Cliente <span class="text-red-500">*</span></label> <input type="text" id="osClienteModal" name="osClienteModal" class="input-field w-full p-2 rounded-md" required> </div> <div> <label for="osProdutoModal" class="block text-sm font-medium mb-1">Produto/Serviço <span class="text-red-500">*</span></label> <input type="text" id="osProdutoModal" name="osProdutoModal" list="productList" class="input-field w-full p-2 rounded-md" required> <datalist id="productList"></datalist> </div> <div> <label for="osSolicitanteModal" class="block text-sm font-medium mb-1">Solicitante</label> <input type="text" id="osSolicitanteModal" name="osSolicitanteModal" class="input-field w-full p-2 rounded-md"> </div> </div> <div class="mb-4"> <label for="osDescricaoModal" class="block text-sm font-medium mb-1">Descrição Detalhada <span class="text-red-500">*</span></label> <textarea id="osDescricaoModal" name="osDescricaoModal" rows="3" class="input-field w-full p-2 rounded-md" required></textarea> </div> <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-4"> <div> <label for="osDataAberturaModal" class="block text-sm font-medium mb-1">Data de Abertura <span class="text-red-500">*</span></label> <input type="date" id="osDataAberturaModal" name="osDataAberturaModal" class="input-field w-full p-2 rounded-md" required> </div> <div> <label for="osPrazoFinalModal" class="block text-sm font-medium mb-1">Prazo Final <span class="text-red-500">*</span></label> <input type="date" id="osPrazoFinalModal" name="osPrazoFinalModal" class="input-field w-full p-2 rounded-md" required> </div> <div> <label for="osResponsavelModal" class="block text-sm font-medium mb-1">Responsável (Colaborador) <span class="text-red-500">*</span></label> <input type="text" id="osResponsavelModal" name="osResponsavelModal" class="input-field w-full p-2 rounded-md" required> </div> <div> <label for="osStatusModal" class="block text-sm font-medium mb-1">Status <span class="text-red-500">*</span></label> <select id="osStatusModal" name="osStatusModal" class="select-field w-full p-2 rounded-md" required> <option value="Aberta">Aberta</option> <option value="Em Andamento">Em Andamento</option> <option value="Pendente Informação">Pendente Informação</option> <option value="Aguardando Aprovação">Aguardando Aprovação</option> <option value="Completa">Completa</option> <option value="Incompleta">Incompleta</option><option value="Provisória">Provisória</option> <option value="Cancelada">Cancelada</option></select> </div> </div> <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 mb-6 items-center"> <div> <label for="osPrioridadeModal" class="block text-sm font-medium mb-1">Prioridade <span class="text-red-500">*</span></label> <select id="osPrioridadeModal" name="osPrioridadeModal" class="select-field w-full p-2 rounded-md" required> <option value="Baixa">Baixa</option> <option value="Média" selected>Média</option> <option value="Alta">Alta</option> <option value="Urgente">Urgente</option> </select> </div> <div class="flex items-center pt-5"> <input type="checkbox" id="osMarcadorAtrasoModal" name="osMarcadorAtrasoModal" class="form-checkbox h-4 w-4 text-purple-600 border-slate-300 rounded focus:ring-purple-500 mr-2"> <label for="osMarcadorAtrasoModal" class="text-sm font-medium">Marcar "Não Realizada no Prazo"</label> </div> <div class="flex items-center pt-5"> <input type="checkbox" id="osLogisticaOkModal" name="osLogisticaOkModal" class="form-checkbox h-4 w-4 text-teal-600 border-slate-300 rounded focus:ring-teal-500 mr-2"> <label for="osLogisticaOkModal" class="text-sm font-medium">Logística Pronta/OK</label> </div></div> <div class="flex justify-end gap-3"> <button type="button" class="btn btn-secondary" onclick="closeOSModal()">Cancelar</button> <button type="submit" class="btn btn-primary">Salvar OS</button> </div> </form> </div> </div>
<script>
    // ==========================================================================
    // VARIÁVEIS GLOBAIS E CONFIGURAÇÕES INICIAIS
    // ==========================================================================
    const ITEMS_PER_PAGE_DEFAULT = 10;
    let ITEMS_PER_PAGE = ITEMS_PER_PAGE_DEFAULT;
    let currentPage = 1;
    let ordensServico = [];
    const defaultProducts = ["WORKNC", "EDGECAM", "ESPRIT", "ALPHACAM", "LANTEK", "SOLIDWORKS CAD", "SOLIDWORKS PDM", "SYNECO", "HEXAGON Scanner", "Impressora 3D Markforged", "Serviço de Consultoria", "Treinamento Software X", "Outro"];
    let googleUser = null;
    let savedFilters = {};

    let osStatusChartInstance = null;
    let reportChartByProductInstance = null;
    let reportChartByUsuarioInstance = null;
    let reportChartByStatusInstance = null;

    // Elementos DOM principais (alguns são definidos no DOMContentLoaded ou quando a view é mostrada)
    let osModal;
    let osForm;
    let modalTitle;
    let productDatalist;
    let filterProductSelect;
    let reportProductSelect;
    const darkModeIcon = document.getElementById('darkModeIcon');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    const sidebarTitleDiv = document.getElementById('sidebar-title');
    let recentActivityList;
    let importStatusMessage;
    let importSummaryDiv;
    let importSummaryList;


    // ==========================================================================
    // FUNÇÕES AUXILIARES DE DATA E FORMATO
    // ==========================================================================
    function formatDateToBR(dateString) {
        if (!dateString) return 'N/A';
        // Check if the dateString is already in YYYY-MM-DD format from parsing
        if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        // Fallback for other types of date inputs (e.g., Date objects if they ever appear here)
        const d = new Date(dateString);
        if (isNaN(d.getTime())) return 'N/A'; // Invalid date

        let day, month, year;
        // Use UTC methods if the dateString was a YYYY-MM-DD and converted to Date object locally
        // For consistency, assuming dateString (if not YYYY-MM-DD) might need offset handling,
        // but usually, it's already what we want.
        // If it was a 'YYYY-MM-DD' string, creating new Date() might use local timezone.
        // To be safe with 'YYYY-MM-DD' (which is what parseAndValidateDate produces):
        if (typeof dateString === 'string' && dateString.includes('-')) { // Likely 'YYYY-MM-DD'
            const parts = dateString.split('-');
            year = parseInt(parts[0],10);
            month = parseInt(parts[1],10);
            day = parseInt(parts[2],10);
             return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
        } else { // General Date object
            day = String(d.getUTCDate()).padStart(2, '0');
            month = String(d.getUTCMonth() + 1).padStart(2, '0'); // Month is 0-indexed
            year = d.getUTCFullYear();
            return `${day}/${month}/${year}`;
        }
    }

    function excelSerialDateToYYYYMMDD(serial) {
        if (serial === null || serial === undefined || serial === '' || isNaN(parseFloat(serial))) return null;
        const excelEpochDiff = 25569; // Days between 1970-01-01 and 1900-01-01 (Excel's epoch)
        let date;
         // Excel thinks 1900 is a leap year. Dates after Feb 28, 1900 need adjustment.
         if (serial >= 60) { // 60 is Feb 29, 1900 in Excel's incorrect calendar
            date = new Date(Math.round((serial - excelEpochDiff -1) * 86400 * 1000)); // The -1 adjusts for the fictional Feb 29, 1900
        } else { // Dates before March 1, 1900 (serial < 60) or serial = 60 (which is bad)
             if (serial === 60) return null; // Excel's representation of "Feb 29, 1900" which doesn't exist
            date = new Date(Math.round((serial - excelEpochDiff) * 86400 * 1000)); // No -1 needed for Jan and Feb 1900
        }
        // Ensure the date is valid after conversion
        if (isNaN(date.getTime())) return null;

        const year = date.getUTCFullYear();
        const month = String(date.getUTCMonth() + 1).padStart(2, '0'); // getUTCMonth is 0-indexed
        const day = String(date.getUTCDate()).padStart(2, '0');

        if (year < 1890 || year > 2300) return null; // Basic sanity check for year range
        return `${year}-${month}-${day}`;
    }

    // This function is the core of date parsing for import and potentially modal saving.
    // It tries to convert various inputs (JS Date, Excel serial number, common date strings)
    // into a 'YYYY-MM-DD' string.
    function parseAndValidateDate(dateValue, fieldNameForLog = "Data") {
        if (dateValue === null || String(dateValue || '').trim() === '') {
            return { date: null, error: `${fieldNameForLog} ausente.` };
        }

        let parsedDateObj = null;

        // 1. If it's already a JavaScript Date object
        if (dateValue instanceof Date) {
            if (!isNaN(dateValue.getTime())) {
                parsedDateObj = dateValue;
            }
        }
        // 2. If it's an Excel serial number (a positive number, often with decimals for time)
        //    SheetJS with `raw: true` will provide numbers for date cells.
        else if (typeof dateValue === 'number' && dateValue > 0 && dateValue < 200000) { // Common range for Excel dates
            const ymd = excelSerialDateToYYYYMMDD(dateValue); // Extracts YYYY-MM-DD from serial
            if (ymd) {
                const [year, month, day] = ymd.split('-').map(Number);
                // Create Date object at UTC midnight for the extracted date
                parsedDateObj = new Date(Date.UTC(year, month - 1, day));
            }
        }
        // 3. If it's a string, try to parse common formats
        else if (typeof dateValue === 'string') {
            let tempDateStr = String(dateValue).trim();
            let parts;

            // Try dd/mm/yyyy (or dd.mm.yyyy, dd-mm-yyyy) with optional time hh:mm:ss
            // This regex is flexible with day/month/year order and separators.
            const dateTimeRegex = /^(\d{1,2})[\\/\.-](\d{1,2})[\\/\.-](\d{2}|\d{4})(?:[ T_](\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?$/;
            if ((parts = tempDateStr.match(dateTimeRegex))) {
                const day = parseInt(parts[1], 10);
                const month = parseInt(parts[2], 10) - 1; // JS month is 0-indexed
                let year = parseInt(parts[3], 10);
                if (year < 100) year += 2000; // Convert yy to yyyy

                const hour = parts[4] ? parseInt(parts[4], 10) : 0;
                const minute = parts[5] ? parseInt(parts[5], 10) : 0;
                const second = parts[6] ? parseInt(parts[6], 10) : 0;

                // Validate day and month ranges before creating Date object
                if (month < 0 || month > 11 || day < 1 || day > 31) {
                    // Invalid month or day
                } else {
                    parsedDateObj = new Date(Date.UTC(year, month, day, hour, minute, second));
                    // Double check if the created date is valid and matches input (e.g. no Feb 30th)
                    if (parsedDateObj.getUTCFullYear() !== year ||
                        parsedDateObj.getUTCMonth() !== month ||
                        parsedDateObj.getUTCDate() !== day) {
                        parsedDateObj = null; // Invalid date created
                    }
                }
            } else {
                // Try yyyy-mm-dd (or yyyy/mm/dd, yyyy.mm.dd) as another common format (ISO-like)
                // This is also the format used by <input type="date">
                const isoDateRegex = /^(\d{4})[\\/\.-](\d{1,2})[\\/\.-](\d{1,2})(?:[ T_](\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?$/;
                if ((parts = tempDateStr.match(isoDateRegex))) {
                    const year = parseInt(parts[1], 10);
                    const month = parseInt(parts[2], 10) - 1; // JS month is 0-indexed
                    const day = parseInt(parts[3], 10);

                    const hour = parts[4] ? parseInt(parts[4], 10) : 0;
                    const minute = parts[5] ? parseInt(parts[5], 10) : 0;
                    const second = parts[6] ? parseInt(parts[6], 10) : 0;

                    if (month < 0 || month > 11 || day < 1 || day > 31) {
                        // invalid
                    } else {
                        parsedDateObj = new Date(Date.UTC(year, month, day, hour, minute, second));
                        if (parsedDateObj.getUTCFullYear() !== year ||
                            parsedDateObj.getUTCMonth() !== month ||
                            parsedDateObj.getUTCDate() !== day) {
                            parsedDateObj = null;
                        }
                    }
                }
            }
        }

        // If a valid Date object was created, format it to YYYY-MM-DD string
        if (parsedDateObj && !isNaN(parsedDateObj.getTime())) {
            const year = parsedDateObj.getUTCFullYear();
            const monthStr = String(parsedDateObj.getUTCMonth() + 1).padStart(2, '0');
            const dayStr = String(parsedDateObj.getUTCDate()).padStart(2, '0');

            if (year < 1890 || year > 2300) { // Sanity check year range
                return { date: null, error: `${fieldNameForLog} ("${String(dateValue).substring(0,20)}") ano inválido (${year}).` };
            }
            return { date: `${year}-${monthStr}-${dayStr}`, error: null };
        }

        // If no valid date could be parsed
        return { date: null, error: `${fieldNameForLog} ("${String(dateValue).substring(0,30)}") formato inválido/não reconhecido.` };
    }

    function getPriorityClass(p){switch(p){case'Alta':return'priority-Alta';case'Urgente':return'priority-Urgente';case'Média':return'priority-Média';case'Baixa':return'priority-Baixa';default:return'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300'}}
    function generateId(){return'OS'+Date.now().toString(36)+Math.random().toString(36).substr(2,5).toUpperCase()}

    // ==========================================================================
    // LOCALSTORAGE, PRODUTOS, ATIVIDADE RECENTE
    // ==========================================================================
    function saveDataToLocalStorage(){try{localStorage.setItem('ordensServicoData_v1_9_0',JSON.stringify(ordensServico));localStorage.setItem('googleUser_v1_9_0',JSON.stringify(googleUser));localStorage.setItem('darkMode_v1_9_0',document.documentElement.classList.contains('dark'));localStorage.setItem('savedFilters_v1_9_0',JSON.stringify(savedFilters));localStorage.setItem('itemsPerPage_v1_9_0',ITEMS_PER_PAGE)}catch(e){console.error("Erro ao salvar localStorage:",e);alert("Problema ao salvar dados.")}}
    function loadDataFromLocalStorage(){
        const d=localStorage.getItem('ordensServicoData_v1_9_0');
        if(d){
            try{
                ordensServico=JSON.parse(d);
                ordensServico.forEach(os => { // Data migration/defaulting for older items
                    if(os.marcadorAtrasoManual === undefined) os.marcadorAtrasoManual = false;
                    if(os.logisticaOk === undefined) os.logisticaOk = false;
                    if(os.produto === undefined) os.produto = ''; // Ensure 'produto' exists
                });
            } catch(e) {
                console.error("Erro localStorage OS:",e);ordensServico=[];
            }
        }
        const u=localStorage.getItem('googleUser_v1_9_0');if(u)try{googleUser=JSON.parse(u)}catch(e){googleUser=null}
        const dm=localStorage.getItem('darkMode_v1_9_0');if(dm==='true'){document.documentElement.classList.add('dark');if(darkModeIcon)darkModeIcon.classList.replace('fa-moon','fa-sun')}else{document.documentElement.classList.remove('dark');if(darkModeIcon)darkModeIcon.classList.replace('fa-sun','fa-moon')}
        const sf=localStorage.getItem('savedFilters_v1_9_0');if(sf)try{savedFilters=JSON.parse(sf)}catch(e){savedFilters={}}

        // Elementos dos filtros são populados depois que o DOM está pronto e as views são mostradas
        // populateSavedFiltersSelect();
        const ip=localStorage.getItem('itemsPerPage_v1_9_0');
        const ipsElement = document.getElementById('itemsPerPageSetting');
        if(ip){ITEMS_PER_PAGE=parseInt(ip,10)||ITEMS_PER_PAGE_DEFAULT;if(ipsElement)ipsElement.value=ITEMS_PER_PAGE}else{if(ipsElement)ipsElement.value=ITEMS_PER_PAGE_DEFAULT}
        // populateProductFilters(); // Called when views are shown
    }
    function populateProductFilters(){
        if(!productDatalist||!filterProductSelect||!reportProductSelect) return; // Ensure elements exist
        const p=[...new Set(ordensServico.map(os=>os.produto).concat(defaultProducts).filter(pr=>pr&&pr.trim()!==""))].sort((a,b)=>a.localeCompare(b));
        productDatalist.innerHTML='';filterProductSelect.innerHTML='<option value="">Todos Produtos</option>';reportProductSelect.innerHTML='<option value="">Todos Produtos</option>';
        p.forEach(pr=>{const o=document.createElement('option');o.value=pr;o.textContent=pr;productDatalist.appendChild(o.cloneNode(true));filterProductSelect.appendChild(o.cloneNode(true));reportProductSelect.appendChild(o.cloneNode(true))})
    }
    function addRecentActivity(a,uN=null){
        if(!recentActivityList) return; // Será definido quando a homeView for ativa
        const li=document.createElement('li');const n=new Date();let uD=uN?` <span class="font-medium text-sky-600 dark:text-sky-400">(${uN})</span>`:(googleUser?` <span class="font-medium text-slate-500 dark:text-slate-400">(${googleUser.given_name||googleUser.name})</span>`:'');
        li.className='flex justify-between items-center text-sm pb-2 border-b border-slate-200 dark:border-slate-700';
        li.innerHTML=`<span>${a}${uD}</span><span class="text-slate-400 dark:text-slate-500 text-xs">${n.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</span>`;
        const pl=recentActivityList.querySelector('.text-placeholder');if(pl)recentActivityList.innerHTML='';
        recentActivityList.insertBefore(li,recentActivityList.firstChild);
        if(recentActivityList.children.length>7)recentActivityList.removeChild(recentActivityList.lastChild)
    }

    // ==========================================================================
    // GOOGLE SIGN-IN
    // ==========================================================================
    function parseJwt(t){try{return JSON.parse(atob(t.split('.')[1]))}catch(e){return null}}
    function handleCredentialResponse(r){const pL=parseJwt(r.credential);googleUser={id:pL.sub,name:pL.name,given_name:pL.given_name,picture:pL.picture,email:pL.email};saveDataToLocalStorage();updateLoginUI();addRecentActivity(`Usuário ${googleUser.name} logado.`)}
    function handleSignOut(){const uN=googleUser?(googleUser.given_name||googleUser.name):"Usuário";googleUser=null;saveDataToLocalStorage();updateLoginUI();addRecentActivity(`${uN} deslogado.`);if(typeof google!=='undefined'&&google.accounts&&google.accounts.id)google.accounts.id.disableAutoSelect()}
    function updateLoginUI(){const uiD=document.getElementById('user-info');const gS=document.querySelector('.g_id_signin');const uNE=document.getElementById('user-name');const uPE=document.getElementById('user-pic');if(!uiD||!gS||!uNE||!uPE)return;if(googleUser){uNE.textContent=googleUser.given_name||googleUser.name;uPE.src=googleUser.picture;uiD.classList.remove('hidden');gS.classList.add('hidden')}else{uiD.classList.add('hidden');gS.classList.remove('hidden');uNE.textContent='';uPE.src=''}}

    // ==========================================================================
    // DARK MODE
    // ==========================================================================
    function toggleDarkMode(){document.documentElement.classList.toggle('dark');if(darkModeIcon){darkModeIcon.classList.toggle('fa-moon');darkModeIcon.classList.toggle('fa-sun')}saveDataToLocalStorage();if(document.getElementById('homeView')&&!document.getElementById('homeView').classList.contains('hidden')&&osStatusChartInstance)renderOSStatusChart();if(document.getElementById('reportsView')&&!document.getElementById('reportsView').classList.contains('hidden')){const rTB=document.getElementById('reportsTableBody');if(rTB&&rTB.querySelectorAll('tr').length>0&&!rTB.querySelector('td[colspan="8"]'))generateCustomReport()}}

    // ==========================================================================
    // FILTROS SALVOS
    // ==========================================================================
    function populateSavedFiltersSelect(){const sFS=document.getElementById('savedFilters');if(!sFS)return;const cS=sFS.value;sFS.innerHTML='<option value="">Carregar filtro...</option>';for(const n in savedFilters){const o=document.createElement('option');o.value=n;o.textContent=n;sFS.appendChild(o)}if(cS&&savedFilters[cS])sFS.value=cS}
    function saveCurrentFilters(){const nFIN=document.getElementById('newFilterName');if(!nFIN)return;const n=nFIN.value.trim();if(!n){alert("Especifique um nome para o filtro salvo.");return}if(savedFilters[n]&&!confirm(`O filtro salvo "${n}" já existe. Deseja sobrescrevê-lo?`))return;const fDI=document.getElementById('filterDescription');savedFilters[n]={numero:document.getElementById('filterOsNumber').value,cliente:document.getElementById('filterClient').value,descricao:fDI?fDI.value:"",produto:document.getElementById('filterProduct').value,status:document.getElementById('filterStatus').value, marcadorAtraso: document.getElementById('filterMarcadorAtraso').value, logisticaOk: document.getElementById('filterLogisticaOk').value };nFIN.value='';populateSavedFiltersSelect();saveDataToLocalStorage();addRecentActivity(`Filtro "${n}" salvo.`)}
    function loadSelectedFilter(){const sFS=document.getElementById('savedFilters');if(!sFS)return;const n=sFS.value;if(n&&savedFilters[n]){document.getElementById('filterOsNumber').value=savedFilters[n].numero||"";document.getElementById('filterClient').value=savedFilters[n].cliente||"";const fDI=document.getElementById('filterDescription');if(fDI)fDI.value=savedFilters[n].descricao||"";document.getElementById('filterProduct').value=savedFilters[n].produto||"";document.getElementById('filterStatus').value=savedFilters[n].status||""; document.getElementById('filterMarcadorAtraso').value = savedFilters[n].marcadorAtraso || ""; document.getElementById('filterLogisticaOk').value = savedFilters[n].logisticaOk || ""; applyFiltersAndRender();addRecentActivity(`Filtro "${n}" carregado.`)}else if(n)alert("Filtro salvo não encontrado.")}
    function deleteSavedFilter(){const sFS=document.getElementById('savedFilters');if(!sFS)return;const n=sFS.value;if(n&&savedFilters[n]){if(confirm(`Tem certeza que deseja excluir o filtro salvo "${n}"?`)){delete savedFilters[n];populateSavedFiltersSelect();saveDataToLocalStorage();addRecentActivity(`Filtro "${n}" excluído.`)}}else if(n)alert("O filtro salvo não existe.");else alert("Por favor, selecione um filtro salvo para excluir.")}

    // ==========================================================================
    // AÇÕES EM MASSA PARA ORDENS DE SERVIÇO
    // ==========================================================================
    function updateSelectedCount(){const sOSC=document.getElementById('selectedOsCount');const bAC=document.getElementById('bulkActionsContainer');const oSTB=document.getElementById('osTableBody');const sAOC=document.getElementById('selectAllOsCheckbox');if(!sOSC||!bAC||!oSTB||!sAOC)return;const sC=Array.from(oSTB.querySelectorAll('input[type="checkbox"][data-id]:checked'));sOSC.textContent=`${sC.length} selecionadas`;if(sC.length>0){bAC.classList.remove('hidden')}else{bAC.classList.add('hidden');sAOC.checked=false}}
    function toggleSelectAllOS(mC){const oSTB=document.getElementById('osTableBody');if(!oSTB||!mC)return;const c=oSTB.querySelectorAll('input[type="checkbox"][data-id]');c.forEach(cb=>cb.checked=mC.checked);updateSelectedCount()}
    function applyBulkAction(){const bAS=document.getElementById('bulkActionStatus');const oSTB=document.getElementById('osTableBody');const sAOC=document.getElementById('selectAllOsCheckbox');if(!bAS||!oSTB||!sAOC)return;const nS=bAS.value;if(!nS){alert("Por favor, selecione um status para aplicar.");return}const sC=Array.from(oSTB.querySelectorAll('input[type="checkbox"][data-id]:checked'));if(sC.length===0){alert("Nenhuma OS selecionada para a ação em massa.");return}sC.forEach(cb=>{const osI=cb.dataset.id;const osIX=ordensServico.findIndex(os=>os.id===osI);if(osIX!==-1)ordensServico[osIX].status=nS});addRecentActivity(`${sC.length} OS(s) tiveram o status alterado para ${nS}.`);saveDataToLocalStorage();refreshAllViews();sAOC.checked=false;updateSelectedCount()}
    function bulkDeleteSelectedOS(){const oSTB=document.getElementById('osTableBody');const sAOC=document.getElementById('selectAllOsCheckbox');if(!oSTB||!sAOC)return;const sC=Array.from(oSTB.querySelectorAll('input[type="checkbox"][data-id]:checked'));if(sC.length===0){alert("Nenhuma OS selecionada para exclusão.");return}if(confirm(`Tem certeza que deseja excluir ${sC.length} OS(s) selecionada(s)? Esta ação é irreversível.`)){const iTD=sC.map(cb=>cb.dataset.id);ordensServico=ordensServico.filter(os=>!iTD.includes(os.id));addRecentActivity(`${iTD.length} OS(s) foram excluídas.`);saveDataToLocalStorage();if(currentPage>1&&paginateData(getFilteredOS(),currentPage,ITEMS_PER_PAGE).length===0)currentPage--;refreshAllViews();sAOC.checked=false;updateSelectedCount()}}

    // ==========================================================================
    // RENDERIZAÇÃO DA TABELA DE OS E PAGINAÇÃO
    // ==========================================================================
    function toggleMarcadorAtrasoManual(osId, event) {
        event.stopPropagation(); // Impede que o clique propague para a linha da tabela (se houver listener)
        const osIndex = ordensServico.findIndex(os => os.id === osId);
        if (osIndex !== -1) {
            ordensServico[osIndex].marcadorAtrasoManual = !ordensServico[osIndex].marcadorAtrasoManual;
            addRecentActivity(`Marcador "Não Realizada no Prazo" ${ordensServico[osIndex].marcadorAtrasoManual ? 'aplicado' : 'removido'} para OS ${ordensServico[osIndex].numero}.`);
            saveDataToLocalStorage();
            applyFiltersAndRender(); // Re-renderiza a tabela para refletir a mudança no ícone e filtro
        }
    }

    function toggleLogisticaOkManual(osId, event) {
        event.stopPropagation();
        const osIndex = ordensServico.findIndex(os => os.id === osId);
        if (osIndex !== -1) {
            ordensServico[osIndex].logisticaOk = !ordensServico[osIndex].logisticaOk;
            addRecentActivity(`Marcador "Logística Pronta" ${ordensServico[osIndex].logisticaOk ? 'aplicado' : 'removido'} para OS ${ordensServico[osIndex].numero}.`);
            saveDataToLocalStorage();
            applyFiltersAndRender(); // Re-renderiza para atualizar ícone e filtro
        }
    }

    function renderOSTable(fD=getFilteredOS()){
        const oSTB=document.getElementById('osTableBody');
        const sAOC=document.getElementById('selectAllOsCheckbox');
        if(!oSTB||!sAOC){console.error("Elemento osTableBody ou selectAllOsCheckbox não encontrado no DOM!");return}
        oSTB.innerHTML='';
        sAOC.checked=false; // Desmarcar o checkbox "selecionar todos"
        updateSelectedCount(); // Atualiza a contagem de selecionados (deve ir para 0)
        if(!fD||fD.length===0){oSTB.innerHTML=`<tr><td colspan="13" class="text-center py-10 text-slate-500 dark:text-slate-400">Nenhuma Ordem de Serviço encontrada com os filtros atuais.</td></tr>`;renderPagination(0,0);return}

        const pD=paginateData(fD,currentPage,ITEMS_PER_PAGE);
        pD.forEach(os=>{
            const r=oSTB.insertRow();
            r.className='table-row hover:bg-slate-100 dark:hover:bg-slate-700';

            // Ícone para o marcador de atraso manual
            const markerAtrasoIconHTML = `
                <span class="manual-flag-toggle" onclick="toggleMarcadorAtrasoManual('${os.id}', event)" title="${os.marcadorAtrasoManual ? 'Desmarcar OS como Não Realizada no Prazo' : 'Marcar OS como Não Realizada no Prazo'}">
                    ${os.marcadorAtrasoManual ? '<i class="fas fa-flag text-purple-500"></i>' : '<i class="far fa-flag text-gray-400 hover:text-purple-500"></i>'}
                </span>`;

            // Ícone para logística OK manual
            const logisticaIconHTML = `
                <span class="logistica-toggle" onclick="toggleLogisticaOkManual('${os.id}', event)" title="${os.logisticaOk ? 'Marcar Logística como Não Pronta' : 'Marcar Logística como Pronta/OK'}">
                    ${os.logisticaOk ? '<i class="fas fa-truck text-teal-500"></i>' : '<i class="fas fa-truck text-gray-400 hover:text-teal-500"></i>'}
                </span>`;

            r.innerHTML=`<td class="py-3 px-2 text-center checkbox-cell"><input type="checkbox" data-id="${os.id}" onchange="updateSelectedCount()" class="form-checkbox h-4 w-4"></td>
                        <td class="py-3 px-4 text-sm font-medium">${markerAtrasoIconHTML} ${os.numero}</td>
                        <td class="py-3 px-4 text-sm">${os.cliente}</td>
                        <td class="py-3 px-4 text-sm">${os.produto||'N/A'}</td>
                        <td class="py-3 px-4 text-sm truncate max-w-xs" title="${os.descricao}">${os.descricao}</td>
                        <td class="py-3 px-4 text-sm">${formatDateToBR(os.dataAbertura)}</td>
                        <td class="py-3 px-4 text-sm">${formatDateToBR(os.prazoFinal)}</td>
                        <td class="py-3 px-4 text-sm">${os.responsavel}</td>
                        <td class="py-3 px-4 text-sm">${os.solicitante||'N/A'}</td>
                        <td class="py-3 px-4 text-sm"><select class="select-field status-select p-1 text-xs" data-id="${os.id}" onchange="updateStatus(this)">
                            <option value="Aberta" ${os.status==='Aberta'?'selected':''}>Aberta</option>
                            <option value="Em Andamento" ${os.status==='Em Andamento'?'selected':''}>Em Andamento</option>
                            <option value="Pendente Informação" ${os.status==='Pendente Informação'?'selected':''}>Pendente Info</option>
                            <option value="Aguardando Aprovação" ${os.status==='Aguardando Aprovação'?'selected':''}>Aguard. Aprov.</option>
                            <option value="Completa" ${os.status==='Completa'?'selected':''}>Completa</option>
                            <option value="Incompleta" ${os.status==='Incompleta'?'selected':''}>Incompleta</option>
                            <option value="Provisória" ${os.status==='Provisória'?'selected':''}>Provisória</option>
                            <option value="Cancelada" ${os.status==='Cancelada'?'selected':''}>Cancelada</option>
                        </select></td>
                        <td class="py-3 px-4 text-sm text-center">${logisticaIconHTML}</td>
                        <td class="py-3 px-4 text-sm"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getPriorityClass(os.prioridade)}">${os.prioridade}</span></td>
                        <td class="py-3 px-4 text-sm"><button class="text-sky-600 hover:text-sky-800 p-1 mr-2" title="Editar" onclick="editOS('${os.id}')"><i class="fas fa-edit"></i></button><button class="text-red-600 hover:text-red-800 p-1 mr-2" title="Excluir" onclick="deleteOS('${os.id}')"><i class="fas fa-trash"></i></button><button class="text-green-600 hover:text-green-800 p-1" title="Baixar .ics" onclick="downloadICS('${os.id}')"><i class="fas fa-calendar-plus"></i></button></td>`
        });
        renderPagination(fD.length,currentPage);
    }
    function paginateData(d,p,iPP){const s=(p-1)*iPP;const e=s+iPP;return d.slice(s,e)}
    function renderPagination(tI,p){const pC=document.getElementById('paginationControls');if(!pC)return;pC.innerHTML='';const tP=Math.ceil(tI/ITEMS_PER_PAGE);if(tP<=1)return;const pB=document.createElement('button');pB.innerHTML='<i class="fas fa-chevron-left"></i> Anterior';pB.className='btn btn-sm btn-secondary disabled:opacity-50';pB.disabled=p===1;pB.onclick=()=>{if(p>1)changePage(p-1)};pC.appendChild(pB);const pI=document.createElement('span');pI.className='text-sm px-3';pI.textContent=`Página ${p} de ${tP}`;pC.appendChild(pI);const nB=document.createElement('button');nB.innerHTML='Próximo <i class="fas fa-chevron-right"></i>';nB.className='btn btn-sm btn-secondary disabled:opacity-50';nB.disabled=p===tP;nB.onclick=()=>{if(p<tP)changePage(p+1)};pC.appendChild(nB)}
    function changePage(nP){currentPage=nP;renderOSTable()}

    // ==========================================================================
    // CRUD DE OS E MODAL (CRIAÇÃO, EDIÇÃO, EXCLUSÃO)
    // ==========================================================================
    function updateStatus(sE){const osI=sE.dataset.id;const nS=sE.value;const osIX=ordensServico.findIndex(os=>os.id===osI);if(osIX!==-1){ordensServico[osIX].status=nS;addRecentActivity(`Status da OS ${ordensServico[osIX].numero} alterado para ${nS}.`);saveDataToLocalStorage();refreshAllViews()}}
    function openAddOSModal(){
        const currentOsForm = document.getElementById('osForm'); // osForm é global, mas pegar aqui garante
        const currentModalTitle = document.getElementById('modalTitle'); // modalTitle é global
        const currentOsModal = document.getElementById('osModal'); // osModal é global

        if(!currentOsForm||!currentModalTitle||!currentOsModal)return;
        currentOsForm.reset();
        document.getElementById('osId').value='';
        currentModalTitle.textContent='Adicionar Nova Ordem de Serviço';
        const dA=document.getElementById('osDataAberturaModal');
        if(dA)dA.value=new Date().toISOString().split('T')[0]; // Data atual no formato YYYY-MM-DD
        document.getElementById('osMarcadorAtrasoModal').checked = false; // Resetar checkbox
        document.getElementById('osLogisticaOkModal').checked = false; // Resetar checkbox
        currentOsModal.classList.remove('hidden');
    }
    function closeOSModal(){
        const currentOsModal = document.getElementById('osModal');
        if(!currentOsModal)return;currentOsModal.classList.add('hidden');
    }
    function editOS(id){
        const currentOsModal = document.getElementById('osModal');
        const currentModalTitle = document.getElementById('modalTitle');
        // const currentOsForm = document.getElementById('osForm'); // Não é necessário aqui
        if(!currentOsModal||!currentModalTitle)return;

        const os=ordensServico.find(o=>o.id===id);
        if(os){
            currentModalTitle.textContent=`Editar OS - ${os.numero}`;
            document.getElementById('osId').value=os.id;
            document.getElementById('osNumeroModal').value=os.numero;
            document.getElementById('osClienteModal').value=os.cliente;
            document.getElementById('osProdutoModal').value=os.produto||'';
            document.getElementById('osSolicitanteModal').value=os.solicitante||'';
            document.getElementById('osDescricaoModal').value=os.descricao;
            document.getElementById('osDataAberturaModal').value=os.dataAbertura; // Deve ser YYYY-MM-DD
            document.getElementById('osPrazoFinalModal').value=os.prazoFinal;   // Deve ser YYYY-MM-DD
            document.getElementById('osResponsavelModal').value=os.responsavel;
            document.getElementById('osStatusModal').value=os.status;
            document.getElementById('osPrioridadeModal').value=os.prioridade;
            document.getElementById('osMarcadorAtrasoModal').checked = os.marcadorAtrasoManual || false;
            document.getElementById('osLogisticaOkModal').checked = os.logisticaOk || false;
            currentOsModal.classList.remove('hidden');
        } else alert("OS não encontrada para edição.");
    }
    function deleteOS(id){const oTD=ordensServico.find(os=>os.id===id);if(confirm(`Tem certeza que deseja excluir a OS ${oTD?.numero||id}? Esta ação é irreversível.`)){ordensServico=ordensServico.filter(os=>os.id!==id);addRecentActivity(`OS ${oTD?.numero||'ID '+id} foi excluída.`);saveDataToLocalStorage();if(currentPage>1&&paginateData(getFilteredOS(),currentPage,ITEMS_PER_PAGE).length===0)currentPage--;refreshAllViews()}}
// ==========================================================================
    // LÓGICA DE IMPORTAÇÃO DE EXCEL/CSV (Função de processamento de dados)
    // ==========================================================================
    function processAndValidateOSData(jsonData) {
        // jsonData[0] são os cabeçalhos, jsonData.slice(1) são as linhas de dados
        const headersFromFile = jsonData[0].map(header => String(header || '').trim().toLowerCase());
        const dataRows = jsonData.slice(1);
        const validOSs = [];
        const importLog = [];

        // Mapeamento esperado das colunas do CSV para as chaves internas do objeto OS
        // Certifique-se que 'início' e 'término' correspondem aos nomes exatos (case-insensitive)
        // das colunas no seu arquivo CSV que contêm as datas.
        const expectedHeaderMapping = {
            codigo: 'código', status: 'status', cliente: 'cliente', inicio: 'início', termino: 'término',
            tecnico: 'técnico', solicitante: 'solicitante', cidade: 'cidade', duracao_h: 'duração (h)',
            produto_import: 'produto' // 'produto_import' para evitar conflito com os.produto se já existir
        };
        const colIndices = {};
        for (const internalKey in expectedHeaderMapping) {
            colIndices[internalKey] = headersFromFile.indexOf(expectedHeaderMapping[internalKey]);
        }

        // Verificar se as colunas essenciais para datas foram encontradas
        const essentialCols = ['codigo', 'cliente', 'inicio', 'termino', 'tecnico', 'solicitante'];
        for (const colKey of essentialCols) {
            if (colIndices[colKey] === -1) {
                importLog.push({ success: false, message: `Erro Crítico: A coluna essencial "${expectedHeaderMapping[colKey]}" não foi encontrada no arquivo. A importação foi interrompida.` });
                return { validOSs, importLog }; // Interrompe se colunas cruciais faltam
            }
        }

        dataRows.forEach((row, rowIndex) => {
            // Pular linhas completamente vazias
            if (row.every(cell => cell === null || String(cell || '').trim() === '')) return;

            const newOS = {
                id: generateId(), // Gera um ID único para a nova OS
                produto: colIndices.produto_import !== -1 && String(row[colIndices.produto_import] || '').trim() !== '' ? String(row[colIndices.produto_import]).trim() : "N/A (Importado)",
                prioridade: "Média", // Default, pode ser ajustado se houver no CSV
                marcadorAtrasoManual: false,
                logisticaOk: false
            };
            let rowIsValid = true;
            let currentLogMessages = [];

            // Nº OS (Código)
            newOS.numero = colIndices.codigo !== -1 ? String(row[colIndices.codigo] || '').trim() : '';
            if (!newOS.numero) { currentLogMessages.push("Nº OS (Coluna 'Código') ausente ou vazia."); rowIsValid = false; }

            // Cliente
            newOS.cliente = colIndices.cliente !== -1 ? String(row[colIndices.cliente] || '').trim() : '';
            if (!newOS.cliente) { currentLogMessages.push("Cliente (Coluna 'Cliente') ausente ou vazio."); rowIsValid = false; }

            // Status
            newOS.status = colIndices.status !== -1 && String(row[colIndices.status] || '').trim() !== '' ? String(row[colIndices.status]).trim() : 'Aberta';
            const validStatuses = ["Aberta", "Em Andamento", "Pendente Informação", "Aguardando Aprovação", "Completa", "Incompleta", "Provisória", "Cancelada"];
            if (!validStatuses.includes(newOS.status)) {
                currentLogMessages.push(`Status "${newOS.status}" inválido. Será usado "Aberta".`); newOS.status = 'Aberta';
            }

            // Data Início e Término
            const inicioVal = colIndices.inicio !== -1 ? row[colIndices.inicio] : null;
            const terminoVal = colIndices.termino !== -1 ? row[colIndices.termino] : null;

            const dataAberturaResult = parseAndValidateDate(inicioVal, "Data Início (Coluna 'Início')");
            if (dataAberturaResult.error) { currentLogMessages.push(dataAberturaResult.error); rowIsValid = false; }
            newOS.dataAbertura = dataAberturaResult.date; // Deve ser 'YYYY-MM-DD' ou null

            const prazoFinalResult = parseAndValidateDate(terminoVal, "Data Término (Coluna 'Término')");
            if (prazoFinalResult.error) { currentLogMessages.push(prazoFinalResult.error); rowIsValid = false; }
            newOS.prazoFinal = prazoFinalResult.date; // Deve ser 'YYYY-MM-DD' ou null

            if (newOS.dataAbertura && newOS.prazoFinal && new Date(newOS.prazoFinal) < new Date(newOS.dataAbertura)) {
                currentLogMessages.push("Data de Prazo Final não pode ser anterior à Data de Início."); rowIsValid = false;
            }

            // Responsável (Técnico)
            newOS.responsavel = colIndices.tecnico !== -1 ? String(row[colIndices.tecnico] || '').trim() : '';
            if (!newOS.responsavel) { currentLogMessages.push("Responsável (Coluna 'Técnico') ausente ou vazio."); rowIsValid = false; }

            // Solicitante
            newOS.solicitante = colIndices.solicitante !== -1 ? String(row[colIndices.solicitante] || '').trim() : '';
             if (!newOS.solicitante && essentialCols.includes('solicitante')) { // Se for uma coluna essencial e estiver faltando
                currentLogMessages.push("Solicitante (Coluna 'Solicitante') ausente ou vazio."); rowIsValid = false;
            }


            // Descrição (pode ser concatenada de outras colunas ou padrão)
            let descParts = [];
            const cidadeVal = colIndices.cidade !== -1 && row[colIndices.cidade] ? String(row[colIndices.cidade]).trim() : '';
            if (cidadeVal) descParts.push(`Cidade: ${cidadeVal}`);

            const duracaoVal = colIndices.duracao_h !== -1 && row[colIndices.duracao_h] ? String(row[colIndices.duracao_h]).trim() : '';
            if (duracaoVal) descParts.push(`Duração: ${duracaoVal}h`);

            if (descParts.length > 0) {
                newOS.descricao = descParts.join(', ') + ". (Importado via Excel)";
            } else {
                newOS.descricao = "(Importado via Excel)"; // Descrição padrão
            }
             newOS.descricao += "\n"; // Adiciona uma nova linha para melhor formatação se necessário


            if (rowIsValid) {
                validOSs.push(newOS);
            } else {
                importLog.push({ success: false, message: `Linha ${rowIndex + 2} da planilha (${newOS.numero || 'OS sem número'}) ignorada: ${currentLogMessages.join('; ')}` });
            }
        });
        return { validOSs, importLog };
    }

    // ==========================================================================
    // FUNÇÃO PRINCIPAL PARA LIDAR COM A IMPORTAÇÃO DE ARQUIVO EXCEL/CSV
    // ==========================================================================
    function handleExcelImport() {
        const fileInput = document.getElementById('excelFileInput');
        const currentImportStatusMessage = document.getElementById('importStatusMessage');
        const currentImportSummaryDiv = document.getElementById('importSummary');
        const currentImportSummaryList = document.getElementById('importSummaryList');

        if (!fileInput || !currentImportStatusMessage || !currentImportSummaryDiv || !currentImportSummaryList) {
            console.error("Elementos da interface de importação não encontrados no DOM.");
            alert("Erro interno na interface de importação. Verifique o console para mais detalhes.");
            return;
        }

        currentImportStatusMessage.textContent = ''; // Limpar mensagens anteriores
        currentImportSummaryList.innerHTML = '';
        currentImportSummaryDiv.classList.add('hidden');

        if (!fileInput.files || fileInput.files.length === 0) {
            currentImportStatusMessage.textContent = 'Por favor, selecione um arquivo Excel ou CSV para importar.';
            currentImportStatusMessage.className = 'mt-4 text-sm text-red-600 dark:text-red-400';
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        currentImportStatusMessage.textContent = `Iniciando processamento do arquivo: ${file.name}...`;
        currentImportStatusMessage.className = 'mt-4 text-sm text-sky-600 dark:text-sky-400';

        reader.onload = function(event) {
            try {
                const data = event.target.result;
                if (typeof XLSX === 'undefined') {
                    throw new Error("A biblioteca SheetJS (XLSX) não está carregada. Verifique o link CDN no HTML.");
                }
                // Usar cellDates:false (ou omitir) para que o raw:true abaixo possa pegar os números de série do Excel.
                // dateNF é mais para formatação de saída, não afeta a leitura para raw numbers.
                const workbook = XLSX.read(data, { type: 'array' }); // Simplificado, cellDates default é false
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // **** ALTERAÇÃO PRINCIPAL AQUI: raw: true ****
                // Isso garante que os números de série do Excel sejam passados como números
                // para a função parseAndValidateDate, que já os manipula corretamente.
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 , raw: true, defval: null});

                // Remover linhas finais completamente vazias que o XLSX pode incluir
                while (jsonData.length > 0 && jsonData[jsonData.length - 1].every(cell => cell === null || String(cell || '').trim() === '')) {
                    jsonData.pop();
                }

                if (jsonData.length < 2) { // Precisa de cabeçalho + pelo menos uma linha de dados
                    throw new Error("O arquivo parece estar vazio ou contém apenas o cabeçalho. Nenhuma linha de dados para importar.");
                }

                const { validOSs, importLog } = processAndValidateOSData(jsonData);

                if (validOSs.length > 0) {
                    ordensServico.unshift(...validOSs); // Adiciona as novas OS no início da lista
                    saveDataToLocalStorage();
                    populateProductFilters(); // Atualizar filtros de produto com novos dados
                    refreshAllViews(); // Atualiza a tabela e outras visualizações
                    addRecentActivity(`${validOSs.length} OS(s) foram importada(s) com sucesso do arquivo: ${file.name}.`);
                }

                let finalMessage = validOSs.length > 0 ? `${validOSs.length} OS(s) importada(s) com sucesso! ` : "Nenhuma OS foi importada com sucesso. ";
                currentImportStatusMessage.className = `mt-4 text-sm ${validOSs.length > 0 ? 'text-green-600 dark:text-green-400' : 'text-amber-600 dark:text-amber-400'}`;

                const errorsCount = importLog.filter(log => !log.success).length;
                if (errorsCount > 0) {
                    finalMessage += `${errorsCount} linha(s) da planilha continham erros e foram ignoradas. Veja o resumo abaixo para detalhes.`;
                    // Mudar a cor se houver erros, mesmo que algumas OSs tenham sido importadas
                    currentImportStatusMessage.className = `mt-4 text-sm ${validOSs.length > 0 ? 'text-amber-600 dark:text-amber-400' : 'text-red-600 dark:text-red-400'}`;
                }
                 // Caso o arquivo tenha dados mas nada foi validado (ex: problema geral de formato)
                 if (validOSs.length === 0 && errorsCount === 0 && jsonData.slice(1).filter(r => !r.every(c => c === null || String(c || '').trim() === '')).length > 0) {
                    finalMessage = `Arquivo lido, mas nenhuma OS válida foi processada. Verifique o formato dos dados e se as colunas essenciais (Código, Cliente, Início, Término, Técnico, Solicitante) estão corretas e presentes na primeira linha da planilha.`;
                    currentImportStatusMessage.className = 'mt-4 text-sm text-amber-600 dark:text-amber-400';
                }


                currentImportStatusMessage.textContent = finalMessage.trim();

                if (importLog.length > 0) {
                    currentImportSummaryDiv.classList.remove('hidden');
                    importLog.forEach(log => {
                        const listItem = document.createElement('li');
                        listItem.textContent = log.message;
                        listItem.className = log.success ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300';
                        currentImportSummaryList.appendChild(listItem);
                    });
                }

            } catch (error) {
                console.error("Erro detalhado ao processar o arquivo Excel/CSV:", error);
                currentImportStatusMessage.textContent = `Erro crítico durante o processamento: ${error.message}. Verifique o console para mais informações.`;
                currentImportStatusMessage.className = 'mt-4 text-sm text-red-600 dark:text-red-400';
                currentImportSummaryDiv.classList.add('hidden'); // Esconder resumo em caso de erro catastrófico
            } finally {
                fileInput.value = ''; // Limpar o input de arquivo para permitir nova seleção do mesmo arquivo
            }
        };
        reader.onerror = function(error) { // Adicionado para tratar erros de leitura do arquivo em si
            console.error("Erro ao ler o arquivo:", error);
            currentImportStatusMessage.textContent = 'Ocorreu um erro ao tentar ler o arquivo. Verifique se é um arquivo Excel/CSV válido e tente novamente.';
            currentImportStatusMessage.className = 'mt-4 text-sm text-red-600 dark:text-red-400';
            fileInput.value = ''; // Limpar o input
        };
        reader.readAsArrayBuffer(file); // Inicia a leitura do arquivo
    }

    function toggleImportSection() {
        const importSection = document.getElementById('importOsLoteContainer');
        if (importSection) {
            importSection.classList.toggle('hidden');
            if (!importSection.classList.contains('hidden')) {
                addRecentActivity("Interface de importação em lote aberta.");
            } else {
                addRecentActivity("Interface de importação em lote fechada.");
                 // Limpar mensagens de status ao fechar
                const currentImportStatusMessage = document.getElementById('importStatusMessage');
                const currentImportSummaryDiv = document.getElementById('importSummary');
                const currentImportSummaryList = document.getElementById('importSummaryList');
                if(currentImportStatusMessage) currentImportStatusMessage.textContent = '';
                if(currentImportSummaryList) currentImportSummaryList.innerHTML = '';
                if(currentImportSummaryDiv) currentImportSummaryDiv.classList.add('hidden');
            }
        }
    }

    // ==========================================================================
    // FUNÇÕES DE NAVEGAÇÃO E EXIBIÇÃO DE VIEWS
    // ==========================================================================
    function showView(vId,cE){ // cE é o elemento do sidebar clicado
        document.querySelectorAll('.view-section').forEach(s=>s.classList.add('hidden'));
        const tV=document.getElementById(vId); // Target View
        if(tV)tV.classList.remove('hidden');
        else{ document.getElementById('homeView').classList.remove('hidden'); console.error(`View '${vId}' não encontrada, exibindo Home.`); } // Fallback
        document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));
        if(cE&&cE.classList.contains('sidebar-item'))cE.classList.add('active');

        // Inicializa elementos específicos da view aqui, pois agora eles estão visíveis
        if (vId === 'homeView') {
            recentActivityList = document.getElementById('recentActivityList'); // Garante que está atualizado
        } else if (vId === 'osListView') {
            importStatusMessage = document.getElementById('importStatusMessage');
            importSummaryDiv = document.getElementById('importSummary');
            importSummaryList = document.getElementById('importSummaryList');
             // Garantir que filtros salvos e de produto sejam populados se a view for osListView ou reportsView
            populateSavedFiltersSelect();
            populateProductFilters();
        } else if (vId === 'reportsView') {
            populateProductFilters(); // Produtos também são usados em relatórios
        }


        // Se sair da view de OS, esconder a seção de importação se estiver aberta.
        const importOsLoteContainer = document.getElementById('importOsLoteContainer');
        if (vId !== 'osListView' && importOsLoteContainer && !importOsLoteContainer.classList.contains('hidden')) {
             importOsLoteContainer.classList.add('hidden');
             // Limpar mensagens de status ao esconder
             if(importStatusMessage) importStatusMessage.textContent = '';
             if(importSummaryList) importSummaryList.innerHTML = '';
             if(importSummaryDiv) importSummaryDiv.classList.add('hidden');
        }

        // Limpar instâncias de gráficos se não estiver na view de relatórios
        if(vId!=='reportsView'){
            if(reportChartByProductInstance){reportChartByProductInstance.destroy();reportChartByProductInstance=null}
            if(reportChartByUsuarioInstance){reportChartByUsuarioInstance.destroy();reportChartByUsuarioInstance=null}
            if(reportChartByStatusInstance){reportChartByStatusInstance.destroy();reportChartByStatusInstance=null}
        }
        // Lógica específica de cada view
        if(vId==='homeView'){updateHomeCounts();renderOSStatusChart()}
        else if(vId==='osListView'){applyFiltersAndRender()} // Renderiza a tabela de OS com filtros
        else if(vId==='reportsView'){generateCustomReport()} // Gera ou limpa relatórios
        else if(vId==='settingsView'){const iPSI=document.getElementById('itemsPerPageSetting');if(iPSI)iPSI.value=ITEMS_PER_PAGE}
    }

    // Lógica da Sidebar (Toggle)
    const mainSidebar = document.getElementById('sidebar');
    const mainContentArea = document.getElementById('mainContent');
    const mainToggleSidebarBtn = document.getElementById('toggleSidebar');
    // const mainSidebarTitleDiv = document.getElementById('sidebar-title'); // Já definido globalmente

    if(mainToggleSidebarBtn && mainSidebar && mainContentArea && sidebarTitleDiv){ // sidebarTitleDiv é global
        mainToggleSidebarBtn.addEventListener('click',()=>{
            mainSidebar.classList.toggle('collapsed');
            mainContentArea.classList.toggle('collapsed');
            const iC=mainSidebar.classList.contains('collapsed'); // isCollapsed
            mainToggleSidebarBtn.innerHTML=iC?'<i class="fas fa-chevron-right text-lg"></i>':'<i class="fas fa-bars text-lg"></i>';
            const tS=sidebarTitleDiv.querySelector('span');if(tS)tS.style.display=iC?'none':'inline';
            const tI=sidebarTitleDiv.querySelector('i');if(tI)tI.style.marginRight=iC?'0':'0.5rem';
            // Redesenhar gráficos se a sidebar for expandida e os gráficos estiverem visíveis
            if(!iC && document.getElementById('homeView') && !document.getElementById('homeView').classList.contains('hidden'))setTimeout(()=>{if(osStatusChartInstance)osStatusChartInstance.resize()},310); // Delay para transição
            if(!iC && document.getElementById('reportsView') && !document.getElementById('reportsView').classList.contains('hidden'))setTimeout(()=>{if(reportChartByProductInstance)reportChartByProductInstance.resize();if(reportChartByUsuarioInstance)reportChartByUsuarioInstance.resize();if(reportChartByStatusInstance)reportChartByStatusInstance.resize()},310);
        });
    }
// ==========================================================================
    // LÓGICA DE FILTROS DA LISTA PRINCIPAL, HOME VIEW E ATUALIZAÇÃO GERAL
    // ==========================================================================
    function getFilteredOS() {
        // Valores dos filtros, convertidos para minúsculas para busca case-insensitive
        const fONV = document.getElementById('filterOsNumber')?.value.toLowerCase() || "";
        const fCV = document.getElementById('filterClient')?.value.toLowerCase() || "";
        const fSV = document.getElementById('filterStatus')?.value || ""; // Status é case-sensitive
        const fPV = document.getElementById('filterProduct')?.value || ""; // Produto é case-sensitive
        const fDV = document.getElementById('filterDescription')?.value.toLowerCase() || "";
        const fMAV = document.getElementById('filterMarcadorAtraso')?.value || ""; // 'marcada', 'nao_marcada', ''
        const fLOV = document.getElementById('filterLogisticaOk')?.value || "";  // 'sim', 'nao', ''

        return ordensServico.filter(os => {
            const matchNumero = (os.numero?.toLowerCase() || "").includes(fONV);
            const matchCliente = (os.cliente?.toLowerCase() || "").includes(fCV);
            const matchStatus = fSV ? os.status === fSV : true;
            const matchProduto = fPV ? os.produto === fPV : true;
            const matchDescricao = (os.descricao?.toLowerCase() || "").includes(fDV);

            let matchMarcadorAtraso = true;
            if (fMAV === "marcada") matchMarcadorAtraso = os.marcadorAtrasoManual === true;
            else if (fMAV === "nao_marcada") matchMarcadorAtraso = os.marcadorAtrasoManual === false;

            let matchLogisticaOk = true;
            if (fLOV === "sim") matchLogisticaOk = os.logisticaOk === true;
            else if (fLOV === "nao") matchLogisticaOk = os.logisticaOk === false;

            return matchNumero && matchCliente && matchStatus && matchProduto && matchDescricao && matchMarcadorAtraso && matchLogisticaOk;
        });
    }
    function applyFiltersAndRender(){currentPage=1;renderOSTable()} // Reseta para a primeira página ao aplicar filtros
    function updateHomeCounts(){const oAE=document.getElementById('osAbertasCount');const oCME=document.getElementById('osCompletasMesCount');const oPE=document.getElementById('osPendentesCount');const oCaE=document.getElementById('osCanceladasCount');if(oAE)oAE.textContent=ordensServico.filter(os=>os.status==='Aberta').length;const h=new Date();const pDM=new Date(h.getFullYear(),h.getMonth(),1);const uDM=new Date(h.getFullYear(),h.getMonth()+1,0,23,59,59,999);if(oCME)oCME.textContent=ordensServico.filter(os=>{if(os.status!=='Completa')return false;const dC=os.dataFechamento?new Date(os.dataFechamento+'T00:00:00Z'):(os.prazoFinal?new Date(os.prazoFinal+'T00:00:00Z'):null);if(!dC)return false;return dC>=pDM&&dC<=uDM}).length;if(oPE)oPE.textContent=ordensServico.filter(os=>os.status==='Pendente Informação'||os.status==='Aguardando Aprovação').length;if(oCaE)oCaE.textContent=ordensServico.filter(os=>os.status==='Cancelada').length}
    function renderOSStatusChart(){const cC=document.getElementById('osStatusChart');const oSCCC=document.getElementById('osStatusChartContainer');if(!cC||!oSCCC||oSCCC.offsetParent===null)return;const ctx=cC.getContext('2d');const iDM=document.documentElement.classList.contains('dark');const sC=ordensServico.reduce((acc,os)=>{acc[os.status]=(acc[os.status]||0)+1;return acc},{});const sCo={'Aberta':'rgba(54,162,235,0.8)','Em Andamento':'rgba(255,159,64,0.8)','Pendente Informação':'rgba(255,205,86,0.8)','Aguardando Aprovação':'rgba(153,102,255,0.8)','Completa':'rgba(75,192,192,0.8)','Cancelada':'rgba(255,99,132,0.8)', 'Incompleta':'rgba(201, 203, 207, 0.8)', 'Provisória': 'rgba(160, 160, 160, 0.8)'};const bC=Object.keys(sC).map(s=>sCo[s]||'rgba(201,203,207,0.8)');const d={labels:Object.keys(sC),datasets:[{label:'OS por Status',data:Object.values(sC),backgroundColor:bC,borderColor:iDM?getComputedStyle(document.documentElement).getPropertyValue('--bg-card-light').trim():'#fff',borderWidth:2,hoverOffset:8}]};if(osStatusChartInstance)osStatusChartInstance.destroy();osStatusChartInstance=new Chart(ctx,{type:'doughnut',data:d,options:{responsive:true,maintainAspectRatio:false,animation:{animateScale:true,animateRotate:true},plugins:{legend:{position:'bottom',labels:{padding:15,font:{size:11},color:iDM?getComputedStyle(document.documentElement).getPropertyValue('--text-primary-light').trim():'#1e293b'}},tooltip:{backgroundColor:iDM?'rgba(30,41,59,0.9)':'rgba(255,255,255,0.9)',titleColor:iDM?'#f1f5f9':'#1e293b',bodyColor:iDM?'#cbd5e1':'#334155',borderColor:iDM?'#475569':'#e2e8f0',borderWidth:1,callbacks:{label:function(c){const p=((c.parsed/c.chart.getDatasetMeta(0).total)*100).toFixed(1);return`${c.label||''}: ${c.parsed||0} (${p}%)`}}}}}})}
    function navigateToOsListWithFilter(sF,fCMP=false){const fSI=document.getElementById('filterStatus');const fONI=document.getElementById('filterOsNumber');const fCI=document.getElementById('filterClient');const fPI=document.getElementById('filterProduct');const fDI=document.getElementById('filterDescription'); const fMAI = document.getElementById('filterMarcadorAtraso'); const fLOKI = document.getElementById('filterLogisticaOk'); if(fONI)fONI.value="";if(fCI)fCI.value="";if(fPI)fPI.value="";if(fDI)fDI.value=""; if(fMAI) fMAI.value = ""; if(fLOKI) fLOKI.value=""; if(fSI){if(Array.isArray(sF)){fSI.value="";addRecentActivity("Visualizando OS. Refine os filtros para visualizar OS pendentes.")}else{fSI.value=sF}}showView('osListView',document.querySelector('.sidebar-item[onclick*="osListView"]'))}
    function refreshAllViews(){renderOSTable();updateHomeCounts();if(document.getElementById('homeView')&&!document.getElementById('homeView').classList.contains('hidden'))renderOSStatusChart();const rVE=document.getElementById('reportsView');if(rVE&&!rVE.classList.contains('hidden'))generateCustomReport()}


    // ==========================================================================
    // RELATÓRIOS PERSONALIZADOS
    // ==========================================================================
    function generateCustomReport() {
        const rTB = document.getElementById('reportsTableBody');
        const rDSI = document.getElementById('reportDateStartFilter');
        const rDEI = document.getElementById('reportDateEndFilter');
        const rSI = document.getElementById('reportStatusFilter');
        const rPI = document.getElementById('reportProductFilter');
        const rFMAI = document.getElementById('reportFilterMarcadorAtraso');
        const rFLOKI = document.getElementById('reportFilterLogisticaOk');

        if (!rTB || !rDSI || !rDEI || !rSI || !rPI || !rFMAI || !rFLOKI) return;
        rTB.innerHTML = ''; // Limpar tabela
        // Limpar gráficos anteriores
        if (reportChartByProductInstance) { reportChartByProductInstance.destroy(); reportChartByProductInstance = null; }
        if (reportChartByUsuarioInstance) { reportChartByUsuarioInstance.destroy(); reportChartByUsuarioInstance = null; }
        if (reportChartByStatusInstance) { reportChartByStatusInstance.destroy(); reportChartByStatusInstance = null; }
        document.getElementById('customReportChartsContainer').querySelectorAll('canvas').forEach(c => {
            const ctx = c.getContext('2d'); ctx.clearRect(0, 0, c.width, c.height);
        });

        const dSV = rDSI.value; // Data Start Value
        const dEV = rDEI.value; // Data End Value
        const sV = rSI.value;   // Status Value
        const pV = rPI.value;   // Product Value
        const fMAVal = rFMAI.value; // Filtro Marcador Atraso Value
        const fLOKVal = rFLOKI.value; // Filtro Logística OK Value

        if (dSV && dEV && new Date(dEV) < new Date(dSV)) {
            alert("A Data Final do relatório não pode ser anterior à Data Inicial.");
            rTB.innerHTML = '<tr><td colspan="8" class="text-center py-10 text-red-500">Erro: Data Final anterior à Data Inicial.</td></tr>';
            return;
        }

        const fRD = ordensServico.filter(os => { // Filtered Report Data
            let matchPrazo = true;
            if (os.prazoFinal) { // OS deve ter um prazo final para ser filtrada por data
                const prazoFinalDate = new Date(os.prazoFinal + "T00:00:00Z"); // Considerar como data UTC
                if (dSV && dEV) { // Ambas as datas do filtro preenchidas
                    matchPrazo = prazoFinalDate >= new Date(dSV + "T00:00:00Z") && prazoFinalDate <= new Date(dEV + "T23:59:59Z");
                } else if (dSV) { // Apenas data inicial do filtro
                    matchPrazo = prazoFinalDate >= new Date(dSV + "T00:00:00Z");
                } else if (dEV) { // Apenas data final do filtro
                    matchPrazo = prazoFinalDate <= new Date(dEV + "T23:59:59Z");
                }
            } else if (dSV || dEV) { // Se filtro de data está ativo mas OS não tem prazo, não incluir
                matchPrazo = false;
            }

            const matchStatus = sV ? os.status === sV : true; // Filtro de status
            const matchProduct = pV ? os.produto === pV : true; // Filtro de produto

            let matchMarcadorAtraso = true; // Filtro de marcador de atraso
            if (fMAVal === "marcada") matchMarcadorAtraso = os.marcadorAtrasoManual === true;
            else if (fMAVal === "nao_marcada") matchMarcadorAtraso = os.marcadorAtrasoManual === false;

            let matchLogistica = true; // Filtro de logística
            if (fLOKVal === "sim") matchLogistica = os.logisticaOk === true;
            else if (fLOKVal === "nao") matchLogistica = os.logisticaOk === false;

            return matchPrazo && matchStatus && matchProduct && matchMarcadorAtraso && matchLogistica;
        });

        if (fRD.length === 0) {
            rTB.innerHTML = '<tr><td colspan="8" class="text-center py-10 text-slate-500 dark:text-slate-400">Nenhuma Ordem de Serviço encontrada para os filtros selecionados.</td></tr>';
            return;
        }

        fRD.sort((a, b) => new Date(a.dataAbertura) - new Date(b.dataAbertura)); // Ordenar por data de abertura
        fRD.forEach(os => {
            const rw = rTB.insertRow();
            rw.className = 'table-row hover:bg-slate-100 dark:hover:bg-slate-700';
            // Código OS, Solicitante, Cliente, Data Início, Data Término, Técnico/Responsável, Logística Pronta, Produto
            rw.innerHTML = `<td class="py-3 px-4 text-sm">${os.numero}</td>
                            <td class="py-3 px-4 text-sm">${os.solicitante || 'N/A'}</td>
                            <td class="py-3 px-4 text-sm">${os.cliente}</td>
                            <td class="py-3 px-4 text-sm">${formatDateToBR(os.dataAbertura)}</td>
                            <td class="py-3 px-4 text-sm">${formatDateToBR(os.prazoFinal)}</td>
                            <td class="py-3 px-4 text-sm">${os.responsavel}</td>
                            <td class="py-3 px-4 text-sm">${os.logisticaOk ? 'Sim' : 'Não'}</td>
                            <td class="py-3 px-4 text-sm">${os.produto || 'N/A'}</td>`;
        });
        addRecentActivity("Relatório personalizado gerado com sucesso.");
        renderReportCharts(fRD); // Renderiza os gráficos com os dados filtrados
    }

    function renderReportCharts(d){const iDM=document.documentElement.classList.contains('dark');const cCO=(tTJS=null)=>({responsive:true,maintainAspectRatio:false,animation:{duration:1e3,easing:'easeInOutQuart',animateScale:true,animateRotate:true},plugins:{legend:{display:true,position:'bottom',labels:{color:iDM?'#cbd5e1':'#1e293b',padding:15,boxWidth:12,font:{size:11}}},title:{display:!!tTJS,text:tTJS,color:iDM?'#cbd5e1':'#1e293b',font:{size:14,weight:'normal'}},tooltip:{backgroundColor:iDM?'rgba(30,41,59,0.95)':'rgba(255,255,255,0.95)',titleColor:iDM?'#f1f5f9':'#1e293b',bodyColor:iDM?'#cbd5e1':'#334155',borderColor:iDM?'#475569':'#e2e8f0',borderWidth:1,padding:10,callbacks:{label:function(c){const t=c.chart.getDatasetMeta(0).total;const p=t>0?((c.parsed/t)*100).toFixed(1)+'%':'0%';return`${c.label||''}: ${c.parsed||0} (${p})`}}}},scales:{y:{beginAtZero:true,ticks:{color:iDM?'#94a3b8':'#475569',stepSize:1,precision:0},grid:{color:iDM?'#334155':'#e2e8f0',drawBorder:false}},x:{ticks:{color:iDM?'#94a3b8':'#475569',autoSkip:true,maxRotation:45,minRotation:0},grid:{display:false}}}});const cCl=['rgba(54,162,235,0.8)','rgba(255,159,64,0.8)','rgba(75,192,192,0.8)','rgba(255,99,132,0.8)','rgba(153,102,255,0.8)','rgba(255,205,86,0.8)','rgba(123,239,178,0.8)','rgba(250,130,49,0.8)','rgba(179,57,57,0.8)','rgba(72,126,176,0.8)','rgba(246,229,141,0.8)','rgba(113,88,226,0.8)'];const cBC=iDM?'rgba(15,23,42,0.8)':'rgba(255,255,255,0.8)';const pC=d.reduce((acc,os)=>{acc[os.produto||'N/Esp.']=(acc[os.produto||'N/Esp.']||0)+1;return acc},{});if(document.getElementById('reportChartByProduct')){if(reportChartByProductInstance)reportChartByProductInstance.destroy();reportChartByProductInstance=new Chart(document.getElementById('reportChartByProduct').getContext('2d'),{type:'bar',data:{labels:Object.keys(pC),datasets:[{label:'OS',data:Object.values(pC),backgroundColor:cCl,borderColor:cBC,borderWidth:1.5}]},options:cCO()})}const uC=d.reduce((acc,os)=>{acc[os.responsavel||'N/Atrib.']=(acc[os.responsavel||'N/Atrib.']||0)+1;return acc},{});if(document.getElementById('reportChartByUsuario')){if(reportChartByUsuarioInstance)reportChartByUsuarioInstance.destroy();reportChartByUsuarioInstance=new Chart(document.getElementById('reportChartByUsuario').getContext('2d'),{type:'pie',data:{labels:Object.keys(uC),datasets:[{label:'OS',data:Object.values(uC),backgroundColor:cCl,borderColor:cBC,borderWidth:1.5,hoverOffset:8}]},options:cCO()})}const sCR=d.reduce((acc,os)=>{acc[os.status]=(acc[os.status]||0)+1;return acc},{});const sCM={'Aberta':'rgba(54,162,235,0.8)','Em Andamento':'rgba(255,159,64,0.8)','Pendente Informação':'rgba(255,205,86,0.8)','Aguardando Aprovação':'rgba(153,102,255,0.8)','Completa':'rgba(75,192,192,0.8)','Cancelada':'rgba(255,99,132,0.8)', 'Incompleta':'rgba(201, 203, 207, 0.8)', 'Provisória': 'rgba(160, 160, 160, 0.8)'};if(document.getElementById('reportChartByStatus')){if(reportChartByStatusInstance)reportChartByStatusInstance.destroy();reportChartByStatusInstance=new Chart(document.getElementById('reportChartByStatus').getContext('2d'),{type:'doughnut',data:{labels:Object.keys(sCR),datasets:[{label:'OS',data:Object.values(sCR),backgroundColor:Object.keys(sCR).map((s,i)=>sCM[s]||cCl[i%cCl.length]),borderColor:cBC,borderWidth:1.5,hoverOffset:8}]},options:cCO()})}}
    const clearReportOnChange=()=>{if(document.getElementById('reportsView')&&!document.getElementById('reportsView').classList.contains('hidden')){document.getElementById('reportsTableBody').innerHTML='<tr><td colspan="8" class="text-center py-10 text-slate-500 dark:text-slate-400">Os filtros foram alterados. Clique em "Gerar Relatório" para atualizar.</td></tr>';if(reportChartByProductInstance){reportChartByProductInstance.destroy();reportChartByProductInstance=null}if(reportChartByUsuarioInstance){reportChartByUsuarioInstance.destroy();reportChartByUsuarioInstance=null}if(reportChartByStatusInstance){reportChartByStatusInstance.destroy();reportChartByStatusInstance=null}document.getElementById('customReportChartsContainer').querySelectorAll('canvas').forEach(c=>{const ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height)})}};


    // ==========================================================================
    // FUNÇÕES DE EXPORTAÇÃO (CSV, PDF)
    // ==========================================================================
    function exportTableToCSV(tId,fN){let c=[];const t=document.getElementById(tId);if(!t){console.error(`Tabela com ID '${tId}' não encontrada para exportação CSV.`);return}const rS=t.querySelectorAll("tr");for(const r of rS){const cS=r.querySelectorAll("td,th");const rD=[];for(const col of cS){let cT=col.innerText;if(col.querySelector('select'))cT=col.querySelector('select').value;else if(col.querySelector('span[class*="priority-"]'))cT=col.querySelector('span').innerText; if(col.querySelector('.fa-flag')) cT = "[M.Atraso] " + cT.replace(/\[M\.Atraso\]\s*/, '').trim(); if(col.querySelector('.fa-truck')) cT = (col.querySelector('.fa-truck.text-teal-500') ? "[L.OK]" : "[L.Pendente]") + cT.replace(/\[L\.(OK|Pendente)\]\s*/, '').trim(); rD.push('"'+cT.replace(/\s+/g,' ').trim().replace(/"/g,'""')+'"')}c.push(rD.join(","))}const cF=new Blob(["\uFEFF"+c.join("\n")],{type:"text/csv;charset=utf-8;"});const l=document.createElement("a");l.href=URL.createObjectURL(cF);l.download=fN;l.style.display="none";document.body.appendChild(l);l.click();document.body.removeChild(l);addRecentActivity(`Arquivo CSV "${fN}" exportado com sucesso.`)}
    function exportTableToPDF(tId,t,tBId,iWR=false){const{jsPDF}=window.jspdf;const d=new jsPDF({orientation:iWR?'landscape':'portrait',unit:'pt',format:'a4'});const iDM=document.documentElement.classList.contains('dark');const tC=iDM?'#FFF':'#000';const hC=iDM?'#334155':'#F2F2F2';const hTC=iDM?'#FFF':'#333';let cY=40;d.setFontSize(18);d.setTextColor(tC);d.text(t,d.internal.pageSize.getWidth()/2,cY,{align:'center'});cY+=30;const tbl=document.getElementById(tId);if(tbl){const h=[];tbl.querySelectorAll('thead th').forEach(th=>{if(th.innerText.toLowerCase() !== 'ações' && !th.querySelector('input[type=checkbox]')) h.push(th.innerText)});const b=[];const tBd=document.getElementById(tBId);if(tBd)tBd.querySelectorAll('tr').forEach(tr=>{const rD=[];tr.querySelectorAll('td').forEach((td, index)=>{let ths = Array.from(tbl.querySelectorAll('thead th')); if(ths[index] && (ths[index].innerText.toLowerCase() === 'ações' || ths[index].querySelector('input[type=checkbox]'))) return; let cT=td.innerText;if(td.querySelector('select'))cT=td.querySelector('select').value;else if(td.querySelector('span[class*="priority-"]'))cT=td.querySelector('span').innerText; if(td.querySelector('.fa-flag')) cT = "[M.A] " + cT.replace(/\[M\.A\]\s*/, '').trim(); if(td.querySelector('.fa-truck')) cT = (td.querySelector('.fa-truck.text-teal-500') ? "Sim" : "Não"); rD.push(cT)});if(rD.length > 0)b.push(rD)});if(b.length>0&&!(b[0].length===1&&b[0][0].includes("Nenhuma OS encontrada"))){d.autoTable({startY:cY,head:[h],body:b,theme:'grid',headStyles:{fillColor:hC,textColor:hTC,fontStyle:'bold'},styles:{textColor:tC,cellPadding:5,fontSize:iWR?7:8,overflow:'linebreak'},alternateRowStyles:{fillColor:iDM?'#1e293b':'#f9f9f9'}})}else d.setFontSize(12).text("Nenhum dado na tabela para exportar.",40,cY)}else d.setFontSize(12).text("Tabela não encontrada para exportação.",40,cY);const gD=`Gerado em: ${new Date().toLocaleString('pt-BR')}`;d.setFontSize(8).text(gD,d.internal.pageSize.getWidth()-40,d.internal.pageSize.getHeight()-20,{align:'right'});d.save(t.replace(/[^a-z0-9_]+/gi,'_').toLowerCase()+'.pdf');addRecentActivity(`Arquivo PDF "${t}" exportado com sucesso.`)}

    async function exportReportToPDFWithCharts(tId,t,tBId,cCI=[]){
        const{jsPDF}=window.jspdf;
        const doc=new jsPDF({orientation:'landscape',unit:'pt',format:'a4'});
        const iDM=document.documentElement.classList.contains('dark');
        const tC=iDM?'#FFF':'#000';const hC=iDM?'#334155':'#F2F2F2';const hTC=iDM?'#FFF':'#333';
        const pH=doc.internal.pageSize.getHeight();
        const pW=doc.internal.pageSize.getWidth();
        const m=40;
        let cY=m;

        doc.setFontSize(16);
        doc.setTextColor(tC);
        doc.text(t, pW/2, cY, {align:'center'});
        cY+=25;

        const rDSV=document.getElementById('reportDateStartFilter')?.value;
        const rDEV=document.getElementById('reportDateEndFilter')?.value;
        const rSV=document.getElementById('reportStatusFilter')?.value;
        const rPV=document.getElementById('reportProductFilter')?.value;
        const rFMAVal = document.getElementById('reportFilterMarcadorAtraso')?.value;
        const rFLOKVal = document.getElementById('reportFilterLogisticaOk')?.value;

        let fT="Filtros Aplicados: ";
        let hF=false;
        if(rDSV||rDEV){fT+=`Período: ${rDSV?formatDateToBR(rDSV):'*'} a ${rDEV?formatDateToBR(rDEV):'*'}. `;hF=true}
        if(rSV){fT+=`Status: ${rSV}. `;hF=true}
        if(rPV){fT+=`Produto: ${rPV}. `;hF=true}
        if(rFMAVal){fT+=`Atraso: ${rFMAVal === "marcada" ? "Marcadas" : (rFMAVal === "nao_marcada" ? "Não Marcadas" : "Todos")}. `; hF=true;}
        if(rFLOKVal){fT+=`Logística: ${rFLOKVal === "sim" ? "Pronta" : (rFLOKVal === "nao" ? "Não Pronta" : "Todas")}. `; hF=true;}
        if(!hF){fT="Filtros: Nenhum filtro específico aplicado."}

        doc.setFontSize(9);
        doc.setTextColor(iDM ? '#bdc3c7' : '#34495e');
        let splitFilters = doc.splitTextToSize(fT, pW - (2*m));
        doc.text(splitFilters, m, cY);
        cY += (splitFilters.length * 10) + 10;


        const tbl=document.getElementById(tId);
        if(tbl){
            const head = [['Cód. OS', 'Solicitante', 'Cliente', 'Início', 'Término', 'Responsável', 'Logística', 'Produto']];
            const body = [];
            const tBd=document.getElementById(tBId);
            if(tBd) {
                tBd.querySelectorAll('tr').forEach(tr => {
                    if (tr.querySelector('td[colspan="8"]')) return;
                    const rD=[];
                    rD.push(tr.cells[0]?.innerText || '');
                    rD.push(tr.cells[1]?.innerText || '');
                    rD.push(tr.cells[2]?.innerText || '');
                    rD.push(tr.cells[3]?.innerText || '');
                    rD.push(tr.cells[4]?.innerText || '');
                    rD.push(tr.cells[5]?.innerText || '');
                    rD.push(tr.cells[6]?.innerText || '');
                    rD.push(tr.cells[7]?.innerText || '');
                    body.push(rD);
                });
            }

            if(body.length>0){
                doc.autoTable({
                    startY:cY, head:head, body:body, theme:'striped',
                    headStyles:{fillColor: hC, textColor:hTC, fontStyle:'bold', halign: 'center', fontSize: 8},
                    styles:{textColor:tC, cellPadding:4, fontSize:7, overflow:'linebreak', halign: 'left'},
                    alternateRowStyles:{fillColor: iDM?'#2c3e50':'#ecf0f1'},
                    columnStyles: {
                        0: { cellWidth: 60 },
                        1: { cellWidth: 80 },
                        2: { cellWidth: 100 },
                        3: { cellWidth: 60 },
                        4: { cellWidth: 60 },
                        5: { cellWidth: 90 },
                        6: { cellWidth: 60, halign: 'center' },
                        7: { cellWidth: 'auto' }
                    },
                    didDrawPage:(data)=>{cY = data.cursor.y + 20; if(cY > pH - m - 50) cY = m; }
                });
                cY = doc.autoTable.previous.finalY + 30;
            }else{doc.setFontSize(10);doc.text("Nenhum dado na tabela para os filtros atuais.",m,cY);cY+=20}
        }else{doc.setFontSize(10);doc.text("Tabela de relatório não encontrada.",m,cY);cY+=20}

        const chartWidth = (pW - (3*m)) / 2;
        const chartHeight = chartWidth * 0.60;
        let chartX = m;
        let chartsOnCurrentPage = 0;

        for(const chartId of cCI){
            const canvas = document.getElementById(chartId);
            if(canvas && canvas.offsetParent !== null && canvas.width > 0 && canvas.height > 0){
                if (cY + chartHeight + 20 > pH - m) { // Check if new page needed for chart
                    doc.addPage();
                    cY = m;
                    chartX = m;
                    chartsOnCurrentPage = 0;
                } else if (chartsOnCurrentPage >= 2) { // Max 2 charts per row, then new line
                    cY += chartHeight + 30;
                    chartX = m;
                    chartsOnCurrentPage = 0;
                     if (cY + chartHeight + 20 > pH - m) { // Check again if new page needed after moving Y
                        doc.addPage();
                        cY = m;
                    }
                }

                try {
                    const imgData = canvas.toDataURL('image/png', 1.0);
                    const chartTitleElement = canvas.closest('.card')?.querySelector('h4');
                    const chartTitle = chartTitleElement ? chartTitleElement.innerText : chartId.replace('reportChartBy','Gráfico ');

                    doc.setFontSize(10);
                    doc.setTextColor(tC);
                    doc.text(chartTitle, chartX + chartWidth/2, cY - 8, {align:'center'});
                    doc.addImage(imgData, 'PNG', chartX, cY, chartWidth, chartHeight);

                    chartX += chartWidth + m;
                    chartsOnCurrentPage++;

                } catch(e) {
                    console.error("Erro ao adicionar gráfico ao PDF:", e, chartId);
                    doc.setTextColor(255,0,0); // Red for error
                    doc.text(`Erro: ${chartId}`, chartX, cY);
                    doc.setTextColor(tC); // Reset color
                    chartX += chartWidth + m;
                    chartsOnCurrentPage++;
                }
            }
        }

        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(iDM ? '#95a5a6' : '#7f8c8d');
            const footerText = `Gerado em: ${new Date().toLocaleString('pt-BR')}   |   Página ${i} de ${pageCount}`;
            doc.text(footerText, pW - m, pH - 15, { align: 'right' });
        }

        doc.save(t.replace(/[^a-z0-9_]+/gi,'_').toLowerCase()+'.pdf');
        addRecentActivity(`Arquivo PDF Detalhado "${t}" exportado com sucesso.`);
    }

    function downloadICS(osI){const os=ordensServico.find(o=>o.id===osI);if(!os){alert("OS não encontrada para gerar arquivo .ics.");return}const nF=new Date().toISOString().replace(/-/g,'').replace(/:/g,'').substring(0,15)+'Z';const d=`OS: ${os.numero}\\nCliente: ${os.cliente}\\nProduto: ${os.produto||'N/A'}\\nDescrição: ${os.descricao.replace(/\n/g,'\\n')}\\nResponsável: ${os.responsavel}\\nPrioridade: ${os.prioridade}\\nStatus: ${os.status}${os.marcadorAtrasoManual ? '\\nMARCADA: NÃO REALIZADA NO PRAZO' : ''}${os.logisticaOk ? '\\nLOGÍSTICA: OK' : ''}`;const iC=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//hacksw/handcal//NONSGML v1.0//EN","BEGIN:VEVENT",`UID:${os.id}@${window.location.hostname||'gestao-os.com'}`,`DTSTAMP:${nF}`,`DTSTART;VALUE=DATE:${os.dataAbertura.replace(/-/g,'')}`,`DTEND;VALUE=DATE:${new Date(new Date(os.prazoFinal).getTime()+864e5).toISOString().split('T')[0].replace(/-/g,'')}`,`SUMMARY:Prazo OS ${os.numero} - ${os.cliente}`,`DESCRIPTION:${d}`,"LOCATION:Cliente "+os.cliente,"BEGIN:VALARM","ACTION:DISPLAY","DESCRIPTION:Lembrete Prazo OS","TRIGGER:-PT1D","END:VALARM","END:VEVENT","END:VCALENDAR"].join("\r\n");const b=new Blob([iC],{type:'text/calendar;charset=utf-8'});const l=document.createElement('a');l.href=URL.createObjectURL(b);l.download=`OS_${os.numero}_${os.cliente.replace(/ /g,'_')}.ics`;document.body.appendChild(l);l.click();document.body.removeChild(l);addRecentActivity(`Arquivo .ics para OS ${os.numero} gerado.`)}

    // ==========================================================================
    // FUNÇÕES DE CONFIGURAÇÕES DA APLICAÇÃO
    // ==========================================================================
    function confirmClearAllData(){if(confirm("ATENÇÃO!\nTem certeza que deseja limpar TODOS os dados de Ordens de Serviço?\nEsta ação é IRREVERSÍVEL e todos os dados salvos localmente serão perdidos.")){if(confirm("CONFIRMAÇÃO FINAL:\nTodos os dados de OS serão permanentemente apagados. Deseja continuar?")){ordensServico=[];savedFilters={};localStorage.removeItem('ordensServicoData_v1_9_0');localStorage.removeItem('savedFilters_v1_9_0');addRecentActivity("Todos os dados de OS foram limpos do sistema.");currentPage=1;refreshAllViews();populateSavedFiltersSelect();alert("Todos os dados de Ordens de Serviço foram limpos com sucesso.")}else alert("Limpeza de dados cancelada pelo usuário.")}else alert("Limpeza de dados cancelada pelo usuário.")}
    function applyItemsPerPageSetting(){const iPSI=document.getElementById('itemsPerPageSetting');if(!iPSI)return;const nIPP=parseInt(iPSI.value,10);if(nIPP>=5&&nIPP<=50){ITEMS_PER_PAGE=nIPP;currentPage=1;saveDataToLocalStorage();renderOSTable();addRecentActivity(`Número de itens por página alterado para ${ITEMS_PER_PAGE}.`)}else{alert("Por favor, insira um valor entre 5 e 50 para itens por página.");iPSI.value=ITEMS_PER_PAGE}}

    // ==========================================================================
    // INICIALIZAÇÃO DA APLICAÇÃO E EVENTOS GLOBAIS
    // ==========================================================================
    document.addEventListener('DOMContentLoaded', () => {
        // Inicializa referências a elementos globais que dependem do DOM carregado
        osModal = document.getElementById('osModal');
        osForm = document.getElementById('osForm');
        modalTitle = document.getElementById('modalTitle');
        productDatalist = document.getElementById('productList');
        filterProductSelect = document.getElementById('filterProduct');
        reportProductSelect = document.getElementById('reportProduct');
        // recentActivityList será inicializado em showView('homeView')
        // Elementos de importação também são melhor inicializados em showView('osListView')

        loadDataFromLocalStorage();

        const homeSidebarItem=document.querySelector('.sidebar-item[onclick*="homeView"]');
        showView('homeView',homeSidebarItem||null); // Chama showView que também popula filtros se necessário

        const dataAberturaModalEl=document.getElementById('osDataAberturaModal');
        if(dataAberturaModalEl&&!dataAberturaModalEl.value)dataAberturaModalEl.value=new Date().toISOString().split('T')[0];

        const processExcelButton = document.getElementById('processExcelButton');
        if (processExcelButton) {
            processExcelButton.addEventListener('click', handleExcelImport);
        }

        if(mainToggleSidebarBtn && mainSidebar && mainContentArea && sidebarTitleDiv){
             if(window.innerWidth<1024 && !mainSidebar.classList.contains('collapsed')){
                mainSidebar.classList.add('collapsed');
                mainContentArea.classList.add('collapsed');
                const iC=mainSidebar.classList.contains('collapsed');
                mainToggleSidebarBtn.innerHTML=iC?'<i class="fas fa-chevron-right text-lg"></i>':'<i class="fas fa-bars text-lg"></i>';
                const tS=sidebarTitleDiv.querySelector('span');if(tS)tS.style.display=iC?'none':'inline';
                const tI=sidebarTitleDiv.querySelector('i');if(tI)tI.style.marginRight=iC?'0':'0.5rem';
            }
        }
        const versionElement = document.querySelector('.sidebar-item span:last-of-type');
        const versionMatch = versionElement ? versionElement.textContent.match(/(\d+\.\d+\.\d+)/) : null;
        const version = versionMatch ? versionMatch[0] : '1.9.0';
        addRecentActivity(`Sistema V${version} inicializado.`);
        updateLoginUI();

        // Adiciona listener ao formulário de OS
        if (osForm) {
            osForm.addEventListener('submit', function(e) {
                e.preventDefault();
                try {
                    const id = document.getElementById('osId').value;
                    const osD = { // osData
                        numero: document.getElementById('osNumeroModal').value.trim(),
                        cliente: document.getElementById('osClienteModal').value.trim(),
                        produto: document.getElementById('osProdutoModal').value.trim(),
                        solicitante: document.getElementById('osSolicitanteModal').value.trim(),
                        descricao: document.getElementById('osDescricaoModal').value.trim(),
                        dataAbertura: document.getElementById('osDataAberturaModal').value, // YYYY-MM-DD
                        prazoFinal: document.getElementById('osPrazoFinalModal').value,   // YYYY-MM-DD
                        responsavel: document.getElementById('osResponsavelModal').value.trim(),
                        status: document.getElementById('osStatusModal').value,
                        prioridade: document.getElementById('osPrioridadeModal').value,
                        marcadorAtrasoManual: document.getElementById('osMarcadorAtrasoModal').checked,
                        logisticaOk: document.getElementById('osLogisticaOkModal').checked
                    };
                    if (!osD.numero || !osD.cliente || !osD.produto || !osD.descricao || !osD.dataAbertura || !osD.prazoFinal || !osD.responsavel || !osD.status || !osD.prioridade) {
                        alert("Por favor, preencha todos os campos obrigatórios (*).");
                        return;
                    }
                    if (new Date(osD.prazoFinal) < new Date(osD.dataAbertura)) {
                        alert("A Data de Prazo Final não pode ser anterior à Data de Abertura.");
                        return;
                    }
                    if (id) { // Editando OS existente
                        const osIX = ordensServico.findIndex(o => o.id === id);
                        if (osIX !== -1) {
                            ordensServico[osIX] = { ...ordensServico[osIX], ...osD }; // Mantém o ID e outras props não editadas
                            addRecentActivity(`OS ${osD.numero} foi editada.`);
                        } else {
                            alert("Erro ao tentar editar a OS. OS não encontrada.");
                            return;
                        }
                    } else { // Adicionando nova OS
                        osD.id = generateId(); // Gera novo ID
                        ordensServico.unshift(osD); // Adiciona no início da lista
                        addRecentActivity(`Nova OS ${osD.numero} foi adicionada.`);
                    }
                    saveDataToLocalStorage();
                    populateProductFilters(); // Atualiza datalist e selects de produto
                    closeOSModal();
                    currentPage = 1; // Volta para a primeira página da lista
                    refreshAllViews(); // Atualiza todas as visualizações relevantes
                } catch (er) {
                    console.error("Erro ao salvar OS:", er);
                    alert("Ocorreu um erro ao tentar salvar a Ordem de Serviço.");
                }
            });
        }

        // Event listeners para filtros da lista de OS (aplicam ao digitar/mudar)
        const filterOsNumEl = document.getElementById('filterOsNumber');if(filterOsNumEl)filterOsNumEl.addEventListener('input',applyFiltersAndRender);
        const filterClientEl = document.getElementById('filterClient');if(filterClientEl)filterClientEl.addEventListener('input',applyFiltersAndRender);
        const filterStatusEl = document.getElementById('filterStatus');if(filterStatusEl)filterStatusEl.addEventListener('change',applyFiltersAndRender);
        const filterProductSelectGlobal = document.getElementById('filterProduct');if(filterProductSelectGlobal)filterProductSelectGlobal.addEventListener('change',applyFiltersAndRender);
        const filterDescriptionInput = document.getElementById('filterDescription');if(filterDescriptionInput)filterDescriptionInput.addEventListener('input',applyFiltersAndRender);
        const filterMarcadorAtrasoEl = document.getElementById('filterMarcadorAtraso'); if(filterMarcadorAtrasoEl) filterMarcadorAtrasoEl.addEventListener('change', applyFiltersAndRender);
        const filterLogisticaOkEl = document.getElementById('filterLogisticaOk'); if(filterLogisticaOkEl) filterLogisticaOkEl.addEventListener('change', applyFiltersAndRender);

        // Event listeners para filtros de Relatórios (limpam o relatório ao mudar, exigindo novo "Gerar")
        const rDSL=document.getElementById('reportDateStartFilter');if(rDSL)rDSL.addEventListener('change',clearReportOnChange);
        const rDEL=document.getElementById('reportDateEndFilter');if(rDEL)rDEL.addEventListener('change',clearReportOnChange);
        const rSL=document.getElementById('reportStatusFilter');if(rSL&&!rSL.getAttribute('data-listener-set')){rSL.addEventListener('change',clearReportOnChange);rSL.setAttribute('data-listener-set','true')}
        const rPL=document.getElementById('reportProductFilter');if(rPL&&!rPL.getAttribute('data-listener-set')){rPL.addEventListener('change',clearReportOnChange);rPL.setAttribute('data-listener-set','true')}
        const rFMAIL = document.getElementById('reportFilterMarcadorAtraso'); if(rFMAIL && !rFMAIL.getAttribute('data-listener-set-report')) {rFMAIL.addEventListener('change', clearReportOnChange);rFMAIL.setAttribute('data-listener-set-report','true')}
        const rFLOK = document.getElementById('reportFilterLogisticaOk'); if(rFLOK && !rFLOK.getAttribute('data-listener-set-report')) {rFLOK.addEventListener('change', clearReportOnChange);rFLOK.setAttribute('data-listener-set-report','true')}
    });

    window.onclick=function(e){
        const currentOsModal = document.getElementById('osModal');
        if(currentOsModal&&e.target==currentOsModal)closeOSModal(); // Fecha modal se clicar fora
    };

    window.onkeydown=function(e){
        const currentOsModal = document.getElementById('osModal');
        if(currentOsModal&&!currentOsModal.classList.contains('hidden')&&e.key==="Escape")closeOSModal(); // Fecha modal com ESC
    };
</script>
</body>
</html>
